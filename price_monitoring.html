<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitoring - Anihan</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link href="price_monitoring.css" rel="stylesheet">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="navbar-nav">
                <div class="nav-item">
                    <div class="user-avatar" onclick="toggleProfileDropdown()">
                        <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                        <i id="userAvatarIcon" class="fas fa-user"></i>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="profileUserTitle">System Administrator</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link active d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="price-card shadow-sm mt-4">
                    <div class="price-card-header d-flex justify-content-between align-items-center">
                        <span>Price Monitoring Records</span>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="price-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Store name</th>
                                    <th>Store location</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded dynamically from database -->
                            </tbody>
                        </table>
                    </div>
                    <div class="price-card-footer">
                        <a href="#" style="color:#2563eb;font-size:0.95rem;">View all &gt;</a>
                        <div class="price-pagination">
                            <button class="btn">&lt;</button>
                            <button class="btn active">1</button>
                            <button class="btn">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script>
        // Note: Supabase configuration is loaded from shared-profile.js
        
        // Load price monitoring data from database
        async function loadPriceMonitoringData() {
            console.log('Loading price monitoring data...');
            try {
                // Add loading state
                const tbody = document.querySelector('.price-table tbody');
                if (!tbody) {
                    console.error('Table body not found!');
                    return;
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin mb-2"></i><br>
                            Loading price data...
                        </td>
                    </tr>
                `;

                console.log('Fetching products and store data...');
                
                // Fetch products with their associated store information
                // Join my_products with store-owner and users tables
                const { data: priceData, error } = await supabaseClient
                    .from('my_products')
                    .select(`
                        id,
                        name,
                        price,
                        size,
                        variation,
                        description,
                        discount,
                        image_url,
                        user_id,
                        users!my_products_user_id_fkey (
                            id,
                            store-owner!store-owner_user_id_fkey (
                                store_name,
                                latitude,
                                longitude,
                                crops_type
                            )
                        )
                    `);

                console.log('Price data query result:', { priceData, error });

                if (error) {
                    console.error('Error loading price data:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle mb-2"></i><br>
                                <strong>Database Error:</strong><br>
                                ${error.message}
                            </td>
                        </tr>
                    `;
                    return;
                }

                if (!priceData || priceData.length === 0) {
                    console.log('No price data found');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-box-open mb-2"></i><br>
                                No price monitoring data found
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Successfully loaded price data:', priceData.length);
                populatePriceTable(priceData);
                
            } catch (error) {
                console.error('Price monitoring error:', error);
                const tbody = document.querySelector('.price-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>
                            <strong>Connection Error:</strong><br>
                            ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

function populatePriceTable(priceData) {
    console.log('Populating price table with data:', priceData);
    const tbody = document.querySelector('.price-table tbody');
    tbody.innerHTML = '';

    priceData.forEach((product, index) => {
        console.log(`Creating row ${index + 1} for product:`, product);
        console.log('Image URL from database:', product.image_url); // Debug log

        // Extract store information
        const user = product.users;
        const storeOwner = user?.['store-owner']?.[0];
        const storeName = storeOwner?.store_name || 'Unknown Store';
        const storeLocation = getLocationString(storeOwner?.latitude, storeOwner?.longitude);
        const category = storeOwner?.crops_type || product.variation || 'General';

        const row = document.createElement('tr');

        // Image cell
        const imageTd = document.createElement('td');
        createImageCellDOM(product.image_url, product.name, imageTd);
        row.appendChild(imageTd);

        // Product name cell
        const nameTd = document.createElement('td');
        nameTd.innerHTML = `
            <div class="product-info">
                <div class="product-name">${escapeHtml(product.name || 'N/A')}</div>
                <div class="product-size text-muted small">${escapeHtml(product.size || '')}</div>
            </div>
        `;
        row.appendChild(nameTd);

        // Category cell
        const categoryTd = document.createElement('td');
        categoryTd.innerHTML = `<span class="category-badge">${escapeHtml(category)}</span>`;
        row.appendChild(categoryTd);

        // Price cell
        const priceTd = document.createElement('td');
        priceTd.innerHTML = `<span class="price">â‚±${escapeHtml(product.price || '0')}</span>${product.discount ? `<div class="discount text-success small">-${escapeHtml(product.discount)}</div>` : ''}`;
        row.appendChild(priceTd);

        // Store name cell
        const storeNameTd = document.createElement('td');
        storeNameTd.innerHTML = `<span class="store-name">${escapeHtml(storeName)}</span>`;
        row.appendChild(storeNameTd);

        // Store location cell
        const storeLocationTd = document.createElement('td');
        storeLocationTd.innerHTML = `<span class="store-location">${escapeHtml(storeLocation)}</span>`;
        row.appendChild(storeLocationTd);

        tbody.appendChild(row);
    });
    console.log('Price table populated successfully');
}


// Create image cell as a DOM element for robust error handling
function createImageCellDOM(imageUrl, productName, tdElement) {
    console.log('Processing image URL:', imageUrl);
    tdElement.innerHTML = '';
    if (!imageUrl || imageUrl.trim() === '') {
        console.log('No image URL provided');
        tdElement.innerHTML = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="No image available"></i>`;
        return;
    }
    const url = imageUrl.trim();
    console.log('Cleaned URL:', url);
    if (url.startsWith('http://') || url.startsWith('https://') || url.startsWith('data:image/')) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = productName || 'Product';
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '4px';
        img.style.background = '#f8f9fa';
        img.onerror = function() {
            handleImageError(this, url);
        };
        img.onload = function() {
            console.log('Image loaded successfully:', this.src);
        };
        tdElement.appendChild(img);
    } else {
        console.warn('Invalid or non-public image URL format:', url);
        tdElement.innerHTML = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="Invalid image URL: ${escapeHtml(url)}"></i>`;
    }
}

function isValidImageUrl(url) {
    try {
        // Check for base64 images
        if (url.startsWith('data:image/')) {
            console.log('Base64 image detected');
            return true;
        }
        
        // Check for HTTP/HTTPS URLs
        if (url.startsWith('http://') || url.startsWith('https://')) {
            console.log('HTTP/HTTPS URL detected');
            // Additional validation for common image extensions
            if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i)) {
                return true;
            }
            // Allow URLs without extensions (might be from cloud storage with query params)
            return true;
        }
        
        // Check for relative paths with image extensions
        if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i)) {
            console.log('Local image file detected');
            return true;
        }
        
        // Check if it might be a Supabase storage URL or other cloud storage
        if (url.includes('supabase') || url.includes('storage') || url.includes('amazonaws') || url.includes('cloudinary')) {
            console.log('Cloud storage URL detected');
            return true;
        }
        
        console.log('URL format not recognized as valid image');
        return false;
        
    } catch (error) {
        console.error('Error validating image URL:', error);
        return false;
    }
}

// IMPROVED ERROR HANDLING FOR IMAGES
function handleImageError(imgElement, originalUrl) {
    console.error('Image failed to load:', originalUrl);
    
    // Replace with fallback icon
    const fallbackIcon = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="Image failed to load: ${originalUrl}"></i>`;
    imgElement.outerHTML = fallbackIcon;
}

// ADDITIONAL DEBUG FUNCTION - Call this to check your data
async function debugImageUrls() {
    console.log('=== DEBUG: Checking image URLs in database ===');
    
    try {
        const { data: products, error } = await supabaseClient
            .from('my_products')
            .select('id, name, image_url')
            .limit(5); // Check first 5 products
            
        if (error) {
            console.error('Error fetching products for debug:', error);
            return;
        }
        
        console.log('Sample products with image URLs:');
        products.forEach((product, index) => {
            console.log(`${index + 1}. Product: ${product.name}`);
            console.log(`   Image URL: "${product.image_url}"`);
            console.log(`   URL type: ${typeof product.image_url}`);
            console.log(`   URL length: ${product.image_url ? product.image_url.length : 0}`);
            console.log(`   Is valid: ${isValidImageUrl(product.image_url || '')}`);
            console.log('---');
        });
        
    } catch (error) {
        console.error('Debug error:', error);
    }
}

        // Convert coordinates to location string
        function getLocationString(latitude, longitude) {
            if (!latitude || !longitude) return 'Location not available';
            

            const lat = parseFloat(latitude).toFixed(4);
            const lng = parseFloat(longitude).toFixed(4);
            return `${lat}, ${lng}`;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Search functionality
        function setupPriceSearch() {
            const searchInput = document.querySelector('.search-input');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('.price-table tbody tr');
                
                rows.forEach(row => {
                    const productName = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
                    const category = row.querySelector('.category-badge')?.textContent.toLowerCase() || '';
                    const storeName = row.querySelector('.store-name')?.textContent.toLowerCase() || '';
                    const storeLocation = row.querySelector('.store-location')?.textContent.toLowerCase() || '';
                    
                    if (productName.includes(searchTerm) || 
                        category.includes(searchTerm) || 
                        storeName.includes(searchTerm) ||
                        storeLocation.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Price monitoring page loaded');
            
            // Wait for shared profile system to initialize
            const checkSharedProfile = () => {
                if (typeof supabaseClient !== 'undefined') {
                    console.log('Supabase client available, loading price data...');
                    loadPriceMonitoringData();
                    setupPriceSearch();
                } else {
                    // Wait a bit more for shared-profile.js to load
                    setTimeout(checkSharedProfile, 100);
                }
            };
            
            checkSharedProfile();
        });
    </script>
</body>
</html>