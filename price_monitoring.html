<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitoring - Anihan</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css?v=5.0" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.0" rel="stylesheet">
    <link href="fixed-layout.css?v=5.0" rel="stylesheet">
    <link href="profile-dropdown.css?v=5.0" rel="stylesheet">
    <link href="price_monitoring.css?v=5.0" rel="stylesheet">
    <style>
        /* Remove conflicting layout styles - let fixed-layout.css handle it */

        /* Table styling improvements */
        .price-table {
            border-collapse: collapse;
        }
        
        .price-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .price-table tbody td {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
            color: #495057;
        }

        /* Card improvements */
        .card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
        }
        
        .card-header.bg-success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="mobile-menu-toggle me-3 d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                    <span class="brand-text">Anihan</span>
                </a>
            </div>
            <div class="navbar-nav">
                <div class="nav-item">
                    <div class="user-avatar" onclick="toggleProfileDropdown()">
                        <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                        <i id="userAvatarIcon" class="fas fa-user"></i>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="profileUserTitle">System Administrator</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link active d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="price-card shadow-sm mt-4 mx-auto" style="max-width: 1200px;">
                    <div class="price-card-header d-flex justify-content-between align-items-center">
                        <span>Price Monitoring Records</span>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover price-table">
                            <thead style="background-color: #f8f9fa;">
                                <tr>
                                    <th style="font-weight: 600; color: #495057; padding: 15px 20px; border-bottom: 2px solid #e9ecef;">Product Name</th>
                                    <th style="font-weight: 600; color: #495057; padding: 15px 20px; border-bottom: 2px solid #e9ecef;">Category</th>
                                    <th style="font-weight: 600; color: #495057; padding: 15px 20px; border-bottom: 2px solid #e9ecef;">Price</th>
                                    <th style="font-weight: 600; color: #495057; padding: 15px 20px; border-bottom: 2px solid #e9ecef;">Store name</th>
                                    <th style="font-weight: 600; color: #495057; padding: 15px 20px; border-bottom: 2px solid #e9ecef;">Store location</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded dynamically from database -->
                            </tbody>
                        </table>
                        </div>
                    </div>
                    <div class="card-footer bg-light d-flex justify-content-between align-items-center" style="padding: 20px 30px;">
                        <div>
                            <span id="priceMonitoringItemsCount" style="color:#495057;font-size:0.95rem;">0 to 0 items of 0</span>
                            <a href="#" style="color:#2563eb;font-size:0.95rem;margin-left:1rem;" onclick="event.preventDefault(); showAllPriceMonitoringModal()">View all &gt;</a>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <button class="btn btn-outline-secondary btn-sm" onclick="changePage(-1)">&lt;</button>
                            <button class="btn btn-success btn-sm" id="currentPageBtn">1</button>
                            <button class="btn btn-outline-secondary btn-sm" onclick="changePage(1)">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add Supabase Client (required by shared-profile.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script>
        // Note: Supabase configuration is loaded from shared-profile.js
        
        // Pagination variables
        let currentPage = 1;
        let totalPriceRecords = 0;
        const recordsPerPage = 10;
        
        // Load price monitoring data from database
        async function loadPriceMonitoringData() {
            console.log('Loading price monitoring data...');
            try {
                // Add loading state
                const tbody = document.querySelector('.price-table tbody');
                if (!tbody) {
                    console.error('Table body not found!');
                    return;
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin mb-2"></i><br>
                            Loading price data...
                        </td>
                    </tr>
                `;

                console.log('Fetching products and store data...');
                
                // First get total count
                const { count } = await supabaseClient
                    .from('my_products')
                    .select('*', { count: 'exact', head: true });

                totalPriceRecords = count || 0;
                
                // Fetch products with their associated store information with pagination
                // Join my_products with store-owner and users tables
                const { data: priceData, error } = await supabaseClient
                    .from('my_products')
                    .select(`
                        id,
                        name,
                        price,
                        category,
                        description,
                        discount,
                        image_url,
                        user_id,
                        users!my_products_user_id_fkey (
                            id,
                            municipality,
                            store-owner!store-owner_user_id_fkey (
                                store_name
                            )
                        )
                    `)
                    .range((currentPage - 1) * recordsPerPage, currentPage * recordsPerPage - 1);

                console.log('Price data query result:', { priceData, error });
                
                // Add detailed debugging for image data
                if (priceData && priceData.length > 0) {
                    console.log(`Fetched ${priceData.length} products from database`);
                    console.log('Sample product data structure:', priceData[0]);
                    
                    if (priceData[0] && priceData[0].image_url) {
                        console.log('=== IMAGE DATA DEBUG ===');
                        console.log('Sample image_url data:');
                        console.log('- Type:', typeof priceData[0].image_url);
                        console.log('- Constructor:', priceData[0].image_url.constructor.name);
                        console.log('- Value:', priceData[0].image_url);
                        console.log('- Length:', priceData[0].image_url ? priceData[0].image_url.length : 'N/A');
                        
                        if (Array.isArray(priceData[0].image_url)) {
                            console.log('- Is Array: YES');
                            console.log('- First 10 bytes:', priceData[0].image_url.slice(0, 10));
                        } else if (typeof priceData[0].image_url === 'string') {
                            console.log('- Is String: YES');
                            console.log('- First 100 chars:', priceData[0].image_url.substring(0, 100));
                            
                            if (priceData[0].image_url.startsWith('\\x')) {
                                console.log('- Appears to be PostgreSQL bytea hex format');
                            } else if (priceData[0].image_url.startsWith('data:')) {
                                console.log('- Appears to be data URL');
                            } else if (priceData[0].image_url.startsWith('[')) {
                                console.log('- Appears to be stringified array');
                            }
                        } else if (priceData[0].image_url instanceof Uint8Array) {
                            console.log('- Is Uint8Array: YES');
                            console.log('- First 10 bytes:', Array.from(priceData[0].image_url.slice(0, 10)));
                        } else if (typeof priceData[0].image_url === 'object') {
                            console.log('- Is Object: YES');
                            console.log('- Object keys:', Object.keys(priceData[0].image_url));
                            if (priceData[0].image_url.data) {
                                console.log('- Has data property:', typeof priceData[0].image_url.data);
                            }
                        }
                        console.log('=== END IMAGE DEBUG ===');
                    }
                }

                if (error) {
                    console.error('Error loading price data:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle mb-2"></i><br>
                                <strong>Database Error:</strong><br>
                                ${error.message}
                            </td>
                        </tr>
                    `;
                    return;
                }

                if (!priceData || priceData.length === 0) {
                    console.log('No price data found');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-box-open mb-2"></i><br>
                                No price monitoring data found
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Successfully loaded price data:', priceData.length);
                populatePriceTable(priceData);
                
            } catch (error) {
                console.error('Price monitoring error:', error);
                const tbody = document.querySelector('.price-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>
                            <strong>Connection Error:</strong><br>
                            ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

function populatePriceTable(priceData) {
    console.log('Populating price table with data:', priceData);
    console.log('Displaying price data. Total products:', priceData.length);
    
    const tbody = document.querySelector('.price-table tbody');
    const itemsCount = document.getElementById('priceMonitoringItemsCount');
    console.log('Found tbody element:', tbody);
    tbody.innerHTML = '';

    if (!priceData || priceData.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-muted py-4">
                    <i class="fas fa-box-open mb-2"></i><br>
                    No price monitoring data found
                </td>
            </tr>
        `;
        if (itemsCount) itemsCount.textContent = '0 to 0 items of 0';
        return;
    }

    // Store all products globally for modal use
    window.allPriceMonitoringProducts = priceData;

    priceData.forEach((product, index) => {
        console.log(`=== Creating row ${index + 1} for product:`, product.name);
        console.log('Full product data:', product);
        console.log('Image URL from database:', product.image_url); // Debug log


    // Extract user and store information
    const user = product.users;
    const storeOwner = user?.['store-owner']?.[0];
    const storeName = storeOwner?.store_name || 'Unknown Store';
    const municipality = user?.municipality || 'Unknown';
    const category = product.category || 'General';

        const row = document.createElement('tr');

        // Product name cell
        const nameTd = document.createElement('td');
        nameTd.innerHTML = `
            <div class="product-info">
                <div class="product-name">${escapeHtml(product.name || 'N/A')}</div>
            </div>
        `;
        row.appendChild(nameTd);

        // Category cell
        const categoryTd = document.createElement('td');
        categoryTd.innerHTML = `<span class="category-badge">${escapeHtml(category)}</span>`;
        row.appendChild(categoryTd);

    // Price cell
    const priceTd = document.createElement('td');
    priceTd.innerHTML = `<span class="price">‚Ç±${escapeHtml(product.price || '0')}</span>`;
    row.appendChild(priceTd);

        // Store name cell
        const storeNameTd = document.createElement('td');
        storeNameTd.innerHTML = `<span class="store-name">${escapeHtml(storeName)}</span>`;
        row.appendChild(storeNameTd);


    // Municipality cell
    const municipalityTd = document.createElement('td');
    municipalityTd.innerHTML = `<span class="store-location">${escapeHtml(municipality)}</span>`;
    row.appendChild(municipalityTd);

        tbody.appendChild(row);
        console.log(`Row ${index + 1} appended to tbody successfully`);
    });

    // Update items count with pagination info
    if (itemsCount) {
        const startItem = ((currentPage - 1) * recordsPerPage) + 1;
        const endItem = Math.min(currentPage * recordsPerPage, totalPriceRecords);
        itemsCount.textContent = `${startItem} to ${endItem} items of ${totalPriceRecords}`;
    }

    // Update current page button
    const currentPageBtn = document.getElementById('currentPageBtn');
    if (currentPageBtn) {
        currentPageBtn.textContent = currentPage;
    }

    console.log(`Price table populated successfully. Total rows displayed: ${priceData.length} of ${totalPriceRecords}`);
}


// Create image cell as a DOM element for robust error handling

// Updated createImageCellDOM function with better byte array handling
function createImageCellDOM(imageData, productName, tdElement) {
    tdElement.innerHTML = '';
    console.log('=== createImageCellDOM called ===');
    console.log('Processing image data for product:', productName);
    console.log('Image data type:', typeof imageData);
    console.log('Image data value:', imageData);
    console.log('Image data length:', imageData ? imageData.length : 'N/A');
    
    if (!imageData || imageData === null || imageData === undefined) {
        console.log('No image data provided, showing placeholder');
        tdElement.innerHTML = `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"><i class="fas fa-image" style="font-size: 16px; color: #6c757d;" title="No image available"></i></div>`;
        return;
    }

    try {
        // Case 1: Handle Supabase byte array data (most common case for database storage)
        if (imageData && typeof imageData === 'object' && (Array.isArray(imageData) || imageData.constructor === Object)) {
            console.log('Processing as Supabase byte array or object');
            
            // If it's a Supabase response with nested data
            if (imageData.data && Array.isArray(imageData.data)) {
                console.log('Found nested data array, processing...');
                const base64String = bytesToBase64(imageData.data);
                const dataUrl = detectImageTypeAndCreateDataUrl(base64String, imageData.data);
                createImageElement(dataUrl, productName, tdElement);
                return;
            }
            
            // If it's a direct array
            if (Array.isArray(imageData)) {
                console.log('Processing direct byte array');
                const base64String = bytesToBase64(imageData);
                const dataUrl = detectImageTypeAndCreateDataUrl(base64String, imageData);
                createImageElement(dataUrl, productName, tdElement);
                return;
            }
        }

        // Case 2: Handle PostgreSQL bytea data (when fetched as string)
        if (typeof imageData === 'string') {
            // Handle mobile app file URIs (common issue)
            if (imageData.startsWith('file:///')) {
                console.log('Detected mobile app file URI - not accessible from web browser');
                console.log('File URI:', imageData);
                
                // Extract filename from URI for display
                const fileName = imageData.split('/').pop() || 'image';
                const fileNameWithoutExt = fileName.split('.')[0] || 'IMG';
                
                // Create initials from product name for a more personalized placeholder
                const productInitials = productName 
                    ? productName.split(' ').map(word => word.charAt(0).toUpperCase()).slice(0, 2).join('')
                    : 'IMG';
                
                tdElement.innerHTML = `
                    <div style="
                        width: 40px; 
                        height: 40px; 
                        display: flex; 
                        flex-direction: column; 
                        align-items: center; 
                        justify-content: center; 
                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                        border-radius: 8px; 
                        color: white; 
                        font-weight: bold; 
                        font-size: 12px; 
                        text-align: center; 
                        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
                        cursor: help;
                    " 
                    title="Product Image: ${productName} (Mobile app file not accessible in browser)">
                        ${productInitials}
                        <div style="font-size: 8px; opacity: 0.8;">üì∑</div>
                    </div>
                `;
                return;
            }
            
            // PostgreSQL bytea often comes as hex string starting with \\x
            if (imageData.startsWith('\\x')) {
                console.log('Processing PostgreSQL bytea hex string');
                const hexString = imageData.substring(2); // Remove \\x prefix
                const byteArray = hexStringToByteArray(hexString);
                const base64String = bytesToBase64(byteArray);
                const dataUrl = detectImageTypeAndCreateDataUrl(base64String, byteArray);
                createImageElement(dataUrl, productName, tdElement);
                return;
            }
            
            // Handle as data URL
            if (imageData.startsWith('data:image/')) {
                console.log('Image data is a data URL');
                createImageElement(imageData, productName, tdElement);
                return;
            }

            // Handle as regular URL
            if (imageData.startsWith('http://') || imageData.startsWith('https://')) {
                console.log('Image data is a regular URL');
                createImageElement(imageData, productName, tdElement);
                return;
            }

            // Handle stringified byte array: "[137,80,78,...]"
            if (imageData.trim().startsWith('[') && imageData.trim().endsWith(']')) {
                console.log('Processing stringified byte array');
                try {
                    const byteArray = JSON.parse(imageData.trim());
                    if (Array.isArray(byteArray)) {
                        const base64String = bytesToBase64(byteArray);
                        const dataUrl = detectImageTypeAndCreateDataUrl(base64String, byteArray);
                        createImageElement(dataUrl, productName, tdElement);
                        return;
                    }
                } catch (parseError) {
                    console.error('Error parsing stringified byte array:', parseError);
                }
            }

            // Handle as base64 string
            if (isBase64String(imageData)) {
                console.log('Processing as base64 string');
                const dataUrl = `data:image/jpeg;base64,${imageData}`;
                createImageElement(dataUrl, productName, tdElement);
                return;
            }

            // Handle as relative path
            if (!imageData.startsWith('data:') && !imageData.startsWith('http')) {
                console.log('Processing as relative path');
                const possiblePaths = [
                    imageData,
                    `images/${imageData}`,
                    `../images/${imageData}`,
                    `./images/${imageData}`,
                    `assets/${imageData}`,
                    `uploads/${imageData}`,
                    'https://via.placeholder.com/40x40/f8f9fa/6c757d?text=Product'
                ];
                createImageElementWithFallbacks(possiblePaths, productName, tdElement);
                return;
            }
        }

        // Case 3: Handle Uint8Array
        if (imageData instanceof Uint8Array) {
            console.log('Processing Uint8Array');
            const byteArray = Array.from(imageData);
            const base64String = bytesToBase64(byteArray);
            const dataUrl = detectImageTypeAndCreateDataUrl(base64String, byteArray);
            createImageElement(dataUrl, productName, tdElement);
            return;
        }

        // Fallback: Unknown format
        console.warn('Unknown image data format:', typeof imageData, imageData);
        tdElement.innerHTML = `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"><i class="fas fa-question" style="font-size: 16px; color: #ffc107;" title="Unsupported image format"></i></div>`;

    } catch (error) {
        console.error('Error processing image data:', error);
        tdElement.innerHTML = `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"><i class="fas fa-exclamation-triangle" style="font-size: 16px; color: #dc3545;" title="Image processing error"></i></div>`;
    }
}

// Helper function to create image element with fallback paths
function createImageElementWithFallbacks(pathArray, alt, tdElement) {
    let currentIndex = 0;
    
    function tryNextPath() {
        if (currentIndex >= pathArray.length) {
            // All paths failed, show placeholder
            console.log('All image paths failed, showing placeholder');
            tdElement.innerHTML = `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"><i class="fas fa-image" style="font-size: 16px; color: #6c757d;" title="Image not found"></i></div>`;
            return;
        }
        
        const img = document.createElement('img');
        img.src = pathArray[currentIndex];
        img.alt = alt || 'Product';
        img.style.width = '40px';
        img.style.height = '40px';
        img.style.objectFit = 'cover';
        img.style.borderRadius = '4px';
        img.style.background = '#f8f9fa';
        img.style.border = '1px solid #dee2e6';
        
        img.onerror = function() {
            console.log(`Failed to load image: ${pathArray[currentIndex]}`);
            currentIndex++;
            tryNextPath();
        };
        
        img.onload = function() {
            console.log(`Image loaded successfully: ${pathArray[currentIndex]}`);
            tdElement.innerHTML = '';
            tdElement.appendChild(img);
        };
        
        // Try loading the image
        // Don't append it yet, wait for onload
    }
    
    tryNextPath();
}

// Helper function to create image element with error handling
function createImageElement(src, alt, tdElement) {
    const img = document.createElement('img');
    img.src = src;
    img.alt = alt || 'Product';
    img.style.width = '40px';
    img.style.height = '40px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '4px';
    img.style.background = '#f8f9fa';
    img.style.border = '1px solid #dee2e6';
    
    img.onerror = function() {
        console.error('Failed to load image:', src);
        tdElement.innerHTML = `<div style="width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;"><i class="fas fa-exclamation-triangle" style="font-size: 16px; color: #dc3545;" title="Failed to load image"></i></div>`;
    };
    
    img.onload = function() {
        console.log('Image loaded successfully:', src);
    };
    
    tdElement.innerHTML = ''; // Clear any existing content
    tdElement.appendChild(img);
}

// Improved byte array to base64 conversion
function bytesToBase64(byteArray) {
    try {
        // Convert array to Uint8Array if it isn't already
        const uint8Array = new Uint8Array(byteArray);
        
        // Method 1: Using btoa with binary string (works for smaller images)
        if (uint8Array.length < 100000) { // Less than ~100KB
            let binary = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binary += String.fromCharCode(uint8Array[i]);
            }
            return btoa(binary);
        }
        
        // Method 2: Chunked processing for larger images
        const chunkSize = 8192;
        let binary = '';
        for (let i = 0; i < uint8Array.length; i += chunkSize) {
            const chunk = uint8Array.slice(i, i + chunkSize);
            binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary);
        
    } catch (error) {
        console.error('Error converting bytes to base64:', error);
        throw error;
    }
}

// Convert Uint8Array to base64
function uint8ArrayToBase64(uint8Array) {
    return bytesToBase64(Array.from(uint8Array));
}

// Check if string is valid base64
function isBase64String(str) {
    if (!str || typeof str !== 'string') return false;
    
    // Remove data URL prefix if present
    const base64Part = str.replace(/^data:image\/[a-z]+;base64,/, '');
    
    // Basic base64 pattern check
    const base64Pattern = /^[A-Za-z0-9+/]*={0,2}$/;
    
    // Check pattern and length (base64 length should be divisible by 4)
    return base64Pattern.test(base64Part) && base64Part.length % 4 === 0 && base64Part.length > 10;
}

// Helper function to detect image type and create proper data URL
function detectImageTypeAndCreateDataUrl(base64String, byteArray) {
    if (!base64String || !byteArray || byteArray.length < 8) {
        return `data:image/jpeg;base64,${base64String}`;
    }

    // Check file signatures (magic numbers)
    const firstBytes = byteArray.slice(0, 8);
    
    // PNG signature: 137 80 78 71 13 10 26 10
    if (firstBytes[0] === 137 && firstBytes[1] === 80 && firstBytes[2] === 78 && firstBytes[3] === 71) {
        return `data:image/png;base64,${base64String}`;
    }
    
    // JPEG signature: 255 216 255
    if (firstBytes[0] === 255 && firstBytes[1] === 216 && firstBytes[2] === 255) {
        return `data:image/jpeg;base64,${base64String}`;
    }
    
    // GIF signature: 71 73 70 (GIF)
    if (firstBytes[0] === 71 && firstBytes[1] === 73 && firstBytes[2] === 70) {
        return `data:image/gif;base64,${base64String}`;
    }
    
    // WebP signature: 82 73 70 70 ... 87 69 66 80
    if (firstBytes[0] === 82 && firstBytes[1] === 73 && firstBytes[2] === 70 && firstBytes[3] === 70) {
        return `data:image/webp;base64,${base64String}`;
    }

    // Default to JPEG
    return `data:image/jpeg;base64,${base64String}`;
}

// Helper function to convert hex string to byte array (for PostgreSQL bytea)
function hexStringToByteArray(hexString) {
    const result = [];
    for (let i = 0; i < hexString.length; i += 2) {
        result.push(parseInt(hexString.substr(i, 2), 16));
    }
    return result;
}

// Debug function to test image conversion
function debugImageConversion(imageData) {
    console.log('=== Image Debug Info ===');
    console.log('Data type:', typeof imageData);
    console.log('Data value:', imageData);
    
    if (Array.isArray(imageData)) {
        console.log('Array length:', imageData.length);
        console.log('First 10 bytes:', imageData.slice(0, 10));
        
        // Check if it looks like a valid image header
        if (imageData.length > 4) {
            const header = imageData.slice(0, 4);
            if (header[0] === 0xFF && header[1] === 0xD8) {
                console.log('Detected JPEG image');
            } else if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) {
                console.log('Detected PNG image');
            } else if (header[0] === 0x47 && header[1] === 0x49 && header[2] === 0x46) {
                console.log('Detected GIF image');
            } else {
                console.log('Unknown image format, header:', header);
            }
        }
    }
    console.log('======================');
}

function isValidImageUrl(url) {
    try {
        // Check for base64 images
        if (url.startsWith('data:image/')) {
            console.log('Base64 image detected');
            return true;
        }
        
        // Check for HTTP/HTTPS URLs
        if (url.startsWith('http://') || url.startsWith('https://')) {
            console.log('HTTP/HTTPS URL detected');
            // Additional validation for common image extensions
            if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i)) {
                return true;
            }
            // Allow URLs without extensions (might be from cloud storage with query params)
            return true;
        }
        
        // Check for relative paths with image extensions
        if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i)) {
            console.log('Local image file detected');
            return true;
        }
        
        // Check if it might be a Supabase storage URL or other cloud storage
        if (url.includes('supabase') || url.includes('storage') || url.includes('amazonaws') || url.includes('cloudinary')) {
            console.log('Cloud storage URL detected');
            return true;
        }
        
        console.log('URL format not recognized as valid image');
        return false;
        
    } catch (error) {
        console.error('Error validating image URL:', error);
        return false;
    }
}

// IMPROVED ERROR HANDLING FOR IMAGES
function handleImageError(imgElement, originalUrl) {
    console.error('Image failed to load:', originalUrl);
    
    // Replace with fallback icon
    const fallbackIcon = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="Image failed to load: ${originalUrl}"></i>`;
    imgElement.outerHTML = fallbackIcon;
}

// ADDITIONAL DEBUG FUNCTION - Call this to check your data
async function debugImageUrls() {
    console.log('=== DEBUG: Checking image URLs in database ===');
    
    try {
        const { data: products, error } = await supabaseClient
            .from('my_products')
            .select('id, name, image_url')
            .limit(5); // Check first 5 products
            
        if (error) {
            console.error('Error fetching products for debug:', error);
            return;
        }
        
        console.log('Sample products with image URLs:');
        products.forEach((product, index) => {
            console.log(`${index + 1}. Product: ${product.name}`);
            console.log(`   Image URL: "${product.image_url}"`);
            console.log(`   URL type: ${typeof product.image_url}`);
            console.log(`   URL length: ${product.image_url ? product.image_url.length : 0}`);
            console.log(`   Is valid: ${isValidImageUrl(product.image_url || '')}`);
            console.log('---');
        });
        
    } catch (error) {
        console.error('Debug error:', error);
    }
}

        // Convert coordinates to location string
        function getLocationString(latitude, longitude) {
            if (!latitude || !longitude) return 'Location not available';
            

            const lat = parseFloat(latitude).toFixed(4);
            const lng = parseFloat(longitude).toFixed(4);
            return `${lat}, ${lng}`;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Search functionality
        function setupPriceSearch() {
            const searchInput = document.querySelector('.search-input');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('.price-table tbody tr');
                
                rows.forEach(row => {
                    const productName = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
                    const category = row.querySelector('.category-badge')?.textContent.toLowerCase() || '';
                    const storeName = row.querySelector('.store-name')?.textContent.toLowerCase() || '';
                    const storeLocation = row.querySelector('.store-location')?.textContent.toLowerCase() || '';
                    
                    if (productName.includes(searchTerm) || 
                        category.includes(searchTerm) || 
                        storeName.includes(searchTerm) ||
                        storeLocation.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Function to change page
        function changePage(direction) {
            const totalPages = Math.ceil(totalPriceRecords / recordsPerPage);
            
            if (direction === 1 && currentPage < totalPages) {
                currentPage++;
                loadPriceMonitoringData();
            } else if (direction === -1 && currentPage > 1) {
                currentPage--;
                loadPriceMonitoringData();
            }
        }

        // Function to show all price monitoring modal
        async function showAllPriceMonitoringModal() {
            const modal = new bootstrap.Modal(document.getElementById('allPriceMonitoringModal'));
            modal.show();
            
            // Fetch all products for the modal
            try {
                const { data: allProducts, error } = await supabaseClient
                    .from('my_products')
                    .select(`
                        id,
                        name,
                        price,
                        category,
                        description,
                        discount,
                        image_url,
                        user_id,
                        users!my_products_user_id_fkey (
                            id,
                            municipality,
                            store-owner!store-owner_user_id_fkey (
                                store_name
                            )
                        )
                    `);
                
                if (error) {
                    console.error('Error fetching all products:', error);
                    updateAllPriceMonitoringTable([]);
                } else {
                    updateAllPriceMonitoringTable(allProducts || []);
                }
            } catch (error) {
                console.error('Error in showAllPriceMonitoringModal:', error);
                updateAllPriceMonitoringTable([]);
            }
        }

        // Function to update the all price monitoring modal table
        function updateAllPriceMonitoringTable(priceData) {
            const tableBody = document.getElementById('allPriceMonitoringTableBody');
            const countElement = document.getElementById('allPriceMonitoringCount');
            
            if (!tableBody) {
                console.error('‚ùå All price monitoring table body not found');
                return;
            }

            if (!priceData || priceData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center text-muted p-4">
                            <i class="fas fa-box-open me-2"></i>
                            No price monitoring records found
                        </td>
                    </tr>
                `;
                if (countElement) countElement.textContent = '0 products found';
                return;
            }

            // Generate all table rows
            tableBody.innerHTML = priceData.map((product, index) => {
                const user = product.users;
                const storeOwner = user?.['store-owner']?.[0];
                const storeName = storeOwner?.store_name || 'Unknown Store';
                const municipality = user?.municipality || 'Unknown';
                const price = parseFloat(product.price) || 0;
                
                return `
                    <tr>
                        <td>
                            <div class="product-name">${escapeHtml(product.name || 'N/A')}</div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">${escapeHtml(product.category || 'General')}</span>
                        </td>
                        <td>
                            <span class="fw-bold">‚Ç±${price.toFixed(2)}</span>
                        </td>
                        <td>
                            <span class="store-name">${escapeHtml(storeName)}</span>
                        </td>
                        <td>
                            <span class="store-location">${escapeHtml(municipality)}</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update count
            if (countElement) {
                countElement.textContent = `${priceData.length} product${priceData.length !== 1 ? 's' : ''} found`;
            }

            // Add search functionality
            const searchInput = document.getElementById('priceMonitoringSearchInput');
            if (searchInput) {
                searchInput.oninput = function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredData = priceData.filter(product => {
                        const user = product.users;
                        const storeOwner = user?.['store-owner']?.[0];
                        const storeName = storeOwner?.store_name || '';
                        const municipality = user?.municipality || '';
                        
                        return (product.name || '').toLowerCase().includes(searchTerm) ||
                               (product.category || '').toLowerCase().includes(searchTerm) ||
                               storeName.toLowerCase().includes(searchTerm) ||
                               municipality.toLowerCase().includes(searchTerm);
                    });
                    
                    if (filteredData.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="5" class="text-center text-muted p-4">
                                    <i class="fas fa-search me-2"></i>
                                    No products found matching "${searchTerm}"
                                </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = filteredData.map((product, index) => {
                            const user = product.users;
                            const storeOwner = user?.['store-owner']?.[0];
                            const storeName = storeOwner?.store_name || 'Unknown Store';
                            const municipality = user?.municipality || 'Unknown';
                            const price = parseFloat(product.price) || 0;
                            
                            return `
                                <tr>
                                    <td>
                                        <div class="product-name">${escapeHtml(product.name || 'N/A')}</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">${escapeHtml(product.category || 'General')}</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold">‚Ç±${price.toFixed(2)}</span>
                                    </td>
                                    <td>
                                        <span class="store-name">${escapeHtml(storeName)}</span>
                                    </td>
                                    <td>
                                        <span class="store-location">${escapeHtml(municipality)}</span>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                    if (countElement) {
                        countElement.textContent = `${filteredData.length} product${filteredData.length !== 1 ? 's' : ''} found`;
                    }
                };
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Price monitoring page loaded');
            
            // Wait for shared profile system to initialize
            const checkSharedProfile = () => {
                if (typeof supabaseClient !== 'undefined') {
                    console.log('Supabase client available, loading price data...');
                    loadPriceMonitoringData();
                    setupPriceSearch();
                } else {
                    // Wait a bit more for shared-profile.js to load
                    setTimeout(checkSharedProfile, 100);
                }
            };
            
            checkSharedProfile();
        });
        
        /*
        =================================================================
        IMPORTANT NOTE ABOUT IMAGE DISPLAY ISSUE:
        =================================================================
        
        The images in your database are stored as mobile app file URIs like:
        "file:///data/user/0/host.exp.exponent/cache/ExperienceData/..."
        
        These are local file paths from a mobile device/app and cannot be 
        displayed in a web browser. To fix this permanently, you need to:
        
        1. OPTION 1 - Upload images to a web server:
           - Modify your mobile app to upload images to a web server
           - Store the web URL (like "https://yoursite.com/images/photo.jpg") 
             in the database instead of the local file path
        
        2. OPTION 2 - Use a cloud storage service:
           - Upload images to services like Supabase Storage, Firebase Storage,
             AWS S3, or Cloudinary
           - Store the public URL in the database
        
        3. OPTION 3 - Store as base64:
           - Convert images to base64 in your mobile app
           - Store the base64 data URL in the database
           - This will increase database size but work immediately
        
        Current behavior: Mobile file URIs show a mobile icon placeholder
        =================================================================
        */

        // Mobile sidebar functions - CSS only, no duplicate positioning
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                // Add navigation content when opening
                if (!sidebar.classList.contains('mobile-open')) {
                    const mobileMenuContent = `
                        <div class="nav flex-column nav-pills">
                            <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                                <i class="fas fa-tachometer-alt me-2"></i>
                                Dashboard
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                                <i class="fas fa-user-shield me-2"></i>
                                Admin Accounts
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="for_approval.html">
                                <i class="fas fa-user-clock me-2"></i>
                                For Approval
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="approved_application.html">
                                <i class="fas fa-user-check me-2"></i>
                                Approved Applications
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                                <i class="fas fa-clipboard-list me-2"></i>
                                Inventory Records
                            </a>
                            <a class="nav-link active d-flex align-items-center text-start" href="price_monitoring.html">
                                <i class="fas fa-dollar-sign me-2"></i>
                                Price Monitoring
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                                <i class="fas fa-chart-bar me-2"></i>
                                In Demand Products
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Sales Per Location
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="add_voucher.html">
                                <i class="fas fa-plus me-2"></i>
                                Add Voucher
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="voucher_records.html">
                                <i class="fas fa-list me-2"></i>
                                Voucher Records
                            </a>
                            <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Violation
                            </a>
                        </div>
                    `;
                    sidebar.innerHTML = mobileMenuContent;
                }
                
                // Just toggle the CSS class - let CSS handle all positioning
                sidebar.classList.toggle('mobile-open');
            }
            
            if (overlay) {
                overlay.classList.toggle('active');
            }
            
            document.body.style.overflow = sidebar && sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                sidebar.classList.remove('mobile-open');
                // Restore original content
                if (sidebar.dataset.originalContent) {
                    sidebar.innerHTML = sidebar.dataset.originalContent;
                }
            }
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>

    <!-- All Price Monitoring Modal -->
    <div class="modal fade" id="allPriceMonitoringModal" tabindex="-1" aria-labelledby="allPriceMonitoringModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allPriceMonitoringModalLabel">All Price Monitoring Records</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="priceMonitoringSearchInput" placeholder="Search by product name, store name, category...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Store Name</th>
                                    <th>Store Location</th>
                                </tr>
                            </thead>
                            <tbody id="allPriceMonitoringTableBody">
                                <tr>
                                    <td colspan="5" class="text-center">Loading price monitoring records...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allPriceMonitoringCount">0 products found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
