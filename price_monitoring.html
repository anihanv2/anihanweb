<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Price Monitoring - Anihan</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link href="price_monitoring.css" rel="stylesheet">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="navbar-nav">
                <div class="nav-item">
                    <div class="user-avatar" onclick="toggleProfileDropdown()">
                        <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                        <i id="userAvatarIcon" class="fas fa-user"></i>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="profileUserTitle">System Administrator</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link active d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="price-card shadow-sm mt-4">
                    <div class="price-card-header d-flex justify-content-between align-items-center">
                        <span>Price Monitoring Records</span>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="price-table">
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Price</th>
                                    <th>Store name</th>
                                    <th>Store location</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Data will be loaded dynamically from database -->
                            </tbody>
                        </table>
                    </div>
                    <div class="price-card-footer">
                        <a href="#" style="color:#2563eb;font-size:0.95rem;">View all &gt;</a>
                        <div class="price-pagination">
                            <button class="btn">&lt;</button>
                            <button class="btn active">1</button>
                            <button class="btn">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script>
        // Note: Supabase configuration is loaded from shared-profile.js
        
        // Load price monitoring data from database
        async function loadPriceMonitoringData() {
            console.log('Loading price monitoring data...');
            try {
                // Add loading state
                const tbody = document.querySelector('.price-table tbody');
                if (!tbody) {
                    console.error('Table body not found!');
                    return;
                }
                
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin mb-2"></i><br>
                            Loading price data...
                        </td>
                    </tr>
                `;

                console.log('Fetching products and store data...');
                
                // Fetch products with their associated store information
                // Join my_products with store-owner and users tables
                const { data: priceData, error } = await supabaseClient
                    .from('my_products')
                    .select(`
                        id,
                        name,
                        price,
                        category,
                        description,
                        discount,
                        image_url,
                        user_id,
                        users!my_products_user_id_fkey (
                            id,
                            municipality,
                            store-owner!store-owner_user_id_fkey (
                                store_name
                            )
                        )
                    `);

                console.log('Price data query result:', { priceData, error });

                if (error) {
                    console.error('Error loading price data:', error);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-danger py-4">
                                <i class="fas fa-exclamation-triangle mb-2"></i><br>
                                <strong>Database Error:</strong><br>
                                ${error.message}
                            </td>
                        </tr>
                    `;
                    return;
                }

                if (!priceData || priceData.length === 0) {
                    console.log('No price data found');
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <i class="fas fa-box-open mb-2"></i><br>
                                No price monitoring data found
                            </td>
                        </tr>
                    `;
                    return;
                }

                console.log('Successfully loaded price data:', priceData.length);
                populatePriceTable(priceData);
                
            } catch (error) {
                console.error('Price monitoring error:', error);
                const tbody = document.querySelector('.price-table tbody');
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-danger py-4">
                            <i class="fas fa-exclamation-triangle mb-2"></i><br>
                            <strong>Connection Error:</strong><br>
                            ${error.message}
                        </td>
                    </tr>
                `;
            }
        }

function populatePriceTable(priceData) {
    console.log('Populating price table with data:', priceData);
    const tbody = document.querySelector('.price-table tbody');
    tbody.innerHTML = '';

    priceData.forEach((product, index) => {
        console.log(`Creating row ${index + 1} for product:`, product);
        console.log('Image URL from database:', product.image_url); // Debug log


    // Extract user and store information
    const user = product.users;
    const storeOwner = user?.['store-owner']?.[0];
    const storeName = storeOwner?.store_name || 'Unknown Store';
    const municipality = user?.municipality || 'Unknown';
    const category = product.category || 'General';

        const row = document.createElement('tr');

        // Image cell
        const imageTd = document.createElement('td');
        createImageCellDOM(product.image_url, product.name, imageTd);
        row.appendChild(imageTd);

        // Product name cell
        const nameTd = document.createElement('td');
        nameTd.innerHTML = `
            <div class="product-info">
                <div class="product-name">${escapeHtml(product.name || 'N/A')}</div>
            </div>
        `;
        row.appendChild(nameTd);

        // Category cell
        const categoryTd = document.createElement('td');
        categoryTd.innerHTML = `<span class="category-badge">${escapeHtml(category)}</span>`;
        row.appendChild(categoryTd);

    // Price cell
    const priceTd = document.createElement('td');
    priceTd.innerHTML = `<span class="price">â‚±${escapeHtml(product.price || '0')}</span>`;
    row.appendChild(priceTd);

        // Store name cell
        const storeNameTd = document.createElement('td');
        storeNameTd.innerHTML = `<span class="store-name">${escapeHtml(storeName)}</span>`;
        row.appendChild(storeNameTd);


    // Municipality cell
    const municipalityTd = document.createElement('td');
    municipalityTd.innerHTML = `<span class="store-location">${escapeHtml(municipality)}</span>`;
    row.appendChild(municipalityTd);

        tbody.appendChild(row);
    });
    console.log('Price table populated successfully');
}


// Create image cell as a DOM element for robust error handling

// Updated createImageCellDOM function with proper byte array handling
function createImageCellDOM(imageData, productName, tdElement) {
    tdElement.innerHTML = '';
    console.log('Processing image data:', imageData);
    
    if (!imageData) {
        tdElement.innerHTML = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="No image available"></i>`;
        return;
    }

    try {
        // Case 1: If imageData is already a valid data URL
        if (typeof imageData === 'string' && imageData.startsWith('data:image/')) {
            createImageElement(imageData, productName, tdElement);
            return;
        }

        // Case 2: If imageData is a regular URL (http/https)
        if (typeof imageData === 'string' && (imageData.startsWith('http://') || imageData.startsWith('https://'))) {
            createImageElement(imageData, productName, tdElement);
            return;
        }

        // Case 3: If imageData is a stringified byte array: "[137,80,78,...]"
        if (typeof imageData === 'string' && imageData.trim().startsWith('[') && imageData.trim().endsWith(']')) {
            try {
                const byteArray = JSON.parse(imageData.trim());
                if (Array.isArray(byteArray)) {
                    const base64String = bytesToBase64(byteArray);
                    const dataUrl = `data:image/jpeg;base64,${base64String}`; // Default to JPEG
                    createImageElement(dataUrl, productName, tdElement);
                    return;
                }
            } catch (parseError) {
                console.error('Error parsing stringified byte array:', parseError);
            }
        }

        // Case 4: If imageData is a direct byte array (Array or Uint8Array)
        if (Array.isArray(imageData)) {
            const base64String = bytesToBase64(imageData);
            const dataUrl = `data:image/jpeg;base64,${base64String}`;
            createImageElement(dataUrl, productName, tdElement);
            return;
        }

        if (imageData instanceof Uint8Array) {
            const base64String = uint8ArrayToBase64(imageData);
            const dataUrl = `data:image/jpeg;base64,${base64String}`;
            createImageElement(dataUrl, productName, tdElement);
            return;
        }

        // Case 5: If imageData is a Buffer-like object with data property
        if (typeof imageData === 'object' && imageData.data && Array.isArray(imageData.data)) {
            const base64String = bytesToBase64(imageData.data);
            const dataUrl = `data:image/jpeg;base64,${base64String}`;
            createImageElement(dataUrl, productName, tdElement);
            return;
        }

        // Case 6: Try to handle as base64 string without data URL prefix
        if (typeof imageData === 'string' && isBase64String(imageData)) {
            const dataUrl = `data:image/jpeg;base64,${imageData}`;
            createImageElement(dataUrl, productName, tdElement);
            return;
        }

        // Fallback: Unknown format
        console.warn('Unknown image data format:', typeof imageData, imageData);
        tdElement.innerHTML = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="Unsupported image format"></i>`;

    } catch (error) {
        console.error('Error processing image data:', error);
        tdElement.innerHTML = `<i class="fas fa-exclamation-triangle" style="font-size: 24px; color: #dc3545;" title="Image processing error"></i>`;
    }
}

// Helper function to create image element with error handling
function createImageElement(src, alt, tdElement) {
    const img = document.createElement('img');
    img.src = src;
    img.alt = alt || 'Product';
    img.style.width = '40px';
    img.style.height = '40px';
    img.style.objectFit = 'cover';
    img.style.borderRadius = '4px';
    img.style.background = '#f8f9fa';
    img.style.border = '1px solid #dee2e6';
    
    img.onerror = function() {
        console.error('Failed to load image:', src);
        this.outerHTML = `<i class="fas fa-image" style="font-size: 24px; color: #dc3545;" title="Failed to load image"></i>`;
    };
    
    img.onload = function() {
        console.log('Image loaded successfully');
    };
    
    tdElement.appendChild(img);
}

// Improved byte array to base64 conversion
function bytesToBase64(byteArray) {
    try {
        // Convert array to Uint8Array if it isn't already
        const uint8Array = new Uint8Array(byteArray);
        
        // Method 1: Using btoa with binary string (works for smaller images)
        if (uint8Array.length < 100000) { // Less than ~100KB
            let binary = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binary += String.fromCharCode(uint8Array[i]);
            }
            return btoa(binary);
        }
        
        // Method 2: Chunked processing for larger images
        const chunkSize = 8192;
        let binary = '';
        for (let i = 0; i < uint8Array.length; i += chunkSize) {
            const chunk = uint8Array.slice(i, i + chunkSize);
            binary += String.fromCharCode.apply(null, chunk);
        }
        return btoa(binary);
        
    } catch (error) {
        console.error('Error converting bytes to base64:', error);
        throw error;
    }
}

// Convert Uint8Array to base64
function uint8ArrayToBase64(uint8Array) {
    return bytesToBase64(Array.from(uint8Array));
}

// Check if string is valid base64
function isBase64String(str) {
    if (!str || typeof str !== 'string') return false;
    
    // Remove data URL prefix if present
    const base64Part = str.replace(/^data:image\/[a-z]+;base64,/, '');
    
    // Basic base64 pattern check
    const base64Pattern = /^[A-Za-z0-9+/]*={0,2}$/;
    
    // Check pattern and length (base64 length should be divisible by 4)
    return base64Pattern.test(base64Part) && base64Part.length % 4 === 0 && base64Part.length > 10;
}

// Debug function to test image conversion
function debugImageConversion(imageData) {
    console.log('=== Image Debug Info ===');
    console.log('Data type:', typeof imageData);
    console.log('Data value:', imageData);
    
    if (Array.isArray(imageData)) {
        console.log('Array length:', imageData.length);
        console.log('First 10 bytes:', imageData.slice(0, 10));
        
        // Check if it looks like a valid image header
        if (imageData.length > 4) {
            const header = imageData.slice(0, 4);
            if (header[0] === 0xFF && header[1] === 0xD8) {
                console.log('Detected JPEG image');
            } else if (header[0] === 0x89 && header[1] === 0x50 && header[2] === 0x4E && header[3] === 0x47) {
                console.log('Detected PNG image');
            } else if (header[0] === 0x47 && header[1] === 0x49 && header[2] === 0x46) {
                console.log('Detected GIF image');
            } else {
                console.log('Unknown image format, header:', header);
            }
        }
    }
    console.log('======================');
}

function isValidImageUrl(url) {
    try {
        // Check for base64 images
        if (url.startsWith('data:image/')) {
            console.log('Base64 image detected');
            return true;
        }
        
        // Check for HTTP/HTTPS URLs
        if (url.startsWith('http://') || url.startsWith('https://')) {
            console.log('HTTP/HTTPS URL detected');
            // Additional validation for common image extensions
            if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)(\?.*)?$/i)) {
                return true;
            }
            // Allow URLs without extensions (might be from cloud storage with query params)
            return true;
        }
        
        // Check for relative paths with image extensions
        if (url.match(/\.(jpg|jpeg|png|gif|webp|svg|bmp|ico)$/i)) {
            console.log('Local image file detected');
            return true;
        }
        
        // Check if it might be a Supabase storage URL or other cloud storage
        if (url.includes('supabase') || url.includes('storage') || url.includes('amazonaws') || url.includes('cloudinary')) {
            console.log('Cloud storage URL detected');
            return true;
        }
        
        console.log('URL format not recognized as valid image');
        return false;
        
    } catch (error) {
        console.error('Error validating image URL:', error);
        return false;
    }
}

// IMPROVED ERROR HANDLING FOR IMAGES
function handleImageError(imgElement, originalUrl) {
    console.error('Image failed to load:', originalUrl);
    
    // Replace with fallback icon
    const fallbackIcon = `<i class="fas fa-image" style="font-size: 24px; color: #ccc;" title="Image failed to load: ${originalUrl}"></i>`;
    imgElement.outerHTML = fallbackIcon;
}

// ADDITIONAL DEBUG FUNCTION - Call this to check your data
async function debugImageUrls() {
    console.log('=== DEBUG: Checking image URLs in database ===');
    
    try {
        const { data: products, error } = await supabaseClient
            .from('my_products')
            .select('id, name, image_url')
            .limit(5); // Check first 5 products
            
        if (error) {
            console.error('Error fetching products for debug:', error);
            return;
        }
        
        console.log('Sample products with image URLs:');
        products.forEach((product, index) => {
            console.log(`${index + 1}. Product: ${product.name}`);
            console.log(`   Image URL: "${product.image_url}"`);
            console.log(`   URL type: ${typeof product.image_url}`);
            console.log(`   URL length: ${product.image_url ? product.image_url.length : 0}`);
            console.log(`   Is valid: ${isValidImageUrl(product.image_url || '')}`);
            console.log('---');
        });
        
    } catch (error) {
        console.error('Debug error:', error);
    }
}

        // Convert coordinates to location string
        function getLocationString(latitude, longitude) {
            if (!latitude || !longitude) return 'Location not available';
            

            const lat = parseFloat(latitude).toFixed(4);
            const lng = parseFloat(longitude).toFixed(4);
            return `${lat}, ${lng}`;
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Search functionality
        function setupPriceSearch() {
            const searchInput = document.querySelector('.search-input');
            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('.price-table tbody tr');
                
                rows.forEach(row => {
                    const productName = row.querySelector('.product-name')?.textContent.toLowerCase() || '';
                    const category = row.querySelector('.category-badge')?.textContent.toLowerCase() || '';
                    const storeName = row.querySelector('.store-name')?.textContent.toLowerCase() || '';
                    const storeLocation = row.querySelector('.store-location')?.textContent.toLowerCase() || '';
                    
                    if (productName.includes(searchTerm) || 
                        category.includes(searchTerm) || 
                        storeName.includes(searchTerm) ||
                        storeLocation.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Price monitoring page loaded');
            
            // Wait for shared profile system to initialize
            const checkSharedProfile = () => {
                if (typeof supabaseClient !== 'undefined') {
                    console.log('Supabase client available, loading price data...');
                    loadPriceMonitoringData();
                    setupPriceSearch();
                } else {
                    // Wait a bit more for shared-profile.js to load
                    setTimeout(checkSharedProfile, 100);
                }
            };
            
            checkSharedProfile();
        });
    </script>
</body>
</html>