<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In - Anihan</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=5.0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.0">
    <link rel="stylesheet" href="sign_in_form.css?v=5.0">
</head>
<body>
    <div class="container-fluid vh-100 d-flex align-items-center justify-content-center">
        <div class="login-card">
            <!-- Logo Section -->
            <div class="logo-section">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image">
                <h2 class="brand-title">ANIHAN</h2>
                <p class="brand-subtitle">SINCE 2024</p>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="login-form">
                <div class="mb-3">
                    <label for="username" class="form-label">NAME</label>
                    <div class="input-container">
                        <i class="fas fa-user input-icon"></i>
                        <input type="text" class="form-control" id="username" name="username" placeholder="Enter your name" required>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="password" class="form-label">PASSWORD</label>
                    <div class="input-container">
                        <i class="fas fa-lock input-icon"></i>
                        <div class="input-group">
                            <input type="password" class="form-control" id="password" name="password" placeholder="•••••" required>
                            <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-signin w-100">Sign In</button>
            </form>

            <!-- Error Message -->
            <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;">
                Invalid name or password. Please try again.
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add CryptoJS for MD5 hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Add Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ontuivohwjfkxjwrjnot.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9udHVpdm9od2pma3hqd3Jqbm90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2Njg3MTAsImV4cCI6MjA3MDI0NDcxMH0.jGQhshEtfnABK8xNF98WxB10c66vIkTzAoLrhxbeQwE'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Password hashing function 
        function hashPassword(password) {
            // Try to use CryptoJS MD5 if available
            if (typeof CryptoJS !== 'undefined' && CryptoJS.MD5) {
                return CryptoJS.MD5(password).toString();
            }
            
            // Fallback to simple hash
            console.warn('CryptoJS not available, using fallback hash');
            return simpleHash(password);
        }
        
        // Fallback hash function if CryptoJS is not available
        function simpleHash(password) {
            let hash = 0;
            for (let i = 0; i < password.length; i++) {
                const char = password.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // Convert to 32bit integer
            }
            return Math.abs(hash).toString(16);
        }

        // Test function to check password hashing - call this in browser console
        window.testPasswordHash = function(password) {
            const hash = hashPassword(password);
            console.log('Password:', password);
            console.log('Hash:', hash);
            console.log('Method:', typeof CryptoJS !== 'undefined' && CryptoJS.MD5 ? 'MD5' : 'Simple Hash');
            return hash;
        };

        // Function to authenticate user against database
        async function authenticateUser(name, password) {
            try {
                console.log('=== LOGIN ATTEMPT ===');
                console.log('Input name:', name);
                console.log('Input password length:', password.length);
                
                const hashedPassword = hashPassword(password);
                console.log('Hashed password:', hashedPassword);
                console.log('Hash method used:', typeof CryptoJS !== 'undefined' && CryptoJS.MD5 ? 'MD5' : 'Simple Hash');
                
                console.log('Querying database for user...');
                const { data: admin, error } = await supabaseClient
                    .from('admin_accounts')
                    .select('*')
                    .eq('name', name)
                    .eq('password', hashedPassword)
                    .single();
                
                console.log('Database response:', { admin, error });
                
                if (error || !admin) {
                    console.log('Authentication failed - trying alternative queries...');
                    
                    // Try to find user by name only to see if user exists
                    const { data: userCheck, error: userError } = await supabaseClient
                        .from('admin_accounts')
                        .select('name, password')
                        .eq('name', name);
                    
                    console.log('User check by name:', { userCheck, userError });
                    
                    if (userCheck && userCheck.length > 0) {
                        console.log('User exists but password doesn\'t match');
                        console.log('Stored password hash:', userCheck[0].password);
                        console.log('Generated password hash:', hashedPassword);
                    } else {
                        console.log('User not found in database');
                    }
                    
                    return null;
                }
                
                console.log('Authentication successful!');
                return admin;
            } catch (error) {
                console.error('Authentication error:', error);
                return null;
            }
        }

        // Show loading state
        function showLoading(show) {
            const submitBtn = document.querySelector('.btn-signin');
            const errorMessage = document.getElementById('errorMessage');
            
            if (show) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Signing in...';
                errorMessage.style.display = 'none';
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Sign In';
            }
        }

        // Show/Hide Password Toggle
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordField = document.getElementById('password');
            const toggleIcon = this.querySelector('i');
            
            if (passwordField.type === 'password') {
                passwordField.type = 'text';
                toggleIcon.classList.remove('fa-eye');
                toggleIcon.classList.add('fa-eye-slash');
            } else {
                passwordField.type = 'password';
                toggleIcon.classList.remove('fa-eye-slash');
                toggleIcon.classList.add('fa-eye');
            }
        });

        // Form Submission Handler
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            const errorMessage = document.getElementById('errorMessage');
            
            // Show loading state
            showLoading(true);
            
            // Hide previous error message
            errorMessage.style.display = 'none';
            
            try {
                // Authenticate user against database
                const authenticatedUser = await authenticateUser(username, password);
                
                if (authenticatedUser) {
                    // Store user session data
                    sessionStorage.setItem('currentUser', JSON.stringify({
                        id: authenticatedUser.id,
                        name: authenticatedUser.name,
                        email: authenticatedUser.email,
                        userType: authenticatedUser.user_type
                    }));
                    
                    // Redirect based on user role
                    if (authenticatedUser.user_type === 'SUPER ADMIN') {
                        window.location.href = 'dashboard_super_admin.html';
                    } else if (authenticatedUser.user_type === 'SUB ADMIN') {
                        window.location.href = 'municipality_dashboard.html';
                    } else {
                        // Default fallback
                        window.location.href = 'dashboard_super_admin.html';
                    }
                } else {
                    // Authentication failed
                    showLoading(false);
                    errorMessage.textContent = 'Invalid username or password. Please try again.';
                    errorMessage.style.display = 'block';
                    
                    // Clear form fields
                    document.getElementById('username').value = '';
                    document.getElementById('password').value = '';
                    
                    // Reset password field to hidden
                    const passwordField = document.getElementById('password');
                    const eyeIcon = document.getElementById('eyeIcon');
                    if (passwordField.type === 'text') {
                        passwordField.type = 'password';
                        eyeIcon.classList.remove('fa-eye');
                        eyeIcon.classList.add('fa-eye-slash');
                    }
                }
            } catch (error) {
                showLoading(false);
                console.error('Login error:', error);
                errorMessage.textContent = 'Login failed. Please check your connection and try again.';
                errorMessage.style.display = 'block';
            }
        });

        // Hide/show icons when focusing/blurring input fields
        const usernameInput = document.getElementById('username');
        const usernameIcon = usernameInput.parentElement.querySelector('.input-icon');
        
        // Hide icon when clicking/focusing on username input
        usernameInput.addEventListener('focus', function() {
            usernameIcon.style.opacity = '0';
            usernameIcon.style.visibility = 'hidden';
        });
        
        // Show icon when blurring username input (if empty)
        usernameInput.addEventListener('blur', function() {
            if (this.value === '') {
                usernameIcon.style.opacity = '1';
                usernameIcon.style.visibility = 'visible';
            }
        });
        
        // Hide icon when typing in username input
        usernameInput.addEventListener('input', function() {
            if (this.value.length > 0) {
                usernameIcon.style.opacity = '0';
                usernameIcon.style.visibility = 'hidden';
            } else {
                usernameIcon.style.opacity = '1';
                usernameIcon.style.visibility = 'visible';
            }
        });

        // Hide error message when user starts typing
        document.getElementById('username').addEventListener('input', function() {
            document.getElementById('errorMessage').style.display = 'none';
        });

        document.getElementById('password').addEventListener('input', function() {
            document.getElementById('errorMessage').style.display = 'none';
        });
    </script>
</body>
</html>
