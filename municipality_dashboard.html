<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipality Dashboard - Anihan</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=5.4" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.4">
    <link rel="stylesheet" href="fixed-layout.css?v=5.4">
    <link href="profile-dropdown.css?v=5.4" rel="stylesheet">
    <link rel="stylesheet" href="municipality_dashboard.css?v=5.4">
    <style>
        .status-filters {
            transition: all 0.3s ease;
        }
        
        .status-filter-btn {
            transition: all 0.2s ease;
            border-width: 1px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-filter-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Municipality Chart Styles */
        .municipality-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .municipality-item:hover {
            border-color: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Chart Container Stability Styles */
        .chart-container-stable {
            overflow: hidden;
            position: relative;
        }

        .chart-container-stable canvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #salesChart {
            transition: none;
            animation: none;
        }

        /* Chart Container Responsive Design */
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            height: 350px;
            overflow: hidden;
        }

        .chart-container canvas {
            width: 100%;
            max-width: 100%;
            height: 100%;
            min-height: 300px;
        }

        /* Analytics Card Styling */
        .analytics-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 24px;
            min-height: 450px;
        }

        .analytics-card .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 20px;
        }

        .analytics-card .card-body {
            padding: 20px;
        }

        .municipality-item.top-municipality {
            background: #ffffff;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .municipality-item.top-municipality::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #f39c12;
        }

        .municipality-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .municipality-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .municipality-sales {
            font-weight: 700;
            color: #27ae60;
            font-size: 16px;
        }

        .municipality-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .municipality-progress {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 6px;
            transition: width 0.8s ease-in-out;
            position: relative;
        }

        .municipality-progress.top-performer {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .municipality-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .municipality-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 15px;
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }

        /* Users Table Styles */
        .users-table-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-table-header {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .users-table-header h5 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .users-table-body {
            padding: 0;
        }

        .users-table-body .table {
            margin: 0;
        }

        .users-table-body .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody td {
            padding: 12px 20px;
            border: none;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody tr {
            border-bottom: 1px solid #f1f3f4;
        }

        .users-table-body .table tbody tr:last-child {
            border-bottom: none;
        }

        .users-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .table-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .table-info {
            color: #6c757d;
            font-size: 14px;
        }

        .view-all-link {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .view-all-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-controls .btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid #28a745;
            color: #28a745;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }

        .pagination-controls .btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .pagination-controls .active-page {
            background: #28a745;
            border-color: #28a745;
            color: white;
        }

        .pagination-controls .btn-outline-secondary {
            border-color: #28a745;
            color: #28a745;
        }

        .pagination-controls .btn-outline-secondary:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* All Users Modal Styles */
        #allUsersModal .modal-dialog {
            max-width: 95%;
        }
        
        #allUsersModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allUsersModal .table td {
            vertical-align: middle;
        }
        
        #userSearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #userSearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .badge {
            font-size: 0.875rem;
        }
        
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="mobile-menu-toggle me-3 d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                    <span class="brand-text">Anihan</span>
                </a>
            </div>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" class="avatar-img" style="display: none;" alt="Profile">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" class="profile-avatar-img" style="display: none;" alt="Profile">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 id="profileUserName" class="profile-dropdown-name">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="profileUserAccess">Loading...</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link active d-flex align-items-center text-start" href="municipality_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_inventory.html">
                        <i class="fas fa-boxes me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_in_demand_products.html">
                        <i class="fas fa-chart-line me-2"></i>
                        In Demand Products
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="sub_admin_for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="sub_admin_approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card stats-users">
                                <div class="stats-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeUsersCount">Loading...</div>
                                    <div class="stats-label">Active Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-products">
                                <div class="stats-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="productsCount">Loading...</div>
                                    <div class="stats-label">Available Products</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-farmers">
                                <div class="stats-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                    <div class="stats-label">Active Farmers</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Sales Analytics (Seller Sales by Municipality)</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="salesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Stocks Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 120px;">
                                            <option value="category">Product Name</option>
                                            <option value="status">Status</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <!-- Product Name Chart -->
                                        <canvas id="stocksChart"></canvas>
                                        
                                        <!-- Status Chart (initially hidden) -->
                                        <canvas id="statusChart" style="display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Soil Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                            <option value="type">Soil Type</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="soilChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Land Area Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 100px;">
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="hectareChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Crop Insight Analytics -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Crop Insight - Harvest vs Overproduction</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="cropInsightFilter" style="width: 150px;" onchange="updateCropInsightChart(this.value)">
                                            <option value="all">All Crops</option>
                                            <option value="overproduced">Overproduced Only</option>
                                            <option value="top10">Top 10 Crops</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="exportChart('cropInsight', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="exportChart('cropInsight', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="exportChart('cropInsight', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="javascript:void(0);" onclick="exportChart('cropInsight', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="cropInsightChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="users-table-card mt-4">
                        <div class="users-table-header">
                            <h5>User Management</h5>
                        </div>
                        <div class="users-table-body">
                            <div class="table-responsive">
                                <table class="table users-table">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Contact Number</th>
                                        </tr>
                                    </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="users-table-footer">
                            <div class="table-info-section">
                                <span class="table-info" id="usersTableInfo">1 to 4 items of 0</span>
                                <a href="#" class="view-all-link" onclick="showAllUsersModal()">View all ></a>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-outline-secondary" onclick="changePage(-1)">&lt;</button>
                                <button class="btn btn-success active-page" id="currentPageBtn">1</button>
                                <button class="btn btn-outline-secondary" onclick="changePage(1)">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>



    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add Supabase Client (required by shared-profile.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script>
        // Chart variables
        let salesChart, stocksChart, soilChart, hectareChart, statusChart, cropInsightChart;

        // Store crop insight data globally for export
        let currentCropInsightData = null;

        // Use the Supabase client from shared-profile.js
        console.log('Municipality dashboard using shared Supabase client');

        // Chart Data for Municipality Dashboard - Initialize with default structure
        let analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: new Array(12).fill(0)
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: new Array(4).fill(0)
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: new Array(4).fill(0)
                }
            },
            stocks: {
                category: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d'],
                    products: {
                        'Loading...': [{ name: 'Loading...', quantity: 0, status: 'Loading...' }]
                    }
                },
                status: {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: [0, 0, 0],
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: {
                        'Available': [],
                        'To be Out of Stock': [],
                        'Out of Stock': []
                    }
                },
                supplier: {
                    labels: ['Local Farmers', 'Cooperatives', 'Direct Import', 'Distributors'],
                    data: [40, 30, 20, 10],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                }
            },
            soil: {
                type: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d']
                },
                region: {
                    labels: ['North District', 'South District', 'East District', 'West District'],
                    data: [30, 25, 25, 20],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                },
                season: {
                    labels: ['Dry Season', 'Wet Season', 'Transition'],
                    data: [45, 35, 20],
                    colors: ['#ff6b35', '#4ecdc4', '#45b7d1']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [180, 185, 190, 195]
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: [5500, 6200, 6800, 7500]
                }
            }
        };

        // Initialize Charts
        function initializeCharts() {
            // Destroy existing charts if they exist to prevent canvas reuse errors
            if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                window.salesChart.destroy();
                window.salesChart = null;
            }
            if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                window.stocksChart.destroy();
                window.stocksChart = null;
            }
            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }
            if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                window.soilChart.destroy();
                window.soilChart = null;
            }
            if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                window.hectareChart.destroy();
                window.hectareChart = null;
            }
            if (window.cropInsightChart && typeof window.cropInsightChart.destroy === 'function') {
                window.cropInsightChart.destroy();
                window.cropInsightChart = null;
            }
            
            console.log('🔄 Initializing charts...');
            initSalesChart();
            initStocksChart();
            initStatusChart(); // Initialize the separate status chart
            initSoilChart();
            initHectareChart();
            initCropInsightChart();
            console.log('✅ Charts initialized successfully');
        }

        // Load municipality-specific statistics for Sub Admin
        window.loadMunicipalityStats = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY STATISTICS ===');
                
                // Check if Supabase client is available
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('❌ Supabase client not available');
                    alert('Database connection not available. Please check your internet connection.');
                    return;
                }
                
                const client = window.supabaseClient || supabaseClient;
                console.log('✅ Supabase client available');
                
                // Get current user from session storage
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('🔍 Current user for stats:', currentUser);
                console.log('🔍 Session storage contents:', sessionStorage.getItem('currentUser'));
                
                if (!currentUser.id) {
                    console.log('❌ No current user found for stats');
                    console.log('🔍 Available session storage keys:', Object.keys(sessionStorage));
                    return;
                }
                
                // Get the admin's full data to access their address (municipality)
                console.log('🔍 Fetching admin data for ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('❌ Error fetching admin data:', adminError);
                    console.log('🔍 Trying to fetch first admin for testing...');
                    
                    // Try to get any admin for testing
                    const { data: testAdmins, error: testError } = await client
                        .from('admin_accounts')
                        .select('*')
                        .limit(5);
                    
                    console.log('🔍 Available admins in database:', testAdmins);
                    if (testError) {
                        console.error('❌ Error fetching test admins:', testError);
                    }
                    return;
                }
                
                console.log('✅ Admin data found:', adminData);
                
                // Check if user is Sub Admin
                if (adminData.user_type !== 'SUB ADMIN') {
                    console.log('ℹ️ User is not Sub Admin, user type:', adminData.user_type);
                    console.log('ℹ️ Available user types should include: SUB ADMIN');
                    // For Super Admin, could show aggregate data or different view
                    
                    // Show some sample data for testing
                    document.getElementById('activeUsersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('productsCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('activeFarmersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('totalRevenueCount').textContent = 'N/A (Super Admin)';
                    return;
                }
                
                console.log('✅ User is Sub Admin');
                
                const municipalityAddress = adminData.address;
                console.log('🔍 Sub Admin municipality/address:', municipalityAddress);
                console.log('🔍 Address type:', typeof municipalityAddress);
                console.log('🔍 Address length:', municipalityAddress ? municipalityAddress.length : 'null');
                
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('❌ No municipality address found for Sub Admin');
                    alert('No municipality assigned to this Sub Admin account. Please contact administrator.');
                    document.getElementById('activeUsersCount').textContent = '0';
                    document.getElementById('productsCount').textContent = '0';
                    document.getElementById('activeFarmersCount').textContent = '0';
                    return;
                }
                
                // Update profile access info
                const profileAccess = document.getElementById('profileUserAccess');
                if (profileAccess) {
                    profileAccess.textContent = `Access: ${municipalityAddress}`;
                }
                
                // 1. Get users whose municipality matches Sub Admin's address
                console.log('🔍 Searching for users with municipality:', municipalityAddress);
                
                // First, let's see what municipalities exist in the database
                const { data: allMunicipalities, error: municError } = await client
                    .from('users')
                    .select('municipality')
                    .not('municipality', 'is', null);
                
                if (!municError && allMunicipalities) {
                    const uniqueMunicipalities = [...new Set(allMunicipalities.map(u => u.municipality))].filter(m => m);
                    console.log('🔍 Available municipalities in users table:', uniqueMunicipalities);
                    console.log('🔍 Looking for exact match with:', municipalityAddress);
                    
                    // Check for case-insensitive matches
                    const caseInsensitiveMatches = uniqueMunicipalities.filter(m => 
                        m && m.toLowerCase() === municipalityAddress.toLowerCase()
                    );
                    console.log('🔍 Case-insensitive matches:', caseInsensitiveMatches);
                }
                
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .eq('municipality', municipalityAddress);
                
                if (usersError) {
                    console.error('❌ Error fetching users by municipality:', usersError);
                    return;
                }
                
                console.log(`🔍 Query result: Found ${municipalityUsers ? municipalityUsers.length : 0} users in municipality: ${municipalityAddress}`);
                console.log('🔍 User details:', municipalityUsers);
                
                // Get all user IDs for further queries
                const userIds = municipalityUsers ? municipalityUsers.map(user => user.id) : [];
                const totalUsers = municipalityUsers ? municipalityUsers.length : 0;
                
                console.log('🔍 User IDs for store owner check:', userIds);
                
                // 2. Get farmers (users who became store owners) in the municipality
                let totalFarmers = 0;
                let storeOwnerUserIds = [];
                
                if (userIds.length > 0) {
                    // Try both possible table name formats for store owner
                    let farmers = null;
                    let farmersError = null;
                    
                    try {
                        console.log('🔍 Trying store-owner table...');
                        const result = await client
                            .from('store-owner')
                            .select('user_id, id')
                            .in('user_id', userIds);
                        farmers = result.data;
                        farmersError = result.error;
                        console.log('✅ store-owner table result:', { data: farmers, error: farmersError });
                    } catch (error) {
                        console.log('❌ store-owner table failed, trying store_owner...');
                        try {
                            const result = await client
                                .from('store_owner')
                                .select('user_id, id')
                                .in('user_id', userIds);
                            farmers = result.data;
                            farmersError = result.error;
                            console.log('✅ store_owner table result:', { data: farmers, error: farmersError });
                        } catch (error2) {
                            console.error('❌ Could not access store owner table with either name format:', error2);
                            farmersError = error2;
                        }
                    }
                    
                    if (!farmersError && farmers) {
                        // Get unique store owner user IDs
                        storeOwnerUserIds = [...new Set(farmers.map(farmer => farmer.user_id))];
                        totalFarmers = storeOwnerUserIds.length;
                        console.log(`Found ${totalFarmers} active farmers (store owners) in ${municipalityAddress}`);
                    } else {
                        console.log('No farmers found or error accessing farmer data:', farmersError);
                    }
                }
                
                // 3. Get available products from users in the municipality who are also store owners
                let totalProducts = 0;
                if (storeOwnerUserIds.length > 0) {
                    console.log('🔍 Searching for products from store owners:', storeOwnerUserIds);
                    const { data: products, error: productsError } = await client
                        .from('my_products')
                        .select('id, user_id, name')
                        .in('user_id', storeOwnerUserIds);
                    
                    if (!productsError && products) {
                        totalProducts = products.length;
                        console.log(`✅ Found ${totalProducts} products from store owners in ${municipalityAddress}`);
                        console.log('🔍 Product details:', products);
                    } else {
                        console.log('❌ No products found or error accessing products:', productsError);
                    }
                } else {
                    console.log('❌ No store owners found, so no products to count');
                }
                
                // Update the UI with the counts
                document.getElementById('activeUsersCount').textContent = `${totalUsers}`;
                document.getElementById('productsCount').textContent = `${totalProducts}`;
                document.getElementById('activeFarmersCount').textContent = `${totalFarmers}`;
                
                console.log('=== MUNICIPALITY STATS LOADED ===');
                console.log(`Municipality: ${municipalityAddress}`);
                console.log(`Active Users (in municipality): ${totalUsers}`);
                console.log(`Active Farmers (users who became store owners): ${totalFarmers}`);
                console.log(`Available Products (from store owners): ${totalProducts}`);
                console.log('Matching criteria: Sub Admin address = Users municipality + Users must be store owners');
                
            } catch (error) {
                console.error('Error loading municipality stats:', error);
                
                // Show error state
                document.getElementById('activeUsersCount').textContent = 'Error';
                document.getElementById('productsCount').textContent = 'Error';
                document.getElementById('activeFarmersCount').textContent = 'Error';
            }
        }

        // Function to load real analytics data based on municipality
        window.loadMunicipalityAnalytics = async function() {
            try {
                console.log('🚀 === STARTING MUNICIPALITY ANALYTICS LOAD ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('❌ Supabase client not available');
                    return;
                }
                console.log('✅ Supabase client found');
                
                // Get current user from session
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('👤 Current user from session:', currentUser);
                
                if (!currentUser.id) {
                    console.error('❌ No current user found');
                    console.log('🔍 Session storage contents:', sessionStorage.getItem('currentUser'));
                    return;
                }
                
                // Get Sub Admin's address
                console.log('🔍 Fetching admin data for user ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('❌ Error fetching admin data:', adminError);
                    console.log('🔍 Trying to fetch any admin data for debugging...');
                    
                    const { data: allAdmins, error: allError } = await client
                        .from('admin_accounts')
                        .select('id, address, user_type')
                        .limit(5);
                    
                    console.log('🔍 Available admins:', allAdmins);
                    return;
                }
                
                console.log('✅ Admin data found:', adminData);
                
                if (!adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('ℹ️ Not a Sub Admin or no admin data, user type:', adminData?.user_type);
                    return;
                }
                
                const municipalityAddress = adminData.address;
                console.log('🏛️ Municipality address:', municipalityAddress);
                if (!municipalityAddress) {
                    console.log('❌ No municipality address found');
                    return;
                }
                
                console.log('🔍 Loading analytics for municipality:', municipalityAddress);
                
                // Get users in the municipality
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id')
                    .eq('municipality', municipalityAddress);
                
                if (usersError || !municipalityUsers) {
                    console.error('❌ Error fetching users:', usersError);
                    return;
                }
                
                const userIds = municipalityUsers.map(user => user.id);
                console.log('🔍 User IDs for analytics:', userIds);
                
                // Load Sales Analytics (from orders matching municipality)
                await loadSalesAnalytics(client, municipalityAddress, adminData);
                
                // Load Stock Analytics (from my_products)
                await loadStockAnalytics(client, userIds);
                
                // Load Soil Analytics (from store-owner)
                await loadSoilAnalytics(client, userIds);
                
                // Load Hectare Analytics (from store-owner)
                await loadHectareAnalytics(client, userIds);
                
                console.log('✅ Municipality analytics loaded successfully');
                
            } catch (error) {
                console.error('❌ Error loading municipality analytics:', error);
            }
        }

        // Load Sales Analytics from orders matching municipality
        async function loadSalesAnalytics(client, municipalityAddress, adminData) {
            try {
                console.log('🚀 STARTING SALES ANALYTICS BY SELLER MUNICIPALITY');
                console.log('🏛️ Target municipality:', municipalityAddress);
                
                // Step 1: Get all sellers from store-owner table
                console.log('📡 Step 1: Fetching all sellers from store-owner table...');
                const { data: sellers, error: sellersError } = await client
                    .from('store-owner')
                    .select('user_id');
                
                if (sellersError) {
                    console.error('❌ Error fetching sellers:', sellersError);
                    console.error('❌ Full error:', JSON.stringify(sellersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`📊 Found ${sellers?.length || 0} sellers in store-owner table`);
                console.log('📊 Sample sellers:', sellers?.slice(0, 3));
                
                if (!sellers || sellers.length === 0) {
                    console.warn('⚠️ No sellers found in store-owner table');
                    updateSalesChartWithFallback();
                    return;
                }
                
                // Extract seller user IDs
                const sellerUserIds = sellers.map(seller => seller.user_id);
                console.log('👥 Seller user IDs:', sellerUserIds.slice(0, 5), '...and', sellerUserIds.length - 5, 'more');
                
                // Step 2: Get seller details with municipality from users table
                console.log('📡 Step 2: Fetching seller details from users table...');
                const { data: sellerUsers, error: usersError } = await client
                    .from('users')
                    .select('id, full_name, municipality')
                    .in('id', sellerUserIds);
                
                if (usersError) {
                    console.error('❌ Error fetching seller users:', usersError);
                    console.error('❌ Full error:', JSON.stringify(usersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`� Found ${sellerUsers?.length || 0} seller users`);
                console.log('👥 Sample seller users:', sellerUsers?.slice(0, 3));
                
                if (!sellerUsers || sellerUsers.length === 0) {
                    console.warn('⚠️ No seller users found');
                    updateSalesChartWithFallback();
                    return;
                }
                
                // Step 3: Filter sellers by municipality (if admin municipality is specified)
                let filteredSellers = sellerUsers;
                if (municipalityAddress) {
                    filteredSellers = sellerUsers.filter(user => user.municipality === municipalityAddress);
                    console.log(`🏛️ Filtered to ${filteredSellers.length} sellers in municipality: ${municipalityAddress}`);
                } else {
                    console.log('� No municipality filter applied - showing all sellers');
                }
                
                console.log('🏛️ Filtered sellers:', filteredSellers?.slice(0, 3));
                
                if (filteredSellers.length === 0) {
                    console.warn('⚠️ No sellers found in target municipality');
                    analyticsData.sales = {
                        monthly: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], data: new Array(12).fill(0) },
                        weekly: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'], data: new Array(4).fill(0) },
                        yearly: { labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()), data: new Array(4).fill(0) }
                    };
                    updateSalesChart();
                    return;
                }
                
                // Step 4: Get orders for these sellers
                const targetSellerIds = filteredSellers.map(seller => seller.id);
                console.log('📡 Step 4: Fetching orders for sellers...');
                console.log('� Target seller IDs:', targetSellerIds);
                
                const { data: sellerProducts, error: productsError } = await client
                    .from('my_products')
                    .select('id, user_id, name')
                    .in('user_id', targetSellerIds);
                
                if (productsError) {
                    console.error('❌ Error fetching seller products:', productsError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`🛍️ Found ${sellerProducts?.length || 0} products from target sellers`);
                
                if (!sellerProducts || sellerProducts.length === 0) {
                    console.warn('⚠️ No products found from target sellers');
                    updateSalesChartWithFallback();
                    return;
                }
                
                const productIds = sellerProducts.map(product => product.id);
                
                // Get order items for these products
                const { data: orderItems, error: orderItemsError } = await client
                    .from('order_items')
                    .select('id, order_id, product_id, quantity, price')
                    .in('product_id', productIds);
                
                if (orderItemsError) {
                    console.error('❌ Error fetching order items:', orderItemsError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`📦 Found ${orderItems?.length || 0} order items for seller products`);
                
                if (!orderItems || orderItems.length === 0) {
                    console.warn('⚠️ No order items found for seller products');
                    updateSalesChartWithFallback();
                    return;
                }
                
                const orderIds = [...new Set(orderItems.map(item => item.order_id))];
                console.log(`📋 Found ${orderIds.length} unique orders containing seller products`);
                
                // Get the full orders for these order IDs
                const { data: orders, error: ordersError } = await client
                    .from('orders')
                    .select('id, user_id, total, created_at, status')
                    .in('id', orderIds)
                    .not('total', 'is', null);
                
                if (ordersError) {
                    console.error('❌ Error fetching orders:', ordersError);
                    console.error('❌ Full error:', JSON.stringify(ordersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`📦 Found ${orders?.length || 0} complete orders`);
                console.log('📦 Sample orders:', orders?.slice(0, 3));
                
                // Step 7: Calculate sales attributed to sellers
                let totalSales = 0;
                const salesByOrder = new Map();
                
                if (orders && orders.length > 0) {
                    // For each order, calculate how much was spent on seller products
                    for (const order of orders) {
                        const orderItemsForThisOrder = orderItems.filter(item => item.order_id === order.id);
                        const orderSalesFromSellers = orderItemsForThisOrder.reduce((sum, item) => {
                            const itemTotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0);
                            return sum + itemTotal;
                        }, 0);
                        
                        salesByOrder.set(order.id, orderSalesFromSellers);
                        totalSales += orderSalesFromSellers;
                    }
                    
                    console.log('💰 Sales breakdown by order:');
                    Array.from(salesByOrder.entries()).slice(0, 10).forEach(([orderId, sales]) => {
                        const order = orders.find(o => o.id === orderId);
                        console.log(`  📦 Order ${orderId}: ₱${sales.toFixed(2)} (${new Date(order?.created_at).toLocaleDateString()})`);
                    });
                    
                    if (salesByOrder.size > 10) {
                        console.log(`  ... and ${salesByOrder.size - 10} more orders`);
                    }
                }
                
                console.log(`💰 TOTAL SALES FROM MUNICIPALITY SELLERS: ₱${totalSales.toFixed(2)}`);
                
                // Step 8: Create modified orders array with seller-attributed sales for chart generation
                const sellerAttributedOrders = orders.map(order => ({
                    ...order,
                    total: salesByOrder.get(order.id) || 0
                })).filter(order => order.total > 0);
                
                console.log('📊 Step 8: Generating time-based chart data...');
                analyticsData.sales = generateMultiPeriodData(sellerAttributedOrders);
                
                // Log chart data
                const monthlyTotal = analyticsData.sales.monthly.data.reduce((sum, val) => sum + val, 0);
                console.log(`📊 Monthly chart total: ₱${monthlyTotal.toFixed(2)}`);
                console.log('📊 Monthly data:', analyticsData.sales.monthly.labels.map((label, i) => 
                    `${label}: ₱${analyticsData.sales.monthly.data[i].toFixed(2)}`
                ).join(', '));
                
                // Step 7: Update the chart
                console.log('📊 Step 7: Updating sales chart...');
                updateSalesChart();
                
                // Force chart update
                setTimeout(() => {
                    if (window.salesChart && analyticsData.sales.monthly) {
                        console.log('🔄 Force updating chart...');
                        const monthlyData = analyticsData.sales.monthly;
                        window.salesChart.data.labels = monthlyData.labels;
                        window.salesChart.data.datasets[0].data = monthlyData.data;
                        window.salesChart.update('none');
                        console.log('✅ Chart force updated with data:', monthlyData);
                    }
                }, 100);
                
                console.log('✅ Sales analytics completed successfully');
                console.log(`✅ Showing sales from ${filteredSellers.length} sellers in ${municipalityAddress}`);
                console.log('✅ Sales properly attributed to seller municipality via order items');
                
            } catch (error) {
                console.error('❌ Critical error in loadSalesAnalytics:', error);
                console.error('❌ Error stack:', error.stack);
                updateSalesChartWithFallback();
            }
        }

        // Helper function to update sales chart
        function updateSalesChart() {
            if (window.salesChart && window.salesChart.data) {
                try {
                    console.log('📊 Updating sales chart with new data...');
                    const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                    const currentData = analyticsData.sales[currentFilter];
                    
                    console.log('📊 Current filter:', currentFilter);
                    console.log('📊 Data to update chart with:', currentData);
                    
                    if (currentData && currentData.labels && currentData.data) {
                        window.salesChart.data.labels = currentData.labels;
                        window.salesChart.data.datasets[0].data = currentData.data;
                        window.salesChart.update('none'); // Update without animation to prevent movement
                        
                        // Update total sales displays
                        updateMunicipalitySalesDisplays(currentData, currentFilter);
                        
                        console.log('✅ Sales chart updated successfully with real data');
                    } else {
                        console.error('❌ Invalid chart data structure:', currentData);
                    }
                } catch (chartError) {
                    console.error('❌ Error updating sales chart:', chartError);
                }
            } else {
                console.warn('⚠️ Sales chart not available for update');
                console.log('🔍 window.salesChart exists:', !!window.salesChart);
                console.log('🔍 window.salesChart.data exists:', !!(window.salesChart && window.salesChart.data));
            }
        }

        // Function to update municipality sales amount displays
        function updateMunicipalitySalesDisplays(currentData, currentFilter) {
            try {
                console.log('🔄 Updating municipality sales displays...', { currentData, currentFilter });
                
                // Calculate current period total
                const currentPeriodTotal = currentData.data.reduce((sum, value) => sum + value, 0);
                
                // Calculate total across all periods
                let totalSales = 0;
                Object.values(analyticsData.sales).forEach(periodData => {
                    if (periodData && periodData.data) {
                        totalSales += periodData.data.reduce((sum, value) => sum + value, 0);
                    }
                });
                
                // Update display elements
                const totalSalesElement = document.getElementById('totalMunicipalitySales');
                const currentPeriodElement = document.getElementById('currentPeriodSales');
                
                console.log('📊 Display elements found:', { 
                    totalSalesElement: !!totalSalesElement, 
                    currentPeriodElement: !!currentPeriodElement 
                });
                
                if (totalSalesElement) {
                    const formattedTotal = `₱${totalSales.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    totalSalesElement.textContent = formattedTotal;
                    console.log('💰 Updated total sales display:', formattedTotal);
                } else {
                    console.warn('⚠️ Total sales element not found');
                }
                
                if (currentPeriodElement) {
                    let periodLabel = '';
                    switch(currentFilter) {
                        case 'monthly': periodLabel = 'This Year'; break;
                        case 'weekly': periodLabel = 'This Month'; break;
                        case 'yearly': periodLabel = 'All Years'; break;
                        default: periodLabel = 'Current Period';
                    }
                    const formattedPeriod = `₱${currentPeriodTotal.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    currentPeriodElement.textContent = formattedPeriod;
                    
                    // Update the label
                    const periodLabelElement = currentPeriodElement.previousElementSibling;
                    if (periodLabelElement && periodLabelElement.classList.contains('text-muted')) {
                        periodLabelElement.textContent = periodLabel;
                    }
                    
                    console.log('📈 Updated current period display:', formattedPeriod, `(${periodLabel})`);
                } else {
                    console.warn('⚠️ Current period element not found');
                }
                
                console.log(`💰 Municipality sales displays updated - Total: ₱${totalSales.toFixed(2)}, Current Period (${currentFilter}): ₱${currentPeriodTotal.toFixed(2)}`);
                
            } catch (error) {
                console.error('❌ Error updating municipality sales displays:', error);
            }
        }

        // Function to process orders data for chart display (copied from dashboard_super_admin)
        function processOrdersForChart(orders) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            // Initialize monthly data
            const monthlyData = {};
            monthNames.forEach(month => {
                monthlyData[month] = 0;
            });

            // Group orders by month
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    if (orderDate.getFullYear() === currentYear) {
                        const monthName = monthNames[orderDate.getMonth()];
                        const orderTotal = parseFloat(order.total) || 0;
                        monthlyData[monthName] += orderTotal;
                    }
                }
            });

            console.log('Monthly sales data:', monthlyData);

            return {
                labels: monthNames,
                data: monthNames.map(month => monthlyData[month])
            };
        }
        
        // Function to generate data for multiple periods (monthly, weekly, yearly)
        function generateMultiPeriodData(orders) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Monthly data for current year
            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = new Array(12).fill(0);
            
            // Weekly data for current month
            const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const weeklyData = new Array(4).fill(0);
            
            // Yearly data for last 4 years
            const yearLabels = [currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(y => y.toString());
            const yearlyData = new Array(4).fill(0);
            
            orders.forEach(order => {
                if (!order.created_at || !order.total) return;
                
                const orderDate = new Date(order.created_at);
                const orderTotal = parseFloat(order.total) || 0;
                const orderYear = orderDate.getFullYear();
                const orderMonth = orderDate.getMonth();
                
                // Monthly data (current year only)
                if (orderYear === currentYear) {
                    monthlyData[orderMonth] += orderTotal;
                }
                
                // Weekly data (current month only)
                if (orderYear === currentYear && orderMonth === currentMonth) {
                    const weekOfMonth = Math.floor((orderDate.getDate() - 1) / 7);
                    if (weekOfMonth >= 0 && weekOfMonth < 4) {
                        weeklyData[weekOfMonth] += orderTotal;
                    }
                }
                
                // Yearly data
                const yearIndex = yearLabels.indexOf(orderYear.toString());
                if (yearIndex !== -1) {
                    yearlyData[yearIndex] += orderTotal;
                }
            });
            
            return {
                monthly: { labels: monthLabels, data: monthlyData },
                weekly: { labels: weekLabels, data: weeklyData },
                yearly: { labels: yearLabels, data: yearlyData }
            };
        }
        
        // Fallback function for when there are errors (similar to dashboard_super_admin)
        function updateSalesChartWithFallback() {
            if (!window.salesChart) return;
            
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let fallbackData;
            
            switch (period) {
                case 'weekly':
                    fallbackData = {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'yearly':
                    fallbackData = {
                        labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()),
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'monthly':
                default:
                    fallbackData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        data: new Array(12).fill(0)
                    };
                    break;
            }
            
            window.salesChart.data.labels = fallbackData.labels;
            window.salesChart.data.datasets[0].data = fallbackData.data;
            window.salesChart.data.datasets[0].label = period === 'weekly' ? 'Weekly Sales' : 
                                                     period === 'yearly' ? 'Annual Sales' : 'Monthly Sales';
            window.salesChart.update();
            console.log(`⚠️ Sales chart updated with empty ${period} data (no municipality data found)`);
        }

        // Test function to check municipality products sales
        window.testMunicipalityProductsSales = async function() {
            try {
                console.log('🧪 === TESTING MUNICIPALITY PRODUCTS SALES LOGIC ===');
                const client = window.supabaseClient || supabaseClient;
                const adminData = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                if (!adminData.address) {
                    console.error('❌ No admin address found in session');
                    return;
                }
                
                await loadSalesAnalytics(client, adminData.address, adminData);
                console.log('🧪 Test completed - check console logs above for details');
            } catch (error) {
                console.error('❌ Test failed:', error);
            }
        };

        // Test function to check orders table
        window.testOrdersTable = async function() {
            try {
                console.log('🧪 === TESTING ORDERS TABLE ACCESS ===');
                const client = window.supabaseClient || supabaseClient;
                
                if (!client) {
                    console.error('❌ No Supabase client');
                    return;
                }
                
                // Test basic table access
                console.log('🧪 Step 1: Testing basic orders table access...');
                const { data: orders, error } = await client
                    .from('orders')
                    .select('*')
                    .limit(10);
                
                console.log('🧪 Orders test result:', { 
                    ordersCount: orders?.length || 0, 
                    error: error,
                    sampleData: orders?.slice(0, 2)
                });
                
                if (error) {
                    console.error('❌ Orders table error:', error);
                    return;
                }
                
                if (!orders || orders.length === 0) {
                    console.warn('⚠️ No orders found in database');
                    console.log('💡 Try creating some test orders first');
                    return;
                }
                
                console.log('✅ Orders table accessible');
                console.log('📦 Total orders in database:', orders.length);
                console.log('📦 Sample orders:');
                orders.forEach((order, index) => {
                    console.log(`  ${index + 1}. ID: ${order.id?.slice(0, 8)}, Total: ₱${order.total}, Address: "${order.address}", Date: ${new Date(order.created_at).toLocaleDateString()}`);
                });
                
                // Test current user
                console.log('🧪 Step 2: Testing current user...');
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('👤 Current user:', currentUser);
                
                if (!currentUser.id) {
                    console.error('❌ No current user found');
                    return;
                }
                
                // Test admin data
                console.log('🧪 Step 3: Testing admin data...');
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                console.log('👨‍💼 Admin data:', { data: adminData, error: adminError });
                
                if (adminError) {
                    console.error('❌ Admin data error:', adminError);
                    return;
                }
                
                if (!adminData.address) {
                    console.warn('⚠️ Admin has no address set');
                    return;
                }
                
                // Test address matching
                console.log('🧪 Step 4: Testing address matching...');
                const adminAddress = adminData.address.toLowerCase();
                console.log('🏛️ Admin address:', adminData.address);
                
                const matchingOrders = orders.filter(order => {
                    if (!order.address) return false;
                    
                    const orderAddress = order.address.toLowerCase();
                    const exactMatch = orderAddress === adminAddress;
                    const containsMatch = orderAddress.includes(adminAddress);
                    const reverseContains = adminAddress.includes(orderAddress);
                    const lipaMatch = adminAddress.includes('lipa') && orderAddress.includes('lipa');
                    
                    return exactMatch || containsMatch || reverseContains || lipaMatch;
                });
                
                console.log('🎯 Matching orders found:', matchingOrders.length);
                if (matchingOrders.length > 0) {
                    console.log('💰 Matching orders:');
                    matchingOrders.forEach((order, index) => {
                        console.log(`  ${index + 1}. Total: ₱${order.total}, Address: "${order.address}"`);
                    });
                    
                    const totalRevenue = matchingOrders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
                    console.log(`💰 Total revenue: ₱${totalRevenue.toFixed(2)}`);
                } else {
                    console.warn('⚠️ No orders match the admin address');
                    console.log('🔍 All order addresses:');
                    orders.forEach((order, index) => {
                        console.log(`  ${index + 1}. "${order.address}"`);
                    });
                    console.log('🔍 Admin address to match:', `"${adminData.address}"`);
                }
                
            } catch (error) {
                console.error('❌ Test error:', error);
            }
        }

        // Simple test to manually trigger sales analytics
        window.testSalesAnalytics = async function() {
            console.log('🧪 === MANUAL SALES ANALYTICS TEST ===');
            try {
                const client = window.supabaseClient || supabaseClient;
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                const { data: adminData } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminData && adminData.address) {
                    await loadSalesAnalytics(client, adminData.address, adminData);
                } else {
                    console.error('❌ No admin data or address found');
                }
            } catch (error) {
                console.error('❌ Manual test error:', error);
            }
        }

        // Load Stock Analytics from my_products
        async function loadStockAnalytics(client, userIds) {
            try {
                console.log('🔍 Loading stock analytics...');
                console.log('🔍 User IDs for stock analysis:', userIds);
                
                if (userIds.length === 0) {
                    console.log('❌ No users to analyze');
                    // Set "No Data" instead of loading
                    analyticsData.stocks.category = {
                        labels: ['No Data'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Data', quantity: 0, status: 'No Data' }]
                    };
                    return;
                }
                
                const { data: products, error: productsError } = await client
                    .from('my_products')
                    .select('category, quantity, name, id')
                    .in('user_id', userIds);
                
                if (productsError) {
                    console.error('❌ Error fetching products:', productsError);
                    return;
                }
                
                console.log('🔍 Products data found:', products);
                console.log('🔍 Number of products:', products ? products.length : 0);
                
                if (!products || products.length === 0) {
                    console.log('❌ No products found for these users');
                    analyticsData.stocks.category = {
                        labels: ['No Products'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Products', quantity: 0, status: 'No Data' }]
                    };
                    
                    // Update chart immediately
                    if (window.stocksChart && window.stocksChart.data) {
                        window.stocksChart.data.labels = ['No Products'];
                        window.stocksChart.data.datasets[0].data = [1];
                        window.stocksChart.data.datasets[0].backgroundColor = ['#6c757d'];
                        window.stocksChart.update();
                    }
                    return;
                }
                
                // Function to determine stock status
                function getStockStatus(quantity) {
                    const qty = parseInt(quantity) || 0;
                    if (qty === 0) return 'Out of Stock';
                    if (qty <= 5) return 'To be Out of Stock';
                    return 'Available';
                }
                
                // Process product data by name (not category)
                const productStats = {};
                const productDetails = {};
                const statusStats = { 'Available': 0, 'To be Out of Stock': 0, 'Out of Stock': 0 };
                const statusProducts = { 'Available': [], 'To be Out of Stock': [], 'Out of Stock': [] };
                
                products.forEach(product => {
                    console.log('🔍 Processing product:', product);
                    const productName = (product.name && product.name.trim() !== '') 
                        ? product.name.trim() 
                        : 'Unnamed Product';
                    
                    const category = (product.category && product.category.trim() !== '') 
                        ? product.category.trim() 
                        : 'Uncategorized';
                    
                    const productStatus = getStockStatus(product.quantity || 0);
                    const productInfo = {
                        name: productName,
                        quantity: product.quantity || 0,
                        status: productStatus,
                        category: category
                    };
                    
                    // Group by product name and sum quantities
                    if (!productStats[productName]) {
                        productStats[productName] = 0;
                        productDetails[productName] = [];
                    }
                    productStats[productName] += (parseInt(product.quantity) || 0);
                    productDetails[productName].push(productInfo);
                    
                    // Count by status
                    statusStats[productStatus] = (statusStats[productStatus] || 0) + 1;
                    
                    // Store detailed product information by status
                    statusProducts[productStatus].push(productInfo);
                });
                
                console.log('📊 Product stats calculated:', productStats);
                console.log('📊 Status stats calculated:', statusStats);
                console.log('📊 Product details:', productDetails);
                console.log('📊 Status products:', statusProducts);
                
                // Convert to arrays for chart
                const productNames = Object.keys(productStats);
                const productQuantities = Object.values(productStats);
                const statusData = Object.values(statusStats);
                const colors = ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545', '#6c757d', '#20c997', '#e83e8c', '#fd7e14'];
                
                console.log('📊 Final chart data:');
                console.log('   Labels (Product Names):', productNames);
                console.log('   Product Quantities:', productQuantities);
                console.log('   Status Data:', statusData);
                
                // Update analyticsData with detailed product information by name
                analyticsData.stocks.category = {
                    labels: productNames,
                    data: productQuantities,
                    colors: colors.slice(0, productNames.length),
                    products: productDetails
                };
                
                // Update status analytics with product details
                analyticsData.stocks.status = {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: statusData,
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: statusProducts
                };
                
                console.log('✅ Updated analyticsData.stocks.category:', analyticsData.stocks.category);
                console.log('✅ Updated analyticsData.stocks.status:', analyticsData.stocks.status);
                
                // Update the charts if they exist
                if (window.stocksChart && window.stocksChart.data) {
                    console.log('🔄 Updating stocks chart with real data');
                    console.log('   Chart before update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                    
                    window.stocksChart.data.labels = productNames;
                    window.stocksChart.data.datasets[0].data = productQuantities;
                    window.stocksChart.data.datasets[0].backgroundColor = colors.slice(0, productNames.length);
                    window.stocksChart.update();
                    
                    console.log('   Chart after update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                } else {
                    console.log('⚠️ Stocks chart not yet initialized, data saved for later use');
                }
                
                // Update the status chart if it exists
                if (window.statusChart && window.statusChart.data) {
                    console.log('🔄 Updating status chart with real data');
                    window.statusChart.data.labels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                    window.statusChart.data.datasets[0].data = statusData;
                    window.statusChart.data.datasets[0].backgroundColor = ['#28a745', '#ffc107', '#dc3545'];
                    window.statusChart.update();
                    console.log('✅ Status chart updated with real data');
                } else {
                    console.log('⚠️ Status chart not yet initialized, data saved for later use');
                }
                
                console.log('✅ Stock analytics completed');
                
            } catch (error) {
                console.error('❌ Error in loadStockAnalytics:', error);
            }
        }

        // Load Soil Analytics from store-owner
        async function loadSoilAnalytics(client, userIds) {
            try {
                console.log('🔍 Loading soil analytics...');
                
                if (userIds.length === 0) {
                    console.log('❌ No users to analyze');
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                try {
                    const result = await client
                        .from('store-owner')
                        .select('soil_type')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                } catch (error) {
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('soil_type')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                    } catch (error2) {
                        console.error('❌ Could not access store owner table:', error2);
                        return;
                    }
                }
                
                if (!storeOwners) {
                    console.log('❌ No store owners found');
                    return;
                }
                
                console.log('🔍 Store owners soil data:', storeOwners);
                
                // Process soil type data
                const soilStats = {};
                
                storeOwners.forEach(owner => {
                    if (owner.soil_type) {
                        soilStats[owner.soil_type] = (soilStats[owner.soil_type] || 0) + 1;
                    }
                });
                
                console.log('📊 Soil stats:', soilStats);
                
                // Update analyticsData.soil.type with real data
                const soilTypes = Object.keys(soilStats);
                const soilData = Object.values(soilStats);
                const colors = ['#8b4513', '#d2691e', '#daa520', '#bc8f8f', '#556b2f', '#654321', '#8b7355'];
                
                analyticsData.soil.type = {
                    labels: soilTypes,
                    data: soilData,
                    colors: colors.slice(0, soilTypes.length)
                };
                
                // Update the chart if it exists
                if (window.soilChart && window.soilChart.data) {
                    console.log('🔄 Updating soil chart with real data');
                    window.soilChart.data.labels = soilTypes;
                    window.soilChart.data.datasets[0].data = soilData;
                    window.soilChart.data.datasets[0].backgroundColor = colors.slice(0, soilTypes.length);
                    window.soilChart.update();
                } else {
                    console.log('⚠️ Soil chart not yet initialized, data will be used when chart is created');
                }
                
                console.log('✅ Soil analytics updated');
                
            } catch (error) {
                console.error('❌ Error in loadSoilAnalytics:', error);
            }
        }

        // Load Hectare Analytics from store-owner
        async function loadHectareAnalytics(client, userIds) {
            try {
                console.log('🔍 Loading hectare analytics...');
                
                if (userIds.length === 0) {
                    console.log('❌ No users to analyze');
                    // Set "No Data" for all periods
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        },
                        weekly: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            data: [0, 0, 0, 0]
                        },
                        yearly: {
                            labels: ['2021', '2022', '2023', '2024'],
                            data: [0, 0, 0, 0]
                        }
                    };
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                let storeOwnerError = null;
                
                try {
                    console.log('🔍 Trying store-owner table...');
                    const result = await client
                        .from('store-owner')
                        .select('land_size, land_size_unit, created_at, user_id')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                    storeOwnerError = result.error;
                    console.log('✅ store-owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                } catch (error) {
                    console.log('❌ store-owner table failed, trying store_owner...');
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('land_size, land_size_unit, created_at, user_id')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                        storeOwnerError = result.error;
                        console.log('✅ store_owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                    } catch (error2) {
                        console.error('❌ Could not access store owner table with either name format:', error2);
                        return;
                    }
                }
                
                if (storeOwnerError || !storeOwners) {
                    console.log('❌ No store owners found or error:', storeOwnerError);
                    return;
                }
                
                console.log('🔍 Store owners land size data:', storeOwners);
                
                // Process land size data - filter valid numeric values and keep original units
                const validLandData = storeOwners
                    .filter(owner => {
                        const landSize = parseFloat(owner.land_size);
                        return owner.land_size && !isNaN(landSize) && landSize > 0;
                    })
                    .map(owner => {
                        return {
                            size: parseFloat(owner.land_size),
                            unit: owner.land_size_unit || 'hectare',
                            date: owner.created_at ? new Date(owner.created_at) : new Date(),
                            userId: owner.user_id
                        };
                    });
                
                console.log('📊 Valid land data by unit:');
                validLandData.forEach((item, index) => {
                    console.log(`  ${index + 1}. User ${item.userId}: ${item.size} ${item.unit} on ${item.date.getFullYear()}-${(item.date.getMonth() + 1).toString().padStart(2, '0')}-${item.date.getDate().toString().padStart(2, '0')}`);
                });
                
                if (validLandData.length === 0) {
                    console.log('❌ No valid land size data found');
                    // Set "No Data" state
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['No Data'],
                            hectares: [1],
                            squareMeters: [0],
                            meters: [0]
                        },
                        weekly: {
                            labels: ['No Data'],
                            hectares: [1],
                            squareMeters: [0],
                            meters: [0]
                        },
                        yearly: {
                            labels: ['No Data'],
                            hectares: [1],
                            squareMeters: [0],
                            meters: [0]
                        }
                    };
                    
                    // Update chart if exists
                    if (window.hectareChart && window.hectareChart.data) {
                        window.hectareChart.data.labels = ['No Data'];
                        window.hectareChart.data.datasets[0].data = [1];
                        window.hectareChart.data.datasets[1].data = [0];
                        window.hectareChart.data.datasets[2].data = [0];
                        window.hectareChart.update();
                    }
                    return;
                }
                
                console.log('📊 Valid land data:', validLandData);
                console.log('📊 Number of valid entries:', validLandData.length);
                
                // Calculate totals by unit
                const totalByUnit = {
                    hectare: 0,
                    'square meter': 0,
                    meter: 0
                };
                
                validLandData.forEach(item => {
                    totalByUnit[item.unit] += item.size;
                });
                
                console.log('📊 Total by unit:', totalByUnit);
                
                // Current date for calculations
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); // 0-based
                
                // MONTHLY DATA - Separate data for each unit
                const monthlyHectares = new Array(12).fill(0);
                const monthlySquareMeters = new Array(12).fill(0);
                const monthlyMeters = new Array(12).fill(0);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Group by creation month and unit for current year or most recent year with data
                const yearlyGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    const month = item.date.getMonth();
                    
                    if (!yearlyGroups[year]) {
                        yearlyGroups[year] = {
                            hectares: new Array(12).fill(0),
                            squareMeters: new Array(12).fill(0),
                            meters: new Array(12).fill(0)
                        };
                    }
                    
                    if (item.unit === 'hectare') {
                        yearlyGroups[year].hectares[month] += item.size;
                    } else if (item.unit === 'square meter') {
                        yearlyGroups[year].squareMeters[month] += item.size;
                    } else if (item.unit === 'meter') {
                        yearlyGroups[year].meters[month] += item.size;
                    }
                });
                
                // Use current year data if available, otherwise use the most recent year
                const availableYears = Object.keys(yearlyGroups).map(y => parseInt(y)).sort((a, b) => b - a);
                const targetYear = availableYears.includes(currentYear) ? currentYear : availableYears[0];
                
                if (targetYear && yearlyGroups[targetYear]) {
                    for (let i = 0; i < 12; i++) {
                        monthlyHectares[i] = yearlyGroups[targetYear].hectares[i];
                        monthlySquareMeters[i] = yearlyGroups[targetYear].squareMeters[i];
                        monthlyMeters[i] = yearlyGroups[targetYear].meters[i];
                    }
                }
                
                // WEEKLY DATA - Separate data for each unit
                const weeklyLabels = [];
                const weeklyHectares = [];
                const weeklySquareMeters = [];
                const weeklyMeters = [];
                
                // Get current month's totals by unit
                const currentMonthHectares = monthlyHectares[currentMonth];
                const currentMonthSquareMeters = monthlySquareMeters[currentMonth];
                const currentMonthMeters = monthlyMeters[currentMonth];
                
                // Get farms in current month or month with most activity
                const farmsInCurrentMonth = validLandData.filter(item => {
                    const itemMonth = item.date.getMonth();
                    return itemMonth === currentMonth;
                });
                
                // If we have farms in the current month, distribute by actual weeks
                if (farmsInCurrentMonth.length > 0) {
                    const weeklyDistribution = {
                        hectares: [0, 0, 0, 0],
                        squareMeters: [0, 0, 0, 0],
                        meters: [0, 0, 0, 0]
                    };
                    
                    farmsInCurrentMonth.forEach(item => {
                        const dayOfMonth = item.date.getDate();
                        const weekOfMonth = Math.min(Math.ceil(dayOfMonth / 7), 4) - 1; // 0-3
                        
                        if (item.unit === 'hectare') {
                            weeklyDistribution.hectares[weekOfMonth] += item.size;
                        } else if (item.unit === 'square meter') {
                            weeklyDistribution.squareMeters[weekOfMonth] += item.size;
                        } else if (item.unit === 'meter') {
                            weeklyDistribution.meters[weekOfMonth] += item.size;
                        }
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        weeklyHectares.push(Math.round(weeklyDistribution.hectares[i] * 100) / 100);
                        weeklySquareMeters.push(Math.round(weeklyDistribution.squareMeters[i] * 100) / 100);
                        weeklyMeters.push(Math.round(weeklyDistribution.meters[i] * 100) / 100);
                    }
                } else {
                    // No data for current month
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        weeklyHectares.push(0);
                        weeklySquareMeters.push(0);
                        weeklyMeters.push(0);
                    }
                }
                
                // YEARLY DATA - Separate data for each unit
                const currentYear2025 = new Date().getFullYear();
                const yearRange = 4;
                const yearlyLabels = [];
                const yearlyHectares = [];
                const yearlySquareMeters = [];
                const yearlyMeters = [];
                
                // Create year groups based on actual data by unit
                const actualYearGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    if (!actualYearGroups[year]) {
                        actualYearGroups[year] = {
                            hectares: 0,
                            squareMeters: 0,
                            meters: 0
                        };
                    }
                    
                    if (item.unit === 'hectare') {
                        actualYearGroups[year].hectares += item.size;
                    } else if (item.unit === 'square meter') {
                        actualYearGroups[year].squareMeters += item.size;
                    } else if (item.unit === 'meter') {
                        actualYearGroups[year].meters += item.size;
                    }
                });
                
                console.log('📊 Year groups by unit:', actualYearGroups);
                
                // Generate data for the last 4 years
                for (let i = yearRange - 1; i >= 0; i--) {
                    const year = currentYear2025 - i;
                    yearlyLabels.push(year.toString());
                    
                    if (actualYearGroups[year]) {
                        yearlyHectares.push(Math.round(actualYearGroups[year].hectares * 100) / 100);
                        yearlySquareMeters.push(Math.round(actualYearGroups[year].squareMeters * 100) / 100);
                        yearlyMeters.push(Math.round(actualYearGroups[year].meters * 100) / 100);
                    } else {
                        yearlyHectares.push(0);
                        yearlySquareMeters.push(0);
                        yearlyMeters.push(0);
                    }
                }
                console.log('📊 Monthly data by unit - Hectares:', monthlyHectares);
                console.log('📊 Monthly data by unit - Square Meters:', monthlySquareMeters);
                console.log('📊 Monthly data by unit - Meters:', monthlyMeters);
                console.log('📊 Weekly data by unit:', { weeklyHectares, weeklySquareMeters, weeklyMeters });
                console.log('📊 Yearly data by unit:', { yearlyHectares, yearlySquareMeters, yearlyMeters });
                
                // Update analyticsData with separate datasets for each unit
                analyticsData.hectare = {
                    monthly: {
                        labels: monthNames,
                        hectares: monthlyHectares,
                        squareMeters: monthlySquareMeters,
                        meters: monthlyMeters,
                        validFarms: validLandData.length
                    },
                    weekly: {
                        labels: weeklyLabels,
                        hectares: weeklyHectares,
                        squareMeters: weeklySquareMeters,
                        meters: weeklyMeters,
                        validFarms: validLandData.length
                    },
                    yearly: {
                        labels: yearlyLabels,
                        hectares: yearlyHectares,
                        squareMeters: yearlySquareMeters,
                        meters: yearlyMeters,
                        validFarms: validLandData.length
                    }
                };
                
                console.log('✅ Updated analyticsData.hectare:', analyticsData.hectare);
                
                // Update the chart if it exists (default to monthly view)
                if (window.hectareChart && window.hectareChart.data) {
                    console.log('🔄 Updating hectare chart with multi-unit data');
                    window.hectareChart.data.labels = monthNames;
                    window.hectareChart.data.datasets[0].data = monthlyHectares;
                    window.hectareChart.data.datasets[1].data = monthlySquareMeters;
                    window.hectareChart.data.datasets[2].data = monthlyMeters;
                    window.hectareChart.update();
                    console.log('✅ Hectare chart updated successfully');
                } else {
                    console.log('⚠️ Hectare chart not yet initialized, data saved for later use');
                }
                
                console.log('✅ Hectare analytics completed');
                
            } catch (error) {
                console.error('❌ Error in loadHectareAnalytics:', error);
            }
        }

        // Test function to check database connection and data
        window.testDatabaseConnection = async function() {
            try {
                console.log('=== TESTING DATABASE CONNECTION ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('❌ No Supabase client available');
                    return;
                }
                
                // Test admin_accounts table
                console.log('🔍 Testing admin_accounts table...');
                const { data: admins, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .limit(3);
                
                console.log('Admin accounts result:', { data: admins, error: adminError });
                
                // Test users table
                console.log('🔍 Testing users table...');
                const { data: users, error: userError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .limit(5);
                
                console.log('Users result:', { data: users, error: userError });
                
                // Test store owner tables
                console.log('🔍 Testing store-owner table...');
                try {
                    const { data: stores1, error: storeError1 } = await client
                        .from('store-owner')
                        .select('*')
                        .limit(3);
                    console.log('store-owner result:', { data: stores1, error: storeError1 });
                } catch (e) {
                    console.log('store-owner table not accessible');
                }
                
                console.log('🔍 Testing store_owner table...');
                try {
                    const { data: stores2, error: storeError2 } = await client
                        .from('store_owner')
                        .select('*')
                        .limit(3);
                    console.log('store_owner result:', { data: stores2, error: storeError2 });
                } catch (e) {
                    console.log('store_owner table not accessible');
                }
                
                // Test products table
                console.log('🔍 Testing my_products table...');
                const { data: products, error: productError } = await client
                    .from('my_products')
                    .select('*')
                    .limit(3);
                
                console.log('Products result:', { data: products, error: productError });
                
                console.log('=== DATABASE TEST COMPLETE ===');
                
            } catch (error) {
                console.error('❌ Error in database test:', error);
            }
        }

        // Wait for shared profile to load, then load municipality stats
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Check if charts are already initialized to prevent duplicates
            if (window.chartsInitialized) {
                console.log('⚠️ Charts already initialized, skipping...');
                return;
            }
            
            // Initialize charts
            initializeCharts();
            window.chartsInitialized = true;
                
            // Load real data after charts are initialized
            setTimeout(() => {
                console.log('🔄 Loading analytics after charts initialization...');
                window.loadMunicipalityAnalytics();
            }, 2000);
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('🔍 Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('🔄 Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
            }, 3000); // Increased timeout to 3 seconds
        });

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            if (data && window.salesChart) {
                window.salesChart.data.labels = data.labels;
                window.salesChart.data.datasets[0].data = data.data;
                window.salesChart.update('none'); // Update without animation to prevent movement
                
                // Update the sales amount displays
                updateMunicipalitySalesDisplays(data, period);
            }
        }

        function updateStocksChart(view) {
            console.log('🔄 Updating stocks chart to view:', view);
            
            const stocksCanvas = document.getElementById('stocksChart');
            const statusCanvas = document.getElementById('statusChart');
            
            if (!stocksCanvas || !statusCanvas) {
                console.warn('⚠️ Chart elements not found');
                return;
            }
            
            if (view === 'status') {
                // Show status chart, hide category chart
                stocksCanvas.style.display = 'none';
                statusCanvas.style.display = 'block';
                
                // Update status chart with real data
                const data = analyticsData.stocks.status;
                console.log('📊 Status chart data:', data);
                
                if (data && data.labels && data.data && window.statusChart && window.statusChart.data) {
                    window.statusChart.data.labels = data.labels;
                    window.statusChart.data.datasets[0].data = data.data;
                    window.statusChart.data.datasets[0].backgroundColor = data.colors;
                    window.statusChart.update();
                    console.log('✅ Status chart updated successfully');
                } else {
                    console.warn('⚠️ Status chart not ready or missing data');
                    if (!window.statusChart) console.warn('  - statusChart not initialized');
                    if (!data) console.warn('  - status data missing');
                    if (window.statusChart && !window.statusChart.data) console.warn('  - statusChart.data is undefined');
                }
                
            } else {
                // Show category chart, hide status chart
                stocksCanvas.style.display = 'block';
                statusCanvas.style.display = 'none';
                
                // Update category chart with real data
                const data = analyticsData.stocks[view];
                console.log('📊 Category chart data:', data);
                
                if (data && data.labels && data.data && window.stocksChart && window.stocksChart.data) {
                    window.stocksChart.data.labels = data.labels;
                    window.stocksChart.data.datasets[0].data = data.data;
                    window.stocksChart.data.datasets[0].backgroundColor = data.colors;
                    window.stocksChart.update();
                    console.log('✅ Category chart updated successfully');
                } else {
                    console.warn('⚠️ Category chart not ready or missing data');
                    if (!window.stocksChart) console.warn('  - stocksChart not initialized');
                    if (!data) console.warn('  - category data missing');
                    if (window.stocksChart && !window.stocksChart.data) console.warn('  - stocksChart.data is undefined');
                }
            }
        }

        // Status filtering function
        function filterByStatus(status) {
            console.log('🔄 Filtering by status:', status);
            
            // Check if statusChart exists
            if (!window.statusChart || !window.statusChart.data) {
                console.warn('⚠️ Status chart not ready for filtering');
                return;
            }
            
            // Update active button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            });
            
            const activeBtn = document.querySelector(`[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (status === 'Available') {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                } else if (status === 'To be Out of Stock') {
                    activeBtn.classList.remove('btn-outline-warning');
                    activeBtn.classList.add('btn-warning');
                } else if (status === 'Out of Stock') {
                    activeBtn.classList.remove('btn-outline-danger');
                    activeBtn.classList.add('btn-danger');
                } else {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                }
            }

            // We're in status view - filter the status chart
            const statusData = analyticsData.stocks.status;
            
            if (!statusData || !statusData.labels || !statusData.data) {
                console.warn('⚠️ Status data not available for filtering');
                return;
            }
            
            if (status === 'all') {
                // Show all status data
                window.statusChart.data.labels = statusData.labels;
                window.statusChart.data.datasets[0].data = statusData.data;
                window.statusChart.data.datasets[0].backgroundColor = statusData.colors;
            } else {
                // Show only the selected status
                const statusIndex = statusData.labels.indexOf(status);
                if (statusIndex !== -1) {
                    window.statusChart.data.labels = [status];
                    window.statusChart.data.datasets[0].data = [statusData.data[statusIndex]];
                    window.statusChart.data.datasets[0].backgroundColor = [statusData.colors[statusIndex]];
                } else {
                    console.warn('⚠️ Status not found in data:', status);
                    return;
                }
            }
            window.statusChart.update();
            console.log('✅ Status filter applied successfully');
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            window.soilChart.data.labels = data.labels;
            window.soilChart.data.datasets[0].data = data.data;
            window.soilChart.data.datasets[0].backgroundColor = data.colors;
            window.soilChart.update();
        }

        function updateHectareChart(period) {
            console.log('🔄 Updating hectare chart to period:', period);
            
            if (!window.hectareChart || !window.hectareChart.data) {
                console.warn('⚠️ Hectare chart not initialized');
                return;
            }
            
            const data = analyticsData.hectare[period];
            if (!data || !data.labels) {
                console.warn('⚠️ No hectare data available for period:', period);
                console.log('Available periods:', Object.keys(analyticsData.hectare));
                return;
            }
            
            console.log('📊 Updating with data for', period, ':', data);
            console.log('📊 Labels:', data.labels);
            console.log('📊 Hectares:', data.hectares);
            console.log('📊 Square Meters:', data.squareMeters);
            console.log('📊 Meters:', data.meters);
            
            window.hectareChart.data.labels = data.labels;
            window.hectareChart.data.datasets[0].data = data.hectares;
            window.hectareChart.data.datasets[1].data = data.squareMeters;
            window.hectareChart.data.datasets[2].data = data.meters;
            window.hectareChart.update();
            
            console.log('✅ Hectare chart updated successfully');
            console.log('✅ Chart now shows:', window.hectareChart.data.labels);
        }

        // Sales Chart (Line Graph)
        function initSalesChart() {
            try {
                console.log('🚀 Initializing Sales Chart...');
                
                // Destroy existing chart if it exists
                if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                    console.log('🗑️ Destroying existing sales chart');
                    window.salesChart.destroy();
                    window.salesChart = null;
                }
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.error('❌ Sales chart canvas not found');
                    return;
                }
                console.log('✅ Sales chart canvas found');
                
                const ctx = canvas.getContext('2d');
                
                // Initialize with better default data that shows something is loading
                const initialData = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] // All zeros initially
                };
                
                console.log('📊 Initial chart data (will be updated with real data):', initialData);
                
                window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: initialData.labels,
                    datasets: [{
                        label: 'Sales by Municipality Sellers (₱)',
                        data: initialData.data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent movement
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 40,
                                usePointStyle: false
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 3,
                            hoverRadius: 5
                        },
                        line: {
                            borderWidth: 2
                        }
                    }
                }
            });
            
            console.log('✅ Sales chart initialized successfully');
            console.log('📊 Chart object:', window.salesChart);
            
            // Schedule a refresh after data should be loaded
            setTimeout(() => {
                console.log('🔄 Auto-refreshing sales chart with latest data...');
                if (window.salesChart && analyticsData.sales) {
                    const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                    const currentData = analyticsData.sales[currentFilter];
                    if (currentData && currentData.data && currentData.data.some(val => val > 0)) {
                        console.log('📊 Found real data, updating chart:', currentData);
                        window.salesChart.data.labels = currentData.labels;
                        window.salesChart.data.datasets[0].data = currentData.data;
                        window.salesChart.update('none');
                        console.log('✅ Sales chart auto-refreshed with real data');
                    } else {
                        console.log('📊 No real data yet, keeping placeholder data');
                    }
                }
            }, 5000); // Check after 5 seconds
            
            } catch (error) {
                console.error('❌ Error initializing sales chart:', error);
            }
        }

        // Stocks Chart (Pie Chart)
        function initStocksChart() {
            try {
                // Destroy existing chart if it exists
                if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                    window.stocksChart.destroy();
                    window.stocksChart = null;
                }
                
                const canvas = document.getElementById('stocksChart');
                if (!canvas) {
                    console.warn('⚠️ Stocks chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.stocks.category;
            
            window.stocksChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    // Get current filter view
                                    const currentFilter = document.getElementById('stocksFilter').value;
                                    const label = context.label;
                                    const quantity = context.parsed;
                                    
                                    if (currentFilter === 'status') {
                                        // Status view - show products by status
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${quantity}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${statusProducts.length} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? '🟢' : 
                                                              product.status === 'To be Out of Stock' ? '🟡' : '🔴';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    } else {
                                        // Product name view - show quantity and details for each product
                                        const products = analyticsData.stocks.category.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Quantity: ${quantity}`;
                                        }
                                        
                                        const productItems = products[label];
                                        let tooltipLines = [`${label}: Total ${quantity} units`];
                                        
                                        // Add individual product instance details
                                        productItems.forEach(product => {
                                            const statusColor = product.status === 'Available' ? '🟢' : 
                                                              product.status === 'To be Out of Stock' ? '🟡' : '🔴';
                                            tooltipLines.push(`${statusColor} ${product.status} - ${product.quantity} units (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    }
                                },
                                labelColor: function(context) {
                                    return {
                                        borderColor: context.dataset.backgroundColor[context.dataIndex],
                                        backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                    };
                                }
                            },
                            displayColors: true,
                            bodySpacing: 4,
                            titleSpacing: 6,
                            footerSpacing: 4,
                            bodyFont: {
                                size: 12
                            },
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('❌ Error initializing stocks chart:', error);
            }
        }

        // Status Chart (Separate Pie Chart for Status View)
        function initStatusChart() {
            try {
                // Destroy existing chart if it exists
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                    window.statusChart = null;
                }
                
                const canvas = document.getElementById('statusChart');
                if (!canvas) {
                    console.warn('⚠️ Status chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.stocks.status;
                
                window.statusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        // Status view - show products by status
                                        const label = context.label;
                                        const count = context.parsed;
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? '🟢' : 
                                                              product.status === 'To be Out of Stock' ? '🟡' : '🔴';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    },
                                    labelColor: function(context) {
                                        return {
                                            borderColor: context.dataset.backgroundColor[context.dataIndex],
                                            backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                        };
                                    }
                                },
                                displayColors: true,
                                bodySpacing: 4,
                                titleSpacing: 6,
                                footerSpacing: 4,
                                bodyFont: {
                                    size: 12
                                },
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('❌ Error initializing status chart:', error);
            }
        }

        // Soil Chart (Donut Chart)
        function initSoilChart() {
            try {
                // Destroy existing chart if it exists
                if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                    window.soilChart.destroy();
                    window.soilChart = null;
                }
                
                const canvas = document.getElementById('soilChart');
                if (!canvas) {
                    console.warn('⚠️ Soil chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.soil.type;
            
            window.soilChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            } catch (error) {
                console.error('❌ Error initializing soil chart:', error);
            }
        }

        // Hectare Chart (Bar Chart)
        function initHectareChart() {
            try {
                // Destroy existing chart if it exists
                if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                    window.hectareChart.destroy();
                    window.hectareChart = null;
                }
                
                const canvas = document.getElementById('hectareChart');
                if (!canvas) {
                    console.warn('⚠️ Hectare chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.hectare.monthly;
                
                window.hectareChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: currentData.labels,
                        datasets: [
                            {
                                label: 'Hectares',
                                data: currentData.hectares,
                                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                borderColor: '#28a745',
                                borderWidth: 1
                            },
                            {
                                label: 'Square Meters',
                                data: currentData.squareMeters,
                                backgroundColor: 'rgba(0, 123, 255, 0.8)',
                                borderColor: '#007bff',
                                borderWidth: 1
                            },
                            {
                                label: 'Meters',
                                data: currentData.meters,
                                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                                borderColor: '#ffc107',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        return `${context[0].label} - ${period.charAt(0).toUpperCase() + period.slice(1)} View`;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const datasetLabel = context.dataset.label;
                                        
                                        let unit = '';
                                        if (datasetLabel === 'Hectares') unit = ' ha';
                                        else if (datasetLabel === 'Square Meters') unit = ' m²';
                                        else if (datasetLabel === 'Meters') unit = ' m';
                                        
                                        return `${datasetLabel}: ${value.toFixed(2)}${unit}`;
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                footerColor: '#ccc',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Land Area'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ Hectare chart initialized successfully');
                
            } catch (error) {
                console.error('❌ Error initializing hectare chart:', error);
            }
        }

        // Initialize Crop Insight Chart (Dual Axis: Overproduction & Land Cultivated)
        async function initCropInsightChart() {
            try {
                console.log('=== INITIALIZING CROP INSIGHT CHART (Municipality Filter) ===');
                
                if (cropInsightChart && typeof cropInsightChart.destroy === 'function') {
                    cropInsightChart.destroy();
                    cropInsightChart = null;
                }
                
                const canvas = document.getElementById('cropInsightChart');
                if (!canvas) {
                    console.warn('⚠️ Crop insight chart canvas not found');
                    return;
                }
                
                // Fetch crop yield data from database filtered by municipality
                await updateCropInsightChart('all');
                
            } catch (error) {
                console.error('❌ Error initializing crop insight chart:', error);
            }
        }

        // Update Crop Insight Chart based on filter
        async function updateCropInsightChart(filter) {
            try {
                console.log(`=== UPDATING CROP INSIGHT CHART (${filter}) ===`);
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    return;
                }

                // Get the current sub-admin's municipality from admin_accounts.address
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                const municipalityAddress = currentUser.address;
                
                if (!municipalityAddress) {
                    console.warn('⚠️ No municipality address found for sub-admin');
                    renderCropInsightChart([], filter);
                    return;
                }

                console.log('🏛️ Admin municipality (address):', municipalityAddress);
                console.log('📡 Step 1: Fetching users from this municipality...');

                // Step 1: Get all users from the municipality (users.municipality = admin_accounts.address)
                const { data: municipalityUsers, error: userError } = await supabaseClient
                    .from('users')
                    .select('id, full_name, municipality')
                    .eq('municipality', municipalityAddress);
                
                if (userError) {
                    console.error('❌ Error fetching users:', userError);
                    renderCropInsightChart([], filter);
                    return;
                }

                console.log(`� Found ${municipalityUsers?.length || 0} users in ${municipalityAddress}`);
                
                if (!municipalityUsers || municipalityUsers.length === 0) {
                    console.warn(`⚠️ No users found in municipality: ${municipalityAddress}`);
                    renderCropInsightChart([], filter);
                    return;
                }

                console.log('👥 Sample users:', municipalityUsers.slice(0, 3).map(u => ({
                    id: u.id,
                    name: u.full_name,
                    municipality: u.municipality
                })));

                // Step 2: Get crop yield data for these users only
                const userIds = municipalityUsers.map(u => u.id);
                console.log('� Step 2: Fetching crop yield data for these users...');
                
                const { data: cropData, error: cropError } = await supabaseClient
                    .from('crop_yield_tracker')
                    .select('*')
                    .in('user_id', userIds)
                    .order('created_at', { ascending: false });

                if (cropError) {
                    console.error('❌ Error fetching crop data:', cropError);
                    renderCropInsightChart([], filter);
                    return;
                }

                console.log(`📊 Found ${cropData?.length || 0} crop yield records for users in ${municipalityAddress}`);
                
                if (cropData && cropData.length > 0) {
                    console.log('📊 Sample crop records:', cropData.slice(0, 3).map(c => ({
                        crop: c.crop_name,
                        user_id: c.user_id,
                        land_cultivated: c.land_cultivated,
                        land_unit: c.land_unit,
                        total_tons: c.total_tons,
                        overproduction: c.overproduction
                    })));
                    
                    renderCropInsightChart(cropData, filter);
                } else {
                    console.log(`⚠️ No crop data available for users in ${municipalityAddress}`);
                    renderCropInsightChart([], filter);
                }

            } catch (error) {
                console.error('❌ Error updating crop insight chart:', error);
                renderCropInsightChart([], filter);
            }
        }

        // Render Crop Insight Chart
        function renderCropInsightChart(cropData, filter) {
            try {
                console.log('🎨 RENDERING CROP INSIGHT CHART');
                console.log('Data received:', cropData?.length || 0, 'records');
                console.log('Filter:', filter);
                
                // Destroy existing chart
                if (cropInsightChart && typeof cropInsightChart.destroy === 'function') {
                    cropInsightChart.destroy();
                }

                const canvas = document.getElementById('cropInsightChart');
                if (!canvas) {
                    console.error('❌ Crop insight chart canvas not found!');
                    return;
                }

                console.log('✅ Canvas element found');

                const ctx = canvas.getContext('2d');

                // Aggregate data by crop name
                const cropAggregates = {};
                cropData.forEach(item => {
                    const cropName = item.crop_name || 'Unknown';
                    if (!cropAggregates[cropName]) {
                        cropAggregates[cropName] = {
                            totalHarvest: 0,
                            overproduction: 0,
                            landCultivated: 0,
                            landCultivatedOriginal: 0,
                            landUnit: item.land_unit || 'ha',
                            count: 0
                        };
                    }
                    
                    const totalTons = parseFloat(item.total_tons || 0);
                    const overproductionTons = parseFloat(item.overproduction || 0);
                    const sellableTons = parseFloat(item.shop_sellable_tons || 0);
                    
                    // Calculate actual harvest (total - overproduction = sellable/usable harvest)
                    const actualHarvest = sellableTons > 0 ? sellableTons : (totalTons - overproductionTons);
                    
                    // Store original land value for display
                    const landValue = parseFloat(item.land_cultivated || item.hectares || 0);
                    
                    cropAggregates[cropName].totalHarvest += actualHarvest;
                    cropAggregates[cropName].overproduction += overproductionTons;
                    cropAggregates[cropName].landCultivated += landValue;
                    cropAggregates[cropName].landCultivatedOriginal += landValue;
                    cropAggregates[cropName].count += 1;
                });

                console.log('📊 Aggregated crops:', Object.keys(cropAggregates).length);

                // Convert to array and sort
                let cropsArray = Object.keys(cropAggregates).map(cropName => ({
                    crop: cropName,
                    harvest: cropAggregates[cropName].totalHarvest,
                    overproduction: cropAggregates[cropName].overproduction,
                    landCultivated: cropAggregates[cropName].landCultivated,
                    landUnit: cropAggregates[cropName].landUnit
                }));

                // Apply filter
                if (filter === 'overproduced') {
                    cropsArray = cropsArray.filter(c => c.overproduction > 0);
                    console.log(`Filtered to ${cropsArray.length} overproduced crops`);
                } else if (filter === 'top10') {
                    cropsArray = cropsArray.sort((a, b) => (b.harvest + b.overproduction) - (a.harvest + a.overproduction)).slice(0, 10);
                    console.log(`Showing top 10 crops`);
                }

                // If no data, show empty chart with message
                if (cropsArray.length === 0) {
                    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                    console.warn(`⚠️ No crop data available for ${currentUser.address || 'this municipality'}`);
                    
                    // Clear existing chart and show no data message
                    if (cropInsightChart && typeof cropInsightChart.destroy === 'function') {
                        cropInsightChart.destroy();
                    }
                    
                    // Display "No Data Available" message on canvas
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.font = '16px Arial';
                    ctx.fillStyle = '#6c757d';
                    ctx.textAlign = 'center';
                    ctx.fillText('No crop data available for this municipality', canvas.width / 2, canvas.height / 2);
                    
                    console.log('📌 Displayed "No Data" message');
                    return;
                }

                console.log(`📈 Rendering ${cropsArray.length} crops on chart`);

                const labels = cropsArray.map(c => c.crop);
                const harvestData = cropsArray.map(c => c.harvest);
                const overproductionData = cropsArray.map(c => c.overproduction);
                const landCultivatedData = cropsArray.map(c => c.landCultivated);
                const landUnits = cropsArray.map(c => c.landUnit);
                
                // Store data globally for export
                currentCropInsightData = {
                    labels: labels,
                    harvest: harvestData,
                    overproduction: overproductionData,
                    landCultivated: landCultivatedData,
                    landUnits: landUnits,
                    fullData: cropsArray
                };
                
                console.log('💾 Stored crop insight data for export:', {
                    crops: labels.length,
                    sampleData: currentCropInsightData.fullData.slice(0, 2)
                });

                // Store landUnits globally for tooltip access
                window.cropInsightLandUnits = landUnits;
                console.log('🔵 Global landUnits stored:', window.cropInsightLandUnits);
                
                // Create stacked bar chart with line overlay
                cropInsightChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Harvested (tons)',
                                data: harvestData,
                                backgroundColor: 'rgba(40, 167, 69, 0.8)',
                                borderColor: '#28a745',
                                borderWidth: 2,
                                yAxisID: 'y',
                                stack: 'Stack 0'
                            },
                            {
                                label: 'Overproduction (tons)',
                                data: overproductionData,
                                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                                borderColor: '#ffc107',
                                borderWidth: 2,
                                yAxisID: 'y',
                                stack: 'Stack 0'
                            },
                            {
                                label: 'Land Cultivated',
                                data: landCultivatedData,
                                type: 'line',
                                borderColor: '#007bff',
                                backgroundColor: 'rgba(0, 123, 255, 0.1)',
                                borderWidth: 3,
                                fill: false,
                                yAxisID: 'y1',
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#007bff',
                                pointBorderColor: '#fff',
                                pointBorderWidth: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Crop Production Analysis - Municipality View',
                                font: { size: 16, weight: 'bold' }
                            },
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    usePointStyle: true,
                                    padding: 15
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return `🌾 ${context[0].label}`;
                                    },
                                    label: function(context) {
                                        const datasetLabel = context.dataset.label;
                                        const value = context.parsed.y;
                                        
                                        if (datasetLabel === 'Land Cultivated') {
                                            const idx = context.dataIndex;
                                            const unit = window.cropInsightLandUnits?.[idx] || 'ha';
                                            return `${datasetLabel}: ${value.toFixed(2)} ${unit}`;
                                        } else {
                                            return `${datasetLabel}: ${value.toFixed(2)} tons`;
                                        }
                                    },
                                    footer: function(context) {
                                        const idx = context[0].dataIndex;
                                        const harvest = harvestData[idx] || 0;
                                        const overproduction = overproductionData[idx] || 0;
                                        const total = harvest + overproduction;
                                        const efficiency = total > 0 ? ((harvest / total) * 100).toFixed(1) : 0;
                                        return `\nTotal: ${total.toFixed(2)} tons\nEfficiency: ${efficiency}%`;
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                footerColor: '#ffc107',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                padding: 12,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                beginAtZero: true,
                                stacked: true,
                                title: {
                                    display: true,
                                    text: 'Production (tons)',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value) {
                                        return value.toFixed(0) + ' t';
                                    }
                                },
                                grid: {
                                    color: 'rgba(0, 0, 0, 0.05)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Land Area',
                                    font: { size: 14, weight: 'bold' }
                                },
                                ticks: {
                                    callback: function(value, index) {
                                        const unit = window.cropInsightLandUnits?.[index] || 'ha';
                                        return value.toFixed(0) + ' ' + unit;
                                    }
                                },
                                grid: {
                                    drawOnChartArea: false
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                },
                                ticks: {
                                    maxRotation: 45,
                                    minRotation: 45
                                }
                            }
                        }
                    }
                });
                
                console.log('✅ Crop insight chart rendered successfully');
                
            } catch (error) {
                console.error('❌ Error rendering crop insight chart:', error);
            }
        }

        // Filter Functions
        function updateSalesChart(period) {
            try {
                if (!window.salesChart || !window.salesChart.data) {
                    console.warn('⚠️ Sales chart not initialized yet');
                    return;
                }
                
                const data = analyticsData.sales[period];
                if (!data || !data.labels || !data.data) {
                    console.warn('⚠️ No sales data available for period:', period);
                    return;
                }
                
                window.salesChart.data.labels = data.labels;
                window.salesChart.data.datasets[0].data = data.data;
                window.salesChart.update();
                console.log('✅ Sales chart updated for period:', period);
            } catch (error) {
                console.error('❌ Error updating sales chart:', error);
            }
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            soilChart.data.labels = data.labels;
            soilChart.data.datasets[0].data = data.data;
            soilChart.data.datasets[0].backgroundColor = data.colors;
            soilChart.update();
        }


        // Event Listeners
        // Event Listeners for Filters
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Initialize charts
            if (typeof Chart !== 'undefined') {
                initializeCharts();
                
                // Load real data after charts are initialized
                setTimeout(() => {
                    console.log('🔄 Loading analytics after charts initialization...');
                    window.loadMunicipalityAnalytics();
                }, 2000);
            }
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('🔍 Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('🔄 Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
                
                // Load municipality users for User Management table
                setTimeout(() => {
                    console.log('🔄 Loading municipality users...');
                    // Check if DOM elements are ready
                    const tableBody = document.getElementById('usersTableBody');
                    if (!tableBody) {
                        console.warn('⚠️ User table not ready, retrying in 2 seconds...');
                        setTimeout(() => {
                            window.loadMunicipalityUsers();
                        }, 2000);
                    } else {
                        window.loadMunicipalityUsers();
                    }
                }, 1500);
            }, 3000); // Increased timeout to 3 seconds
            
            // Add event listeners for filters
            const salesFilter = document.getElementById('salesFilter');
            if (salesFilter) {
                salesFilter.addEventListener('change', function() {
                    updateSalesChart(this.value);
                });
            }

            const stocksFilter = document.getElementById('stocksFilter');
            if (stocksFilter) {
                stocksFilter.addEventListener('change', function() {
                    updateStocksChart(this.value);
                });
            }

            const soilFilter = document.getElementById('soilFilter');
            if (soilFilter) {
                soilFilter.addEventListener('change', function() {
                    updateSoilChart(this.value);
                });
            }

            const hectareFilter = document.getElementById('hectareFilter');
            if (hectareFilter) {
                hectareFilter.addEventListener('change', function() {
                    updateHectareChart(this.value);
                });
            }
        });

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                sales: salesChart,
                stocks: stocksChart,
                soil: soilChart,
                hectare: hectareChart,
                cropInsight: cropInsightChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_municipality_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
                case 'picture':
                    exportToPicture(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = 'Label,Value\n';
            let data;
            
            switch(chartType) {
                case 'sales':
                    data = analyticsData.sales.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'stocks':
                    // Check which filter view is active
                    const stocksFilter = document.getElementById('stocksFilter')?.value || 'category';
                    
                    if (stocksFilter === 'status') {
                        // Export status view with detailed product information
                        csv = 'Product Name,Stocks,Status,Category\n';
                        data = analyticsData.stocks.status;
                        
                        // Get all products from status view
                        const statusLabels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                        statusLabels.forEach(status => {
                            if (data.products && data.products[status]) {
                                data.products[status].forEach(product => {
                                    csv += `${product.name},${product.quantity},${product.status},${product.category}\n`;
                                });
                            }
                        });
                    } else {
                        // Export product name view with detailed information
                        csv = 'Product Name,Stocks,Status,Category\n';
                        data = analyticsData.stocks.category;
                        
                        // Get all products from category (which is now product name) view
                        if (data.products) {
                            Object.keys(data.products).forEach(productName => {
                                data.products[productName].forEach(product => {
                                    csv += `${product.name},${product.quantity},${product.status},${product.category}\n`;
                                });
                            });
                        }
                    }
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'hectare':
                    const currentFilter = document.getElementById('hectareFilter')?.value || 'monthly';
                    data = analyticsData.hectare[currentFilter];
                    csv = 'Period,Hectares,Square Meters,Meters\n';
                    data.labels.forEach((label, index) => {
                        const hectares = data.hectares[index] || 0;
                        const squareMeters = data.squareMeters[index] || 0;
                        const meters = data.meters[index] || 0;
                        csv += `${label},${hectares},${squareMeters},${meters}\n`;
                    });
                    break;
                case 'cropInsight':
                    if (currentCropInsightData && currentCropInsightData.fullData) {
                        csv = 'Crop Name,Harvested (tons),Overproduction (tons),Land Cultivated,Land Unit\n';
                        currentCropInsightData.fullData.forEach(crop => {
                            csv += `${crop.crop},${crop.harvest.toFixed(2)},${crop.overproduction.toFixed(2)},${crop.landCultivated.toFixed(2)},${crop.landUnit}\n`;
                        });
                    }
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Set document properties
            let yPosition = 20;
            const pageWidth = doc.internal.pageSize.getWidth();
            const leftMargin = 15;
            const rightMargin = 15;
            const contentWidth = pageWidth - leftMargin - rightMargin;
            
            // Get municipality info
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
            const municipalityName = currentUser?.address || 'Not specified';
            
            // Title
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text(`Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report`, leftMargin, yPosition);
            yPosition += 10;
            
            // Report info
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');
            doc.text(`Municipality: ${municipalityName}`, leftMargin, yPosition);
            yPosition += 7;
            doc.text(`Report Generated: ${new Date().toLocaleDateString('en-PH', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}`, leftMargin, yPosition);
            yPosition += 7;
            doc.text(`Period: ${document.getElementById(chartType + 'Filter')?.value || 'Monthly'}`, leftMargin, yPosition);
            yPosition += 7;
            doc.text(`Chart Type: ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}`, leftMargin, yPosition);
            yPosition += 15;
            
            // Generate data table based on chart type
            if (chartType === 'sales' && analyticsData && analyticsData.sales) {
                const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                const currentData = analyticsData.sales[currentFilter];
                
                if (currentData && currentData.labels && currentData.data) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Sales Data Table - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View`, leftMargin, yPosition);
                    yPosition += 10;
                    
                    const headers = [['Period', 'Sales Amount (PHP)']];
                    const data = [];
                    let total = 0;
                    
                    currentData.labels.forEach((label, index) => {
                        const value = currentData.data[index] || 0;
                        total += value;
                        const formattedValue = new Intl.NumberFormat('en-PH', {
                            style: 'currency',
                            currency: 'PHP',
                            minimumFractionDigits: 2
                        }).format(value);
                        data.push([label, formattedValue]);
                    });
                    
                    const formattedTotal = new Intl.NumberFormat('en-PH', {
                        style: 'currency',
                        currency: 'PHP',
                        minimumFractionDigits: 2
                    }).format(total);
                    data.push(['Total', formattedTotal]);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin }
                    });
                }
            } else if (chartType === 'soil') {
                const soilData = analyticsData.soil.type;
                
                if (soilData && soilData.labels && soilData.data) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Soil Analytics Data Table', leftMargin, yPosition);
                    yPosition += 10;
                    
                    const headers = [['Soil Type', 'Count']];
                    const data = [];
                    let total = 0;
                    
                    soilData.labels.forEach((label, index) => {
                        const value = soilData.data[index] || 0;
                        total += value;
                        data.push([label, value.toString()]);
                    });
                    
                    data.push(['Total', total.toString()]);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin }
                    });
                }
            } else if (chartType === 'hectare') {
                const currentFilter = document.getElementById('hectareFilter')?.value || 'monthly';
                const hectareData = analyticsData.hectare[currentFilter];
                
                if (hectareData && hectareData.labels && hectareData.hectares) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text(`Land Area Analytics - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View`, leftMargin, yPosition);
                    yPosition += 10;
                    
                    const headers = [['Period', 'Hectares (ha)', 'Square Meters (m²)', 'Meters (m)']];
                    const data = [];
                    let totalHectares = 0;
                    let totalSquareMeters = 0;
                    let totalMeters = 0;
                    
                    hectareData.labels.forEach((label, index) => {
                        const hectares = hectareData.hectares[index] || 0;
                        const squareMeters = hectareData.squareMeters[index] || 0;
                        const meters = hectareData.meters[index] || 0;
                        
                        totalHectares += hectares;
                        totalSquareMeters += squareMeters;
                        totalMeters += meters;
                        
                        data.push([
                            label,
                            hectares.toFixed(2) + ' ha',
                            squareMeters.toFixed(2) + ' m²',
                            meters.toFixed(2) + ' m'
                        ]);
                    });
                    
                    data.push([
                        'Total',
                        totalHectares.toFixed(2) + ' ha',
                        totalSquareMeters.toFixed(2) + ' m²',
                        totalMeters.toFixed(2) + ' m'
                    ]);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin },
                        styles: { fontSize: 9 }
                    });
                }
            } else if (chartType === 'stocks') {
                const stocksFilter = document.getElementById('stocksFilter');
                const currentView = stocksFilter ? stocksFilter.value : 'category';
                const stocksData = analyticsData.stocks[currentView];
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(`Stocks Analytics - ${currentView === 'status' ? 'Status' : 'Product Name'} View`, leftMargin, yPosition);
                yPosition += 10;
                
                if (currentView === 'status' && stocksData && stocksData.products) {
                    const headers = [['Product Name', 'Stocks', 'Status', 'Category']];
                    const data = [];
                    let totalStocks = 0;
                    const statusLabels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                    
                    statusLabels.forEach(status => {
                        if (stocksData.products[status]) {
                            stocksData.products[status].forEach(product => {
                                totalStocks += parseInt(product.quantity) || 0;
                                data.push([
                                    product.name,
                                    product.quantity.toString(),
                                    product.status,
                                    product.category
                                ]);
                            });
                        }
                    });
                    
                    data.push(['Total Stocks', totalStocks.toString(), '', '']);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin },
                        styles: { fontSize: 9 }
                    });
                } else if (currentView === 'category' && stocksData && stocksData.products) {
                    const headers = [['Product Name', 'Stocks', 'Status', 'Category']];
                    const data = [];
                    let totalStocks = 0;
                    
                    Object.keys(stocksData.products).forEach(productName => {
                        stocksData.products[productName].forEach(product => {
                            totalStocks += parseInt(product.quantity) || 0;
                            data.push([
                                product.name,
                                product.quantity.toString(),
                                product.status,
                                product.category
                            ]);
                        });
                    });
                    
                    data.push(['Total Stocks', totalStocks.toString(), '', '']);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin },
                        styles: { fontSize: 9 }
                    });
                }
            } else if (chartType === 'cropInsight') {
                if (currentCropInsightData && currentCropInsightData.fullData) {
                    doc.setFontSize(14);
                    doc.setFont(undefined, 'bold');
                    doc.text('Crop Insight Data Table', leftMargin, yPosition);
                    yPosition += 10;
                    
                    const headers = [['Crop Name', 'Harvested (tons)', 'Overproduction (tons)', 'Land Cultivated', 'Unit']];
                    const data = [];
                    let totalHarvest = 0;
                    let totalOverproduction = 0;
                    
                    currentCropInsightData.fullData.forEach(crop => {
                        totalHarvest += crop.harvest;
                        totalOverproduction += crop.overproduction;
                        
                        data.push([
                            crop.crop,
                            crop.harvest.toFixed(2),
                            crop.overproduction.toFixed(2),
                            crop.landCultivated.toFixed(2),
                            crop.landUnit
                        ]);
                    });
                    
                    const totalProduction = totalHarvest + totalOverproduction;
                    data.push([
                        'Total',
                        totalHarvest.toFixed(2),
                        totalOverproduction.toFixed(2),
                        `Total: ${totalProduction.toFixed(2)} tons`,
                        ''
                    ]);
                    
                    doc.autoTable({
                        startY: yPosition,
                        head: headers,
                        body: data,
                        theme: 'grid',
                        headStyles: { fillColor: [40, 167, 69], textColor: 255, fontStyle: 'bold' },
                        footStyles: { fillColor: [233, 236, 239], textColor: 0, fontStyle: 'bold' },
                        margin: { left: leftMargin, right: rightMargin },
                        styles: { fontSize: 9 }
                    });
                }
            }
            
            // Footer
            const finalY = doc.autoTable.previous ? doc.autoTable.previous.finalY + 15 : yPosition + 20;
            doc.setFontSize(9);
            doc.setTextColor(108, 117, 125);
            doc.text('This report was automatically generated by the Anihan Municipality Dashboard.', leftMargin, finalY);
            
            doc.save(filename + '.pdf');
        }

        function exportToWord(chartType, filename) {
            console.log('📝 Exporting to Word:', chartType);
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Prepare data table HTML based on chart type
                    let dataTableHTML = '';
                    let municipalityName = '';
                    
                    // Get current user municipality from sessionStorage
                    const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                    if (currentUser && currentUser.address) {
                        municipalityName = currentUser.address;
                    }
                    
                    console.log('📍 Municipality for export:', municipalityName);
                    
                    if (chartType === 'sales' && analyticsData && analyticsData.sales) {
                        console.log('📊 Processing sales data for Word export...');
                        const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                        const currentData = analyticsData.sales[currentFilter];
                        
                        if (currentData && currentData.labels && currentData.data) {
                            dataTableHTML = `
                                <h2>Sales Data Table - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Sales Amount (PHP)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            currentData.labels.forEach((label, index) => {
                                const value = currentData.data[index] || 0;
                                const formattedValue = new Intl.NumberFormat('en-PH', {
                                    style: 'currency',
                                    currency: 'PHP',
                                    minimumFractionDigits: 2
                                }).format(value);
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedValue}</td>
                                    </tr>
                                `;
                            });
                            
                            // Calculate total
                            const total = currentData.data.reduce((sum, value) => sum + (value || 0), 0);
                            const formattedTotal = new Intl.NumberFormat('en-PH', {
                                style: 'currency',
                                currency: 'PHP',
                                minimumFractionDigits: 2
                            }).format(total);
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedTotal}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            dataTableHTML = `<p><em>No sales data available for ${currentFilter} view.</em></p>`;
                        }
                    } else if (chartType === 'soil') {
                        console.log('🌱 Processing soil data for Word export...');
                        // Use analyticsData.soil.type which gets updated from database
                        const soilData = analyticsData.soil.type;
                        console.log('Soil data for export:', soilData);
                        
                        if (soilData && soilData.labels && soilData.data) {
                            dataTableHTML = `
                                <h2>Soil Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Soil Type</th>
                                            <th style="padding: 10px; text-align: right;">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            soilData.labels.forEach((label, index) => {
                                const value = soilData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('⚠️ Soil data not available for Word export');
                            dataTableHTML = `<p><em>No soil data available for export.</em></p>`;
                        }
                    } else if (chartType === 'hectare') {
                        console.log('📊 Processing hectare data for Word export...');
                        // Use analyticsData.hectare with current filter
                        const currentFilter = document.getElementById('hectareFilter')?.value || 'monthly';
                        const hectareData = analyticsData.hectare[currentFilter];
                        console.log('Hectare data for export:', hectareData);
                        
                        if (hectareData && hectareData.labels && hectareData.hectares) {
                            dataTableHTML = `
                                <h2>Land Area Analytics Data Table - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Hectares (ha)</th>
                                            <th style="padding: 10px; text-align: right;">Square Meters (m²)</th>
                                            <th style="padding: 10px; text-align: right;">Meters (m)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let totalHectares = 0;
                            let totalSquareMeters = 0;
                            let totalMeters = 0;
                            
                            hectareData.labels.forEach((label, index) => {
                                const hectares = hectareData.hectares[index] || 0;
                                const squareMeters = hectareData.squareMeters[index] || 0;
                                const meters = hectareData.meters[index] || 0;
                                
                                totalHectares += hectares;
                                totalSquareMeters += squareMeters;
                                totalMeters += meters;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${hectares.toFixed(2)} ha</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${squareMeters.toFixed(2)} m²</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${meters.toFixed(2)} m</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalHectares.toFixed(2)} ha</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalSquareMeters.toFixed(2)} m²</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalMeters.toFixed(2)} m</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('⚠️ Hectare data not available for Word export');
                            dataTableHTML = `<p><em>No hectare data available for export.</em></p>`;
                        }
                    } else if (chartType === 'stocks') {
                        console.log('📦 Processing stocks data for Word export...');
                        // Use the current stocks filter to determine which data to show
                        const stocksFilter = document.getElementById('stocksFilter');
                        const currentView = stocksFilter ? stocksFilter.value : 'category';
                        const stocksData = analyticsData.stocks[currentView];
                        
                        if (currentView === 'status' && stocksData && stocksData.products) {
                            // Status view - show detailed product list with status
                            dataTableHTML = `
                                <h2>Stocks Analytics Data Table (Status View)</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Product Name</th>
                                            <th style="padding: 10px; text-align: right;">Stocks</th>
                                            <th style="padding: 10px; text-align: center;">Status</th>
                                            <th style="padding: 10px; text-align: left;">Category</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let totalStocks = 0;
                            const statusLabels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                            
                            statusLabels.forEach(status => {
                                if (stocksData.products[status]) {
                                    stocksData.products[status].forEach(product => {
                                        totalStocks += parseInt(product.quantity) || 0;
                                        const statusColor = status === 'Available' ? '#28a745' : 
                                                          status === 'To be Out of Stock' ? '#ffc107' : '#dc3545';
                                        
                                        dataTableHTML += `
                                            <tr>
                                                <td style="padding: 10px; border: 1px solid #ddd;">${product.name}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${product.quantity}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${product.status}</td>
                                                <td style="padding: 10px; border: 1px solid #ddd;">${product.category}</td>
                                            </tr>
                                        `;
                                    });
                                }
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total Stocks</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalStocks}</td>
                                            <td colspan="2" style="padding: 10px; border: 1px solid #ddd;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else if (currentView === 'category' && stocksData && stocksData.products) {
                            // Product name view - show detailed product list
                            dataTableHTML = `
                                <h2>Stocks Analytics Data Table (Product Name View)</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Product Name</th>
                                            <th style="padding: 10px; text-align: right;">Stocks</th>
                                            <th style="padding: 10px; text-align: center;">Status</th>
                                            <th style="padding: 10px; text-align: left;">Category</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let totalStocks = 0;
                            Object.keys(stocksData.products).forEach(productName => {
                                stocksData.products[productName].forEach(product => {
                                    totalStocks += parseInt(product.quantity) || 0;
                                    const statusColor = product.status === 'Available' ? '#28a745' : 
                                                      product.status === 'To be Out of Stock' ? '#ffc107' : '#dc3545';
                                    
                                    dataTableHTML += `
                                        <tr>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${product.name}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${product.quantity}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: center; color: ${statusColor}; font-weight: bold;">${product.status}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd;">${product.category}</td>
                                        </tr>
                                    `;
                                });
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total Stocks</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalStocks}</td>
                                            <td colspan="2" style="padding: 10px; border: 1px solid #ddd;"></td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('⚠️ Stocks data not available for Word export');
                            dataTableHTML = `<p><em>No stocks data available for export.</em></p>`;
                        }
                    } else if (chartType === 'cropInsight') {
                        console.log('🌾 Processing crop insight data for Word export...');
                        
                        if (currentCropInsightData && currentCropInsightData.fullData) {
                            dataTableHTML = `
                                <h2>Crop Insight Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Crop Name</th>
                                            <th style="padding: 10px; text-align: right;">Harvested (tons)</th>
                                            <th style="padding: 10px; text-align: right;">Overproduction (tons)</th>
                                            <th style="padding: 10px; text-align: right;">Land Cultivated</th>
                                            <th style="padding: 10px; text-align: center;">Unit</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let totalHarvest = 0;
                            let totalOverproduction = 0;
                            
                            currentCropInsightData.fullData.forEach(crop => {
                                totalHarvest += crop.harvest;
                                totalOverproduction += crop.overproduction;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${crop.crop}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${crop.harvest.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${crop.overproduction.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${crop.landCultivated.toFixed(2)}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: center;">${crop.landUnit}</td>
                                    </tr>
                                `;
                            });
                            
                            const totalProduction = totalHarvest + totalOverproduction;
                            const efficiency = totalProduction > 0 ? ((totalHarvest / totalProduction) * 100).toFixed(1) : 0;
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalHarvest.toFixed(2)}</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${totalOverproduction.toFixed(2)}</td>
                                            <td colspan="2" style="padding: 10px; border: 1px solid #ddd; text-align: center;">Total: ${totalProduction.toFixed(2)} tons</td>
                                        </tr>
                                        <tr style="background-color: #d1ecf1;">
                                            <td colspan="2" style="padding: 10px; border: 1px solid #ddd; font-weight: bold;">Production Efficiency</td>
                                            <td colspan="3" style="padding: 10px; border: 1px solid #ddd; text-align: center; font-weight: bold;">${efficiency}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('⚠️ Crop insight data not available for Word export');
                            dataTableHTML = `<p><em>No crop insight data available for export.</em></p>`;
                        }
                    } else {
                        console.warn('⚠️ Chart data not available for:', chartType);
                        dataTableHTML = `<p><em>No data available for ${chartType} chart.</em></p>`;
                    }
                    
                    const content = `
                        <html>
                        <head>
                            <title>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
                                h2 { color: #495057; margin-top: 30px; }
                                .report-info { background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; }
                                .chart-container { text-align: center; margin: 30px 0; }
                                table { font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <h1>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            
                            <div class="report-info">
                                <strong>Municipality:</strong> ${municipalityName || 'Not specified'}<br>
                                <strong>Report Generated:</strong> ${new Date().toLocaleDateString('en-PH', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}<br>
                                <strong>Period:</strong> ${document.getElementById(chartType + 'Filter')?.value || 'Monthly'}<br>
                                <strong>Chart Type:</strong> ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}
                            </div>
                            
                            <div class="chart-container">
                                <h2>Chart Visualization</h2>
                                <img src="${imgData}" style="max-width: 100%; border: 1px solid #ddd; padding: 10px;" />
                            </div>
                            
                            ${dataTableHTML}
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #6c757d;">
                                <p>This report was automatically generated by the Anihan Municipality Dashboard.</p>
                            </div>
                        </body>
                        </html>
                    `;
                    const blob = new Blob([content], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function exportToPicture(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Mobile sidebar functions
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
            
            // Prevent body scrolling when sidebar is open
            if (sidebar.classList.contains('mobile-open')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Load municipality-specific users for User Management table
        window.loadMunicipalityUsers = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('❌ Supabase client not available');
                    updateUserTable([], 'Database connection not available');
                    return;
                }
                
                // Get current admin user
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (!currentUser.id) {
                    console.log('❌ No current user found');
                    updateUserTable([], 'User not logged in');
                    return;
                }
                
                // Get Sub Admin's municipality/address
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError || !adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('ℹ️ Not a Sub Admin or no address');
                    updateUserTable([], 'Access restricted to Sub Admins');
                    return;
                }
                
                const municipalityAddress = adminData.address;
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('❌ No municipality address found');
                    updateUserTable([], 'No municipality assigned');
                    return;
                }
                
                console.log('🔍 Loading users for municipality:', municipalityAddress);
                
                // Get users from the same municipality
                const { data: users, error: usersError } = await client
                    .from('users')
                    .select('full_name, email, phone_number, municipality, address')
                    .eq('municipality', municipalityAddress)
                    .order('full_name', { ascending: true });
                
                if (usersError) {
                    console.error('❌ Error fetching users:', usersError);
                    updateUserTable([], 'Error loading users');
                    return;
                }
                
                console.log(`✅ Found ${users ? users.length : 0} users in ${municipalityAddress}`);
                console.log('🔍 User details:', users);
                
                updateUserTable(users || [], null, municipalityAddress);
                
            } catch (error) {
                console.error('❌ Error in loadMunicipalityUsers:', error);
                updateUserTable([], 'Error loading users');
            }
        }
        
        // Pagination variables
        let currentUserPage = 1;
        let allMunicipalityUsers = [];
        
        // Update User Management table with real data
        function updateUserTable(users, errorMessage, municipality) {
            const tableBody = document.getElementById('usersTableBody');
            const viewAllLink = document.getElementById('viewAllUsersLink');
            
            if (!tableBody) {
                console.warn('⚠️ User table element (usersTableBody) not found. Retrying in 1 second...');
                setTimeout(() => updateUserTable(users, errorMessage, municipality), 1000);
                return;
            }
            
            console.log('✅ User table elements found, updating table...');
            
            // Store users for pagination
            allMunicipalityUsers = users;
            currentUserPage = 1;
            
            if (errorMessage) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${errorMessage}
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-users me-2"></i>
                            No users found in ${municipality || 'this municipality'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log(`📊 Displaying ${users.length} users from ${municipality}`);
            
            // Update view all link
            if (viewAllLink) {
                viewAllLink.textContent = `View all ${users.length} users >`;
            }
            
            // Display paginated users
            displayUsersPage(currentUserPage);
        }
        
        // Display users for current page
        function displayUsersPage(page) {
            const tableBody = document.getElementById('usersTableBody');
            const currentPageBtn = document.getElementById('currentPageBtn');
            const tableInfo = document.getElementById('usersTableInfo');
            
            if (!tableBody) {
                console.warn('⚠️ User table element not found in displayUsersPage');
                return;
            }
            
            console.log(`📄 Displaying page ${page} of users`);
            
            const startIndex = (page - 1) * 10; // Use 10 for the existing pagination system
            const endIndex = startIndex + 10;
            const pageUsers = allMunicipalityUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No users on this page
                        </td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }
            
            tableBody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>${user.full_name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                </tr>
            `).join('');
            
            console.log(`✅ Successfully displayed ${pageUsers.length} users on page ${page}`);
            
            // Update pagination info
            if (currentPageBtn) {
                currentPageBtn.textContent = page;
            }
            
            // Update table info
            if (tableInfo) {
                const startItem = startIndex + 1;
                const endItem = Math.min(endIndex, allMunicipalityUsers.length);
                tableInfo.textContent = `${startItem} to ${endItem} items of ${allMunicipalityUsers.length}`;
            }
            
            console.log(`📄 Displaying page ${page}: ${pageUsers.length} users`);
        }
        
        // Pagination function
        function changePage(direction) {
            const totalPages = Math.ceil(allMunicipalityUsers.length / 10); // Use 10 for consistency
            const newPage = currentUserPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentUserPage = newPage;
                displayUsersPage(currentUserPage);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Modal and User Management Functions
        function showAllUsersModal() {
            const modal = new bootstrap.Modal(document.getElementById('allUsersModal'));
            modal.show();
            // Use the filtered municipality users instead of loading all users
            loadMunicipalityUsersForModal();
        }

        // Function to load municipality users for the modal (same data as main table)
        function loadMunicipalityUsersForModal() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS FOR MODAL ===');
                
                // Use the existing filtered municipality users
                if (allMunicipalityUsers && allMunicipalityUsers.length > 0) {
                    console.log('✅ Using existing municipality users data:', allMunicipalityUsers);
                    updateAllUsersTable(allMunicipalityUsers);
                } else {
                    console.log('⚠️ No municipality users data available');
                    updateAllUsersTable([]);
                }

            } catch (error) {
                console.error('Error in loadMunicipalityUsersForModal:', error);
                updateAllUsersTable([]);
            }
        }

        // Function to update the all users modal table
        function updateAllUsersTable(users) {
            const tableBody = document.getElementById('allUsersTableBody');
            const usersCount = document.getElementById('allUsersCount');
            const modalTitle = document.getElementById('allUsersModalLabel');
            
            if (!tableBody) {
                console.error('❌ All users table body not found');
                return;
            }

            // Update modal title to reflect municipality users
            if (modalTitle) {
                modalTitle.textContent = 'All Municipality Users';
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No users found in this municipality</td>
                    </tr>
                `;
                if (usersCount) {
                    usersCount.textContent = '0 users found';
                }
                return;
            }

            // Populate table with user data (simplified to match main table)
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.full_name || user.name || user.email || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || user.phone || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update count
            if (usersCount) {
                usersCount.textContent = `${users.length} users found`;
            }

            console.log('✅ All municipality users modal table updated with', users.length, 'users');
            
            // Store users data for search functionality
            window.allUsersData = users;
            setupUserSearch();
        }

        // Function to setup user search functionality
        function setupUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!window.allUsersData) return;

                const filteredUsers = window.allUsersData.filter(user => {
                    const name = (user.full_name || user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const phone = (user.phone_number || user.phone || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           email.includes(searchTerm) || 
                           phone.includes(searchTerm);
                });

                updateAllUsersTable(filteredUsers);
            });
        }

        // Debug function to test sales data loading
        window.debugSalesData = async function() {
            console.log('🐛 DEBUG: Testing sales data loading...');
            
            const client = window.supabaseClient || supabaseClient;
            if (!client) {
                console.error('❌ No Supabase client available');
                return;
            }
            
            console.log('✅ Supabase client available');
            
            // Test 1: Check store-owner table
            console.log('🧪 Test 1: Checking store-owner table...');
            const { data: sellers, error: sellersError } = await client
                .from('store-owner')
                .select('*')
                .limit(5);
            
            if (sellersError) {
                console.error('❌ Error accessing store-owner table:', sellersError);
            } else {
                console.log('✅ store-owner table accessible, sample data:', sellers);
            }
            
            // Test 2: Check users table
            console.log('🧪 Test 2: Checking users table...');
            const { data: users, error: usersError } = await client
                .from('users')
                .select('id, full_name, municipality')
                .limit(5);
            
            if (usersError) {
                console.error('❌ Error accessing users table:', usersError);
            } else {
                console.log('✅ users table accessible, sample data:', users);
            }
            
            // Test 3: Check orders table
            console.log('🧪 Test 3: Checking orders table...');
            const { data: orders, error: ordersError } = await client
                .from('orders')
                .select('id, user_id, total, created_at')
                .not('total', 'is', null)
                .limit(5);
            
            if (ordersError) {
                console.error('❌ Error accessing orders table:', ordersError);
            } else {
                console.log('✅ orders table accessible, sample data:', orders);
            }
            
            // Test 4: Manual data loading
            if (sellers && users && orders) {
                console.log('🧪 Test 4: Manual sales analytics loading...');
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (currentUser.address) {
                    await loadSalesAnalytics(client, currentUser.address, currentUser);
                } else {
                    console.log('📡 Loading sales analytics without municipality filter...');
                    await loadSalesAnalytics(client, null, currentUser);
                }
            }
            
            console.log('🐛 DEBUG: Test completed');
        };
    </script>

    <!-- All Users Modal -->
    <div class="modal fade" id="allUsersModal" tabindex="-1" aria-labelledby="allUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allUsersModalLabel">All Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search users by name, email...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Contact Number</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allUsersCount">0 users found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
