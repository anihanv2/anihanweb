<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipality Dashboard - Anihan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="fixed-layout.css">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link rel="stylesheet" href="municipality_dashboard.css">
    <style>
        .status-filters {
            transition: all 0.3s ease;
        }
        
        .status-filter-btn {
            transition: all 0.2s ease;
            border-width: 1px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-filter-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Municipality Chart Styles */
        .municipality-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .municipality-item:hover {
            border-color: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .municipality-item.top-municipality {
            background: #ffffff;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .municipality-item.top-municipality::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #f39c12;
        }

        .municipality-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .municipality-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .municipality-sales {
            font-weight: 700;
            color: #27ae60;
            font-size: 16px;
        }

        .municipality-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .municipality-progress {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 6px;
            transition: width 0.8s ease-in-out;
            position: relative;
        }

        .municipality-progress.top-performer {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .municipality-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .municipality-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 15px;
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }

        /* Users Table Styles */
        .users-table-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-table-header {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .users-table-header h5 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .users-table-body {
            padding: 0;
        }

        .users-table-body .table {
            margin: 0;
        }

        .users-table-body .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody td {
            padding: 12px 20px;
            border: none;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody tr {
            border-bottom: 1px solid #f1f3f4;
        }

        .users-table-body .table tbody tr:last-child {
            border-bottom: none;
        }

        .users-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .table-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .table-info {
            color: #6c757d;
            font-size: 14px;
        }

        .view-all-link {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .view-all-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-controls .btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 5px 10px;
        }

        .pagination-controls .active-page {
            background: #007bff;
            border-color: #007bff;
            color: white;
        }

        /* All Users Modal Styles */
        #allUsersModal .modal-dialog {
            max-width: 95%;
        }
        
        #allUsersModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allUsersModal .table td {
            vertical-align: middle;
        }
        
        #userSearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #userSearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .badge {
            font-size: 0.875rem;
        }
        
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" class="avatar-img" style="display: none;" alt="Profile">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" class="profile-avatar-img" style="display: none;" alt="Profile">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 id="profileUserName" class="profile-dropdown-name">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="profileUserAccess">Loading...</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="municipality_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link" href="sub_admin_inventory.html">
                        <i class="fas fa-boxes me-2"></i>
                        Inventory Records
                    </a>
                    <a class="nav-link" href="sub_admin_price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    <a class="nav-link" href="sub_admin_in_demand_products.html">
                        <i class="fas fa-chart-line me-2"></i>
                        In Demand Products
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="main-content">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card stats-users">
                                <div class="stats-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeUsersCount">Loading...</div>
                                    <div class="stats-label">Active Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-products">
                                <div class="stats-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="productsCount">Loading...</div>
                                    <div class="stats-label">Available Products</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-farmers">
                                <div class="stats-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                    <div class="stats-label">Active Farmers</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Sales Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Stocks Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 100px;">
                                            <option value="category">Category</option>
                                            <option value="status">Status</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Chart Container with Fixed Height -->
                                    <div class="chart-container" style="position: relative; height: 200px;">
                                        <!-- Category Chart -->
                                        <canvas id="stocksChart" width="400" height="200" style="position: absolute; top: 0; left: 0; display: block; max-width: 100%; height: 200px;"></canvas>
                                        
                                        <!-- Status Chart (initially hidden) -->
                                        <canvas id="statusChart" width="400" height="200" style="position: absolute; top: 0; left: 0; display: none; max-width: 100%; height: 200px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Soil Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                            <option value="type">Soil Type</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="soilChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Hectare Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 100px;">
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="hectareChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="users-table-card mt-4">
                        <div class="users-table-header">
                            <h5>User Management</h5>
                        </div>
                        <div class="users-table-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Contact Number</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="users-table-footer">
                            <div class="table-info-section">
                                <span class="table-info" id="usersTableInfo">1 to 4 items of 0</span>
                                <a href="#" class="view-all-link" onclick="showAllUsersModal()">View all ></a>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-outline-secondary" onclick="changePage(-1)">&lt;</button>
                                <button class="btn active-page" id="currentPageBtn">1</button>
                                <button class="btn btn-outline-secondary" onclick="changePage(1)">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Chart variables
        let salesChart, stocksChart, soilChart, hectareChart, statusChart;

        // Use the Supabase client from shared-profile.js
        console.log('Municipality dashboard using shared Supabase client');

        // Chart Data for Municipality Dashboard - Initialize with default structure
        let analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: new Array(12).fill(0)
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: new Array(4).fill(0)
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: new Array(4).fill(0)
                }
            },
            stocks: {
                category: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d'],
                    products: {
                        'Loading...': [{ name: 'Loading...', quantity: 0, status: 'Loading...' }]
                    }
                },
                status: {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: [0, 0, 0],
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: {
                        'Available': [],
                        'To be Out of Stock': [],
                        'Out of Stock': []
                    }
                },
                supplier: {
                    labels: ['Local Farmers', 'Cooperatives', 'Direct Import', 'Distributors'],
                    data: [40, 30, 20, 10],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                }
            },
            soil: {
                type: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d']
                },
                region: {
                    labels: ['North District', 'South District', 'East District', 'West District'],
                    data: [30, 25, 25, 20],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                },
                season: {
                    labels: ['Dry Season', 'Wet Season', 'Transition'],
                    data: [45, 35, 20],
                    colors: ['#ff6b35', '#4ecdc4', '#45b7d1']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [180, 185, 190, 195]
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: [5500, 6200, 6800, 7500]
                }
            }
        };

        // Initialize Charts
        function initializeCharts() {
            // Destroy existing charts if they exist to prevent canvas reuse errors
            if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                window.salesChart.destroy();
                window.salesChart = null;
            }
            if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                window.stocksChart.destroy();
                window.stocksChart = null;
            }
            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }
            if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                window.soilChart.destroy();
                window.soilChart = null;
            }
            if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                window.hectareChart.destroy();
                window.hectareChart = null;
            }
            
            console.log('ðŸ”„ Initializing charts...');
            initSalesChart();
            initStocksChart();
            initStatusChart(); // Initialize the separate status chart
            initSoilChart();
            initHectareChart();
            console.log('âœ… Charts initialized successfully');
        }

        // Load municipality-specific statistics for Sub Admin
        window.loadMunicipalityStats = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY STATISTICS ===');
                
                // Check if Supabase client is available
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('âŒ Supabase client not available');
                    alert('Database connection not available. Please check your internet connection.');
                    return;
                }
                
                const client = window.supabaseClient || supabaseClient;
                console.log('âœ… Supabase client available');
                
                // Get current user from session storage
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('ðŸ” Current user for stats:', currentUser);
                console.log('ðŸ” Session storage contents:', sessionStorage.getItem('currentUser'));
                
                if (!currentUser.id) {
                    console.log('âŒ No current user found for stats');
                    console.log('ðŸ” Available session storage keys:', Object.keys(sessionStorage));
                    return;
                }
                
                // Get the admin's full data to access their address (municipality)
                console.log('ðŸ” Fetching admin data for ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('âŒ Error fetching admin data:', adminError);
                    console.log('ðŸ” Trying to fetch first admin for testing...');
                    
                    // Try to get any admin for testing
                    const { data: testAdmins, error: testError } = await client
                        .from('admin_accounts')
                        .select('*')
                        .limit(5);
                    
                    console.log('ðŸ” Available admins in database:', testAdmins);
                    if (testError) {
                        console.error('âŒ Error fetching test admins:', testError);
                    }
                    return;
                }
                
                console.log('âœ… Admin data found:', adminData);
                
                // Check if user is Sub Admin
                if (adminData.user_type !== 'SUB ADMIN') {
                    console.log('â„¹ï¸ User is not Sub Admin, user type:', adminData.user_type);
                    console.log('â„¹ï¸ Available user types should include: SUB ADMIN');
                    // For Super Admin, could show aggregate data or different view
                    
                    // Show some sample data for testing
                    document.getElementById('activeUsersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('productsCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('activeFarmersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('totalRevenueCount').textContent = 'N/A (Super Admin)';
                    return;
                }
                
                console.log('âœ… User is Sub Admin');
                
                const municipalityAddress = adminData.address;
                console.log('ðŸ” Sub Admin municipality/address:', municipalityAddress);
                console.log('ðŸ” Address type:', typeof municipalityAddress);
                console.log('ðŸ” Address length:', municipalityAddress ? municipalityAddress.length : 'null');
                
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('âŒ No municipality address found for Sub Admin');
                    alert('No municipality assigned to this Sub Admin account. Please contact administrator.');
                    document.getElementById('activeUsersCount').textContent = '0';
                    document.getElementById('productsCount').textContent = '0';
                    document.getElementById('activeFarmersCount').textContent = '0';
                    return;
                }
                
                // Update profile access info
                const profileAccess = document.getElementById('profileUserAccess');
                if (profileAccess) {
                    profileAccess.textContent = `Access: ${municipalityAddress}`;
                }
                
                // 1. Get users whose municipality matches Sub Admin's address
                console.log('ðŸ” Searching for users with municipality:', municipalityAddress);
                
                // First, let's see what municipalities exist in the database
                const { data: allMunicipalities, error: municError } = await client
                    .from('users')
                    .select('municipality')
                    .not('municipality', 'is', null);
                
                if (!municError && allMunicipalities) {
                    const uniqueMunicipalities = [...new Set(allMunicipalities.map(u => u.municipality))].filter(m => m);
                    console.log('ðŸ” Available municipalities in users table:', uniqueMunicipalities);
                    console.log('ðŸ” Looking for exact match with:', municipalityAddress);
                    
                    // Check for case-insensitive matches
                    const caseInsensitiveMatches = uniqueMunicipalities.filter(m => 
                        m && m.toLowerCase() === municipalityAddress.toLowerCase()
                    );
                    console.log('ðŸ” Case-insensitive matches:', caseInsensitiveMatches);
                }
                
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .eq('municipality', municipalityAddress);
                
                if (usersError) {
                    console.error('âŒ Error fetching users by municipality:', usersError);
                    return;
                }
                
                console.log(`ðŸ” Query result: Found ${municipalityUsers ? municipalityUsers.length : 0} users in municipality: ${municipalityAddress}`);
                console.log('ðŸ” User details:', municipalityUsers);
                
                // Get all user IDs for further queries
                const userIds = municipalityUsers ? municipalityUsers.map(user => user.id) : [];
                const totalUsers = municipalityUsers ? municipalityUsers.length : 0;
                
                console.log('ðŸ” User IDs for store owner check:', userIds);
                
                // 2. Get farmers (users who became store owners) in the municipality
                let totalFarmers = 0;
                let storeOwnerUserIds = [];
                
                if (userIds.length > 0) {
                    // Try both possible table name formats for store owner
                    let farmers = null;
                    let farmersError = null;
                    
                    try {
                        console.log('ðŸ” Trying store-owner table...');
                        const result = await client
                            .from('store-owner')
                            .select('user_id, id')
                            .in('user_id', userIds);
                        farmers = result.data;
                        farmersError = result.error;
                        console.log('âœ… store-owner table result:', { data: farmers, error: farmersError });
                    } catch (error) {
                        console.log('âŒ store-owner table failed, trying store_owner...');
                        try {
                            const result = await client
                                .from('store_owner')
                                .select('user_id, id')
                                .in('user_id', userIds);
                            farmers = result.data;
                            farmersError = result.error;
                            console.log('âœ… store_owner table result:', { data: farmers, error: farmersError });
                        } catch (error2) {
                            console.error('âŒ Could not access store owner table with either name format:', error2);
                            farmersError = error2;
                        }
                    }
                    
                    if (!farmersError && farmers) {
                        // Get unique store owner user IDs
                        storeOwnerUserIds = [...new Set(farmers.map(farmer => farmer.user_id))];
                        totalFarmers = storeOwnerUserIds.length;
                        console.log(`Found ${totalFarmers} active farmers (store owners) in ${municipalityAddress}`);
                    } else {
                        console.log('No farmers found or error accessing farmer data:', farmersError);
                    }
                }
                
                // 3. Get available products from users in the municipality who are also store owners
                let totalProducts = 0;
                if (storeOwnerUserIds.length > 0) {
                    console.log('ðŸ” Searching for products from store owners:', storeOwnerUserIds);
                    const { data: products, error: productsError } = await client
                        .from('my_products')
                        .select('id, user_id, name')
                        .in('user_id', storeOwnerUserIds);
                    
                    if (!productsError && products) {
                        totalProducts = products.length;
                        console.log(`âœ… Found ${totalProducts} products from store owners in ${municipalityAddress}`);
                        console.log('ðŸ” Product details:', products);
                    } else {
                        console.log('âŒ No products found or error accessing products:', productsError);
                    }
                } else {
                    console.log('âŒ No store owners found, so no products to count');
                }
                
                // Update the UI with the counts
                document.getElementById('activeUsersCount').textContent = `${totalUsers}`;
                document.getElementById('productsCount').textContent = `${totalProducts}`;
                document.getElementById('activeFarmersCount').textContent = `${totalFarmers}`;
                
                console.log('=== MUNICIPALITY STATS LOADED ===');
                console.log(`Municipality: ${municipalityAddress}`);
                console.log(`Active Users (in municipality): ${totalUsers}`);
                console.log(`Active Farmers (users who became store owners): ${totalFarmers}`);
                console.log(`Available Products (from store owners): ${totalProducts}`);
                console.log('Matching criteria: Sub Admin address = Users municipality + Users must be store owners');
                
            } catch (error) {
                console.error('Error loading municipality stats:', error);
                
                // Show error state
                document.getElementById('activeUsersCount').textContent = 'Error';
                document.getElementById('productsCount').textContent = 'Error';
                document.getElementById('activeFarmersCount').textContent = 'Error';
            }
        }

        // Function to load real analytics data based on municipality
        window.loadMunicipalityAnalytics = async function() {
            try {
                console.log('ðŸš€ === STARTING MUNICIPALITY ANALYTICS LOAD ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('âŒ Supabase client not available');
                    return;
                }
                console.log('âœ… Supabase client found');
                
                // Get current user from session
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('ðŸ‘¤ Current user from session:', currentUser);
                
                if (!currentUser.id) {
                    console.error('âŒ No current user found');
                    console.log('ðŸ” Session storage contents:', sessionStorage.getItem('currentUser'));
                    return;
                }
                
                // Get Sub Admin's address
                console.log('ðŸ” Fetching admin data for user ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('âŒ Error fetching admin data:', adminError);
                    console.log('ðŸ” Trying to fetch any admin data for debugging...');
                    
                    const { data: allAdmins, error: allError } = await client
                        .from('admin_accounts')
                        .select('id, address, user_type')
                        .limit(5);
                    
                    console.log('ðŸ” Available admins:', allAdmins);
                    return;
                }
                
                console.log('âœ… Admin data found:', adminData);
                
                if (!adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('â„¹ï¸ Not a Sub Admin or no admin data, user type:', adminData?.user_type);
                    return;
                }
                
                const municipalityAddress = adminData.address;
                console.log('ðŸ›ï¸ Municipality address:', municipalityAddress);
                if (!municipalityAddress) {
                    console.log('âŒ No municipality address found');
                    return;
                }
                
                console.log('ðŸ” Loading analytics for municipality:', municipalityAddress);
                
                // Get users in the municipality
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id')
                    .eq('municipality', municipalityAddress);
                
                if (usersError || !municipalityUsers) {
                    console.error('âŒ Error fetching users:', usersError);
                    return;
                }
                
                const userIds = municipalityUsers.map(user => user.id);
                console.log('ðŸ” User IDs for analytics:', userIds);
                
                // Load Sales Analytics (from orders matching municipality)
                await loadSalesAnalytics(client, municipalityAddress, adminData);
                
                // Load Stock Analytics (from my_products)
                await loadStockAnalytics(client, userIds);
                
                // Load Soil Analytics (from store-owner)
                await loadSoilAnalytics(client, userIds);
                
                // Load Hectare Analytics (from store-owner)
                await loadHectareAnalytics(client, userIds);
                
                console.log('âœ… Municipality analytics loaded successfully');
                
            } catch (error) {
                console.error('âŒ Error loading municipality analytics:', error);
            }
        }

        // Load Sales Analytics from orders matching municipality
        async function loadSalesAnalytics(client, municipalityAddress, adminData) {
            try {
                console.log('ï¿½ STARTING SALES ANALYTICS LOAD');
                console.log('ï¿½ðŸ” Loading sales analytics for municipality:', municipalityAddress);
                console.log('ðŸ” Admin data:', adminData);
                console.log('ðŸ” Client available:', !!client);
                
                // Step 1: Get all store owners
                console.log('ðŸ“¡ Step 1: Fetching store owners...');
                const { data: storeOwners, error: storeOwnersError } = await client
                    .from('store-owner')
                    .select('user_id');
                
                if (storeOwnersError) {
                    console.error('âŒ Error fetching store owners:', storeOwnersError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                const storeOwnerIds = storeOwners?.map(so => so.user_id) || [];
                console.log(`ðŸ“¦ Found ${storeOwnerIds.length} store owners`);
                
                // Step 2: Get products from store owners in the same municipality
                console.log('ðŸ“¡ Step 2: Fetching products from store owners in municipality...');
                const { data: municipalityProducts, error: productsError } = await client
                    .from('my_products')
                    .select(`
                        id, 
                        name, 
                        user_id,
                        users!inner (
                            id,
                            full_name,
                            municipality,
                            address
                        )
                    `)
                    .in('user_id', storeOwnerIds);
                
                if (productsError) {
                    console.error('âŒ Error fetching products:', productsError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`ðŸ“¦ Found ${municipalityProducts?.length || 0} products from store owners`);
                
                // Filter products by store owner municipality matching admin's address
                const matchingProducts = municipalityProducts?.filter(product => {
                    if (!product.users || (!product.users.municipality && !product.users.address)) return false;
                    
                    const adminMunicipality = municipalityAddress.toLowerCase();
                    const storeOwnerMunicipality = (product.users.municipality || product.users.address || '').toLowerCase();
                    
                    // Try multiple matching strategies
                    const exactMatch = storeOwnerMunicipality === adminMunicipality;
                    const containsMatch = storeOwnerMunicipality.includes(adminMunicipality) || adminMunicipality.includes(storeOwnerMunicipality);
                    const lipaMatch = adminMunicipality.includes('lipa') && storeOwnerMunicipality.includes('lipa');
                    
                    const matches = exactMatch || containsMatch || lipaMatch;
                    
                    if (matches) {
                        console.log(`âœ… Product ${product.name} (${product.id}) from store owner ${product.users.full_name} matches municipality:`, {
                            storeOwnerMunicipality: product.users.municipality || product.users.address,
                            adminMunicipality: municipalityAddress,
                            matchType: exactMatch ? 'exact' : containsMatch ? 'contains' : 'lipa'
                        });
                    }
                    
                    return matches;
                }) || [];
                
                console.log(`ðŸ“ Found ${matchingProducts.length} products from store owners in municipality "${municipalityAddress}"`);
                
                // Step 3: Get all orders (like dashboard_super_admin) and filter for municipality relevance
                if (matchingProducts.length === 0) {
                    console.warn('âš ï¸ No products found from store owners in municipality - showing empty analytics');
                    analyticsData.sales = {
                        monthly: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], data: new Array(12).fill(0) },
                        weekly: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'], data: new Array(4).fill(0) },
                        yearly: { labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()), data: new Array(4).fill(0) }
                    };
                    updateSalesChart();
                    return;
                }
                
                // Get unique store owner user IDs who have products in the municipality
                const municipalityStoreOwnerIds = [...new Set(matchingProducts.map(p => p.user_id))];
                console.log('ï¿½ Step 3: Fetching all orders to filter for municipality relevance...');
                console.log('ðŸ“ Municipality store owner IDs:', municipalityStoreOwnerIds);
                
                // Get all orders (following dashboard_super_admin pattern)
                const { data: allOrders, error: ordersError } = await client
                    .from('orders')
                    .select('id, total, user_id, created_at, status, address')
                    .not('total', 'is', null);
                
                if (ordersError) {
                    console.error('âŒ Error fetching orders:', ordersError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`ðŸ“¦ Found ${allOrders?.length || 0} total orders in system`);
                
                // Filter orders that are relevant to the municipality (either from store owners or delivered to municipality)
                const municipalityOrders = allOrders?.filter(order => {
                    // Check if order is from a municipality store owner
                    const isFromMunicipalityStoreOwner = municipalityStoreOwnerIds.includes(order.user_id);
                    
                    // Check if order is delivered to the municipality
                    let isDeliveredToMunicipality = false;
                    if (order.address) {
                        const adminMunicipality = municipalityAddress.toLowerCase();
                        const orderAddress = order.address.toLowerCase();
                        
                        isDeliveredToMunicipality = orderAddress.includes(adminMunicipality) || 
                                                  adminMunicipality.includes(orderAddress) ||
                                                  (adminMunicipality.includes('lipa') && orderAddress.includes('lipa'));
                    }
                    
                    const matches = isFromMunicipalityStoreOwner || isDeliveredToMunicipality;
                    
                    if (matches) {
                        console.log(`âœ… Order ${order.id} matches municipality:`, {
                            total: `â‚±${parseFloat(order.total).toFixed(2)}`,
                            isFromStoreOwner: isFromMunicipalityStoreOwner,
                            isDeliveredToMunicipality: isDeliveredToMunicipality,
                            orderAddress: order.address
                        });
                    }
                    
                    return matches;
                }) || [];
                
                console.log(`ðŸ“¦ Found ${municipalityOrders.length} orders related to municipality`);
                if (municipalityOrders && municipalityOrders.length > 0) {
                    const totalRevenue = municipalityOrders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
                    console.log('ðŸ’° Municipality orders details:', municipalityOrders.slice(0, 5).map(o => ({
                        id: o.id,
                        total: `â‚±${parseFloat(o.total).toFixed(2)}`,
                        user_id: o.user_id,
                        address: o.address,
                        date: new Date(o.created_at).toLocaleDateString()
                    })));
                    console.log(`ðŸ’° Total revenue from municipality-related orders: â‚±${totalRevenue.toFixed(2)}`);
                }
                
                // Process the filtered orders using dashboard_super_admin approach
                const chartData = processOrdersForChart(municipalityOrders || []);
                console.log('ðŸ“Š Processed chart data:', chartData);
                
                // Update analytics data with multiple periods
                analyticsData.sales = generateMultiPeriodData(municipalityOrders || []);
                console.log('âœ… Sales analytics updated with municipality store owner data');
                
                // Update the chart
                updateSalesChart();
                
            } catch (error) {
                console.error('âŒ Error loading sales analytics:', error);
            }
        }

        // Helper function to update sales chart
        function updateSalesChart() {
            if (window.salesChart && window.salesChart.data) {
                try {
                    console.log('ðŸ“Š Updating sales chart with new data...');
                    const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                    const currentData = analyticsData.sales[currentFilter];
                    
                    console.log('ðŸ“Š Current filter:', currentFilter);
                    console.log('ðŸ“Š Data to update chart with:', currentData);
                    
                    if (currentData && currentData.labels && currentData.data) {
                        window.salesChart.data.labels = currentData.labels;
                        window.salesChart.data.datasets[0].data = currentData.data;
                        window.salesChart.update();
                        console.log('âœ… Sales chart updated successfully with real data');
                    } else {
                        console.error('âŒ Invalid chart data structure:', currentData);
                    }
                } catch (chartError) {
                    console.error('âŒ Error updating sales chart:', chartError);
                }
            } else {
                console.warn('âš ï¸ Sales chart not available for update');
                console.log('ðŸ” window.salesChart exists:', !!window.salesChart);
                console.log('ðŸ” window.salesChart.data exists:', !!(window.salesChart && window.salesChart.data));
            }
        }

        // Function to process orders data for chart display (copied from dashboard_super_admin)
        function processOrdersForChart(orders) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            // Initialize monthly data
            const monthlyData = {};
            monthNames.forEach(month => {
                monthlyData[month] = 0;
            });

            // Group orders by month
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    if (orderDate.getFullYear() === currentYear) {
                        const monthName = monthNames[orderDate.getMonth()];
                        const orderTotal = parseFloat(order.total) || 0;
                        monthlyData[monthName] += orderTotal;
                    }
                }
            });

            console.log('Monthly sales data:', monthlyData);

            return {
                labels: monthNames,
                data: monthNames.map(month => monthlyData[month])
            };
        }
        
        // Function to generate data for multiple periods (monthly, weekly, yearly)
        function generateMultiPeriodData(orders) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Monthly data for current year
            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = new Array(12).fill(0);
            
            // Weekly data for current month
            const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const weeklyData = new Array(4).fill(0);
            
            // Yearly data for last 4 years
            const yearLabels = [currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(y => y.toString());
            const yearlyData = new Array(4).fill(0);
            
            orders.forEach(order => {
                if (!order.created_at || !order.total) return;
                
                const orderDate = new Date(order.created_at);
                const orderTotal = parseFloat(order.total) || 0;
                const orderYear = orderDate.getFullYear();
                const orderMonth = orderDate.getMonth();
                
                // Monthly data (current year only)
                if (orderYear === currentYear) {
                    monthlyData[orderMonth] += orderTotal;
                }
                
                // Weekly data (current month only)
                if (orderYear === currentYear && orderMonth === currentMonth) {
                    const weekOfMonth = Math.floor((orderDate.getDate() - 1) / 7);
                    if (weekOfMonth >= 0 && weekOfMonth < 4) {
                        weeklyData[weekOfMonth] += orderTotal;
                    }
                }
                
                // Yearly data
                const yearIndex = yearLabels.indexOf(orderYear.toString());
                if (yearIndex !== -1) {
                    yearlyData[yearIndex] += orderTotal;
                }
            });
            
            return {
                monthly: { labels: monthLabels, data: monthlyData },
                weekly: { labels: weekLabels, data: weeklyData },
                yearly: { labels: yearLabels, data: yearlyData }
            };
        }
        
        // Fallback function for when there are errors (similar to dashboard_super_admin)
        function updateSalesChartWithFallback() {
            if (!window.salesChart) return;
            
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let fallbackData;
            
            switch (period) {
                case 'weekly':
                    fallbackData = {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'yearly':
                    fallbackData = {
                        labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()),
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'monthly':
                default:
                    fallbackData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        data: new Array(12).fill(0)
                    };
                    break;
            }
            
            window.salesChart.data.labels = fallbackData.labels;
            window.salesChart.data.datasets[0].data = fallbackData.data;
            window.salesChart.data.datasets[0].label = period === 'weekly' ? 'Weekly Sales' : 
                                                     period === 'yearly' ? 'Annual Sales' : 'Monthly Sales';
            window.salesChart.update();
            console.log(`âš ï¸ Sales chart updated with empty ${period} data (no municipality data found)`);
        }

        // Test function to check municipality products sales
        window.testMunicipalityProductsSales = async function() {
            try {
                console.log('ðŸ§ª === TESTING MUNICIPALITY PRODUCTS SALES LOGIC ===');
                const client = window.supabaseClient || supabaseClient;
                const adminData = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                if (!adminData.address) {
                    console.error('âŒ No admin address found in session');
                    return;
                }
                
                await loadSalesAnalytics(client, adminData.address, adminData);
                console.log('ðŸ§ª Test completed - check console logs above for details');
            } catch (error) {
                console.error('âŒ Test failed:', error);
            }
        };

        // Test function to check orders table
        window.testOrdersTable = async function() {
            try {
                console.log('ðŸ§ª === TESTING ORDERS TABLE ACCESS ===');
                const client = window.supabaseClient || supabaseClient;
                
                if (!client) {
                    console.error('âŒ No Supabase client');
                    return;
                }
                
                // Test basic table access
                console.log('ðŸ§ª Step 1: Testing basic orders table access...');
                const { data: orders, error } = await client
                    .from('orders')
                    .select('*')
                    .limit(10);
                
                console.log('ðŸ§ª Orders test result:', { 
                    ordersCount: orders?.length || 0, 
                    error: error,
                    sampleData: orders?.slice(0, 2)
                });
                
                if (error) {
                    console.error('âŒ Orders table error:', error);
                    return;
                }
                
                if (!orders || orders.length === 0) {
                    console.warn('âš ï¸ No orders found in database');
                    console.log('ðŸ’¡ Try creating some test orders first');
                    return;
                }
                
                console.log('âœ… Orders table accessible');
                console.log('ðŸ“¦ Total orders in database:', orders.length);
                console.log('ðŸ“¦ Sample orders:');
                orders.forEach((order, index) => {
                    console.log(`  ${index + 1}. ID: ${order.id?.slice(0, 8)}, Total: â‚±${order.total}, Address: "${order.address}", Date: ${new Date(order.created_at).toLocaleDateString()}`);
                });
                
                // Test current user
                console.log('ðŸ§ª Step 2: Testing current user...');
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('ðŸ‘¤ Current user:', currentUser);
                
                if (!currentUser.id) {
                    console.error('âŒ No current user found');
                    return;
                }
                
                // Test admin data
                console.log('ðŸ§ª Step 3: Testing admin data...');
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                console.log('ðŸ‘¨â€ðŸ’¼ Admin data:', { data: adminData, error: adminError });
                
                if (adminError) {
                    console.error('âŒ Admin data error:', adminError);
                    return;
                }
                
                if (!adminData.address) {
                    console.warn('âš ï¸ Admin has no address set');
                    return;
                }
                
                // Test address matching
                console.log('ðŸ§ª Step 4: Testing address matching...');
                const adminAddress = adminData.address.toLowerCase();
                console.log('ðŸ›ï¸ Admin address:', adminData.address);
                
                const matchingOrders = orders.filter(order => {
                    if (!order.address) return false;
                    
                    const orderAddress = order.address.toLowerCase();
                    const exactMatch = orderAddress === adminAddress;
                    const containsMatch = orderAddress.includes(adminAddress);
                    const reverseContains = adminAddress.includes(orderAddress);
                    const lipaMatch = adminAddress.includes('lipa') && orderAddress.includes('lipa');
                    
                    return exactMatch || containsMatch || reverseContains || lipaMatch;
                });
                
                console.log('ðŸŽ¯ Matching orders found:', matchingOrders.length);
                if (matchingOrders.length > 0) {
                    console.log('ðŸ’° Matching orders:');
                    matchingOrders.forEach((order, index) => {
                        console.log(`  ${index + 1}. Total: â‚±${order.total}, Address: "${order.address}"`);
                    });
                    
                    const totalRevenue = matchingOrders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
                    console.log(`ðŸ’° Total revenue: â‚±${totalRevenue.toFixed(2)}`);
                } else {
                    console.warn('âš ï¸ No orders match the admin address');
                    console.log('ðŸ” All order addresses:');
                    orders.forEach((order, index) => {
                        console.log(`  ${index + 1}. "${order.address}"`);
                    });
                    console.log('ðŸ” Admin address to match:', `"${adminData.address}"`);
                }
                
            } catch (error) {
                console.error('âŒ Test error:', error);
            }
        }

        // Simple test to manually trigger sales analytics
        window.testSalesAnalytics = async function() {
            console.log('ðŸ§ª === MANUAL SALES ANALYTICS TEST ===');
            try {
                const client = window.supabaseClient || supabaseClient;
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                const { data: adminData } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminData && adminData.address) {
                    await loadSalesAnalytics(client, adminData.address, adminData);
                } else {
                    console.error('âŒ No admin data or address found');
                }
            } catch (error) {
                console.error('âŒ Manual test error:', error);
            }
        }

        // Load Stock Analytics from my_products
        async function loadStockAnalytics(client, userIds) {
            try {
                console.log('ðŸ” Loading stock analytics...');
                console.log('ðŸ” User IDs for stock analysis:', userIds);
                
                if (userIds.length === 0) {
                    console.log('âŒ No users to analyze');
                    // Set "No Data" instead of loading
                    analyticsData.stocks.category = {
                        labels: ['No Data'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Data', quantity: 0, status: 'No Data' }]
                    };
                    return;
                }
                
                const { data: products, error: productsError } = await client
                    .from('my_products')
                    .select('category, quantity, name, id')
                    .in('user_id', userIds);
                
                if (productsError) {
                    console.error('âŒ Error fetching products:', productsError);
                    return;
                }
                
                console.log('ðŸ” Products data found:', products);
                console.log('ðŸ” Number of products:', products ? products.length : 0);
                
                if (!products || products.length === 0) {
                    console.log('âŒ No products found for these users');
                    analyticsData.stocks.category = {
                        labels: ['No Products'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Products', quantity: 0, status: 'No Data' }]
                    };
                    
                    // Update chart immediately
                    if (window.stocksChart && window.stocksChart.data) {
                        window.stocksChart.data.labels = ['No Products'];
                        window.stocksChart.data.datasets[0].data = [1];
                        window.stocksChart.data.datasets[0].backgroundColor = ['#6c757d'];
                        window.stocksChart.update();
                    }
                    return;
                }
                
                // Function to determine stock status
                function getStockStatus(quantity) {
                    if (quantity === 0) return 'Out of Stock';
                    if (quantity <= 5) return 'To be Out of Stock';
                    return 'Available';
                }
                
                // Process category data with detailed product information
                const categoryStats = {};
                const categoryProducts = {};
                const statusStats = { 'Available': 0, 'To be Out of Stock': 0, 'Out of Stock': 0 };
                const statusProducts = { 'Available': [], 'To be Out of Stock': [], 'Out of Stock': [] };
                
                products.forEach(product => {
                    console.log('ðŸ” Processing product:', product);
                    const category = (product.category && product.category.trim() !== '') 
                        ? product.category.trim() 
                        : 'Uncategorized';
                    
                    const productStatus = getStockStatus(product.quantity || 0);
                    const productInfo = {
                        name: product.name || 'Unnamed Product',
                        quantity: product.quantity || 0,
                        status: productStatus,
                        category: category
                    };
                    
                    // Count by category
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    
                    // Count by status
                    statusStats[productStatus] = (statusStats[productStatus] || 0) + 1;
                    
                    // Store detailed product information by category
                    if (!categoryProducts[category]) {
                        categoryProducts[category] = [];
                    }
                    categoryProducts[category].push(productInfo);
                    
                    // Store detailed product information by status
                    statusProducts[productStatus].push(productInfo);
                });
                
                console.log('ðŸ“Š Category stats calculated:', categoryStats);
                console.log('ðŸ“Š Status stats calculated:', statusStats);
                console.log('ðŸ“Š Category products:', categoryProducts);
                console.log('ðŸ“Š Status products:', statusProducts);
                
                // Convert to arrays for chart
                const categories = Object.keys(categoryStats);
                const categoryData = Object.values(categoryStats);
                const statusData = Object.values(statusStats);
                const colors = ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545', '#6c757d'];
                
                console.log('ðŸ“Š Final chart data:');
                console.log('   Labels:', categories);
                console.log('   Category Data:', categoryData);
                console.log('   Status Data:', statusData);
                
                // Update analyticsData with detailed product information
                analyticsData.stocks.category = {
                    labels: categories,
                    data: categoryData,
                    colors: colors.slice(0, categories.length),
                    products: categoryProducts
                };
                
                // Update status analytics with product details
                analyticsData.stocks.status = {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: statusData,
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: statusProducts
                };
                
                console.log('âœ… Updated analyticsData.stocks.category:', analyticsData.stocks.category);
                console.log('âœ… Updated analyticsData.stocks.status:', analyticsData.stocks.status);
                
                // Update the charts if they exist
                if (window.stocksChart && window.stocksChart.data) {
                    console.log('ðŸ”„ Updating stocks chart with real data');
                    console.log('   Chart before update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                    
                    window.stocksChart.data.labels = categories;
                    window.stocksChart.data.datasets[0].data = categoryData;
                    window.stocksChart.data.datasets[0].backgroundColor = colors.slice(0, categories.length);
                    window.stocksChart.update();
                    
                    console.log('   Chart after update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                } else {
                    console.log('âš ï¸ Stocks chart not yet initialized, data saved for later use');
                }
                
                // Update the status chart if it exists
                if (window.statusChart && window.statusChart.data) {
                    console.log('ðŸ”„ Updating status chart with real data');
                    window.statusChart.data.labels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                    window.statusChart.data.datasets[0].data = statusData;
                    window.statusChart.data.datasets[0].backgroundColor = ['#28a745', '#ffc107', '#dc3545'];
                    window.statusChart.update();
                    console.log('âœ… Status chart updated with real data');
                } else {
                    console.log('âš ï¸ Status chart not yet initialized, data saved for later use');
                }
                
                console.log('âœ… Stock analytics completed');
                
            } catch (error) {
                console.error('âŒ Error in loadStockAnalytics:', error);
            }
        }

        // Load Soil Analytics from store-owner
        async function loadSoilAnalytics(client, userIds) {
            try {
                console.log('ðŸ” Loading soil analytics...');
                
                if (userIds.length === 0) {
                    console.log('âŒ No users to analyze');
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                try {
                    const result = await client
                        .from('store-owner')
                        .select('soil_type')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                } catch (error) {
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('soil_type')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                    } catch (error2) {
                        console.error('âŒ Could not access store owner table:', error2);
                        return;
                    }
                }
                
                if (!storeOwners) {
                    console.log('âŒ No store owners found');
                    return;
                }
                
                console.log('ðŸ” Store owners soil data:', storeOwners);
                
                // Process soil type data
                const soilStats = {};
                
                storeOwners.forEach(owner => {
                    if (owner.soil_type) {
                        soilStats[owner.soil_type] = (soilStats[owner.soil_type] || 0) + 1;
                    }
                });
                
                console.log('ðŸ“Š Soil stats:', soilStats);
                
                // Update analyticsData.soil.type with real data
                const soilTypes = Object.keys(soilStats);
                const soilData = Object.values(soilStats);
                const colors = ['#8b4513', '#d2691e', '#daa520', '#bc8f8f', '#556b2f', '#654321', '#8b7355'];
                
                analyticsData.soil.type = {
                    labels: soilTypes,
                    data: soilData,
                    colors: colors.slice(0, soilTypes.length)
                };
                
                // Update the chart if it exists
                if (window.soilChart && window.soilChart.data) {
                    console.log('ðŸ”„ Updating soil chart with real data');
                    window.soilChart.data.labels = soilTypes;
                    window.soilChart.data.datasets[0].data = soilData;
                    window.soilChart.data.datasets[0].backgroundColor = colors.slice(0, soilTypes.length);
                    window.soilChart.update();
                } else {
                    console.log('âš ï¸ Soil chart not yet initialized, data will be used when chart is created');
                }
                
                console.log('âœ… Soil analytics updated');
                
            } catch (error) {
                console.error('âŒ Error in loadSoilAnalytics:', error);
            }
        }

        // Load Hectare Analytics from store-owner
        async function loadHectareAnalytics(client, userIds) {
            try {
                console.log('ðŸ” Loading hectare analytics...');
                
                if (userIds.length === 0) {
                    console.log('âŒ No users to analyze');
                    // Set "No Data" for all periods
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        },
                        weekly: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            data: [0, 0, 0, 0]
                        },
                        yearly: {
                            labels: ['2021', '2022', '2023', '2024'],
                            data: [0, 0, 0, 0]
                        }
                    };
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                let storeOwnerError = null;
                
                try {
                    console.log('ðŸ” Trying store-owner table...');
                    const result = await client
                        .from('store-owner')
                        .select('land_size, created_at, user_id')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                    storeOwnerError = result.error;
                    console.log('âœ… store-owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                } catch (error) {
                    console.log('âŒ store-owner table failed, trying store_owner...');
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('land_size, created_at, user_id')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                        storeOwnerError = result.error;
                        console.log('âœ… store_owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                    } catch (error2) {
                        console.error('âŒ Could not access store owner table with either name format:', error2);
                        return;
                    }
                }
                
                if (storeOwnerError || !storeOwners) {
                    console.log('âŒ No store owners found or error:', storeOwnerError);
                    return;
                }
                
                console.log('ðŸ” Store owners land size data:', storeOwners);
                
                // Process land size data - filter valid numeric values
                const validLandData = storeOwners
                    .filter(owner => {
                        const landSize = parseFloat(owner.land_size);
                        return owner.land_size && !isNaN(landSize) && landSize > 0;
                    })
                    .map(owner => ({
                        size: parseFloat(owner.land_size),
                        date: owner.created_at ? new Date(owner.created_at) : new Date(),
                        userId: owner.user_id
                    }));
                
                console.log('ðŸ“Š Valid land data with dates:');
                validLandData.forEach((item, index) => {
                    console.log(`  ${index + 1}. User ${item.userId}: ${item.size} ha on ${item.date.getFullYear()}-${(item.date.getMonth() + 1).toString().padStart(2, '0')}-${item.date.getDate().toString().padStart(2, '0')}`);
                });
                
                if (validLandData.length === 0) {
                    console.log('âŒ No valid land size data found');
                    // Set "No Data" state
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        weekly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        yearly: {
                            labels: ['No Data'],
                            data: [1]
                        }
                    };
                    
                    // Update chart if exists
                    if (window.hectareChart && window.hectareChart.data) {
                        window.hectareChart.data.labels = ['No Data'];
                        window.hectareChart.data.datasets[0].data = [1];
                        window.hectareChart.update();
                    }
                    return;
                }
                
                console.log('ðŸ“Š Valid land data:', validLandData);
                console.log('ðŸ“Š Number of valid entries:', validLandData.length);
                
                // Calculate total hectares
                const totalHectares = validLandData.reduce((sum, item) => sum + item.size, 0);
                const avgHectares = totalHectares / validLandData.length;
                
                console.log('ðŸ“Š Total hectares:', totalHectares);
                console.log('ðŸ“Š Average hectares per farm:', avgHectares);
                
                // Current date for calculations
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); // 0-based
                
                // MONTHLY DATA - Distribute land data across 12 months based on creation dates
                const monthlyData = new Array(12).fill(0);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Group by creation month for current year or most recent year with data
                const yearlyGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    const month = item.date.getMonth();
                    
                    if (!yearlyGroups[year]) yearlyGroups[year] = new Array(12).fill(0);
                    yearlyGroups[year][month] += item.size;
                });
                
                // Use current year data if available, otherwise use the most recent year
                const availableYears = Object.keys(yearlyGroups).map(y => parseInt(y)).sort((a, b) => b - a);
                const targetYear = availableYears.includes(currentYear) ? currentYear : availableYears[0];
                
                if (targetYear && yearlyGroups[targetYear]) {
                    for (let i = 0; i < 12; i++) {
                        monthlyData[i] = yearlyGroups[targetYear][i];
                    }
                } else {
                    // Fallback: distribute evenly if no specific year data
                    const monthlyAvg = totalHectares / 12;
                    for (let i = 0; i < 12; i++) {
                        const variation = (Math.random() - 0.5) * 0.2;
                        monthlyData[i] = Math.round((monthlyAvg + monthlyAvg * variation) * 100) / 100;
                    }
                }
                
                // WEEKLY DATA - More accurate weekly distribution based on actual data
                const weeklyLabels = [];
                const weeklyData = [];
                
                // Get current month's data or data from the month with most activity
                const currentMonthTotal = monthlyData[currentMonth];
                const maxMonthIndex = monthlyData.indexOf(Math.max(...monthlyData));
                const targetMonthTotal = currentMonthTotal > 0 ? currentMonthTotal : monthlyData[maxMonthIndex];
                
                // Get current week number for more accurate labeling
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentWeek = Math.ceil((now.getDate() + startOfMonth.getDay()) / 7);
                
                // Create weekly distribution based on actual farm registration patterns
                const farmsInTargetMonth = validLandData.filter(item => {
                    const itemMonth = item.date.getMonth();
                    return currentMonthTotal > 0 ? itemMonth === currentMonth : itemMonth === maxMonthIndex;
                });
                
                // If we have farms in the target month, distribute by actual weeks
                if (farmsInTargetMonth.length > 0) {
                    const weeklyDistribution = [0, 0, 0, 0];
                    
                    farmsInTargetMonth.forEach(item => {
                        const dayOfMonth = item.date.getDate();
                        const weekOfMonth = Math.min(Math.ceil(dayOfMonth / 7), 4) - 1; // 0-3
                        weeklyDistribution[weekOfMonth] += item.size;
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        weeklyData.push(Math.round(weeklyDistribution[i] * 100) / 100);
                    }
                } else {
                    // Fallback: distribute target month evenly across weeks
                    const weeklyBase = targetMonthTotal / 4;
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        const variation = (Math.random() - 0.5) * 0.1;
                        weeklyData.push(Math.round((weeklyBase + weeklyBase * variation) * 100) / 100);
                    }
                }
                
                // YEARLY DATA - ONLY use actual database data, no simulation
                const currentYear2025 = new Date().getFullYear(); // Use actual current year (2025)
                const yearRange = 4; // Show last 4 years
                const yearlyLabels = [];
                const yearlyData = [];
                
                // Create year groups based ONLY on actual data - sum ALL land registered in each year
                const actualYearGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    if (!actualYearGroups[year]) actualYearGroups[year] = 0;
                    actualYearGroups[year] += item.size; // Sum total land for this year
                });
                
                console.log('ðŸ“Š Raw year groups from database (ACTUAL DATA ONLY):', actualYearGroups);
                console.log('ðŸ“Š Current year detected:', currentYear2025);
                
                // Generate data for the last 4 years (2022-2025) - ONLY ACTUAL DATA
                for (let i = yearRange - 1; i >= 0; i--) {
                    const year = currentYear2025 - i;
                    yearlyLabels.push(year.toString());
                    
                    if (actualYearGroups[year] && actualYearGroups[year] > 0) {
                        // Use ONLY actual total land registered in this year
                        yearlyData.push(Math.round(actualYearGroups[year] * 100) / 100);
                        console.log(`âœ… Year ${year}: ACTUAL DATA = ${actualYearGroups[year]} hectares`);
                    } else {
                        // NO SIMULATION - if no actual data, show 0
                        yearlyData.push(0);
                        console.log(`âŒ Year ${year}: No actual data found, showing 0 hectares`);
                    }
                }
                
                console.log('ðŸ“Š Final yearly labels (REAL DATA ONLY):', yearlyLabels);
                console.log('ðŸ“Š Final yearly data (REAL DATA ONLY):');
                yearlyLabels.forEach((year, index) => {
                    const value = yearlyData[index];
                    const source = value > 0 ? 'ACTUAL DATABASE' : 'NO DATA';
                    console.log(`   ${year}: ${value} hectares (${source})`);
                });
                
                console.log('ðŸ“Š Actual year groups from database:', actualYearGroups);
                console.log('ðŸ“Š Monthly hectare data:', monthlyData);
                console.log('ðŸ“Š Weekly hectare data (accurate):', weeklyData);
                console.log('ðŸ“Š Yearly hectare data (accurate):', yearlyData);
                
                // Update analyticsData with comprehensive data
                analyticsData.hectare = {
                    monthly: {
                        labels: monthNames,
                        data: monthlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    },
                    weekly: {
                        labels: weeklyLabels,
                        data: weeklyData,
                        totalHectares: targetMonthTotal,
                        validFarms: validLandData.length
                    },
                    yearly: {
                        labels: yearlyLabels,
                        data: yearlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    }
                };
                
                console.log('âœ… Updated analyticsData.hectare:', analyticsData.hectare);
                
                // Update the chart if it exists (default to monthly view)
                if (window.hectareChart && window.hectareChart.data) {
                    console.log('ðŸ”„ Updating hectare chart with real monthly data');
                    window.hectareChart.data.labels = monthNames;
                    window.hectareChart.data.datasets[0].data = monthlyData;
                    window.hectareChart.update();
                    console.log('âœ… Hectare chart updated successfully');
                } else {
                    console.log('âš ï¸ Hectare chart not yet initialized, data saved for later use');
                }
                
                console.log('âœ… Hectare analytics completed');
                
            } catch (error) {
                console.error('âŒ Error in loadHectareAnalytics:', error);
            }
        }

        // Test function to check database connection and data
        window.testDatabaseConnection = async function() {
            try {
                console.log('=== TESTING DATABASE CONNECTION ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('âŒ No Supabase client available');
                    return;
                }
                
                // Test admin_accounts table
                console.log('ðŸ” Testing admin_accounts table...');
                const { data: admins, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .limit(3);
                
                console.log('Admin accounts result:', { data: admins, error: adminError });
                
                // Test users table
                console.log('ðŸ” Testing users table...');
                const { data: users, error: userError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .limit(5);
                
                console.log('Users result:', { data: users, error: userError });
                
                // Test store owner tables
                console.log('ðŸ” Testing store-owner table...');
                try {
                    const { data: stores1, error: storeError1 } = await client
                        .from('store-owner')
                        .select('*')
                        .limit(3);
                    console.log('store-owner result:', { data: stores1, error: storeError1 });
                } catch (e) {
                    console.log('store-owner table not accessible');
                }
                
                console.log('ðŸ” Testing store_owner table...');
                try {
                    const { data: stores2, error: storeError2 } = await client
                        .from('store_owner')
                        .select('*')
                        .limit(3);
                    console.log('store_owner result:', { data: stores2, error: storeError2 });
                } catch (e) {
                    console.log('store_owner table not accessible');
                }
                
                // Test products table
                console.log('ðŸ” Testing my_products table...');
                const { data: products, error: productError } = await client
                    .from('my_products')
                    .select('*')
                    .limit(3);
                
                console.log('Products result:', { data: products, error: productError });
                
                console.log('=== DATABASE TEST COMPLETE ===');
                
            } catch (error) {
                console.error('âŒ Error in database test:', error);
            }
        }

        // Wait for shared profile to load, then load municipality stats
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Check if charts are already initialized to prevent duplicates
            if (window.chartsInitialized) {
                console.log('âš ï¸ Charts already initialized, skipping...');
                return;
            }
            
            // Initialize charts
            initializeCharts();
            window.chartsInitialized = true;
                
            // Load real data after charts are initialized
            setTimeout(() => {
                console.log('ðŸ”„ Loading analytics after charts initialization...');
                window.loadMunicipalityAnalytics();
            }, 2000);
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('ðŸ” Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('ðŸ”„ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
            }, 3000); // Increased timeout to 3 seconds
        });

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            window.salesChart.data.labels = data.labels;
            window.salesChart.data.datasets[0].data = data.data;
            window.salesChart.update();
        }

        function updateStocksChart(view) {
            console.log('ðŸ”„ Updating stocks chart to view:', view);
            
            const stocksCanvas = document.getElementById('stocksChart');
            const statusCanvas = document.getElementById('statusChart');
            
            if (!stocksCanvas || !statusCanvas) {
                console.warn('âš ï¸ Chart elements not found');
                return;
            }
            
            if (view === 'status') {
                // Show status chart, hide category chart
                stocksCanvas.style.display = 'none';
                statusCanvas.style.display = 'block';
                
                // Update status chart with real data
                const data = analyticsData.stocks.status;
                console.log('ðŸ“Š Status chart data:', data);
                
                if (data && data.labels && data.data && window.statusChart && window.statusChart.data) {
                    window.statusChart.data.labels = data.labels;
                    window.statusChart.data.datasets[0].data = data.data;
                    window.statusChart.data.datasets[0].backgroundColor = data.colors;
                    window.statusChart.update();
                    console.log('âœ… Status chart updated successfully');
                } else {
                    console.warn('âš ï¸ Status chart not ready or missing data');
                    if (!window.statusChart) console.warn('  - statusChart not initialized');
                    if (!data) console.warn('  - status data missing');
                    if (window.statusChart && !window.statusChart.data) console.warn('  - statusChart.data is undefined');
                }
                
            } else {
                // Show category chart, hide status chart
                stocksCanvas.style.display = 'block';
                statusCanvas.style.display = 'none';
                
                // Update category chart with real data
                const data = analyticsData.stocks[view];
                console.log('ðŸ“Š Category chart data:', data);
                
                if (data && data.labels && data.data && window.stocksChart && window.stocksChart.data) {
                    window.stocksChart.data.labels = data.labels;
                    window.stocksChart.data.datasets[0].data = data.data;
                    window.stocksChart.data.datasets[0].backgroundColor = data.colors;
                    window.stocksChart.update();
                    console.log('âœ… Category chart updated successfully');
                } else {
                    console.warn('âš ï¸ Category chart not ready or missing data');
                    if (!window.stocksChart) console.warn('  - stocksChart not initialized');
                    if (!data) console.warn('  - category data missing');
                    if (window.stocksChart && !window.stocksChart.data) console.warn('  - stocksChart.data is undefined');
                }
            }
        }

        // Status filtering function
        function filterByStatus(status) {
            console.log('ðŸ”„ Filtering by status:', status);
            
            // Check if statusChart exists
            if (!window.statusChart || !window.statusChart.data) {
                console.warn('âš ï¸ Status chart not ready for filtering');
                return;
            }
            
            // Update active button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            });
            
            const activeBtn = document.querySelector(`[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (status === 'Available') {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                } else if (status === 'To be Out of Stock') {
                    activeBtn.classList.remove('btn-outline-warning');
                    activeBtn.classList.add('btn-warning');
                } else if (status === 'Out of Stock') {
                    activeBtn.classList.remove('btn-outline-danger');
                    activeBtn.classList.add('btn-danger');
                } else {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                }
            }

            // We're in status view - filter the status chart
            const statusData = analyticsData.stocks.status;
            
            if (!statusData || !statusData.labels || !statusData.data) {
                console.warn('âš ï¸ Status data not available for filtering');
                return;
            }
            
            if (status === 'all') {
                // Show all status data
                window.statusChart.data.labels = statusData.labels;
                window.statusChart.data.datasets[0].data = statusData.data;
                window.statusChart.data.datasets[0].backgroundColor = statusData.colors;
            } else {
                // Show only the selected status
                const statusIndex = statusData.labels.indexOf(status);
                if (statusIndex !== -1) {
                    window.statusChart.data.labels = [status];
                    window.statusChart.data.datasets[0].data = [statusData.data[statusIndex]];
                    window.statusChart.data.datasets[0].backgroundColor = [statusData.colors[statusIndex]];
                } else {
                    console.warn('âš ï¸ Status not found in data:', status);
                    return;
                }
            }
            window.statusChart.update();
            console.log('âœ… Status filter applied successfully');
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            window.soilChart.data.labels = data.labels;
            window.soilChart.data.datasets[0].data = data.data;
            window.soilChart.data.datasets[0].backgroundColor = data.colors;
            window.soilChart.update();
        }

        function updateHectareChart(period) {
            console.log('ðŸ”„ Updating hectare chart to period:', period);
            
            if (!window.hectareChart || !window.hectareChart.data) {
                console.warn('âš ï¸ Hectare chart not initialized');
                return;
            }
            
            const data = analyticsData.hectare[period];
            if (!data || !data.labels || !data.data) {
                console.warn('âš ï¸ No hectare data available for period:', period);
                console.log('Available periods:', Object.keys(analyticsData.hectare));
                return;
            }
            
            console.log('ðŸ“Š Updating with data for', period, ':', data);
            console.log('ðŸ“Š Labels:', data.labels);
            console.log('ðŸ“Š Data:', data.data);
            
            window.hectareChart.data.labels = data.labels;
            window.hectareChart.data.datasets[0].data = data.data;
            window.hectareChart.update();
            
            console.log('âœ… Hectare chart updated successfully');
            console.log('âœ… Chart now shows:', window.hectareChart.data.labels);
        }

        // Sales Chart (Line Graph)
        function initSalesChart() {
            try {
                console.log('ðŸš€ Initializing Sales Chart...');
                
                // Destroy existing chart if it exists
                if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                    console.log('ðŸ—‘ï¸ Destroying existing sales chart');
                    window.salesChart.destroy();
                    window.salesChart = null;
                }
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.error('âŒ Sales chart canvas not found');
                    return;
                }
                console.log('âœ… Sales chart canvas found');
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.sales.monthly;
                
                console.log('ðŸ“Š Initial chart data:', currentData);
                
                window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        label: 'Sales (â‚±)',
                        data: currentData.data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 40,
                                usePointStyle: false
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'â‚±' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            
            console.log('âœ… Sales chart initialized successfully');
            console.log('ðŸ“Š Chart object:', window.salesChart);
            
            } catch (error) {
                console.error('âŒ Error initializing sales chart:', error);
            }
        }

        // Stocks Chart (Pie Chart)
        function initStocksChart() {
            try {
                // Destroy existing chart if it exists
                if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                    window.stocksChart.destroy();
                    window.stocksChart = null;
                }
                
                const canvas = document.getElementById('stocksChart');
                if (!canvas) {
                    console.warn('âš ï¸ Stocks chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.stocks.category;
            
            window.stocksChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    // Get current filter view
                                    const currentFilter = document.getElementById('stocksFilter').value;
                                    const label = context.label;
                                    const count = context.parsed;
                                    
                                    if (currentFilter === 'status') {
                                        // Status view - show products by status
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'ðŸŸ¢' : 
                                                              product.status === 'To be Out of Stock' ? 'ðŸŸ¡' : 'ðŸ”´';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    } else {
                                        // Category view - show products by category
                                        const products = analyticsData.stocks.category.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const categoryProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        categoryProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'ðŸŸ¢' : 
                                                              product.status === 'To be Out of Stock' ? 'ðŸŸ¡' : 'ðŸ”´';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.status})`);
                                        });
                                        
                                        return tooltipLines;
                                    }
                                },
                                labelColor: function(context) {
                                    return {
                                        borderColor: context.dataset.backgroundColor[context.dataIndex],
                                        backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                    };
                                }
                            },
                            displayColors: true,
                            bodySpacing: 4,
                            titleSpacing: 6,
                            footerSpacing: 4,
                            bodyFont: {
                                size: 12
                            },
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('âŒ Error initializing stocks chart:', error);
            }
        }

        // Status Chart (Separate Pie Chart for Status View)
        function initStatusChart() {
            try {
                // Destroy existing chart if it exists
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                    window.statusChart = null;
                }
                
                const canvas = document.getElementById('statusChart');
                if (!canvas) {
                    console.warn('âš ï¸ Status chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.stocks.status;
                
                window.statusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        // Status view - show products by status
                                        const label = context.label;
                                        const count = context.parsed;
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'ðŸŸ¢' : 
                                                              product.status === 'To be Out of Stock' ? 'ðŸŸ¡' : 'ðŸ”´';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    },
                                    labelColor: function(context) {
                                        return {
                                            borderColor: context.dataset.backgroundColor[context.dataIndex],
                                            backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                        };
                                    }
                                },
                                displayColors: true,
                                bodySpacing: 4,
                                titleSpacing: 6,
                                footerSpacing: 4,
                                bodyFont: {
                                    size: 12
                                },
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ Error initializing status chart:', error);
            }
        }

        // Soil Chart (Donut Chart)
        function initSoilChart() {
            try {
                // Destroy existing chart if it exists
                if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                    window.soilChart.destroy();
                    window.soilChart = null;
                }
                
                const canvas = document.getElementById('soilChart');
                if (!canvas) {
                    console.warn('âš ï¸ Soil chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.soil.type;
            
            window.soilChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            } catch (error) {
                console.error('âŒ Error initializing soil chart:', error);
            }
        }

        // Hectare Chart (Bar Chart)
        function initHectareChart() {
            try {
                // Destroy existing chart if it exists
                if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                    window.hectareChart.destroy();
                    window.hectareChart = null;
                }
                
                const canvas = document.getElementById('hectareChart');
                if (!canvas) {
                    console.warn('âš ï¸ Hectare chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.hectare.monthly;
                
                window.hectareChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            label: 'Hectares',
                            data: currentData.data,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        return `${context[0].label} - ${period.charAt(0).toUpperCase() + period.slice(1)} View`;
                                    },
                                    label: function(context) {
                                        const hectares = context.parsed.y;
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        const label = context.label;
                                        
                                        let tooltipText = [`ðŸŒ¾ Hectares: ${hectares.toFixed(2)} ha`];
                                        
                                        // Add contextual information based on period
                                        if (hectareData.totalHectares && hectareData.totalHectares > 0) {
                                            const percentage = ((hectares / hectareData.totalHectares) * 100).toFixed(1);
                                            tooltipText.push(`ðŸ“Š Percentage: ${percentage}%`);
                                        }
                                        
                                        if (hectareData.validFarms) {
                                            tooltipText.push(`ðŸª Active Farms: ${hectareData.validFarms}`);
                                        }
                                        
                                        // Period-specific information
                                        if (period === 'monthly') {
                                            if (hectareData.validFarms > 0) {
                                                const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                tooltipText.push(`ðŸ“ Avg per Farm: ${avgPerFarm} ha`);
                                            }
                                            tooltipText.push(`ðŸ“… Month: ${label}`);
                                        } else if (period === 'weekly') {
                                            tooltipText.push(`ðŸ“… Current Month Distribution`);
                                            if (hectares > 0) {
                                                tooltipText.push(`ðŸ—“ï¸ ${label} of Month`);
                                            }
                                        } else if (period === 'yearly') {
                                            tooltipText.push(`ðŸ“… Year: ${label}`);
                                            
                                            if (hectares > 0) {
                                                tooltipText.push(`ðŸŒ¾ Total Land in ${label}: ${hectares.toFixed(2)} ha`);
                                                tooltipText.push(`ðŸ“Š ACTUAL DATABASE DATA`);
                                                
                                                if (hectareData.validFarms > 0) {
                                                    const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                    tooltipText.push(`ðŸ“ Est. Avg per Farm: ${avgPerFarm} ha`);
                                                }
                                            } else {
                                                tooltipText.push(`âŒ No farms registered in ${label}`);
                                                tooltipText.push(`ðŸ“Š NO DATA AVAILABLE`);
                                            }
                                        }
                                        
                                        return tooltipText;
                                    },
                                    footer: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        
                                        if (hectareData.totalHectares) {
                                            return `Total Land: ${hectareData.totalHectares.toFixed(2)} hectares`;
                                        }
                                        return '';
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                footerColor: '#ccc',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' ha';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('âœ… Hectare chart initialized successfully');
                
            } catch (error) {
                console.error('âŒ Error initializing hectare chart:', error);
            }
        }

        // Filter Functions
        function updateSalesChart(period) {
            try {
                if (!window.salesChart || !window.salesChart.data) {
                    console.warn('âš ï¸ Sales chart not initialized yet');
                    return;
                }
                
                const data = analyticsData.sales[period];
                if (!data || !data.labels || !data.data) {
                    console.warn('âš ï¸ No sales data available for period:', period);
                    return;
                }
                
                window.salesChart.data.labels = data.labels;
                window.salesChart.data.datasets[0].data = data.data;
                window.salesChart.update();
                console.log('âœ… Sales chart updated for period:', period);
            } catch (error) {
                console.error('âŒ Error updating sales chart:', error);
            }
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            soilChart.data.labels = data.labels;
            soilChart.data.datasets[0].data = data.data;
            soilChart.data.datasets[0].backgroundColor = data.colors;
            soilChart.update();
        }


        // Event Listeners
        // Event Listeners for Filters
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Initialize charts
            if (typeof Chart !== 'undefined') {
                initializeCharts();
                
                // Load real data after charts are initialized
                setTimeout(() => {
                    console.log('ðŸ”„ Loading analytics after charts initialization...');
                    window.loadMunicipalityAnalytics();
                }, 2000);
            }
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('ðŸ” Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('ðŸ”„ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
                
                // Load municipality users for User Management table
                setTimeout(() => {
                    console.log('ðŸ”„ Loading municipality users...');
                    // Check if DOM elements are ready
                    const tableBody = document.getElementById('usersTableBody');
                    if (!tableBody) {
                        console.warn('âš ï¸ User table not ready, retrying in 2 seconds...');
                        setTimeout(() => {
                            window.loadMunicipalityUsers();
                        }, 2000);
                    } else {
                        window.loadMunicipalityUsers();
                    }
                }, 1500);
            }, 3000); // Increased timeout to 3 seconds
            
            // Add event listeners for filters
            const salesFilter = document.getElementById('salesFilter');
            if (salesFilter) {
                salesFilter.addEventListener('change', function() {
                    updateSalesChart(this.value);
                });
            }

            const stocksFilter = document.getElementById('stocksFilter');
            if (stocksFilter) {
                stocksFilter.addEventListener('change', function() {
                    updateStocksChart(this.value);
                });
            }

            const soilFilter = document.getElementById('soilFilter');
            if (soilFilter) {
                soilFilter.addEventListener('change', function() {
                    updateSoilChart(this.value);
                });
            }

            const hectareFilter = document.getElementById('hectareFilter');
            if (hectareFilter) {
                hectareFilter.addEventListener('change', function() {
                    updateHectareChart(this.value);
                });
            }
        });

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                sales: salesChart,
                stocks: stocksChart,
                soil: soilChart,
                hectare: hectareChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_municipality_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
                case 'picture':
                    exportToPicture(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = 'Label,Value\n';
            let data;
            
            switch(chartType) {
                case 'sales':
                    data = analyticsData.sales.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'stocks':
                    data = analyticsData.stocks.category;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'hectare':
                    data = analyticsData.hectare.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 10, 190, 100);
                    doc.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const content = `
                        <html>
                        <head><title>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics</title></head>
                        <body>
                            <h1>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            <img src="${imgData}" style="max-width: 100%; height: auto;">
                        </body>
                        </html>
                    `;
                    const blob = new Blob([content], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function exportToPicture(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Load municipality-specific users for User Management table
        window.loadMunicipalityUsers = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('âŒ Supabase client not available');
                    updateUserTable([], 'Database connection not available');
                    return;
                }
                
                // Get current admin user
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (!currentUser.id) {
                    console.log('âŒ No current user found');
                    updateUserTable([], 'User not logged in');
                    return;
                }
                
                // Get Sub Admin's municipality/address
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError || !adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('â„¹ï¸ Not a Sub Admin or no address');
                    updateUserTable([], 'Access restricted to Sub Admins');
                    return;
                }
                
                const municipalityAddress = adminData.address;
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('âŒ No municipality address found');
                    updateUserTable([], 'No municipality assigned');
                    return;
                }
                
                console.log('ðŸ” Loading users for municipality:', municipalityAddress);
                
                // Get users from the same municipality
                const { data: users, error: usersError } = await client
                    .from('users')
                    .select('full_name, email, phone_number, municipality, address')
                    .eq('municipality', municipalityAddress)
                    .order('full_name', { ascending: true });
                
                if (usersError) {
                    console.error('âŒ Error fetching users:', usersError);
                    updateUserTable([], 'Error loading users');
                    return;
                }
                
                console.log(`âœ… Found ${users ? users.length : 0} users in ${municipalityAddress}`);
                console.log('ðŸ” User details:', users);
                
                updateUserTable(users || [], null, municipalityAddress);
                
            } catch (error) {
                console.error('âŒ Error in loadMunicipalityUsers:', error);
                updateUserTable([], 'Error loading users');
            }
        }
        
        // Pagination variables
        let currentUserPage = 1;
        let allMunicipalityUsers = [];
        
        // Update User Management table with real data
        function updateUserTable(users, errorMessage, municipality) {
            const tableBody = document.getElementById('usersTableBody');
            const viewAllLink = document.getElementById('viewAllUsersLink');
            
            if (!tableBody) {
                console.warn('âš ï¸ User table element (usersTableBody) not found. Retrying in 1 second...');
                setTimeout(() => updateUserTable(users, errorMessage, municipality), 1000);
                return;
            }
            
            console.log('âœ… User table elements found, updating table...');
            
            // Store users for pagination
            allMunicipalityUsers = users;
            currentUserPage = 1;
            
            if (errorMessage) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${errorMessage}
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-users me-2"></i>
                            No users found in ${municipality || 'this municipality'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log(`ðŸ“Š Displaying ${users.length} users from ${municipality}`);
            
            // Update view all link
            if (viewAllLink) {
                viewAllLink.textContent = `View all ${users.length} users >`;
            }
            
            // Display paginated users
            displayUsersPage(currentUserPage);
        }
        
        // Display users for current page
        function displayUsersPage(page) {
            const tableBody = document.getElementById('usersTableBody');
            const currentPageBtn = document.getElementById('currentPageBtn');
            const tableInfo = document.getElementById('usersTableInfo');
            
            if (!tableBody) {
                console.warn('âš ï¸ User table element not found in displayUsersPage');
                return;
            }
            
            console.log(`ðŸ“„ Displaying page ${page} of users`);
            
            const startIndex = (page - 1) * 10; // Use 10 for the existing pagination system
            const endIndex = startIndex + 10;
            const pageUsers = allMunicipalityUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No users on this page
                        </td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }
            
            tableBody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>${user.full_name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                </tr>
            `).join('');
            
            console.log(`âœ… Successfully displayed ${pageUsers.length} users on page ${page}`);
            
            // Update pagination info
            if (currentPageBtn) {
                currentPageBtn.textContent = page;
            }
            
            // Update table info
            if (tableInfo) {
                const startItem = startIndex + 1;
                const endItem = Math.min(endIndex, allMunicipalityUsers.length);
                tableInfo.textContent = `${startItem} to ${endItem} items of ${allMunicipalityUsers.length}`;
            }
            
            console.log(`ðŸ“„ Displaying page ${page}: ${pageUsers.length} users`);
        }
        
        // Pagination function
        function changePage(direction) {
            const totalPages = Math.ceil(allMunicipalityUsers.length / 10); // Use 10 for consistency
            const newPage = currentUserPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentUserPage = newPage;
                displayUsersPage(currentUserPage);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Modal and User Management Functions
        function showAllUsersModal() {
            const modal = new bootstrap.Modal(document.getElementById('allUsersModal'));
            modal.show();
            // Use the filtered municipality users instead of loading all users
            loadMunicipalityUsersForModal();
        }

        // Function to load municipality users for the modal (same data as main table)
        function loadMunicipalityUsersForModal() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS FOR MODAL ===');
                
                // Use the existing filtered municipality users
                if (allMunicipalityUsers && allMunicipalityUsers.length > 0) {
                    console.log('âœ… Using existing municipality users data:', allMunicipalityUsers);
                    updateAllUsersTable(allMunicipalityUsers);
                } else {
                    console.log('âš ï¸ No municipality users data available');
                    updateAllUsersTable([]);
                }

            } catch (error) {
                console.error('Error in loadMunicipalityUsersForModal:', error);
                updateAllUsersTable([]);
            }
        }

        // Function to update the all users modal table
        function updateAllUsersTable(users) {
            const tableBody = document.getElementById('allUsersTableBody');
            const usersCount = document.getElementById('allUsersCount');
            const modalTitle = document.getElementById('allUsersModalLabel');
            
            if (!tableBody) {
                console.error('âŒ All users table body not found');
                return;
            }

            // Update modal title to reflect municipality users
            if (modalTitle) {
                modalTitle.textContent = 'All Municipality Users';
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No users found in this municipality</td>
                    </tr>
                `;
                if (usersCount) {
                    usersCount.textContent = '0 users found';
                }
                return;
            }

            // Populate table with user data (simplified to match main table)
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.full_name || user.name || user.email || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || user.phone || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update count
            if (usersCount) {
                usersCount.textContent = `${users.length} users found`;
            }

            console.log('âœ… All municipality users modal table updated with', users.length, 'users');
            
            // Store users data for search functionality
            window.allUsersData = users;
            setupUserSearch();
        }

        // Function to setup user search functionality
        function setupUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!window.allUsersData) return;

                const filteredUsers = window.allUsersData.filter(user => {
                    const name = (user.full_name || user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const phone = (user.phone_number || user.phone || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           email.includes(searchTerm) || 
                           phone.includes(searchTerm);
                });

                updateAllUsersTable(filteredUsers);
            });
        }
    </script>

    <!-- All Users Modal -->
    <div class="modal fade" id="allUsersModal" tabindex="-1" aria-labelledby="allUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allUsersModalLabel">All Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search users by name, email...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Contact Number</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allUsersCount">0 users found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
