<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipality Dashboard - Anihan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="fixed-layout.css">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link rel="stylesheet" href="municipality_dashboard.css">
    <style>
        .status-filters {
            transition: all 0.3s ease;
        }
        
        .status-filter-btn {
            transition: all 0.2s ease;
            border-width: 1px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-filter-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        /* Municipality Chart Styles */
        .municipality-item {
            margin-bottom: 20px;
            padding: 15px;
            background: #ffffff;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            transition: all 0.3s ease;
        }

        .municipality-item:hover {
            border-color: #dee2e6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        /* Chart Container Stability Styles */
        .chart-container-stable {
            overflow: hidden !important;
            position: relative !important;
        }

        .chart-container-stable canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
        }

        #salesChart {
            transition: none !important;
            animation: none !important;
        }

        /* Chart Container Responsive Design */
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            height: 350px;
            overflow: hidden;
        }

        .chart-container canvas {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
            min-height: 300px !important;
        }

        /* Analytics Card Styling */
        .analytics-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 24px;
            min-height: 450px;
        }

        .analytics-card .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 20px;
        }

        .analytics-card .card-body {
            padding: 20px;
        }

        .municipality-item.top-municipality {
            background: #ffffff;
            border: 1px solid #e9ecef;
            position: relative;
            overflow: hidden;
        }

        .municipality-item.top-municipality::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #f39c12;
        }

        .municipality-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .municipality-name {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        .municipality-sales {
            font-weight: 700;
            color: #27ae60;
            font-size: 16px;
        }

        .municipality-bar {
            width: 100%;
            height: 12px;
            background-color: #e9ecef;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .municipality-progress {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            border-radius: 6px;
            transition: width 0.8s ease-in-out;
            position: relative;
        }

        .municipality-progress.top-performer {
            background: linear-gradient(90deg, #f39c12, #e67e22);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .municipality-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .municipality-scale {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding: 0 15px;
            font-size: 12px;
            color: #6c757d;
            font-weight: 500;
        }

        /* Users Table Styles */
        .users-table-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-table-header {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .users-table-header h5 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .users-table-body {
            padding: 0;
        }

        .users-table-body .table {
            margin: 0;
        }

        .users-table-body .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody td {
            padding: 12px 20px;
            border: none;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody tr {
            border-bottom: 1px solid #f1f3f4;
        }

        .users-table-body .table tbody tr:last-child {
            border-bottom: none;
        }

        .users-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .table-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .table-info {
            color: #6c757d;
            font-size: 14px;
        }

        .view-all-link {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .view-all-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-controls .btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid #28a745;
            color: #28a745;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }

        .pagination-controls .btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .pagination-controls .active-page {
            background: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }

        .pagination-controls .btn-outline-secondary {
            border-color: #28a745;
            color: #28a745;
        }

        .pagination-controls .btn-outline-secondary:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* All Users Modal Styles */
        #allUsersModal .modal-dialog {
            max-width: 95%;
        }
        
        #allUsersModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allUsersModal .table td {
            vertical-align: middle;
        }
        
        #userSearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #userSearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .badge {
            font-size: 0.875rem;
        }
        
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" class="avatar-img" style="display: none;" alt="Profile">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" class="profile-avatar-img" style="display: none;" alt="Profile">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 id="profileUserName" class="profile-dropdown-name">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="profileUserAccess">Loading...</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="municipality_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link" href="sub_admin_inventory.html">
                        <i class="fas fa-boxes me-2"></i>
                        Inventory Records
                    </a>
                    <a class="nav-link" href="sub_admin_price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    <a class="nav-link" href="sub_admin_in_demand_products.html">
                        <i class="fas fa-chart-line me-2"></i>
                        In Demand Products
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="main-content">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card stats-users">
                                <div class="stats-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeUsersCount">Loading...</div>
                                    <div class="stats-label">Active Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-products">
                                <div class="stats-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="productsCount">Loading...</div>
                                    <div class="stats-label">Available Products</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-farmers">
                                <div class="stats-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                    <div class="stats-label">Active Farmers</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Sales Analytics (Seller Sales by Municipality)</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="salesChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Stocks Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 100px;">
                                            <option value="category">Category</option>
                                            <option value="status">Status</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <!-- Category Chart -->
                                        <canvas id="stocksChart"></canvas>
                                        
                                        <!-- Status Chart (initially hidden) -->
                                        <canvas id="statusChart" style="display: none;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Soil Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                            <option value="type">Soil Type</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="soilChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Hectare Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 100px;">
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="hectareChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="users-table-card mt-4">
                        <div class="users-table-header">
                            <h5>User Management</h5>
                        </div>
                        <div class="users-table-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Contact Number</th>
                                    </tr>
                                </thead>
                                <tbody id="usersTableBody">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="users-table-footer">
                            <div class="table-info-section">
                                <span class="table-info" id="usersTableInfo">1 to 4 items of 0</span>
                                <a href="#" class="view-all-link" onclick="showAllUsersModal()">View all ></a>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-outline-secondary" onclick="changePage(-1)">&lt;</button>
                                <button class="btn btn-success active-page" id="currentPageBtn">1</button>
                                <button class="btn btn-outline-secondary" onclick="changePage(1)">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Add Supabase Client (required by shared-profile.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Chart variables
        let salesChart, stocksChart, soilChart, hectareChart, statusChart;

        // Use the Supabase client from shared-profile.js
        console.log('Municipality dashboard using shared Supabase client');

        // Chart Data for Municipality Dashboard - Initialize with default structure
        let analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: new Array(12).fill(0)
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: new Array(4).fill(0)
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: new Array(4).fill(0)
                }
            },
            stocks: {
                category: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d'],
                    products: {
                        'Loading...': [{ name: 'Loading...', quantity: 0, status: 'Loading...' }]
                    }
                },
                status: {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: [0, 0, 0],
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: {
                        'Available': [],
                        'To be Out of Stock': [],
                        'Out of Stock': []
                    }
                },
                supplier: {
                    labels: ['Local Farmers', 'Cooperatives', 'Direct Import', 'Distributors'],
                    data: [40, 30, 20, 10],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                }
            },
            soil: {
                type: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d']
                },
                region: {
                    labels: ['North District', 'South District', 'East District', 'West District'],
                    data: [30, 25, 25, 20],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                },
                season: {
                    labels: ['Dry Season', 'Wet Season', 'Transition'],
                    data: [45, 35, 20],
                    colors: ['#ff6b35', '#4ecdc4', '#45b7d1']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [180, 185, 190, 195]
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: [5500, 6200, 6800, 7500]
                }
            }
        };

        // Initialize Charts
        function initializeCharts() {
            // Destroy existing charts if they exist to prevent canvas reuse errors
            if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                window.salesChart.destroy();
                window.salesChart = null;
            }
            if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                window.stocksChart.destroy();
                window.stocksChart = null;
            }
            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }
            if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                window.soilChart.destroy();
                window.soilChart = null;
            }
            if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                window.hectareChart.destroy();
                window.hectareChart = null;
            }
            
            console.log('üîÑ Initializing charts...');
            initSalesChart();
            initStocksChart();
            initStatusChart(); // Initialize the separate status chart
            initSoilChart();
            initHectareChart();
            console.log('‚úÖ Charts initialized successfully');
        }

        // Load municipality-specific statistics for Sub Admin
        window.loadMunicipalityStats = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY STATISTICS ===');
                
                // Check if Supabase client is available
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('‚ùå Supabase client not available');
                    alert('Database connection not available. Please check your internet connection.');
                    return;
                }
                
                const client = window.supabaseClient || supabaseClient;
                console.log('‚úÖ Supabase client available');
                
                // Get current user from session storage
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('üîç Current user for stats:', currentUser);
                console.log('üîç Session storage contents:', sessionStorage.getItem('currentUser'));
                
                if (!currentUser.id) {
                    console.log('‚ùå No current user found for stats');
                    console.log('üîç Available session storage keys:', Object.keys(sessionStorage));
                    return;
                }
                
                // Get the admin's full data to access their address (municipality)
                console.log('üîç Fetching admin data for ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('‚ùå Error fetching admin data:', adminError);
                    console.log('üîç Trying to fetch first admin for testing...');
                    
                    // Try to get any admin for testing
                    const { data: testAdmins, error: testError } = await client
                        .from('admin_accounts')
                        .select('*')
                        .limit(5);
                    
                    console.log('üîç Available admins in database:', testAdmins);
                    if (testError) {
                        console.error('‚ùå Error fetching test admins:', testError);
                    }
                    return;
                }
                
                console.log('‚úÖ Admin data found:', adminData);
                
                // Check if user is Sub Admin
                if (adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è User is not Sub Admin, user type:', adminData.user_type);
                    console.log('‚ÑπÔ∏è Available user types should include: SUB ADMIN');
                    // For Super Admin, could show aggregate data or different view
                    
                    // Show some sample data for testing
                    document.getElementById('activeUsersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('productsCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('activeFarmersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('totalRevenueCount').textContent = 'N/A (Super Admin)';
                    return;
                }
                
                console.log('‚úÖ User is Sub Admin');
                
                const municipalityAddress = adminData.address;
                console.log('üîç Sub Admin municipality/address:', municipalityAddress);
                console.log('üîç Address type:', typeof municipalityAddress);
                console.log('üîç Address length:', municipalityAddress ? municipalityAddress.length : 'null');
                
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('‚ùå No municipality address found for Sub Admin');
                    alert('No municipality assigned to this Sub Admin account. Please contact administrator.');
                    document.getElementById('activeUsersCount').textContent = '0';
                    document.getElementById('productsCount').textContent = '0';
                    document.getElementById('activeFarmersCount').textContent = '0';
                    return;
                }
                
                // Update profile access info
                const profileAccess = document.getElementById('profileUserAccess');
                if (profileAccess) {
                    profileAccess.textContent = `Access: ${municipalityAddress}`;
                }
                
                // 1. Get users whose municipality matches Sub Admin's address
                console.log('üîç Searching for users with municipality:', municipalityAddress);
                
                // First, let's see what municipalities exist in the database
                const { data: allMunicipalities, error: municError } = await client
                    .from('users')
                    .select('municipality')
                    .not('municipality', 'is', null);
                
                if (!municError && allMunicipalities) {
                    const uniqueMunicipalities = [...new Set(allMunicipalities.map(u => u.municipality))].filter(m => m);
                    console.log('üîç Available municipalities in users table:', uniqueMunicipalities);
                    console.log('üîç Looking for exact match with:', municipalityAddress);
                    
                    // Check for case-insensitive matches
                    const caseInsensitiveMatches = uniqueMunicipalities.filter(m => 
                        m && m.toLowerCase() === municipalityAddress.toLowerCase()
                    );
                    console.log('üîç Case-insensitive matches:', caseInsensitiveMatches);
                }
                
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .eq('municipality', municipalityAddress);
                
                if (usersError) {
                    console.error('‚ùå Error fetching users by municipality:', usersError);
                    return;
                }
                
                console.log(`üîç Query result: Found ${municipalityUsers ? municipalityUsers.length : 0} users in municipality: ${municipalityAddress}`);
                console.log('üîç User details:', municipalityUsers);
                
                // Get all user IDs for further queries
                const userIds = municipalityUsers ? municipalityUsers.map(user => user.id) : [];
                const totalUsers = municipalityUsers ? municipalityUsers.length : 0;
                
                console.log('üîç User IDs for store owner check:', userIds);
                
                // 2. Get farmers (users who became store owners) in the municipality
                let totalFarmers = 0;
                let storeOwnerUserIds = [];
                
                if (userIds.length > 0) {
                    // Try both possible table name formats for store owner
                    let farmers = null;
                    let farmersError = null;
                    
                    try {
                        console.log('üîç Trying store-owner table...');
                        const result = await client
                            .from('store-owner')
                            .select('user_id, id')
                            .in('user_id', userIds);
                        farmers = result.data;
                        farmersError = result.error;
                        console.log('‚úÖ store-owner table result:', { data: farmers, error: farmersError });
                    } catch (error) {
                        console.log('‚ùå store-owner table failed, trying store_owner...');
                        try {
                            const result = await client
                                .from('store_owner')
                                .select('user_id, id')
                                .in('user_id', userIds);
                            farmers = result.data;
                            farmersError = result.error;
                            console.log('‚úÖ store_owner table result:', { data: farmers, error: farmersError });
                        } catch (error2) {
                            console.error('‚ùå Could not access store owner table with either name format:', error2);
                            farmersError = error2;
                        }
                    }
                    
                    if (!farmersError && farmers) {
                        // Get unique store owner user IDs
                        storeOwnerUserIds = [...new Set(farmers.map(farmer => farmer.user_id))];
                        totalFarmers = storeOwnerUserIds.length;
                        console.log(`Found ${totalFarmers} active farmers (store owners) in ${municipalityAddress}`);
                    } else {
                        console.log('No farmers found or error accessing farmer data:', farmersError);
                    }
                }
                
                // 3. Get available products from users in the municipality who are also store owners
                let totalProducts = 0;
                if (storeOwnerUserIds.length > 0) {
                    console.log('üîç Searching for products from store owners:', storeOwnerUserIds);
                    const { data: products, error: productsError } = await client
                        .from('my_products')
                        .select('id, user_id, name')
                        .in('user_id', storeOwnerUserIds);
                    
                    if (!productsError && products) {
                        totalProducts = products.length;
                        console.log(`‚úÖ Found ${totalProducts} products from store owners in ${municipalityAddress}`);
                        console.log('üîç Product details:', products);
                    } else {
                        console.log('‚ùå No products found or error accessing products:', productsError);
                    }
                } else {
                    console.log('‚ùå No store owners found, so no products to count');
                }
                
                // Update the UI with the counts
                document.getElementById('activeUsersCount').textContent = `${totalUsers}`;
                document.getElementById('productsCount').textContent = `${totalProducts}`;
                document.getElementById('activeFarmersCount').textContent = `${totalFarmers}`;
                
                console.log('=== MUNICIPALITY STATS LOADED ===');
                console.log(`Municipality: ${municipalityAddress}`);
                console.log(`Active Users (in municipality): ${totalUsers}`);
                console.log(`Active Farmers (users who became store owners): ${totalFarmers}`);
                console.log(`Available Products (from store owners): ${totalProducts}`);
                console.log('Matching criteria: Sub Admin address = Users municipality + Users must be store owners');
                
            } catch (error) {
                console.error('Error loading municipality stats:', error);
                
                // Show error state
                document.getElementById('activeUsersCount').textContent = 'Error';
                document.getElementById('productsCount').textContent = 'Error';
                document.getElementById('activeFarmersCount').textContent = 'Error';
            }
        }

        // Function to load real analytics data based on municipality
        window.loadMunicipalityAnalytics = async function() {
            try {
                console.log('üöÄ === STARTING MUNICIPALITY ANALYTICS LOAD ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå Supabase client not available');
                    return;
                }
                console.log('‚úÖ Supabase client found');
                
                // Get current user from session
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('üë§ Current user from session:', currentUser);
                
                if (!currentUser.id) {
                    console.error('‚ùå No current user found');
                    console.log('üîç Session storage contents:', sessionStorage.getItem('currentUser'));
                    return;
                }
                
                // Get Sub Admin's address
                console.log('üîç Fetching admin data for user ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('‚ùå Error fetching admin data:', adminError);
                    console.log('üîç Trying to fetch any admin data for debugging...');
                    
                    const { data: allAdmins, error: allError } = await client
                        .from('admin_accounts')
                        .select('id, address, user_type')
                        .limit(5);
                    
                    console.log('üîç Available admins:', allAdmins);
                    return;
                }
                
                console.log('‚úÖ Admin data found:', adminData);
                
                if (!adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è Not a Sub Admin or no admin data, user type:', adminData?.user_type);
                    return;
                }
                
                const municipalityAddress = adminData.address;
                console.log('üèõÔ∏è Municipality address:', municipalityAddress);
                if (!municipalityAddress) {
                    console.log('‚ùå No municipality address found');
                    return;
                }
                
                console.log('üîç Loading analytics for municipality:', municipalityAddress);
                
                // Get users in the municipality
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id')
                    .eq('municipality', municipalityAddress);
                
                if (usersError || !municipalityUsers) {
                    console.error('‚ùå Error fetching users:', usersError);
                    return;
                }
                
                const userIds = municipalityUsers.map(user => user.id);
                console.log('üîç User IDs for analytics:', userIds);
                
                // Load Sales Analytics (from orders matching municipality)
                await loadSalesAnalytics(client, municipalityAddress, adminData);
                
                // Load Stock Analytics (from my_products)
                await loadStockAnalytics(client, userIds);
                
                // Load Soil Analytics (from store-owner)
                await loadSoilAnalytics(client, userIds);
                
                // Load Hectare Analytics (from store-owner)
                await loadHectareAnalytics(client, userIds);
                
                console.log('‚úÖ Municipality analytics loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading municipality analytics:', error);
            }
        }

        // Load Sales Analytics from orders matching municipality
        async function loadSalesAnalytics(client, municipalityAddress, adminData) {
            try {
                console.log('üöÄ STARTING SALES ANALYTICS BY SELLER MUNICIPALITY');
                console.log('üèõÔ∏è Target municipality:', municipalityAddress);
                
                // Step 1: Get all sellers from store-owner table
                console.log('üì° Step 1: Fetching all sellers from store-owner table...');
                const { data: sellers, error: sellersError } = await client
                    .from('store-owner')
                    .select('user_id');
                
                if (sellersError) {
                    console.error('‚ùå Error fetching sellers:', sellersError);
                    console.error('‚ùå Full error:', JSON.stringify(sellersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`üìä Found ${sellers?.length || 0} sellers in store-owner table`);
                console.log('üìä Sample sellers:', sellers?.slice(0, 3));
                
                if (!sellers || sellers.length === 0) {
                    console.warn('‚ö†Ô∏è No sellers found in store-owner table');
                    updateSalesChartWithFallback();
                    return;
                }
                
                // Extract seller user IDs
                const sellerUserIds = sellers.map(seller => seller.user_id);
                console.log('üë• Seller user IDs:', sellerUserIds.slice(0, 5), '...and', sellerUserIds.length - 5, 'more');
                
                // Step 2: Get seller details with municipality from users table
                console.log('üì° Step 2: Fetching seller details from users table...');
                const { data: sellerUsers, error: usersError } = await client
                    .from('users')
                    .select('id, full_name, municipality')
                    .in('id', sellerUserIds);
                
                if (usersError) {
                    console.error('‚ùå Error fetching seller users:', usersError);
                    console.error('‚ùå Full error:', JSON.stringify(usersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`ÔøΩ Found ${sellerUsers?.length || 0} seller users`);
                console.log('üë• Sample seller users:', sellerUsers?.slice(0, 3));
                
                if (!sellerUsers || sellerUsers.length === 0) {
                    console.warn('‚ö†Ô∏è No seller users found');
                    updateSalesChartWithFallback();
                    return;
                }
                
                // Step 3: Filter sellers by municipality (if admin municipality is specified)
                let filteredSellers = sellerUsers;
                if (municipalityAddress) {
                    filteredSellers = sellerUsers.filter(user => user.municipality === municipalityAddress);
                    console.log(`üèõÔ∏è Filtered to ${filteredSellers.length} sellers in municipality: ${municipalityAddress}`);
                } else {
                    console.log('ÔøΩ No municipality filter applied - showing all sellers');
                }
                
                console.log('üèõÔ∏è Filtered sellers:', filteredSellers?.slice(0, 3));
                
                if (filteredSellers.length === 0) {
                    console.warn('‚ö†Ô∏è No sellers found in target municipality');
                    analyticsData.sales = {
                        monthly: { labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'], data: new Array(12).fill(0) },
                        weekly: { labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'], data: new Array(4).fill(0) },
                        yearly: { labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()), data: new Array(4).fill(0) }
                    };
                    updateSalesChart();
                    return;
                }
                
                // Step 4: Get orders for these sellers
                const targetSellerIds = filteredSellers.map(seller => seller.id);
                console.log('üì° Step 4: Fetching orders for sellers...');
                console.log('ÔøΩ Target seller IDs:', targetSellerIds);
                
                const { data: sellerProducts, error: productsError } = await client
                    .from('my_products')
                    .select('id, user_id, name')
                    .in('user_id', targetSellerIds);
                
                if (productsError) {
                    console.error('‚ùå Error fetching seller products:', productsError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`üõçÔ∏è Found ${sellerProducts?.length || 0} products from target sellers`);
                
                if (!sellerProducts || sellerProducts.length === 0) {
                    console.warn('‚ö†Ô∏è No products found from target sellers');
                    updateSalesChartWithFallback();
                    return;
                }
                
                const productIds = sellerProducts.map(product => product.id);
                
                // Get order items for these products
                const { data: orderItems, error: orderItemsError } = await client
                    .from('order_items')
                    .select('id, order_id, product_id, quantity, price')
                    .in('product_id', productIds);
                
                if (orderItemsError) {
                    console.error('‚ùå Error fetching order items:', orderItemsError);
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`üì¶ Found ${orderItems?.length || 0} order items for seller products`);
                
                if (!orderItems || orderItems.length === 0) {
                    console.warn('‚ö†Ô∏è No order items found for seller products');
                    updateSalesChartWithFallback();
                    return;
                }
                
                const orderIds = [...new Set(orderItems.map(item => item.order_id))];
                console.log(`üìã Found ${orderIds.length} unique orders containing seller products`);
                
                // Get the full orders for these order IDs
                const { data: orders, error: ordersError } = await client
                    .from('orders')
                    .select('id, user_id, total, created_at, status')
                    .in('id', orderIds)
                    .not('total', 'is', null);
                
                if (ordersError) {
                    console.error('‚ùå Error fetching orders:', ordersError);
                    console.error('‚ùå Full error:', JSON.stringify(ordersError, null, 2));
                    updateSalesChartWithFallback();
                    return;
                }
                
                console.log(`üì¶ Found ${orders?.length || 0} complete orders`);
                console.log('üì¶ Sample orders:', orders?.slice(0, 3));
                
                // Step 7: Calculate sales attributed to sellers
                let totalSales = 0;
                const salesByOrder = new Map();
                
                if (orders && orders.length > 0) {
                    // For each order, calculate how much was spent on seller products
                    for (const order of orders) {
                        const orderItemsForThisOrder = orderItems.filter(item => item.order_id === order.id);
                        const orderSalesFromSellers = orderItemsForThisOrder.reduce((sum, item) => {
                            const itemTotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0);
                            return sum + itemTotal;
                        }, 0);
                        
                        salesByOrder.set(order.id, orderSalesFromSellers);
                        totalSales += orderSalesFromSellers;
                    }
                    
                    console.log('üí∞ Sales breakdown by order:');
                    Array.from(salesByOrder.entries()).slice(0, 10).forEach(([orderId, sales]) => {
                        const order = orders.find(o => o.id === orderId);
                        console.log(`  üì¶ Order ${orderId}: ‚Ç±${sales.toFixed(2)} (${new Date(order?.created_at).toLocaleDateString()})`);
                    });
                    
                    if (salesByOrder.size > 10) {
                        console.log(`  ... and ${salesByOrder.size - 10} more orders`);
                    }
                }
                
                console.log(`üí∞ TOTAL SALES FROM MUNICIPALITY SELLERS: ‚Ç±${totalSales.toFixed(2)}`);
                
                // Step 8: Create modified orders array with seller-attributed sales for chart generation
                const sellerAttributedOrders = orders.map(order => ({
                    ...order,
                    total: salesByOrder.get(order.id) || 0
                })).filter(order => order.total > 0);
                
                console.log('üìä Step 8: Generating time-based chart data...');
                analyticsData.sales = generateMultiPeriodData(sellerAttributedOrders);
                
                // Log chart data
                const monthlyTotal = analyticsData.sales.monthly.data.reduce((sum, val) => sum + val, 0);
                console.log(`üìä Monthly chart total: ‚Ç±${monthlyTotal.toFixed(2)}`);
                console.log('üìä Monthly data:', analyticsData.sales.monthly.labels.map((label, i) => 
                    `${label}: ‚Ç±${analyticsData.sales.monthly.data[i].toFixed(2)}`
                ).join(', '));
                
                // Step 7: Update the chart
                console.log('üìä Step 7: Updating sales chart...');
                updateSalesChart();
                
                // Force chart update
                setTimeout(() => {
                    if (window.salesChart && analyticsData.sales.monthly) {
                        console.log('üîÑ Force updating chart...');
                        const monthlyData = analyticsData.sales.monthly;
                        window.salesChart.data.labels = monthlyData.labels;
                        window.salesChart.data.datasets[0].data = monthlyData.data;
                        window.salesChart.update('none');
                        console.log('‚úÖ Chart force updated with data:', monthlyData);
                    }
                }, 100);
                
                console.log('‚úÖ Sales analytics completed successfully');
                console.log(`‚úÖ Showing sales from ${filteredSellers.length} sellers in ${municipalityAddress}`);
                console.log('‚úÖ Sales properly attributed to seller municipality via order items');
                
            } catch (error) {
                console.error('‚ùå Critical error in loadSalesAnalytics:', error);
                console.error('‚ùå Error stack:', error.stack);
                updateSalesChartWithFallback();
            }
        }

        // Helper function to update sales chart
        function updateSalesChart() {
            if (window.salesChart && window.salesChart.data) {
                try {
                    console.log('üìä Updating sales chart with new data...');
                    const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                    const currentData = analyticsData.sales[currentFilter];
                    
                    console.log('üìä Current filter:', currentFilter);
                    console.log('üìä Data to update chart with:', currentData);
                    
                    if (currentData && currentData.labels && currentData.data) {
                        window.salesChart.data.labels = currentData.labels;
                        window.salesChart.data.datasets[0].data = currentData.data;
                        window.salesChart.update('none'); // Update without animation to prevent movement
                        
                        // Update total sales displays
                        updateMunicipalitySalesDisplays(currentData, currentFilter);
                        
                        console.log('‚úÖ Sales chart updated successfully with real data');
                    } else {
                        console.error('‚ùå Invalid chart data structure:', currentData);
                    }
                } catch (chartError) {
                    console.error('‚ùå Error updating sales chart:', chartError);
                }
            } else {
                console.warn('‚ö†Ô∏è Sales chart not available for update');
                console.log('üîç window.salesChart exists:', !!window.salesChart);
                console.log('üîç window.salesChart.data exists:', !!(window.salesChart && window.salesChart.data));
            }
        }

        // Function to update municipality sales amount displays
        function updateMunicipalitySalesDisplays(currentData, currentFilter) {
            try {
                console.log('üîÑ Updating municipality sales displays...', { currentData, currentFilter });
                
                // Calculate current period total
                const currentPeriodTotal = currentData.data.reduce((sum, value) => sum + value, 0);
                
                // Calculate total across all periods
                let totalSales = 0;
                Object.values(analyticsData.sales).forEach(periodData => {
                    if (periodData && periodData.data) {
                        totalSales += periodData.data.reduce((sum, value) => sum + value, 0);
                    }
                });
                
                // Update display elements
                const totalSalesElement = document.getElementById('totalMunicipalitySales');
                const currentPeriodElement = document.getElementById('currentPeriodSales');
                
                console.log('üìä Display elements found:', { 
                    totalSalesElement: !!totalSalesElement, 
                    currentPeriodElement: !!currentPeriodElement 
                });
                
                if (totalSalesElement) {
                    const formattedTotal = `‚Ç±${totalSales.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    totalSalesElement.textContent = formattedTotal;
                    console.log('üí∞ Updated total sales display:', formattedTotal);
                } else {
                    console.warn('‚ö†Ô∏è Total sales element not found');
                }
                
                if (currentPeriodElement) {
                    let periodLabel = '';
                    switch(currentFilter) {
                        case 'monthly': periodLabel = 'This Year'; break;
                        case 'weekly': periodLabel = 'This Month'; break;
                        case 'yearly': periodLabel = 'All Years'; break;
                        default: periodLabel = 'Current Period';
                    }
                    const formattedPeriod = `‚Ç±${currentPeriodTotal.toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                    currentPeriodElement.textContent = formattedPeriod;
                    
                    // Update the label
                    const periodLabelElement = currentPeriodElement.previousElementSibling;
                    if (periodLabelElement && periodLabelElement.classList.contains('text-muted')) {
                        periodLabelElement.textContent = periodLabel;
                    }
                    
                    console.log('üìà Updated current period display:', formattedPeriod, `(${periodLabel})`);
                } else {
                    console.warn('‚ö†Ô∏è Current period element not found');
                }
                
                console.log(`üí∞ Municipality sales displays updated - Total: ‚Ç±${totalSales.toFixed(2)}, Current Period (${currentFilter}): ‚Ç±${currentPeriodTotal.toFixed(2)}`);
                
            } catch (error) {
                console.error('‚ùå Error updating municipality sales displays:', error);
            }
        }

        // Function to process orders data for chart display (copied from dashboard_super_admin)
        function processOrdersForChart(orders) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            // Initialize monthly data
            const monthlyData = {};
            monthNames.forEach(month => {
                monthlyData[month] = 0;
            });

            // Group orders by month
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    if (orderDate.getFullYear() === currentYear) {
                        const monthName = monthNames[orderDate.getMonth()];
                        const orderTotal = parseFloat(order.total) || 0;
                        monthlyData[monthName] += orderTotal;
                    }
                }
            });

            console.log('Monthly sales data:', monthlyData);

            return {
                labels: monthNames,
                data: monthNames.map(month => monthlyData[month])
            };
        }
        
        // Function to generate data for multiple periods (monthly, weekly, yearly)
        function generateMultiPeriodData(orders) {
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            
            // Monthly data for current year
            const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const monthlyData = new Array(12).fill(0);
            
            // Weekly data for current month
            const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const weeklyData = new Array(4).fill(0);
            
            // Yearly data for last 4 years
            const yearLabels = [currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(y => y.toString());
            const yearlyData = new Array(4).fill(0);
            
            orders.forEach(order => {
                if (!order.created_at || !order.total) return;
                
                const orderDate = new Date(order.created_at);
                const orderTotal = parseFloat(order.total) || 0;
                const orderYear = orderDate.getFullYear();
                const orderMonth = orderDate.getMonth();
                
                // Monthly data (current year only)
                if (orderYear === currentYear) {
                    monthlyData[orderMonth] += orderTotal;
                }
                
                // Weekly data (current month only)
                if (orderYear === currentYear && orderMonth === currentMonth) {
                    const weekOfMonth = Math.floor((orderDate.getDate() - 1) / 7);
                    if (weekOfMonth >= 0 && weekOfMonth < 4) {
                        weeklyData[weekOfMonth] += orderTotal;
                    }
                }
                
                // Yearly data
                const yearIndex = yearLabels.indexOf(orderYear.toString());
                if (yearIndex !== -1) {
                    yearlyData[yearIndex] += orderTotal;
                }
            });
            
            return {
                monthly: { labels: monthLabels, data: monthlyData },
                weekly: { labels: weekLabels, data: weeklyData },
                yearly: { labels: yearLabels, data: yearlyData }
            };
        }
        
        // Fallback function for when there are errors (similar to dashboard_super_admin)
        function updateSalesChartWithFallback() {
            if (!window.salesChart) return;
            
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let fallbackData;
            
            switch (period) {
                case 'weekly':
                    fallbackData = {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'yearly':
                    fallbackData = {
                        labels: [new Date().getFullYear() - 3, new Date().getFullYear() - 2, new Date().getFullYear() - 1, new Date().getFullYear()].map(y => y.toString()),
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'monthly':
                default:
                    fallbackData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        data: new Array(12).fill(0)
                    };
                    break;
            }
            
            window.salesChart.data.labels = fallbackData.labels;
            window.salesChart.data.datasets[0].data = fallbackData.data;
            window.salesChart.data.datasets[0].label = period === 'weekly' ? 'Weekly Sales' : 
                                                     period === 'yearly' ? 'Annual Sales' : 'Monthly Sales';
            window.salesChart.update();
            console.log(`‚ö†Ô∏è Sales chart updated with empty ${period} data (no municipality data found)`);
        }

        // Test function to check municipality products sales
        window.testMunicipalityProductsSales = async function() {
            try {
                console.log('üß™ === TESTING MUNICIPALITY PRODUCTS SALES LOGIC ===');
                const client = window.supabaseClient || supabaseClient;
                const adminData = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                if (!adminData.address) {
                    console.error('‚ùå No admin address found in session');
                    return;
                }
                
                await loadSalesAnalytics(client, adminData.address, adminData);
                console.log('üß™ Test completed - check console logs above for details');
            } catch (error) {
                console.error('‚ùå Test failed:', error);
            }
        };

        // Test function to check orders table
        window.testOrdersTable = async function() {
            try {
                console.log('üß™ === TESTING ORDERS TABLE ACCESS ===');
                const client = window.supabaseClient || supabaseClient;
                
                if (!client) {
                    console.error('‚ùå No Supabase client');
                    return;
                }
                
                // Test basic table access
                console.log('üß™ Step 1: Testing basic orders table access...');
                const { data: orders, error } = await client
                    .from('orders')
                    .select('*')
                    .limit(10);
                
                console.log('üß™ Orders test result:', { 
                    ordersCount: orders?.length || 0, 
                    error: error,
                    sampleData: orders?.slice(0, 2)
                });
                
                if (error) {
                    console.error('‚ùå Orders table error:', error);
                    return;
                }
                
                if (!orders || orders.length === 0) {
                    console.warn('‚ö†Ô∏è No orders found in database');
                    console.log('üí° Try creating some test orders first');
                    return;
                }
                
                console.log('‚úÖ Orders table accessible');
                console.log('üì¶ Total orders in database:', orders.length);
                console.log('üì¶ Sample orders:');
                orders.forEach((order, index) => {
                    console.log(`  ${index + 1}. ID: ${order.id?.slice(0, 8)}, Total: ‚Ç±${order.total}, Address: "${order.address}", Date: ${new Date(order.created_at).toLocaleDateString()}`);
                });
                
                // Test current user
                console.log('üß™ Step 2: Testing current user...');
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('üë§ Current user:', currentUser);
                
                if (!currentUser.id) {
                    console.error('‚ùå No current user found');
                    return;
                }
                
                // Test admin data
                console.log('üß™ Step 3: Testing admin data...');
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                console.log('üë®‚Äçüíº Admin data:', { data: adminData, error: adminError });
                
                if (adminError) {
                    console.error('‚ùå Admin data error:', adminError);
                    return;
                }
                
                if (!adminData.address) {
                    console.warn('‚ö†Ô∏è Admin has no address set');
                    return;
                }
                
                // Test address matching
                console.log('üß™ Step 4: Testing address matching...');
                const adminAddress = adminData.address.toLowerCase();
                console.log('üèõÔ∏è Admin address:', adminData.address);
                
                const matchingOrders = orders.filter(order => {
                    if (!order.address) return false;
                    
                    const orderAddress = order.address.toLowerCase();
                    const exactMatch = orderAddress === adminAddress;
                    const containsMatch = orderAddress.includes(adminAddress);
                    const reverseContains = adminAddress.includes(orderAddress);
                    const lipaMatch = adminAddress.includes('lipa') && orderAddress.includes('lipa');
                    
                    return exactMatch || containsMatch || reverseContains || lipaMatch;
                });
                
                console.log('üéØ Matching orders found:', matchingOrders.length);
                if (matchingOrders.length > 0) {
                    console.log('üí∞ Matching orders:');
                    matchingOrders.forEach((order, index) => {
                        console.log(`  ${index + 1}. Total: ‚Ç±${order.total}, Address: "${order.address}"`);
                    });
                    
                    const totalRevenue = matchingOrders.reduce((sum, order) => sum + (parseFloat(order.total) || 0), 0);
                    console.log(`üí∞ Total revenue: ‚Ç±${totalRevenue.toFixed(2)}`);
                } else {
                    console.warn('‚ö†Ô∏è No orders match the admin address');
                    console.log('üîç All order addresses:');
                    orders.forEach((order, index) => {
                        console.log(`  ${index + 1}. "${order.address}"`);
                    });
                    console.log('üîç Admin address to match:', `"${adminData.address}"`);
                }
                
            } catch (error) {
                console.error('‚ùå Test error:', error);
            }
        }

        // Simple test to manually trigger sales analytics
        window.testSalesAnalytics = async function() {
            console.log('üß™ === MANUAL SALES ANALYTICS TEST ===');
            try {
                const client = window.supabaseClient || supabaseClient;
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                
                const { data: adminData } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminData && adminData.address) {
                    await loadSalesAnalytics(client, adminData.address, adminData);
                } else {
                    console.error('‚ùå No admin data or address found');
                }
            } catch (error) {
                console.error('‚ùå Manual test error:', error);
            }
        }

        // Load Stock Analytics from my_products
        async function loadStockAnalytics(client, userIds) {
            try {
                console.log('üîç Loading stock analytics...');
                console.log('üîç User IDs for stock analysis:', userIds);
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    // Set "No Data" instead of loading
                    analyticsData.stocks.category = {
                        labels: ['No Data'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Data', quantity: 0, status: 'No Data' }]
                    };
                    return;
                }
                
                const { data: products, error: productsError } = await client
                    .from('my_products')
                    .select('category, quantity, name, id')
                    .in('user_id', userIds);
                
                if (productsError) {
                    console.error('‚ùå Error fetching products:', productsError);
                    return;
                }
                
                console.log('üîç Products data found:', products);
                console.log('üîç Number of products:', products ? products.length : 0);
                
                if (!products || products.length === 0) {
                    console.log('‚ùå No products found for these users');
                    analyticsData.stocks.category = {
                        labels: ['No Products'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Products', quantity: 0, status: 'No Data' }]
                    };
                    
                    // Update chart immediately
                    if (window.stocksChart && window.stocksChart.data) {
                        window.stocksChart.data.labels = ['No Products'];
                        window.stocksChart.data.datasets[0].data = [1];
                        window.stocksChart.data.datasets[0].backgroundColor = ['#6c757d'];
                        window.stocksChart.update();
                    }
                    return;
                }
                
                // Function to determine stock status
                function getStockStatus(quantity) {
                    if (quantity === 0) return 'Out of Stock';
                    if (quantity <= 5) return 'To be Out of Stock';
                    return 'Available';
                }
                
                // Process category data with detailed product information
                const categoryStats = {};
                const categoryProducts = {};
                const statusStats = { 'Available': 0, 'To be Out of Stock': 0, 'Out of Stock': 0 };
                const statusProducts = { 'Available': [], 'To be Out of Stock': [], 'Out of Stock': [] };
                
                products.forEach(product => {
                    console.log('üîç Processing product:', product);
                    const category = (product.category && product.category.trim() !== '') 
                        ? product.category.trim() 
                        : 'Uncategorized';
                    
                    const productStatus = getStockStatus(product.quantity || 0);
                    const productInfo = {
                        name: product.name || 'Unnamed Product',
                        quantity: product.quantity || 0,
                        status: productStatus,
                        category: category
                    };
                    
                    // Count by category
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    
                    // Count by status
                    statusStats[productStatus] = (statusStats[productStatus] || 0) + 1;
                    
                    // Store detailed product information by category
                    if (!categoryProducts[category]) {
                        categoryProducts[category] = [];
                    }
                    categoryProducts[category].push(productInfo);
                    
                    // Store detailed product information by status
                    statusProducts[productStatus].push(productInfo);
                });
                
                console.log('üìä Category stats calculated:', categoryStats);
                console.log('üìä Status stats calculated:', statusStats);
                console.log('üìä Category products:', categoryProducts);
                console.log('üìä Status products:', statusProducts);
                
                // Convert to arrays for chart
                const categories = Object.keys(categoryStats);
                const categoryData = Object.values(categoryStats);
                const statusData = Object.values(statusStats);
                const colors = ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545', '#6c757d'];
                
                console.log('üìä Final chart data:');
                console.log('   Labels:', categories);
                console.log('   Category Data:', categoryData);
                console.log('   Status Data:', statusData);
                
                // Update analyticsData with detailed product information
                analyticsData.stocks.category = {
                    labels: categories,
                    data: categoryData,
                    colors: colors.slice(0, categories.length),
                    products: categoryProducts
                };
                
                // Update status analytics with product details
                analyticsData.stocks.status = {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: statusData,
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: statusProducts
                };
                
                console.log('‚úÖ Updated analyticsData.stocks.category:', analyticsData.stocks.category);
                console.log('‚úÖ Updated analyticsData.stocks.status:', analyticsData.stocks.status);
                
                // Update the charts if they exist
                if (window.stocksChart && window.stocksChart.data) {
                    console.log('üîÑ Updating stocks chart with real data');
                    console.log('   Chart before update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                    
                    window.stocksChart.data.labels = categories;
                    window.stocksChart.data.datasets[0].data = categoryData;
                    window.stocksChart.data.datasets[0].backgroundColor = colors.slice(0, categories.length);
                    window.stocksChart.update();
                    
                    console.log('   Chart after update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                } else {
                    console.log('‚ö†Ô∏è Stocks chart not yet initialized, data saved for later use');
                }
                
                // Update the status chart if it exists
                if (window.statusChart && window.statusChart.data) {
                    console.log('üîÑ Updating status chart with real data');
                    window.statusChart.data.labels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                    window.statusChart.data.datasets[0].data = statusData;
                    window.statusChart.data.datasets[0].backgroundColor = ['#28a745', '#ffc107', '#dc3545'];
                    window.statusChart.update();
                    console.log('‚úÖ Status chart updated with real data');
                } else {
                    console.log('‚ö†Ô∏è Status chart not yet initialized, data saved for later use');
                }
                
                console.log('‚úÖ Stock analytics completed');
                
            } catch (error) {
                console.error('‚ùå Error in loadStockAnalytics:', error);
            }
        }

        // Load Soil Analytics from store-owner
        async function loadSoilAnalytics(client, userIds) {
            try {
                console.log('üîç Loading soil analytics...');
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                try {
                    const result = await client
                        .from('store-owner')
                        .select('soil_type')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                } catch (error) {
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('soil_type')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                    } catch (error2) {
                        console.error('‚ùå Could not access store owner table:', error2);
                        return;
                    }
                }
                
                if (!storeOwners) {
                    console.log('‚ùå No store owners found');
                    return;
                }
                
                console.log('üîç Store owners soil data:', storeOwners);
                
                // Process soil type data
                const soilStats = {};
                
                storeOwners.forEach(owner => {
                    if (owner.soil_type) {
                        soilStats[owner.soil_type] = (soilStats[owner.soil_type] || 0) + 1;
                    }
                });
                
                console.log('üìä Soil stats:', soilStats);
                
                // Update analyticsData.soil.type with real data
                const soilTypes = Object.keys(soilStats);
                const soilData = Object.values(soilStats);
                const colors = ['#8b4513', '#d2691e', '#daa520', '#bc8f8f', '#556b2f', '#654321', '#8b7355'];
                
                analyticsData.soil.type = {
                    labels: soilTypes,
                    data: soilData,
                    colors: colors.slice(0, soilTypes.length)
                };
                
                // Update the chart if it exists
                if (window.soilChart && window.soilChart.data) {
                    console.log('üîÑ Updating soil chart with real data');
                    window.soilChart.data.labels = soilTypes;
                    window.soilChart.data.datasets[0].data = soilData;
                    window.soilChart.data.datasets[0].backgroundColor = colors.slice(0, soilTypes.length);
                    window.soilChart.update();
                } else {
                    console.log('‚ö†Ô∏è Soil chart not yet initialized, data will be used when chart is created');
                }
                
                console.log('‚úÖ Soil analytics updated');
                
            } catch (error) {
                console.error('‚ùå Error in loadSoilAnalytics:', error);
            }
        }

        // Load Hectare Analytics from store-owner
        async function loadHectareAnalytics(client, userIds) {
            try {
                console.log('üîç Loading hectare analytics...');
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    // Set "No Data" for all periods
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        },
                        weekly: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            data: [0, 0, 0, 0]
                        },
                        yearly: {
                            labels: ['2021', '2022', '2023', '2024'],
                            data: [0, 0, 0, 0]
                        }
                    };
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                let storeOwnerError = null;
                
                try {
                    console.log('üîç Trying store-owner table...');
                    const result = await client
                        .from('store-owner')
                        .select('land_size, created_at, user_id')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                    storeOwnerError = result.error;
                    console.log('‚úÖ store-owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                } catch (error) {
                    console.log('‚ùå store-owner table failed, trying store_owner...');
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('land_size, created_at, user_id')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                        storeOwnerError = result.error;
                        console.log('‚úÖ store_owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                    } catch (error2) {
                        console.error('‚ùå Could not access store owner table with either name format:', error2);
                        return;
                    }
                }
                
                if (storeOwnerError || !storeOwners) {
                    console.log('‚ùå No store owners found or error:', storeOwnerError);
                    return;
                }
                
                console.log('üîç Store owners land size data:', storeOwners);
                
                // Process land size data - filter valid numeric values
                const validLandData = storeOwners
                    .filter(owner => {
                        const landSize = parseFloat(owner.land_size);
                        return owner.land_size && !isNaN(landSize) && landSize > 0;
                    })
                    .map(owner => ({
                        size: parseFloat(owner.land_size),
                        date: owner.created_at ? new Date(owner.created_at) : new Date(),
                        userId: owner.user_id
                    }));
                
                console.log('üìä Valid land data with dates:');
                validLandData.forEach((item, index) => {
                    console.log(`  ${index + 1}. User ${item.userId}: ${item.size} ha on ${item.date.getFullYear()}-${(item.date.getMonth() + 1).toString().padStart(2, '0')}-${item.date.getDate().toString().padStart(2, '0')}`);
                });
                
                if (validLandData.length === 0) {
                    console.log('‚ùå No valid land size data found');
                    // Set "No Data" state
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        weekly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        yearly: {
                            labels: ['No Data'],
                            data: [1]
                        }
                    };
                    
                    // Update chart if exists
                    if (window.hectareChart && window.hectareChart.data) {
                        window.hectareChart.data.labels = ['No Data'];
                        window.hectareChart.data.datasets[0].data = [1];
                        window.hectareChart.update();
                    }
                    return;
                }
                
                console.log('üìä Valid land data:', validLandData);
                console.log('üìä Number of valid entries:', validLandData.length);
                
                // Calculate total hectares
                const totalHectares = validLandData.reduce((sum, item) => sum + item.size, 0);
                const avgHectares = totalHectares / validLandData.length;
                
                console.log('üìä Total hectares:', totalHectares);
                console.log('üìä Average hectares per farm:', avgHectares);
                
                // Current date for calculations
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); // 0-based
                
                // MONTHLY DATA - Distribute land data across 12 months based on creation dates
                const monthlyData = new Array(12).fill(0);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Group by creation month for current year or most recent year with data
                const yearlyGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    const month = item.date.getMonth();
                    
                    if (!yearlyGroups[year]) yearlyGroups[year] = new Array(12).fill(0);
                    yearlyGroups[year][month] += item.size;
                });
                
                // Use current year data if available, otherwise use the most recent year
                const availableYears = Object.keys(yearlyGroups).map(y => parseInt(y)).sort((a, b) => b - a);
                const targetYear = availableYears.includes(currentYear) ? currentYear : availableYears[0];
                
                if (targetYear && yearlyGroups[targetYear]) {
                    for (let i = 0; i < 12; i++) {
                        monthlyData[i] = yearlyGroups[targetYear][i];
                    }
                } else {
                    // Fallback: distribute evenly if no specific year data
                    const monthlyAvg = totalHectares / 12;
                    for (let i = 0; i < 12; i++) {
                        const variation = (Math.random() - 0.5) * 0.2;
                        monthlyData[i] = Math.round((monthlyAvg + monthlyAvg * variation) * 100) / 100;
                    }
                }
                
                // WEEKLY DATA - More accurate weekly distribution based on actual data
                const weeklyLabels = [];
                const weeklyData = [];
                
                // Get current month's data or data from the month with most activity
                const currentMonthTotal = monthlyData[currentMonth];
                const maxMonthIndex = monthlyData.indexOf(Math.max(...monthlyData));
                const targetMonthTotal = currentMonthTotal > 0 ? currentMonthTotal : monthlyData[maxMonthIndex];
                
                // Get current week number for more accurate labeling
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentWeek = Math.ceil((now.getDate() + startOfMonth.getDay()) / 7);
                
                // Create weekly distribution based on actual farm registration patterns
                const farmsInTargetMonth = validLandData.filter(item => {
                    const itemMonth = item.date.getMonth();
                    return currentMonthTotal > 0 ? itemMonth === currentMonth : itemMonth === maxMonthIndex;
                });
                
                // If we have farms in the target month, distribute by actual weeks
                if (farmsInTargetMonth.length > 0) {
                    const weeklyDistribution = [0, 0, 0, 0];
                    
                    farmsInTargetMonth.forEach(item => {
                        const dayOfMonth = item.date.getDate();
                        const weekOfMonth = Math.min(Math.ceil(dayOfMonth / 7), 4) - 1; // 0-3
                        weeklyDistribution[weekOfMonth] += item.size;
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        weeklyData.push(Math.round(weeklyDistribution[i] * 100) / 100);
                    }
                } else {
                    // Fallback: distribute target month evenly across weeks
                    const weeklyBase = targetMonthTotal / 4;
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        const variation = (Math.random() - 0.5) * 0.1;
                        weeklyData.push(Math.round((weeklyBase + weeklyBase * variation) * 100) / 100);
                    }
                }
                
                // YEARLY DATA - ONLY use actual database data, no simulation
                const currentYear2025 = new Date().getFullYear(); // Use actual current year (2025)
                const yearRange = 4; // Show last 4 years
                const yearlyLabels = [];
                const yearlyData = [];
                
                // Create year groups based ONLY on actual data - sum ALL land registered in each year
                const actualYearGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    if (!actualYearGroups[year]) actualYearGroups[year] = 0;
                    actualYearGroups[year] += item.size; // Sum total land for this year
                });
                
                console.log('üìä Raw year groups from database (ACTUAL DATA ONLY):', actualYearGroups);
                console.log('üìä Current year detected:', currentYear2025);
                
                // Generate data for the last 4 years (2022-2025) - ONLY ACTUAL DATA
                for (let i = yearRange - 1; i >= 0; i--) {
                    const year = currentYear2025 - i;
                    yearlyLabels.push(year.toString());
                    
                    if (actualYearGroups[year] && actualYearGroups[year] > 0) {
                        // Use ONLY actual total land registered in this year
                        yearlyData.push(Math.round(actualYearGroups[year] * 100) / 100);
                        console.log(`‚úÖ Year ${year}: ACTUAL DATA = ${actualYearGroups[year]} hectares`);
                    } else {
                        // NO SIMULATION - if no actual data, show 0
                        yearlyData.push(0);
                        console.log(`‚ùå Year ${year}: No actual data found, showing 0 hectares`);
                    }
                }
                
                console.log('üìä Final yearly labels (REAL DATA ONLY):', yearlyLabels);
                console.log('üìä Final yearly data (REAL DATA ONLY):');
                yearlyLabels.forEach((year, index) => {
                    const value = yearlyData[index];
                    const source = value > 0 ? 'ACTUAL DATABASE' : 'NO DATA';
                    console.log(`   ${year}: ${value} hectares (${source})`);
                });
                
                console.log('üìä Actual year groups from database:', actualYearGroups);
                console.log('üìä Monthly hectare data:', monthlyData);
                console.log('üìä Weekly hectare data (accurate):', weeklyData);
                console.log('üìä Yearly hectare data (accurate):', yearlyData);
                
                // Update analyticsData with comprehensive data
                analyticsData.hectare = {
                    monthly: {
                        labels: monthNames,
                        data: monthlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    },
                    weekly: {
                        labels: weeklyLabels,
                        data: weeklyData,
                        totalHectares: targetMonthTotal,
                        validFarms: validLandData.length
                    },
                    yearly: {
                        labels: yearlyLabels,
                        data: yearlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    }
                };
                
                console.log('‚úÖ Updated analyticsData.hectare:', analyticsData.hectare);
                
                // Update the chart if it exists (default to monthly view)
                if (window.hectareChart && window.hectareChart.data) {
                    console.log('üîÑ Updating hectare chart with real monthly data');
                    window.hectareChart.data.labels = monthNames;
                    window.hectareChart.data.datasets[0].data = monthlyData;
                    window.hectareChart.update();
                    console.log('‚úÖ Hectare chart updated successfully');
                } else {
                    console.log('‚ö†Ô∏è Hectare chart not yet initialized, data saved for later use');
                }
                
                console.log('‚úÖ Hectare analytics completed');
                
            } catch (error) {
                console.error('‚ùå Error in loadHectareAnalytics:', error);
            }
        }

        // Test function to check database connection and data
        window.testDatabaseConnection = async function() {
            try {
                console.log('=== TESTING DATABASE CONNECTION ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå No Supabase client available');
                    return;
                }
                
                // Test admin_accounts table
                console.log('üîç Testing admin_accounts table...');
                const { data: admins, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .limit(3);
                
                console.log('Admin accounts result:', { data: admins, error: adminError });
                
                // Test users table
                console.log('üîç Testing users table...');
                const { data: users, error: userError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .limit(5);
                
                console.log('Users result:', { data: users, error: userError });
                
                // Test store owner tables
                console.log('üîç Testing store-owner table...');
                try {
                    const { data: stores1, error: storeError1 } = await client
                        .from('store-owner')
                        .select('*')
                        .limit(3);
                    console.log('store-owner result:', { data: stores1, error: storeError1 });
                } catch (e) {
                    console.log('store-owner table not accessible');
                }
                
                console.log('üîç Testing store_owner table...');
                try {
                    const { data: stores2, error: storeError2 } = await client
                        .from('store_owner')
                        .select('*')
                        .limit(3);
                    console.log('store_owner result:', { data: stores2, error: storeError2 });
                } catch (e) {
                    console.log('store_owner table not accessible');
                }
                
                // Test products table
                console.log('üîç Testing my_products table...');
                const { data: products, error: productError } = await client
                    .from('my_products')
                    .select('*')
                    .limit(3);
                
                console.log('Products result:', { data: products, error: productError });
                
                console.log('=== DATABASE TEST COMPLETE ===');
                
            } catch (error) {
                console.error('‚ùå Error in database test:', error);
            }
        }

        // Wait for shared profile to load, then load municipality stats
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Check if charts are already initialized to prevent duplicates
            if (window.chartsInitialized) {
                console.log('‚ö†Ô∏è Charts already initialized, skipping...');
                return;
            }
            
            // Initialize charts
            initializeCharts();
            window.chartsInitialized = true;
                
            // Load real data after charts are initialized
            setTimeout(() => {
                console.log('üîÑ Loading analytics after charts initialization...');
                window.loadMunicipalityAnalytics();
            }, 2000);
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('üîç Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('üîÑ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
            }, 3000); // Increased timeout to 3 seconds
        });

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            if (data && window.salesChart) {
                window.salesChart.data.labels = data.labels;
                window.salesChart.data.datasets[0].data = data.data;
                window.salesChart.update('none'); // Update without animation to prevent movement
                
                // Update the sales amount displays
                updateMunicipalitySalesDisplays(data, period);
            }
        }

        function updateStocksChart(view) {
            console.log('üîÑ Updating stocks chart to view:', view);
            
            const stocksCanvas = document.getElementById('stocksChart');
            const statusCanvas = document.getElementById('statusChart');
            
            if (!stocksCanvas || !statusCanvas) {
                console.warn('‚ö†Ô∏è Chart elements not found');
                return;
            }
            
            if (view === 'status') {
                // Show status chart, hide category chart
                stocksCanvas.style.display = 'none';
                statusCanvas.style.display = 'block';
                
                // Update status chart with real data
                const data = analyticsData.stocks.status;
                console.log('üìä Status chart data:', data);
                
                if (data && data.labels && data.data && window.statusChart && window.statusChart.data) {
                    window.statusChart.data.labels = data.labels;
                    window.statusChart.data.datasets[0].data = data.data;
                    window.statusChart.data.datasets[0].backgroundColor = data.colors;
                    window.statusChart.update();
                    console.log('‚úÖ Status chart updated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Status chart not ready or missing data');
                    if (!window.statusChart) console.warn('  - statusChart not initialized');
                    if (!data) console.warn('  - status data missing');
                    if (window.statusChart && !window.statusChart.data) console.warn('  - statusChart.data is undefined');
                }
                
            } else {
                // Show category chart, hide status chart
                stocksCanvas.style.display = 'block';
                statusCanvas.style.display = 'none';
                
                // Update category chart with real data
                const data = analyticsData.stocks[view];
                console.log('üìä Category chart data:', data);
                
                if (data && data.labels && data.data && window.stocksChart && window.stocksChart.data) {
                    window.stocksChart.data.labels = data.labels;
                    window.stocksChart.data.datasets[0].data = data.data;
                    window.stocksChart.data.datasets[0].backgroundColor = data.colors;
                    window.stocksChart.update();
                    console.log('‚úÖ Category chart updated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Category chart not ready or missing data');
                    if (!window.stocksChart) console.warn('  - stocksChart not initialized');
                    if (!data) console.warn('  - category data missing');
                    if (window.stocksChart && !window.stocksChart.data) console.warn('  - stocksChart.data is undefined');
                }
            }
        }

        // Status filtering function
        function filterByStatus(status) {
            console.log('üîÑ Filtering by status:', status);
            
            // Check if statusChart exists
            if (!window.statusChart || !window.statusChart.data) {
                console.warn('‚ö†Ô∏è Status chart not ready for filtering');
                return;
            }
            
            // Update active button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            });
            
            const activeBtn = document.querySelector(`[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (status === 'Available') {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                } else if (status === 'To be Out of Stock') {
                    activeBtn.classList.remove('btn-outline-warning');
                    activeBtn.classList.add('btn-warning');
                } else if (status === 'Out of Stock') {
                    activeBtn.classList.remove('btn-outline-danger');
                    activeBtn.classList.add('btn-danger');
                } else {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                }
            }

            // We're in status view - filter the status chart
            const statusData = analyticsData.stocks.status;
            
            if (!statusData || !statusData.labels || !statusData.data) {
                console.warn('‚ö†Ô∏è Status data not available for filtering');
                return;
            }
            
            if (status === 'all') {
                // Show all status data
                window.statusChart.data.labels = statusData.labels;
                window.statusChart.data.datasets[0].data = statusData.data;
                window.statusChart.data.datasets[0].backgroundColor = statusData.colors;
            } else {
                // Show only the selected status
                const statusIndex = statusData.labels.indexOf(status);
                if (statusIndex !== -1) {
                    window.statusChart.data.labels = [status];
                    window.statusChart.data.datasets[0].data = [statusData.data[statusIndex]];
                    window.statusChart.data.datasets[0].backgroundColor = [statusData.colors[statusIndex]];
                } else {
                    console.warn('‚ö†Ô∏è Status not found in data:', status);
                    return;
                }
            }
            window.statusChart.update();
            console.log('‚úÖ Status filter applied successfully');
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            window.soilChart.data.labels = data.labels;
            window.soilChart.data.datasets[0].data = data.data;
            window.soilChart.data.datasets[0].backgroundColor = data.colors;
            window.soilChart.update();
        }

        function updateHectareChart(period) {
            console.log('üîÑ Updating hectare chart to period:', period);
            
            if (!window.hectareChart || !window.hectareChart.data) {
                console.warn('‚ö†Ô∏è Hectare chart not initialized');
                return;
            }
            
            const data = analyticsData.hectare[period];
            if (!data || !data.labels || !data.data) {
                console.warn('‚ö†Ô∏è No hectare data available for period:', period);
                console.log('Available periods:', Object.keys(analyticsData.hectare));
                return;
            }
            
            console.log('üìä Updating with data for', period, ':', data);
            console.log('üìä Labels:', data.labels);
            console.log('üìä Data:', data.data);
            
            window.hectareChart.data.labels = data.labels;
            window.hectareChart.data.datasets[0].data = data.data;
            window.hectareChart.update();
            
            console.log('‚úÖ Hectare chart updated successfully');
            console.log('‚úÖ Chart now shows:', window.hectareChart.data.labels);
        }

        // Sales Chart (Line Graph)
        function initSalesChart() {
            try {
                console.log('üöÄ Initializing Sales Chart...');
                
                // Destroy existing chart if it exists
                if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                    console.log('üóëÔ∏è Destroying existing sales chart');
                    window.salesChart.destroy();
                    window.salesChart = null;
                }
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.error('‚ùå Sales chart canvas not found');
                    return;
                }
                console.log('‚úÖ Sales chart canvas found');
                
                const ctx = canvas.getContext('2d');
                
                // Initialize with better default data that shows something is loading
                const initialData = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0] // All zeros initially
                };
                
                console.log('üìä Initial chart data (will be updated with real data):', initialData);
                
                window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: initialData.labels,
                    datasets: [{
                        label: 'Sales by Municipality Sellers (‚Ç±)',
                        data: initialData.data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0 // Disable animations to prevent movement
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 40,
                                usePointStyle: false
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç±' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            radius: 3,
                            hoverRadius: 5
                        },
                        line: {
                            borderWidth: 2
                        }
                    }
                }
            });
            
            console.log('‚úÖ Sales chart initialized successfully');
            console.log('üìä Chart object:', window.salesChart);
            
            // Schedule a refresh after data should be loaded
            setTimeout(() => {
                console.log('üîÑ Auto-refreshing sales chart with latest data...');
                if (window.salesChart && analyticsData.sales) {
                    const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                    const currentData = analyticsData.sales[currentFilter];
                    if (currentData && currentData.data && currentData.data.some(val => val > 0)) {
                        console.log('üìä Found real data, updating chart:', currentData);
                        window.salesChart.data.labels = currentData.labels;
                        window.salesChart.data.datasets[0].data = currentData.data;
                        window.salesChart.update('none');
                        console.log('‚úÖ Sales chart auto-refreshed with real data');
                    } else {
                        console.log('üìä No real data yet, keeping placeholder data');
                    }
                }
            }, 5000); // Check after 5 seconds
            
            } catch (error) {
                console.error('‚ùå Error initializing sales chart:', error);
            }
        }

        // Stocks Chart (Pie Chart)
        function initStocksChart() {
            try {
                // Destroy existing chart if it exists
                if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                    window.stocksChart.destroy();
                    window.stocksChart = null;
                }
                
                const canvas = document.getElementById('stocksChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Stocks chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.stocks.category;
            
            window.stocksChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    // Get current filter view
                                    const currentFilter = document.getElementById('stocksFilter').value;
                                    const label = context.label;
                                    const count = context.parsed;
                                    
                                    if (currentFilter === 'status') {
                                        // Status view - show products by status
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    } else {
                                        // Category view - show products by category
                                        const products = analyticsData.stocks.category.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const categoryProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        categoryProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.status})`);
                                        });
                                        
                                        return tooltipLines;
                                    }
                                },
                                labelColor: function(context) {
                                    return {
                                        borderColor: context.dataset.backgroundColor[context.dataIndex],
                                        backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                    };
                                }
                            },
                            displayColors: true,
                            bodySpacing: 4,
                            titleSpacing: 6,
                            footerSpacing: 4,
                            bodyFont: {
                                size: 12
                            },
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('‚ùå Error initializing stocks chart:', error);
            }
        }

        // Status Chart (Separate Pie Chart for Status View)
        function initStatusChart() {
            try {
                // Destroy existing chart if it exists
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                    window.statusChart = null;
                }
                
                const canvas = document.getElementById('statusChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Status chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.stocks.status;
                
                window.statusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        // Status view - show products by status
                                        const label = context.label;
                                        const count = context.parsed;
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    },
                                    labelColor: function(context) {
                                        return {
                                            borderColor: context.dataset.backgroundColor[context.dataIndex],
                                            backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                        };
                                    }
                                },
                                displayColors: true,
                                bodySpacing: 4,
                                titleSpacing: 6,
                                footerSpacing: 4,
                                bodyFont: {
                                    size: 12
                                },
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('‚ùå Error initializing status chart:', error);
            }
        }

        // Soil Chart (Donut Chart)
        function initSoilChart() {
            try {
                // Destroy existing chart if it exists
                if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                    window.soilChart.destroy();
                    window.soilChart = null;
                }
                
                const canvas = document.getElementById('soilChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Soil chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.soil.type;
            
            window.soilChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            } catch (error) {
                console.error('‚ùå Error initializing soil chart:', error);
            }
        }

        // Hectare Chart (Bar Chart)
        function initHectareChart() {
            try {
                // Destroy existing chart if it exists
                if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                    window.hectareChart.destroy();
                    window.hectareChart = null;
                }
                
                const canvas = document.getElementById('hectareChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Hectare chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.hectare.monthly;
                
                window.hectareChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            label: 'Hectares',
                            data: currentData.data,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        return `${context[0].label} - ${period.charAt(0).toUpperCase() + period.slice(1)} View`;
                                    },
                                    label: function(context) {
                                        const hectares = context.parsed.y;
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        const label = context.label;
                                        
                                        let tooltipText = [`üåæ Hectares: ${hectares.toFixed(2)} ha`];
                                        
                                        // Add contextual information based on period
                                        if (hectareData.totalHectares && hectareData.totalHectares > 0) {
                                            const percentage = ((hectares / hectareData.totalHectares) * 100).toFixed(1);
                                            tooltipText.push(`üìä Percentage: ${percentage}%`);
                                        }
                                        
                                        if (hectareData.validFarms) {
                                            tooltipText.push(`üè™ Active Farms: ${hectareData.validFarms}`);
                                        }
                                        
                                        // Period-specific information
                                        if (period === 'monthly') {
                                            if (hectareData.validFarms > 0) {
                                                const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                tooltipText.push(`üìè Avg per Farm: ${avgPerFarm} ha`);
                                            }
                                            tooltipText.push(`üìÖ Month: ${label}`);
                                        } else if (period === 'weekly') {
                                            tooltipText.push(`üìÖ Current Month Distribution`);
                                            if (hectares > 0) {
                                                tooltipText.push(`üóìÔ∏è ${label} of Month`);
                                            }
                                        } else if (period === 'yearly') {
                                            tooltipText.push(`üìÖ Year: ${label}`);
                                            
                                            if (hectares > 0) {
                                                tooltipText.push(`üåæ Total Land in ${label}: ${hectares.toFixed(2)} ha`);
                                                tooltipText.push(`üìä ACTUAL DATABASE DATA`);
                                                
                                                if (hectareData.validFarms > 0) {
                                                    const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                    tooltipText.push(`üìè Est. Avg per Farm: ${avgPerFarm} ha`);
                                                }
                                            } else {
                                                tooltipText.push(`‚ùå No farms registered in ${label}`);
                                                tooltipText.push(`üìä NO DATA AVAILABLE`);
                                            }
                                        }
                                        
                                        return tooltipText;
                                    },
                                    footer: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        
                                        if (hectareData.totalHectares) {
                                            return `Total Land: ${hectareData.totalHectares.toFixed(2)} hectares`;
                                        }
                                        return '';
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                footerColor: '#ccc',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' ha';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Hectare chart initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing hectare chart:', error);
            }
        }

        // Filter Functions
        function updateSalesChart(period) {
            try {
                if (!window.salesChart || !window.salesChart.data) {
                    console.warn('‚ö†Ô∏è Sales chart not initialized yet');
                    return;
                }
                
                const data = analyticsData.sales[period];
                if (!data || !data.labels || !data.data) {
                    console.warn('‚ö†Ô∏è No sales data available for period:', period);
                    return;
                }
                
                window.salesChart.data.labels = data.labels;
                window.salesChart.data.datasets[0].data = data.data;
                window.salesChart.update();
                console.log('‚úÖ Sales chart updated for period:', period);
            } catch (error) {
                console.error('‚ùå Error updating sales chart:', error);
            }
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            soilChart.data.labels = data.labels;
            soilChart.data.datasets[0].data = data.data;
            soilChart.data.datasets[0].backgroundColor = data.colors;
            soilChart.update();
        }


        // Event Listeners
        // Event Listeners for Filters
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Initialize charts
            if (typeof Chart !== 'undefined') {
                initializeCharts();
                
                // Load real data after charts are initialized
                setTimeout(() => {
                    console.log('üîÑ Loading analytics after charts initialization...');
                    window.loadMunicipalityAnalytics();
                }, 2000);
            }
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('üîç Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('üîÑ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
                
                // Load municipality users for User Management table
                setTimeout(() => {
                    console.log('üîÑ Loading municipality users...');
                    // Check if DOM elements are ready
                    const tableBody = document.getElementById('usersTableBody');
                    if (!tableBody) {
                        console.warn('‚ö†Ô∏è User table not ready, retrying in 2 seconds...');
                        setTimeout(() => {
                            window.loadMunicipalityUsers();
                        }, 2000);
                    } else {
                        window.loadMunicipalityUsers();
                    }
                }, 1500);
            }, 3000); // Increased timeout to 3 seconds
            
            // Add event listeners for filters
            const salesFilter = document.getElementById('salesFilter');
            if (salesFilter) {
                salesFilter.addEventListener('change', function() {
                    updateSalesChart(this.value);
                });
            }

            const stocksFilter = document.getElementById('stocksFilter');
            if (stocksFilter) {
                stocksFilter.addEventListener('change', function() {
                    updateStocksChart(this.value);
                });
            }

            const soilFilter = document.getElementById('soilFilter');
            if (soilFilter) {
                soilFilter.addEventListener('change', function() {
                    updateSoilChart(this.value);
                });
            }

            const hectareFilter = document.getElementById('hectareFilter');
            if (hectareFilter) {
                hectareFilter.addEventListener('change', function() {
                    updateHectareChart(this.value);
                });
            }
        });

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                sales: salesChart,
                stocks: stocksChart,
                soil: soilChart,
                hectare: hectareChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_municipality_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
                case 'picture':
                    exportToPicture(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = 'Label,Value\n';
            let data;
            
            switch(chartType) {
                case 'sales':
                    data = analyticsData.sales.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'stocks':
                    data = analyticsData.stocks.category;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'hectare':
                    data = analyticsData.hectare.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 10, 190, 100);
                    doc.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            console.log('üìù Exporting to Word:', chartType);
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Prepare data table HTML based on chart type
                    let dataTableHTML = '';
                    let municipalityName = '';
                    
                    // Get current user municipality
                    if (window.currentUser && window.currentUser.address) {
                        municipalityName = window.currentUser.address;
                    }
                    
                    if (chartType === 'sales' && analyticsData && analyticsData.sales) {
                        console.log('üìä Processing sales data for Word export...');
                        const currentFilter = document.getElementById('salesFilter')?.value || 'monthly';
                        const currentData = analyticsData.sales[currentFilter];
                        
                        if (currentData && currentData.labels && currentData.data) {
                            dataTableHTML = `
                                <h2>Sales Data Table - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Sales Amount (PHP)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            currentData.labels.forEach((label, index) => {
                                const value = currentData.data[index] || 0;
                                const formattedValue = new Intl.NumberFormat('en-PH', {
                                    style: 'currency',
                                    currency: 'PHP',
                                    minimumFractionDigits: 2
                                }).format(value);
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedValue}</td>
                                    </tr>
                                `;
                            });
                            
                            // Calculate total
                            const total = currentData.data.reduce((sum, value) => sum + (value || 0), 0);
                            const formattedTotal = new Intl.NumberFormat('en-PH', {
                                style: 'currency',
                                currency: 'PHP',
                                minimumFractionDigits: 2
                            }).format(total);
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedTotal}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            dataTableHTML = `<p><em>No sales data available for ${currentFilter} view.</em></p>`;
                        }
                    } else if (chartType === 'soil') {
                        console.log('üå± Processing soil data for Word export...');
                        // Use analyticsData.soil.type which gets updated from database
                        const soilData = analyticsData.soil.type;
                        console.log('Soil data for export:', soilData);
                        
                        if (soilData && soilData.labels && soilData.data) {
                            dataTableHTML = `
                                <h2>Soil Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Soil Type</th>
                                            <th style="padding: 10px; text-align: right;">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            soilData.labels.forEach((label, index) => {
                                const value = soilData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('‚ö†Ô∏è Soil data not available for Word export');
                            dataTableHTML = `<p><em>No soil data available for export.</em></p>`;
                        }
                    } else if (chartType === 'hectare') {
                        console.log('üìä Processing hectare data for Word export...');
                        // Use analyticsData.hectare.monthly which gets updated from database
                        const currentFilter = document.getElementById('hectareFilter')?.value || 'monthly';
                        const hectareData = analyticsData.hectare[currentFilter];
                        console.log('Hectare data for export:', hectareData);
                        
                        if (hectareData && hectareData.labels && hectareData.data) {
                            dataTableHTML = `
                                <h2>Hectare Analytics Data Table - ${currentFilter.charAt(0).toUpperCase() + currentFilter.slice(1)} View</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Hectares</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            hectareData.labels.forEach((label, index) => {
                                const value = hectareData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value.toFixed(1)} ha</td>
                                    </tr>
                                `;
                            });
                            
                            // Calculate average
                            const average = hectareData.labels.length > 0 ? (total / hectareData.labels.length).toFixed(1) : 0;
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total.toFixed(1)} ha</td>
                                        </tr>
                                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Average</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${average} ha</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('‚ö†Ô∏è Hectare data not available for Word export');
                            dataTableHTML = `<p><em>No hectare data available for export.</em></p>`;
                        }
                    } else if (chartType === 'stocks') {
                        console.log('üì¶ Processing stocks data for Word export...');
                        // Use the current stocks filter to determine which data to show
                        const stocksFilter = document.getElementById('stocksFilter');
                        const currentView = stocksFilter ? stocksFilter.value : 'category';
                        const stocksData = analyticsData.stocks[currentView];
                        
                        if (stocksData && stocksData.labels && stocksData.data) {
                            const headerLabel = currentView === 'category' ? 'Category' : 'Status';
                            const valueLabel = currentView === 'category' ? 'Quantity' : 'Count';
                            
                            dataTableHTML = `
                                <h2>Stocks Analytics Data Table (${currentView.charAt(0).toUpperCase() + currentView.slice(1)})</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">${headerLabel}</th>
                                            <th style="padding: 10px; text-align: right;">${valueLabel}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            stocksData.labels.forEach((label, index) => {
                                const value = stocksData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('‚ö†Ô∏è Stocks data not available for Word export');
                            dataTableHTML = `<p><em>No stocks data available for export.</em></p>`;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Chart data not available for:', chartType);
                        dataTableHTML = `<p><em>No data available for ${chartType} chart.</em></p>`;
                    }
                    
                    const content = `
                        <html>
                        <head>
                            <title>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
                                h2 { color: #495057; margin-top: 30px; }
                                .report-info { background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; }
                                .chart-container { text-align: center; margin: 30px 0; }
                                table { font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <h1>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            
                            <div class="report-info">
                                <strong>Municipality:</strong> ${municipalityName || 'Not specified'}<br>
                                <strong>Report Generated:</strong> ${new Date().toLocaleDateString('en-PH', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}<br>
                                <strong>Period:</strong> ${document.getElementById(chartType + 'Filter')?.value || 'Monthly'}<br>
                                <strong>Chart Type:</strong> ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}
                            </div>
                            
                            <div class="chart-container">
                                <h2>Chart Visualization</h2>
                                <img src="${imgData}" style="max-width: 100%; border: 1px solid #ddd; padding: 10px;" />
                            </div>
                            
                            ${dataTableHTML}
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #6c757d;">
                                <p>This report was automatically generated by the Anihan Municipality Dashboard.</p>
                            </div>
                        </body>
                        </html>
                    `;
                    const blob = new Blob([content], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function exportToPicture(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Load municipality-specific users for User Management table
        window.loadMunicipalityUsers = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå Supabase client not available');
                    updateUserTable([], 'Database connection not available');
                    return;
                }
                
                // Get current admin user
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (!currentUser.id) {
                    console.log('‚ùå No current user found');
                    updateUserTable([], 'User not logged in');
                    return;
                }
                
                // Get Sub Admin's municipality/address
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError || !adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è Not a Sub Admin or no address');
                    updateUserTable([], 'Access restricted to Sub Admins');
                    return;
                }
                
                const municipalityAddress = adminData.address;
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('‚ùå No municipality address found');
                    updateUserTable([], 'No municipality assigned');
                    return;
                }
                
                console.log('üîç Loading users for municipality:', municipalityAddress);
                
                // Get users from the same municipality
                const { data: users, error: usersError } = await client
                    .from('users')
                    .select('full_name, email, phone_number, municipality, address')
                    .eq('municipality', municipalityAddress)
                    .order('full_name', { ascending: true });
                
                if (usersError) {
                    console.error('‚ùå Error fetching users:', usersError);
                    updateUserTable([], 'Error loading users');
                    return;
                }
                
                console.log(`‚úÖ Found ${users ? users.length : 0} users in ${municipalityAddress}`);
                console.log('üîç User details:', users);
                
                updateUserTable(users || [], null, municipalityAddress);
                
            } catch (error) {
                console.error('‚ùå Error in loadMunicipalityUsers:', error);
                updateUserTable([], 'Error loading users');
            }
        }
        
        // Pagination variables
        let currentUserPage = 1;
        let allMunicipalityUsers = [];
        
        // Update User Management table with real data
        function updateUserTable(users, errorMessage, municipality) {
            const tableBody = document.getElementById('usersTableBody');
            const viewAllLink = document.getElementById('viewAllUsersLink');
            
            if (!tableBody) {
                console.warn('‚ö†Ô∏è User table element (usersTableBody) not found. Retrying in 1 second...');
                setTimeout(() => updateUserTable(users, errorMessage, municipality), 1000);
                return;
            }
            
            console.log('‚úÖ User table elements found, updating table...');
            
            // Store users for pagination
            allMunicipalityUsers = users;
            currentUserPage = 1;
            
            if (errorMessage) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${errorMessage}
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-users me-2"></i>
                            No users found in ${municipality || 'this municipality'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log(`üìä Displaying ${users.length} users from ${municipality}`);
            
            // Update view all link
            if (viewAllLink) {
                viewAllLink.textContent = `View all ${users.length} users >`;
            }
            
            // Display paginated users
            displayUsersPage(currentUserPage);
        }
        
        // Display users for current page
        function displayUsersPage(page) {
            const tableBody = document.getElementById('usersTableBody');
            const currentPageBtn = document.getElementById('currentPageBtn');
            const tableInfo = document.getElementById('usersTableInfo');
            
            if (!tableBody) {
                console.warn('‚ö†Ô∏è User table element not found in displayUsersPage');
                return;
            }
            
            console.log(`üìÑ Displaying page ${page} of users`);
            
            const startIndex = (page - 1) * 10; // Use 10 for the existing pagination system
            const endIndex = startIndex + 10;
            const pageUsers = allMunicipalityUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No users on this page
                        </td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }
            
            tableBody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>${user.full_name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                </tr>
            `).join('');
            
            console.log(`‚úÖ Successfully displayed ${pageUsers.length} users on page ${page}`);
            
            // Update pagination info
            if (currentPageBtn) {
                currentPageBtn.textContent = page;
            }
            
            // Update table info
            if (tableInfo) {
                const startItem = startIndex + 1;
                const endItem = Math.min(endIndex, allMunicipalityUsers.length);
                tableInfo.textContent = `${startItem} to ${endItem} items of ${allMunicipalityUsers.length}`;
            }
            
            console.log(`üìÑ Displaying page ${page}: ${pageUsers.length} users`);
        }
        
        // Pagination function
        function changePage(direction) {
            const totalPages = Math.ceil(allMunicipalityUsers.length / 10); // Use 10 for consistency
            const newPage = currentUserPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentUserPage = newPage;
                displayUsersPage(currentUserPage);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Modal and User Management Functions
        function showAllUsersModal() {
            const modal = new bootstrap.Modal(document.getElementById('allUsersModal'));
            modal.show();
            // Use the filtered municipality users instead of loading all users
            loadMunicipalityUsersForModal();
        }

        // Function to load municipality users for the modal (same data as main table)
        function loadMunicipalityUsersForModal() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS FOR MODAL ===');
                
                // Use the existing filtered municipality users
                if (allMunicipalityUsers && allMunicipalityUsers.length > 0) {
                    console.log('‚úÖ Using existing municipality users data:', allMunicipalityUsers);
                    updateAllUsersTable(allMunicipalityUsers);
                } else {
                    console.log('‚ö†Ô∏è No municipality users data available');
                    updateAllUsersTable([]);
                }

            } catch (error) {
                console.error('Error in loadMunicipalityUsersForModal:', error);
                updateAllUsersTable([]);
            }
        }

        // Function to update the all users modal table
        function updateAllUsersTable(users) {
            const tableBody = document.getElementById('allUsersTableBody');
            const usersCount = document.getElementById('allUsersCount');
            const modalTitle = document.getElementById('allUsersModalLabel');
            
            if (!tableBody) {
                console.error('‚ùå All users table body not found');
                return;
            }

            // Update modal title to reflect municipality users
            if (modalTitle) {
                modalTitle.textContent = 'All Municipality Users';
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No users found in this municipality</td>
                    </tr>
                `;
                if (usersCount) {
                    usersCount.textContent = '0 users found';
                }
                return;
            }

            // Populate table with user data (simplified to match main table)
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.full_name || user.name || user.email || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || user.phone || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update count
            if (usersCount) {
                usersCount.textContent = `${users.length} users found`;
            }

            console.log('‚úÖ All municipality users modal table updated with', users.length, 'users');
            
            // Store users data for search functionality
            window.allUsersData = users;
            setupUserSearch();
        }

        // Function to setup user search functionality
        function setupUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!window.allUsersData) return;

                const filteredUsers = window.allUsersData.filter(user => {
                    const name = (user.full_name || user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const phone = (user.phone_number || user.phone || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           email.includes(searchTerm) || 
                           phone.includes(searchTerm);
                });

                updateAllUsersTable(filteredUsers);
            });
        }

        // Debug function to test sales data loading
        window.debugSalesData = async function() {
            console.log('üêõ DEBUG: Testing sales data loading...');
            
            const client = window.supabaseClient || supabaseClient;
            if (!client) {
                console.error('‚ùå No Supabase client available');
                return;
            }
            
            console.log('‚úÖ Supabase client available');
            
            // Test 1: Check store-owner table
            console.log('üß™ Test 1: Checking store-owner table...');
            const { data: sellers, error: sellersError } = await client
                .from('store-owner')
                .select('*')
                .limit(5);
            
            if (sellersError) {
                console.error('‚ùå Error accessing store-owner table:', sellersError);
            } else {
                console.log('‚úÖ store-owner table accessible, sample data:', sellers);
            }
            
            // Test 2: Check users table
            console.log('üß™ Test 2: Checking users table...');
            const { data: users, error: usersError } = await client
                .from('users')
                .select('id, full_name, municipality')
                .limit(5);
            
            if (usersError) {
                console.error('‚ùå Error accessing users table:', usersError);
            } else {
                console.log('‚úÖ users table accessible, sample data:', users);
            }
            
            // Test 3: Check orders table
            console.log('üß™ Test 3: Checking orders table...');
            const { data: orders, error: ordersError } = await client
                .from('orders')
                .select('id, user_id, total, created_at')
                .not('total', 'is', null)
                .limit(5);
            
            if (ordersError) {
                console.error('‚ùå Error accessing orders table:', ordersError);
            } else {
                console.log('‚úÖ orders table accessible, sample data:', orders);
            }
            
            // Test 4: Manual data loading
            if (sellers && users && orders) {
                console.log('üß™ Test 4: Manual sales analytics loading...');
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (currentUser.address) {
                    await loadSalesAnalytics(client, currentUser.address, currentUser);
                } else {
                    console.log('üì° Loading sales analytics without municipality filter...');
                    await loadSalesAnalytics(client, null, currentUser);
                }
            }
            
            console.log('üêõ DEBUG: Test completed');
        };
    </script>

    <!-- All Users Modal -->
    <div class="modal fade" id="allUsersModal" tabindex="-1" aria-labelledby="allUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allUsersModalLabel">All Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search users by name, email...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Contact Number</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allUsersCount">0 users found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
