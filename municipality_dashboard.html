<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Municipality Dashboard - Anihan</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="fixed-layout.css">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link rel="stylesheet" href="municipality_dashboard.css">
    <style>
        .status-filters {
            transition: all 0.3s ease;
        }
        
        .status-filter-btn {
            transition: all 0.2s ease;
            border-width: 1px;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .status-filter-btn.active {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .status-filter-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" class="avatar-img" style="display: none;" alt="Profile">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" class="profile-avatar-img" style="display: none;" alt="Profile">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 id="profileUserName" class="profile-dropdown-name">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-map-marker-alt"></i>
                            <span id="profileUserAccess">Loading...</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="sidebar">
                <nav class="nav flex-column">
                    <a class="nav-link active" href="municipality_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    <a class="nav-link" href="sub_admin_inventory.html">
                        <i class="fas fa-boxes me-2"></i>
                        Inventory Records
                    </a>
                    <a class="nav-link" href="sub_admin_price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    <a class="nav-link" href="sub_admin_in_demand_products.html">
                        <i class="fas fa-chart-line me-2"></i>
                        In Demand Products
                    </a>
                </nav>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div class="main-content">
                    <!-- Stats Cards -->
                    <div class="row mb-4">
                        <div class="col-md-4">
                            <div class="stats-card stats-users">
                                <div class="stats-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeUsersCount">Loading...</div>
                                    <div class="stats-label">Active Users</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-products">
                                <div class="stats-icon">
                                    <i class="fas fa-boxes"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="productsCount">Loading...</div>
                                    <div class="stats-label">Available Products</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="stats-card stats-farmers">
                                <div class="stats-icon">
                                    <i class="fas fa-tractor"></i>
                                </div>
                                <div class="stats-info">
                                    <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                    <div class="stats-label">Active Farmers</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 1 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Sales Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                            <option value="monthly">Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="salesChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Stocks Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 100px;">
                                            <option value="category">Category</option>
                                            <option value="status">Status</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <!-- Chart Container with Fixed Height -->
                                    <div class="chart-container" style="position: relative; height: 200px;">
                                        <!-- Category Chart -->
                                        <canvas id="stocksChart" width="400" height="200" style="position: absolute; top: 0; left: 0; display: block; max-width: 100%; height: 200px;"></canvas>
                                        
                                        <!-- Status Chart (initially hidden) -->
                                        <canvas id="statusChart" width="400" height="200" style="position: absolute; top: 0; left: 0; display: none; max-width: 100%; height: 200px;"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Analytics Cards Row 2 -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Soil Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                            <option value="type">Soil Type</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="soilChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="analytics-card">
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h5>Hectare Analytics</h5>
                                    <div class="chart-controls">
                                        <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 100px;">
                                            <option value="monthly" selected>Monthly</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="yearly">Yearly</option>
                                        </select>
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                                <i class="fas fa-bars"></i>
                                            </button>
                                            <ul class="dropdown-menu">
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                    <i class="fas fa-file-csv me-2"></i>Save as CSV
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                    <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                    <i class="fas fa-file-word me-2"></i>Save as Word
                                                </a></li>
                                                <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                    <i class="fas fa-image me-2"></i>Save as Picture
                                                </a></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <canvas id="hectareChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- User Management -->
                    <div class="price-card shadow-sm mt-4">
                        <div class="price-card-header d-flex justify-content-between align-items-center">
                            <span>User Management</span>
                        </div>
                        <div class="table-responsive">
                            <table class="price-table">
                                <thead>
                                    <tr>
                                        <th>Name</th>
                                        <th>Email</th>
                                        <th>Contact Number</th>
                                    </tr>
                                </thead>
                                <tbody id="userManagementTable">
                                    <tr>
                                        <td colspan="3" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading users...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="price-card-footer">
                            <a href="#" style="color:#2563eb;font-size:0.95rem;" id="viewAllUsersLink">View all &gt;</a>
                            <div class="price-pagination" id="userPagination">
                                <button class="btn" onclick="changePage(-1)">&lt;</button>
                                <button class="btn active" id="currentPageBtn">1</button>
                                <button class="btn" onclick="changePage(1)">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Shared Profile System -->
    <script src="shared-profile.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // Chart variables
        let salesChart, stocksChart, soilChart, hectareChart, statusChart;

        // Use the Supabase client from shared-profile.js
        console.log('Municipality dashboard using shared Supabase client');

        // Chart Data for Municipality Dashboard - Initialize with empty structure
        let analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [12000, 15500, 18000, 16800, 22500, 25000, 28000, 26500, 29000, 32000, 35000, 38000]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [7500, 8200, 9500, 11000]
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: [180000, 220000, 280000, 320000]
                }
            },
            stocks: {
                category: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d'],
                    products: {
                        'Loading...': [{ name: 'Loading...', quantity: 0, status: 'Loading...' }]
                    }
                },
                status: {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: [0, 0, 0],
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: {
                        'Available': [],
                        'To be Out of Stock': [],
                        'Out of Stock': []
                    }
                },
                supplier: {
                    labels: ['Local Farmers', 'Cooperatives', 'Direct Import', 'Distributors'],
                    data: [40, 30, 20, 10],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                }
            },
            soil: {
                type: {
                    labels: ['Loading...'],
                    data: [1],
                    colors: ['#6c757d']
                },
                region: {
                    labels: ['North District', 'South District', 'East District', 'West District'],
                    data: [30, 25, 25, 20],
                    colors: ['#28a745', '#17a2b8', '#ffc107', '#6f42c1']
                },
                season: {
                    labels: ['Dry Season', 'Wet Season', 'Transition'],
                    data: [45, 35, 20],
                    colors: ['#ff6b35', '#4ecdc4', '#45b7d1']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [180, 185, 190, 195]
                },
                yearly: {
                    labels: ['2021', '2022', '2023', '2024'],
                    data: [5500, 6200, 6800, 7500]
                }
            }
        };

        // Initialize Charts
        function initializeCharts() {
            // Destroy existing charts if they exist to prevent canvas reuse errors
            if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                window.salesChart.destroy();
                window.salesChart = null;
            }
            if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                window.stocksChart.destroy();
                window.stocksChart = null;
            }
            if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                window.statusChart.destroy();
                window.statusChart = null;
            }
            if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                window.soilChart.destroy();
                window.soilChart = null;
            }
            if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                window.hectareChart.destroy();
                window.hectareChart = null;
            }
            
            console.log('üîÑ Initializing charts...');
            initSalesChart();
            initStocksChart();
            initStatusChart(); // Initialize the separate status chart
            initSoilChart();
            initHectareChart();
            console.log('‚úÖ Charts initialized successfully');
        }

        // Load municipality-specific statistics for Sub Admin
        window.loadMunicipalityStats = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY STATISTICS ===');
                
                // Check if Supabase client is available
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('‚ùå Supabase client not available');
                    alert('Database connection not available. Please check your internet connection.');
                    return;
                }
                
                const client = window.supabaseClient || supabaseClient;
                console.log('‚úÖ Supabase client available');
                
                // Get current user from session storage
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('üîç Current user for stats:', currentUser);
                console.log('üîç Session storage contents:', sessionStorage.getItem('currentUser'));
                
                if (!currentUser.id) {
                    console.log('‚ùå No current user found for stats');
                    console.log('üîç Available session storage keys:', Object.keys(sessionStorage));
                    return;
                }
                
                // Get the admin's full data to access their address (municipality)
                console.log('üîç Fetching admin data for ID:', currentUser.id);
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError) {
                    console.error('‚ùå Error fetching admin data:', adminError);
                    console.log('üîç Trying to fetch first admin for testing...');
                    
                    // Try to get any admin for testing
                    const { data: testAdmins, error: testError } = await client
                        .from('admin_accounts')
                        .select('*')
                        .limit(5);
                    
                    console.log('üîç Available admins in database:', testAdmins);
                    if (testError) {
                        console.error('‚ùå Error fetching test admins:', testError);
                    }
                    return;
                }
                
                console.log('‚úÖ Admin data found:', adminData);
                
                // Check if user is Sub Admin
                if (adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è User is not Sub Admin, user type:', adminData.user_type);
                    console.log('‚ÑπÔ∏è Available user types should include: SUB ADMIN');
                    // For Super Admin, could show aggregate data or different view
                    
                    // Show some sample data for testing
                    document.getElementById('activeUsersCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('productsCount').textContent = 'N/A (Super Admin)';
                    document.getElementById('activeFarmersCount').textContent = 'N/A (Super Admin)';
                    return;
                }
                
                console.log('‚úÖ User is Sub Admin');
                
                const municipalityAddress = adminData.address;
                console.log('üîç Sub Admin municipality/address:', municipalityAddress);
                console.log('üîç Address type:', typeof municipalityAddress);
                console.log('üîç Address length:', municipalityAddress ? municipalityAddress.length : 'null');
                
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('‚ùå No municipality address found for Sub Admin');
                    alert('No municipality assigned to this Sub Admin account. Please contact administrator.');
                    document.getElementById('activeUsersCount').textContent = '0';
                    document.getElementById('productsCount').textContent = '0';
                    document.getElementById('activeFarmersCount').textContent = '0';
                    return;
                }
                
                // Update profile access info
                const profileAccess = document.getElementById('profileUserAccess');
                if (profileAccess) {
                    profileAccess.textContent = `Access: ${municipalityAddress}`;
                }
                
                // 1. Get users whose municipality matches Sub Admin's address
                console.log('üîç Searching for users with municipality:', municipalityAddress);
                
                // First, let's see what municipalities exist in the database
                const { data: allMunicipalities, error: municError } = await client
                    .from('users')
                    .select('municipality')
                    .not('municipality', 'is', null);
                
                if (!municError && allMunicipalities) {
                    const uniqueMunicipalities = [...new Set(allMunicipalities.map(u => u.municipality))].filter(m => m);
                    console.log('üîç Available municipalities in users table:', uniqueMunicipalities);
                    console.log('üîç Looking for exact match with:', municipalityAddress);
                    
                    // Check for case-insensitive matches
                    const caseInsensitiveMatches = uniqueMunicipalities.filter(m => 
                        m && m.toLowerCase() === municipalityAddress.toLowerCase()
                    );
                    console.log('üîç Case-insensitive matches:', caseInsensitiveMatches);
                }
                
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .eq('municipality', municipalityAddress);
                
                if (usersError) {
                    console.error('‚ùå Error fetching users by municipality:', usersError);
                    return;
                }
                
                console.log(`üîç Query result: Found ${municipalityUsers ? municipalityUsers.length : 0} users in municipality: ${municipalityAddress}`);
                console.log('üîç User details:', municipalityUsers);
                
                // Get all user IDs for further queries
                const userIds = municipalityUsers ? municipalityUsers.map(user => user.id) : [];
                const totalUsers = municipalityUsers ? municipalityUsers.length : 0;
                
                console.log('üîç User IDs for store owner check:', userIds);
                
                // 2. Get farmers (users who became store owners) in the municipality
                let totalFarmers = 0;
                let storeOwnerUserIds = [];
                
                if (userIds.length > 0) {
                    // Try both possible table name formats for store owner
                    let farmers = null;
                    let farmersError = null;
                    
                    try {
                        console.log('üîç Trying store-owner table...');
                        const result = await client
                            .from('store-owner')
                            .select('user_id, id')
                            .in('user_id', userIds);
                        farmers = result.data;
                        farmersError = result.error;
                        console.log('‚úÖ store-owner table result:', { data: farmers, error: farmersError });
                    } catch (error) {
                        console.log('‚ùå store-owner table failed, trying store_owner...');
                        try {
                            const result = await client
                                .from('store_owner')
                                .select('user_id, id')
                                .in('user_id', userIds);
                            farmers = result.data;
                            farmersError = result.error;
                            console.log('‚úÖ store_owner table result:', { data: farmers, error: farmersError });
                        } catch (error2) {
                            console.error('‚ùå Could not access store owner table with either name format:', error2);
                            farmersError = error2;
                        }
                    }
                    
                    if (!farmersError && farmers) {
                        // Get unique store owner user IDs
                        storeOwnerUserIds = [...new Set(farmers.map(farmer => farmer.user_id))];
                        totalFarmers = storeOwnerUserIds.length;
                        console.log(`Found ${totalFarmers} active farmers (store owners) in ${municipalityAddress}`);
                    } else {
                        console.log('No farmers found or error accessing farmer data:', farmersError);
                    }
                }
                
                // 3. Get available products from users in the municipality who are also store owners
                let totalProducts = 0;
                if (storeOwnerUserIds.length > 0) {
                    console.log('üîç Searching for products from store owners:', storeOwnerUserIds);
                    const { data: products, error: productsError } = await client
                        .from('my_products')
                        .select('id, user_id, name')
                        .in('user_id', storeOwnerUserIds);
                    
                    if (!productsError && products) {
                        totalProducts = products.length;
                        console.log(`‚úÖ Found ${totalProducts} products from store owners in ${municipalityAddress}`);
                        console.log('üîç Product details:', products);
                    } else {
                        console.log('‚ùå No products found or error accessing products:', productsError);
                    }
                } else {
                    console.log('‚ùå No store owners found, so no products to count');
                }
                
                // Update the UI with the counts
                document.getElementById('activeUsersCount').textContent = `${totalUsers}`;
                document.getElementById('productsCount').textContent = `${totalProducts}`;
                document.getElementById('activeFarmersCount').textContent = `${totalFarmers}`;
                
                console.log('=== MUNICIPALITY STATS LOADED ===');
                console.log(`Municipality: ${municipalityAddress}`);
                console.log(`Active Users (in municipality): ${totalUsers}`);
                console.log(`Active Farmers (users who became store owners): ${totalFarmers}`);
                console.log(`Available Products (from store owners): ${totalProducts}`);
                console.log('Matching criteria: Sub Admin address = Users municipality + Users must be store owners');
                
            } catch (error) {
                console.error('Error loading municipality stats:', error);
                
                // Show error state
                document.getElementById('activeUsersCount').textContent = 'Error';
                document.getElementById('productsCount').textContent = 'Error';
                document.getElementById('activeFarmersCount').textContent = 'Error';
            }
        }

        // Function to load real analytics data based on municipality
        window.loadMunicipalityAnalytics = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY ANALYTICS ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå Supabase client not available');
                    return;
                }
                
                // Get current user from session
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (!currentUser.id) {
                    console.log('‚ùå No current user found');
                    return;
                }
                
                // Get Sub Admin's address
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError || !adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è Not a Sub Admin or no address, using dummy data');
                    return;
                }
                
                const municipalityAddress = adminData.address;
                if (!municipalityAddress) {
                    console.log('‚ùå No municipality address found');
                    return;
                }
                
                console.log('üîç Loading analytics for municipality:', municipalityAddress);
                
                // Get users in the municipality
                const { data: municipalityUsers, error: usersError } = await client
                    .from('users')
                    .select('id')
                    .eq('municipality', municipalityAddress);
                
                if (usersError || !municipalityUsers) {
                    console.error('‚ùå Error fetching users:', usersError);
                    return;
                }
                
                const userIds = municipalityUsers.map(user => user.id);
                console.log('üîç User IDs for analytics:', userIds);
                
                // Load Stock Analytics (from my_products)
                await loadStockAnalytics(client, userIds);
                
                // Load Soil Analytics (from store-owner)
                await loadSoilAnalytics(client, userIds);
                
                // Load Hectare Analytics (from store-owner)
                await loadHectareAnalytics(client, userIds);
                
                console.log('‚úÖ Municipality analytics loaded successfully');
                
            } catch (error) {
                console.error('‚ùå Error loading municipality analytics:', error);
            }
        }

        // Load Stock Analytics from my_products
        async function loadStockAnalytics(client, userIds) {
            try {
                console.log('üîç Loading stock analytics...');
                console.log('üîç User IDs for stock analysis:', userIds);
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    // Set "No Data" instead of loading
                    analyticsData.stocks.category = {
                        labels: ['No Data'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Data', quantity: 0, status: 'No Data' }]
                    };
                    return;
                }
                
                const { data: products, error: productsError } = await client
                    .from('my_products')
                    .select('category, quantity, name, id')
                    .in('user_id', userIds);
                
                if (productsError) {
                    console.error('‚ùå Error fetching products:', productsError);
                    return;
                }
                
                console.log('üîç Products data found:', products);
                console.log('üîç Number of products:', products ? products.length : 0);
                
                if (!products || products.length === 0) {
                    console.log('‚ùå No products found for these users');
                    analyticsData.stocks.category = {
                        labels: ['No Products'],
                        data: [1],
                        colors: ['#6c757d'],
                        products: [{ name: 'No Products', quantity: 0, status: 'No Data' }]
                    };
                    
                    // Update chart immediately
                    if (window.stocksChart && window.stocksChart.data) {
                        window.stocksChart.data.labels = ['No Products'];
                        window.stocksChart.data.datasets[0].data = [1];
                        window.stocksChart.data.datasets[0].backgroundColor = ['#6c757d'];
                        window.stocksChart.update();
                    }
                    return;
                }
                
                // Function to determine stock status
                function getStockStatus(quantity) {
                    if (quantity === 0) return 'Out of Stock';
                    if (quantity <= 5) return 'To be Out of Stock';
                    return 'Available';
                }
                
                // Process category data with detailed product information
                const categoryStats = {};
                const categoryProducts = {};
                const statusStats = { 'Available': 0, 'To be Out of Stock': 0, 'Out of Stock': 0 };
                const statusProducts = { 'Available': [], 'To be Out of Stock': [], 'Out of Stock': [] };
                
                products.forEach(product => {
                    console.log('üîç Processing product:', product);
                    const category = (product.category && product.category.trim() !== '') 
                        ? product.category.trim() 
                        : 'Uncategorized';
                    
                    const productStatus = getStockStatus(product.quantity || 0);
                    const productInfo = {
                        name: product.name || 'Unnamed Product',
                        quantity: product.quantity || 0,
                        status: productStatus,
                        category: category
                    };
                    
                    // Count by category
                    categoryStats[category] = (categoryStats[category] || 0) + 1;
                    
                    // Count by status
                    statusStats[productStatus] = (statusStats[productStatus] || 0) + 1;
                    
                    // Store detailed product information by category
                    if (!categoryProducts[category]) {
                        categoryProducts[category] = [];
                    }
                    categoryProducts[category].push(productInfo);
                    
                    // Store detailed product information by status
                    statusProducts[productStatus].push(productInfo);
                });
                
                console.log('üìä Category stats calculated:', categoryStats);
                console.log('üìä Status stats calculated:', statusStats);
                console.log('üìä Category products:', categoryProducts);
                console.log('üìä Status products:', statusProducts);
                
                // Convert to arrays for chart
                const categories = Object.keys(categoryStats);
                const categoryData = Object.values(categoryStats);
                const statusData = Object.values(statusStats);
                const colors = ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#dc3545', '#6c757d'];
                
                console.log('üìä Final chart data:');
                console.log('   Labels:', categories);
                console.log('   Category Data:', categoryData);
                console.log('   Status Data:', statusData);
                
                // Update analyticsData with detailed product information
                analyticsData.stocks.category = {
                    labels: categories,
                    data: categoryData,
                    colors: colors.slice(0, categories.length),
                    products: categoryProducts
                };
                
                // Update status analytics with product details
                analyticsData.stocks.status = {
                    labels: ['Available', 'To be Out of Stock', 'Out of Stock'],
                    data: statusData,
                    colors: ['#28a745', '#ffc107', '#dc3545'],
                    products: statusProducts
                };
                
                console.log('‚úÖ Updated analyticsData.stocks.category:', analyticsData.stocks.category);
                console.log('‚úÖ Updated analyticsData.stocks.status:', analyticsData.stocks.status);
                
                // Update the charts if they exist
                if (window.stocksChart && window.stocksChart.data) {
                    console.log('üîÑ Updating stocks chart with real data');
                    console.log('   Chart before update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                    
                    window.stocksChart.data.labels = categories;
                    window.stocksChart.data.datasets[0].data = categoryData;
                    window.stocksChart.data.datasets[0].backgroundColor = colors.slice(0, categories.length);
                    window.stocksChart.update();
                    
                    console.log('   Chart after update:', {
                        labels: window.stocksChart.data.labels,
                        data: window.stocksChart.data.datasets[0].data
                    });
                } else {
                    console.log('‚ö†Ô∏è Stocks chart not yet initialized, data saved for later use');
                }
                
                // Update the status chart if it exists
                if (window.statusChart && window.statusChart.data) {
                    console.log('üîÑ Updating status chart with real data');
                    window.statusChart.data.labels = ['Available', 'To be Out of Stock', 'Out of Stock'];
                    window.statusChart.data.datasets[0].data = statusData;
                    window.statusChart.data.datasets[0].backgroundColor = ['#28a745', '#ffc107', '#dc3545'];
                    window.statusChart.update();
                    console.log('‚úÖ Status chart updated with real data');
                } else {
                    console.log('‚ö†Ô∏è Status chart not yet initialized, data saved for later use');
                }
                
                console.log('‚úÖ Stock analytics completed');
                
            } catch (error) {
                console.error('‚ùå Error in loadStockAnalytics:', error);
            }
        }

        // Load Soil Analytics from store-owner
        async function loadSoilAnalytics(client, userIds) {
            try {
                console.log('üîç Loading soil analytics...');
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                try {
                    const result = await client
                        .from('store-owner')
                        .select('soil_type')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                } catch (error) {
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('soil_type')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                    } catch (error2) {
                        console.error('‚ùå Could not access store owner table:', error2);
                        return;
                    }
                }
                
                if (!storeOwners) {
                    console.log('‚ùå No store owners found');
                    return;
                }
                
                console.log('üîç Store owners soil data:', storeOwners);
                
                // Process soil type data
                const soilStats = {};
                
                storeOwners.forEach(owner => {
                    if (owner.soil_type) {
                        soilStats[owner.soil_type] = (soilStats[owner.soil_type] || 0) + 1;
                    }
                });
                
                console.log('üìä Soil stats:', soilStats);
                
                // Update analyticsData.soil.type with real data
                const soilTypes = Object.keys(soilStats);
                const soilData = Object.values(soilStats);
                const colors = ['#8b4513', '#d2691e', '#daa520', '#bc8f8f', '#556b2f', '#654321', '#8b7355'];
                
                analyticsData.soil.type = {
                    labels: soilTypes,
                    data: soilData,
                    colors: colors.slice(0, soilTypes.length)
                };
                
                // Update the chart if it exists
                if (window.soilChart && window.soilChart.data) {
                    console.log('üîÑ Updating soil chart with real data');
                    window.soilChart.data.labels = soilTypes;
                    window.soilChart.data.datasets[0].data = soilData;
                    window.soilChart.data.datasets[0].backgroundColor = colors.slice(0, soilTypes.length);
                    window.soilChart.update();
                } else {
                    console.log('‚ö†Ô∏è Soil chart not yet initialized, data will be used when chart is created');
                }
                
                console.log('‚úÖ Soil analytics updated');
                
            } catch (error) {
                console.error('‚ùå Error in loadSoilAnalytics:', error);
            }
        }

        // Load Hectare Analytics from store-owner
        async function loadHectareAnalytics(client, userIds) {
            try {
                console.log('üîç Loading hectare analytics...');
                
                if (userIds.length === 0) {
                    console.log('‚ùå No users to analyze');
                    // Set "No Data" for all periods
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                        },
                        weekly: {
                            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                            data: [0, 0, 0, 0]
                        },
                        yearly: {
                            labels: ['2021', '2022', '2023', '2024'],
                            data: [0, 0, 0, 0]
                        }
                    };
                    return;
                }
                
                // Try both table name formats
                let storeOwners = null;
                let storeOwnerError = null;
                
                try {
                    console.log('üîç Trying store-owner table...');
                    const result = await client
                        .from('store-owner')
                        .select('land_size, created_at, user_id')
                        .in('user_id', userIds);
                    storeOwners = result.data;
                    storeOwnerError = result.error;
                    console.log('‚úÖ store-owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                } catch (error) {
                    console.log('‚ùå store-owner table failed, trying store_owner...');
                    try {
                        const result = await client
                            .from('store_owner')
                            .select('land_size, created_at, user_id')
                            .in('user_id', userIds);
                        storeOwners = result.data;
                        storeOwnerError = result.error;
                        console.log('‚úÖ store_owner table result:', { data: storeOwners?.length || 0, error: storeOwnerError });
                    } catch (error2) {
                        console.error('‚ùå Could not access store owner table with either name format:', error2);
                        return;
                    }
                }
                
                if (storeOwnerError || !storeOwners) {
                    console.log('‚ùå No store owners found or error:', storeOwnerError);
                    return;
                }
                
                console.log('üîç Store owners land size data:', storeOwners);
                
                // Process land size data - filter valid numeric values
                const validLandData = storeOwners
                    .filter(owner => {
                        const landSize = parseFloat(owner.land_size);
                        return owner.land_size && !isNaN(landSize) && landSize > 0;
                    })
                    .map(owner => ({
                        size: parseFloat(owner.land_size),
                        date: owner.created_at ? new Date(owner.created_at) : new Date(),
                        userId: owner.user_id
                    }));
                
                console.log('üìä Valid land data with dates:');
                validLandData.forEach((item, index) => {
                    console.log(`  ${index + 1}. User ${item.userId}: ${item.size} ha on ${item.date.getFullYear()}-${(item.date.getMonth() + 1).toString().padStart(2, '0')}-${item.date.getDate().toString().padStart(2, '0')}`);
                });
                
                if (validLandData.length === 0) {
                    console.log('‚ùå No valid land size data found');
                    // Set "No Data" state
                    analyticsData.hectare = {
                        monthly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        weekly: {
                            labels: ['No Data'],
                            data: [1]
                        },
                        yearly: {
                            labels: ['No Data'],
                            data: [1]
                        }
                    };
                    
                    // Update chart if exists
                    if (window.hectareChart && window.hectareChart.data) {
                        window.hectareChart.data.labels = ['No Data'];
                        window.hectareChart.data.datasets[0].data = [1];
                        window.hectareChart.update();
                    }
                    return;
                }
                
                console.log('üìä Valid land data:', validLandData);
                console.log('üìä Number of valid entries:', validLandData.length);
                
                // Calculate total hectares
                const totalHectares = validLandData.reduce((sum, item) => sum + item.size, 0);
                const avgHectares = totalHectares / validLandData.length;
                
                console.log('üìä Total hectares:', totalHectares);
                console.log('üìä Average hectares per farm:', avgHectares);
                
                // Current date for calculations
                const currentDate = new Date();
                const currentYear = currentDate.getFullYear();
                const currentMonth = currentDate.getMonth(); // 0-based
                
                // MONTHLY DATA - Distribute land data across 12 months based on creation dates
                const monthlyData = new Array(12).fill(0);
                const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // Group by creation month for current year or most recent year with data
                const yearlyGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    const month = item.date.getMonth();
                    
                    if (!yearlyGroups[year]) yearlyGroups[year] = new Array(12).fill(0);
                    yearlyGroups[year][month] += item.size;
                });
                
                // Use current year data if available, otherwise use the most recent year
                const availableYears = Object.keys(yearlyGroups).map(y => parseInt(y)).sort((a, b) => b - a);
                const targetYear = availableYears.includes(currentYear) ? currentYear : availableYears[0];
                
                if (targetYear && yearlyGroups[targetYear]) {
                    for (let i = 0; i < 12; i++) {
                        monthlyData[i] = yearlyGroups[targetYear][i];
                    }
                } else {
                    // Fallback: distribute evenly if no specific year data
                    const monthlyAvg = totalHectares / 12;
                    for (let i = 0; i < 12; i++) {
                        const variation = (Math.random() - 0.5) * 0.2;
                        monthlyData[i] = Math.round((monthlyAvg + monthlyAvg * variation) * 100) / 100;
                    }
                }
                
                // WEEKLY DATA - More accurate weekly distribution based on actual data
                const weeklyLabels = [];
                const weeklyData = [];
                
                // Get current month's data or data from the month with most activity
                const currentMonthTotal = monthlyData[currentMonth];
                const maxMonthIndex = monthlyData.indexOf(Math.max(...monthlyData));
                const targetMonthTotal = currentMonthTotal > 0 ? currentMonthTotal : monthlyData[maxMonthIndex];
                
                // Get current week number for more accurate labeling
                const now = new Date();
                const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
                const currentWeek = Math.ceil((now.getDate() + startOfMonth.getDay()) / 7);
                
                // Create weekly distribution based on actual farm registration patterns
                const farmsInTargetMonth = validLandData.filter(item => {
                    const itemMonth = item.date.getMonth();
                    return currentMonthTotal > 0 ? itemMonth === currentMonth : itemMonth === maxMonthIndex;
                });
                
                // If we have farms in the target month, distribute by actual weeks
                if (farmsInTargetMonth.length > 0) {
                    const weeklyDistribution = [0, 0, 0, 0];
                    
                    farmsInTargetMonth.forEach(item => {
                        const dayOfMonth = item.date.getDate();
                        const weekOfMonth = Math.min(Math.ceil(dayOfMonth / 7), 4) - 1; // 0-3
                        weeklyDistribution[weekOfMonth] += item.size;
                    });
                    
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        weeklyData.push(Math.round(weeklyDistribution[i] * 100) / 100);
                    }
                } else {
                    // Fallback: distribute target month evenly across weeks
                    const weeklyBase = targetMonthTotal / 4;
                    for (let i = 0; i < 4; i++) {
                        weeklyLabels.push(`Week ${i + 1}`);
                        const variation = (Math.random() - 0.5) * 0.1;
                        weeklyData.push(Math.round((weeklyBase + weeklyBase * variation) * 100) / 100);
                    }
                }
                
                // YEARLY DATA - ONLY use actual database data, no simulation
                const currentYear2025 = new Date().getFullYear(); // Use actual current year (2025)
                const yearRange = 4; // Show last 4 years
                const yearlyLabels = [];
                const yearlyData = [];
                
                // Create year groups based ONLY on actual data - sum ALL land registered in each year
                const actualYearGroups = {};
                validLandData.forEach(item => {
                    const year = item.date.getFullYear();
                    if (!actualYearGroups[year]) actualYearGroups[year] = 0;
                    actualYearGroups[year] += item.size; // Sum total land for this year
                });
                
                console.log('üìä Raw year groups from database (ACTUAL DATA ONLY):', actualYearGroups);
                console.log('üìä Current year detected:', currentYear2025);
                
                // Generate data for the last 4 years (2022-2025) - ONLY ACTUAL DATA
                for (let i = yearRange - 1; i >= 0; i--) {
                    const year = currentYear2025 - i;
                    yearlyLabels.push(year.toString());
                    
                    if (actualYearGroups[year] && actualYearGroups[year] > 0) {
                        // Use ONLY actual total land registered in this year
                        yearlyData.push(Math.round(actualYearGroups[year] * 100) / 100);
                        console.log(`‚úÖ Year ${year}: ACTUAL DATA = ${actualYearGroups[year]} hectares`);
                    } else {
                        // NO SIMULATION - if no actual data, show 0
                        yearlyData.push(0);
                        console.log(`‚ùå Year ${year}: No actual data found, showing 0 hectares`);
                    }
                }
                
                console.log('üìä Final yearly labels (REAL DATA ONLY):', yearlyLabels);
                console.log('üìä Final yearly data (REAL DATA ONLY):');
                yearlyLabels.forEach((year, index) => {
                    const value = yearlyData[index];
                    const source = value > 0 ? 'ACTUAL DATABASE' : 'NO DATA';
                    console.log(`   ${year}: ${value} hectares (${source})`);
                });
                
                console.log('üìä Actual year groups from database:', actualYearGroups);
                console.log('üìä Monthly hectare data:', monthlyData);
                console.log('üìä Weekly hectare data (accurate):', weeklyData);
                console.log('üìä Yearly hectare data (accurate):', yearlyData);
                
                // Update analyticsData with comprehensive data
                analyticsData.hectare = {
                    monthly: {
                        labels: monthNames,
                        data: monthlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    },
                    weekly: {
                        labels: weeklyLabels,
                        data: weeklyData,
                        totalHectares: targetMonthTotal,
                        validFarms: validLandData.length
                    },
                    yearly: {
                        labels: yearlyLabels,
                        data: yearlyData,
                        totalHectares: totalHectares,
                        validFarms: validLandData.length
                    }
                };
                
                console.log('‚úÖ Updated analyticsData.hectare:', analyticsData.hectare);
                
                // Update the chart if it exists (default to monthly view)
                if (window.hectareChart && window.hectareChart.data) {
                    console.log('üîÑ Updating hectare chart with real monthly data');
                    window.hectareChart.data.labels = monthNames;
                    window.hectareChart.data.datasets[0].data = monthlyData;
                    window.hectareChart.update();
                    console.log('‚úÖ Hectare chart updated successfully');
                } else {
                    console.log('‚ö†Ô∏è Hectare chart not yet initialized, data saved for later use');
                }
                
                console.log('‚úÖ Hectare analytics completed');
                
            } catch (error) {
                console.error('‚ùå Error in loadHectareAnalytics:', error);
            }
        }

        // Test function to check database connection and data
        window.testDatabaseConnection = async function() {
            try {
                console.log('=== TESTING DATABASE CONNECTION ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå No Supabase client available');
                    return;
                }
                
                // Test admin_accounts table
                console.log('üîç Testing admin_accounts table...');
                const { data: admins, error: adminError } = await client
                    .from('admin_accounts')
                    .select('*')
                    .limit(3);
                
                console.log('Admin accounts result:', { data: admins, error: adminError });
                
                // Test users table
                console.log('üîç Testing users table...');
                const { data: users, error: userError } = await client
                    .from('users')
                    .select('id, municipality, address, full_name')
                    .limit(5);
                
                console.log('Users result:', { data: users, error: userError });
                
                // Test store owner tables
                console.log('üîç Testing store-owner table...');
                try {
                    const { data: stores1, error: storeError1 } = await client
                        .from('store-owner')
                        .select('*')
                        .limit(3);
                    console.log('store-owner result:', { data: stores1, error: storeError1 });
                } catch (e) {
                    console.log('store-owner table not accessible');
                }
                
                console.log('üîç Testing store_owner table...');
                try {
                    const { data: stores2, error: storeError2 } = await client
                        .from('store_owner')
                        .select('*')
                        .limit(3);
                    console.log('store_owner result:', { data: stores2, error: storeError2 });
                } catch (e) {
                    console.log('store_owner table not accessible');
                }
                
                // Test products table
                console.log('üîç Testing my_products table...');
                const { data: products, error: productError } = await client
                    .from('my_products')
                    .select('*')
                    .limit(3);
                
                console.log('Products result:', { data: products, error: productError });
                
                console.log('=== DATABASE TEST COMPLETE ===');
                
            } catch (error) {
                console.error('‚ùå Error in database test:', error);
            }
        }

        // Wait for shared profile to load, then load municipality stats
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Check if charts are already initialized to prevent duplicates
            if (window.chartsInitialized) {
                console.log('‚ö†Ô∏è Charts already initialized, skipping...');
                return;
            }
            
            // Initialize charts
            initializeCharts();
            window.chartsInitialized = true;
                
            // Load real data after charts are initialized
            setTimeout(() => {
                console.log('üîÑ Loading analytics after charts initialization...');
                window.loadMunicipalityAnalytics();
            }, 2000);
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('üîç Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('üîÑ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
            }, 3000); // Increased timeout to 3 seconds
        });

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            window.salesChart.data.labels = data.labels;
            window.salesChart.data.datasets[0].data = data.data;
            window.salesChart.update();
        }

        function updateStocksChart(view) {
            console.log('üîÑ Updating stocks chart to view:', view);
            
            const stocksCanvas = document.getElementById('stocksChart');
            const statusCanvas = document.getElementById('statusChart');
            
            if (!stocksCanvas || !statusCanvas) {
                console.warn('‚ö†Ô∏è Chart elements not found');
                return;
            }
            
            if (view === 'status') {
                // Show status chart, hide category chart
                stocksCanvas.style.display = 'none';
                statusCanvas.style.display = 'block';
                
                // Update status chart with real data
                const data = analyticsData.stocks.status;
                console.log('üìä Status chart data:', data);
                
                if (data && data.labels && data.data && window.statusChart && window.statusChart.data) {
                    window.statusChart.data.labels = data.labels;
                    window.statusChart.data.datasets[0].data = data.data;
                    window.statusChart.data.datasets[0].backgroundColor = data.colors;
                    window.statusChart.update();
                    console.log('‚úÖ Status chart updated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Status chart not ready or missing data');
                    if (!window.statusChart) console.warn('  - statusChart not initialized');
                    if (!data) console.warn('  - status data missing');
                    if (window.statusChart && !window.statusChart.data) console.warn('  - statusChart.data is undefined');
                }
                
            } else {
                // Show category chart, hide status chart
                stocksCanvas.style.display = 'block';
                statusCanvas.style.display = 'none';
                
                // Update category chart with real data
                const data = analyticsData.stocks[view];
                console.log('üìä Category chart data:', data);
                
                if (data && data.labels && data.data && window.stocksChart && window.stocksChart.data) {
                    window.stocksChart.data.labels = data.labels;
                    window.stocksChart.data.datasets[0].data = data.data;
                    window.stocksChart.data.datasets[0].backgroundColor = data.colors;
                    window.stocksChart.update();
                    console.log('‚úÖ Category chart updated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Category chart not ready or missing data');
                    if (!window.stocksChart) console.warn('  - stocksChart not initialized');
                    if (!data) console.warn('  - category data missing');
                    if (window.stocksChart && !window.stocksChart.data) console.warn('  - stocksChart.data is undefined');
                }
            }
        }

        // Status filtering function
        function filterByStatus(status) {
            console.log('üîÑ Filtering by status:', status);
            
            // Check if statusChart exists
            if (!window.statusChart || !window.statusChart.data) {
                console.warn('‚ö†Ô∏è Status chart not ready for filtering');
                return;
            }
            
            // Update active button
            document.querySelectorAll('.status-filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.remove('btn-success', 'btn-warning', 'btn-danger');
                btn.classList.add('btn-outline-success', 'btn-outline-warning', 'btn-outline-danger');
            });
            
            const activeBtn = document.querySelector(`[data-status="${status}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
                if (status === 'Available') {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                } else if (status === 'To be Out of Stock') {
                    activeBtn.classList.remove('btn-outline-warning');
                    activeBtn.classList.add('btn-warning');
                } else if (status === 'Out of Stock') {
                    activeBtn.classList.remove('btn-outline-danger');
                    activeBtn.classList.add('btn-danger');
                } else {
                    activeBtn.classList.remove('btn-outline-success');
                    activeBtn.classList.add('btn-success');
                }
            }

            // We're in status view - filter the status chart
            const statusData = analyticsData.stocks.status;
            
            if (!statusData || !statusData.labels || !statusData.data) {
                console.warn('‚ö†Ô∏è Status data not available for filtering');
                return;
            }
            
            if (status === 'all') {
                // Show all status data
                window.statusChart.data.labels = statusData.labels;
                window.statusChart.data.datasets[0].data = statusData.data;
                window.statusChart.data.datasets[0].backgroundColor = statusData.colors;
            } else {
                // Show only the selected status
                const statusIndex = statusData.labels.indexOf(status);
                if (statusIndex !== -1) {
                    window.statusChart.data.labels = [status];
                    window.statusChart.data.datasets[0].data = [statusData.data[statusIndex]];
                    window.statusChart.data.datasets[0].backgroundColor = [statusData.colors[statusIndex]];
                } else {
                    console.warn('‚ö†Ô∏è Status not found in data:', status);
                    return;
                }
            }
            window.statusChart.update();
            console.log('‚úÖ Status filter applied successfully');
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            window.soilChart.data.labels = data.labels;
            window.soilChart.data.datasets[0].data = data.data;
            window.soilChart.data.datasets[0].backgroundColor = data.colors;
            window.soilChart.update();
        }

        function updateHectareChart(period) {
            console.log('üîÑ Updating hectare chart to period:', period);
            
            if (!window.hectareChart || !window.hectareChart.data) {
                console.warn('‚ö†Ô∏è Hectare chart not initialized');
                return;
            }
            
            const data = analyticsData.hectare[period];
            if (!data || !data.labels || !data.data) {
                console.warn('‚ö†Ô∏è No hectare data available for period:', period);
                console.log('Available periods:', Object.keys(analyticsData.hectare));
                return;
            }
            
            console.log('üìä Updating with data for', period, ':', data);
            console.log('üìä Labels:', data.labels);
            console.log('üìä Data:', data.data);
            
            window.hectareChart.data.labels = data.labels;
            window.hectareChart.data.datasets[0].data = data.data;
            window.hectareChart.update();
            
            console.log('‚úÖ Hectare chart updated successfully');
            console.log('‚úÖ Chart now shows:', window.hectareChart.data.labels);
        }

        // Sales Chart (Line Graph)
        function initSalesChart() {
            try {
                // Destroy existing chart if it exists
                if (window.salesChart && typeof window.salesChart.destroy === 'function') {
                    window.salesChart.destroy();
                    window.salesChart = null;
                }
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Sales chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.sales.monthly;
                
                window.salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        label: 'Sales (‚Ç±)',
                        data: currentData.data,
                        borderColor: '#28a745',
                        backgroundColor: 'rgba(40, 167, 69, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                boxWidth: 40,
                                usePointStyle: false
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‚Ç±' + value.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('‚ùå Error initializing sales chart:', error);
            }
        }

        // Stocks Chart (Pie Chart)
        function initStocksChart() {
            try {
                // Destroy existing chart if it exists
                if (window.stocksChart && typeof window.stocksChart.destroy === 'function') {
                    window.stocksChart.destroy();
                    window.stocksChart = null;
                }
                
                const canvas = document.getElementById('stocksChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Stocks chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.stocks.category;
            
            window.stocksChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return context[0].label;
                                },
                                label: function(context) {
                                    // Get current filter view
                                    const currentFilter = document.getElementById('stocksFilter').value;
                                    const label = context.label;
                                    const count = context.parsed;
                                    
                                    if (currentFilter === 'status') {
                                        // Status view - show products by status
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    } else {
                                        // Category view - show products by category
                                        const products = analyticsData.stocks.category.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const categoryProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        categoryProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.status})`);
                                        });
                                        
                                        return tooltipLines;
                                    }
                                },
                                labelColor: function(context) {
                                    return {
                                        borderColor: context.dataset.backgroundColor[context.dataIndex],
                                        backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                    };
                                }
                            },
                            displayColors: true,
                            bodySpacing: 4,
                            titleSpacing: 6,
                            footerSpacing: 4,
                            bodyFont: {
                                size: 12
                            },
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            }
                        }
                    }
                }
            });
            } catch (error) {
                console.error('‚ùå Error initializing stocks chart:', error);
            }
        }

        // Status Chart (Separate Pie Chart for Status View)
        function initStatusChart() {
            try {
                // Destroy existing chart if it exists
                if (window.statusChart && typeof window.statusChart.destroy === 'function') {
                    window.statusChart.destroy();
                    window.statusChart = null;
                }
                
                const canvas = document.getElementById('statusChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Status chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.stocks.status;
                
                window.statusChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        return context[0].label;
                                    },
                                    label: function(context) {
                                        // Status view - show products by status
                                        const label = context.label;
                                        const count = context.parsed;
                                        const products = analyticsData.stocks.status.products;
                                        
                                        if (!products || !products[label]) {
                                            return `Products: ${count}`;
                                        }
                                        
                                        const statusProducts = products[label];
                                        let tooltipLines = [`${label}: ${count} products`];
                                        
                                        // Add individual product details
                                        statusProducts.forEach(product => {
                                            const statusColor = product.status === 'Available' ? 'üü¢' : 
                                                              product.status === 'To be Out of Stock' ? 'üü°' : 'üî¥';
                                            tooltipLines.push(`${statusColor} ${product.name}: ${product.quantity} stocks (${product.category})`);
                                        });
                                        
                                        return tooltipLines;
                                    },
                                    labelColor: function(context) {
                                        return {
                                            borderColor: context.dataset.backgroundColor[context.dataIndex],
                                            backgroundColor: context.dataset.backgroundColor[context.dataIndex]
                                        };
                                    }
                                },
                                displayColors: true,
                                bodySpacing: 4,
                                titleSpacing: 6,
                                footerSpacing: 4,
                                bodyFont: {
                                    size: 12
                                },
                                titleFont: {
                                    size: 14,
                                    weight: 'bold'
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('‚ùå Error initializing status chart:', error);
            }
        }

        // Soil Chart (Donut Chart)
        function initSoilChart() {
            try {
                // Destroy existing chart if it exists
                if (window.soilChart && typeof window.soilChart.destroy === 'function') {
                    window.soilChart.destroy();
                    window.soilChart = null;
                }
                
                const canvas = document.getElementById('soilChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Soil chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
            const currentData = analyticsData.soil.type;
            
            window.soilChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            } catch (error) {
                console.error('‚ùå Error initializing soil chart:', error);
            }
        }

        // Hectare Chart (Bar Chart)
        function initHectareChart() {
            try {
                // Destroy existing chart if it exists
                if (window.hectareChart && typeof window.hectareChart.destroy === 'function') {
                    window.hectareChart.destroy();
                    window.hectareChart = null;
                }
                
                const canvas = document.getElementById('hectareChart');
                if (!canvas) {
                    console.warn('‚ö†Ô∏è Hectare chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = analyticsData.hectare.monthly;
                
                window.hectareChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            label: 'Hectares',
                            data: currentData.data,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        return `${context[0].label} - ${period.charAt(0).toUpperCase() + period.slice(1)} View`;
                                    },
                                    label: function(context) {
                                        const hectares = context.parsed.y;
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        const label = context.label;
                                        
                                        let tooltipText = [`üåæ Hectares: ${hectares.toFixed(2)} ha`];
                                        
                                        // Add contextual information based on period
                                        if (hectareData.totalHectares && hectareData.totalHectares > 0) {
                                            const percentage = ((hectares / hectareData.totalHectares) * 100).toFixed(1);
                                            tooltipText.push(`üìä Percentage: ${percentage}%`);
                                        }
                                        
                                        if (hectareData.validFarms) {
                                            tooltipText.push(`üè™ Active Farms: ${hectareData.validFarms}`);
                                        }
                                        
                                        // Period-specific information
                                        if (period === 'monthly') {
                                            if (hectareData.validFarms > 0) {
                                                const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                tooltipText.push(`üìè Avg per Farm: ${avgPerFarm} ha`);
                                            }
                                            tooltipText.push(`üìÖ Month: ${label}`);
                                        } else if (period === 'weekly') {
                                            tooltipText.push(`üìÖ Current Month Distribution`);
                                            if (hectares > 0) {
                                                tooltipText.push(`üóìÔ∏è ${label} of Month`);
                                            }
                                        } else if (period === 'yearly') {
                                            tooltipText.push(`üìÖ Year: ${label}`);
                                            
                                            if (hectares > 0) {
                                                tooltipText.push(`üåæ Total Land in ${label}: ${hectares.toFixed(2)} ha`);
                                                tooltipText.push(`üìä ACTUAL DATABASE DATA`);
                                                
                                                if (hectareData.validFarms > 0) {
                                                    const avgPerFarm = (hectares / hectareData.validFarms).toFixed(2);
                                                    tooltipText.push(`üìè Est. Avg per Farm: ${avgPerFarm} ha`);
                                                }
                                            } else {
                                                tooltipText.push(`‚ùå No farms registered in ${label}`);
                                                tooltipText.push(`üìä NO DATA AVAILABLE`);
                                            }
                                        }
                                        
                                        return tooltipText;
                                    },
                                    footer: function(context) {
                                        const period = document.getElementById('hectareFilter')?.value || 'monthly';
                                        const hectareData = analyticsData.hectare[period];
                                        
                                        if (hectareData.totalHectares) {
                                            return `Total Land: ${hectareData.totalHectares.toFixed(2)} hectares`;
                                        }
                                        return '';
                                    }
                                },
                                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                                titleColor: '#fff',
                                bodyColor: '#fff',
                                footerColor: '#ccc',
                                borderColor: '#28a745',
                                borderWidth: 1,
                                cornerRadius: 6,
                                displayColors: true
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' ha';
                                    }
                                }
                            }
                        }
                    }
                });
                
                console.log('‚úÖ Hectare chart initialized successfully');
                
            } catch (error) {
                console.error('‚ùå Error initializing hectare chart:', error);
            }
        }

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            salesChart.data.labels = data.labels;
            salesChart.data.datasets[0].data = data.data;
            salesChart.update();
        }

        function updateSoilChart(view) {
            const data = analyticsData.soil[view];
            soilChart.data.labels = data.labels;
            soilChart.data.datasets[0].data = data.data;
            soilChart.data.datasets[0].backgroundColor = data.colors;
            soilChart.update();
        }


        // Event Listeners
        // Event Listeners for Filters
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Municipality dashboard loaded');
            
            // Initialize charts
            if (typeof Chart !== 'undefined') {
                initializeCharts();
                
                // Load real data after charts are initialized
                setTimeout(() => {
                    console.log('üîÑ Loading analytics after charts initialization...');
                    window.loadMunicipalityAnalytics();
                }, 2000);
            }
            
            // Wait a bit for profile to load, then load municipality stats
            setTimeout(() => {
                console.log('üîç Starting municipality stats load...');
                window.testDatabaseConnection(); // Test database first
                window.loadMunicipalityStats();
                
                // Load analytics with additional delay to ensure charts are ready
                setTimeout(() => {
                    console.log('üîÑ Loading analytics with delay...');
                    window.loadMunicipalityAnalytics();
                }, 1000);
                
                // Load municipality users for User Management table
                setTimeout(() => {
                    console.log('üîÑ Loading municipality users...');
                    // Check if DOM elements are ready
                    const tableBody = document.getElementById('userManagementTable');
                    if (!tableBody) {
                        console.warn('‚ö†Ô∏è User table not ready, retrying in 2 seconds...');
                        setTimeout(() => {
                            window.loadMunicipalityUsers();
                        }, 2000);
                    } else {
                        window.loadMunicipalityUsers();
                    }
                }, 1500);
            }, 3000); // Increased timeout to 3 seconds
            
            // Add event listeners for filters
            const salesFilter = document.getElementById('salesFilter');
            if (salesFilter) {
                salesFilter.addEventListener('change', function() {
                    updateSalesChart(this.value);
                });
            }

            const stocksFilter = document.getElementById('stocksFilter');
            if (stocksFilter) {
                stocksFilter.addEventListener('change', function() {
                    updateStocksChart(this.value);
                });
            }

            const soilFilter = document.getElementById('soilFilter');
            if (soilFilter) {
                soilFilter.addEventListener('change', function() {
                    updateSoilChart(this.value);
                });
            }

            const hectareFilter = document.getElementById('hectareFilter');
            if (hectareFilter) {
                hectareFilter.addEventListener('change', function() {
                    updateHectareChart(this.value);
                });
            }
        });

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                sales: salesChart,
                stocks: stocksChart,
                soil: soilChart,
                hectare: hectareChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_municipality_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
                case 'picture':
                    exportToPicture(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = 'Label,Value\n';
            let data;
            
            switch(chartType) {
                case 'sales':
                    data = analyticsData.sales.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'stocks':
                    data = analyticsData.stocks.category;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
                case 'hectare':
                    data = analyticsData.hectare.monthly;
                    data.labels.forEach((label, index) => {
                        csv += `${label},${data.data[index]}\n`;
                    });
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 10, 190, 100);
                    doc.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const content = `
                        <html>
                        <head><title>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics</title></head>
                        <body>
                            <h1>Municipality ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            <img src="${imgData}" style="max-width: 100%; height: auto;">
                        </body>
                        </html>
                    `;
                    const blob = new Blob([content], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function exportToPicture(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Load municipality-specific users for User Management table
        window.loadMunicipalityUsers = async function() {
            try {
                console.log('=== LOADING MUNICIPALITY USERS ===');
                
                const client = window.supabaseClient || supabaseClient;
                if (!client) {
                    console.error('‚ùå Supabase client not available');
                    updateUserTable([], 'Database connection not available');
                    return;
                }
                
                // Get current admin user
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                if (!currentUser.id) {
                    console.log('‚ùå No current user found');
                    updateUserTable([], 'User not logged in');
                    return;
                }
                
                // Get Sub Admin's municipality/address
                const { data: adminData, error: adminError } = await client
                    .from('admin_accounts')
                    .select('address, user_type')
                    .eq('id', currentUser.id)
                    .single();
                
                if (adminError || !adminData || adminData.user_type !== 'SUB ADMIN') {
                    console.log('‚ÑπÔ∏è Not a Sub Admin or no address');
                    updateUserTable([], 'Access restricted to Sub Admins');
                    return;
                }
                
                const municipalityAddress = adminData.address;
                if (!municipalityAddress || municipalityAddress.trim() === '') {
                    console.log('‚ùå No municipality address found');
                    updateUserTable([], 'No municipality assigned');
                    return;
                }
                
                console.log('üîç Loading users for municipality:', municipalityAddress);
                
                // Get users from the same municipality
                const { data: users, error: usersError } = await client
                    .from('users')
                    .select('full_name, email, phone_number, municipality, address')
                    .eq('municipality', municipalityAddress)
                    .order('full_name', { ascending: true });
                
                if (usersError) {
                    console.error('‚ùå Error fetching users:', usersError);
                    updateUserTable([], 'Error loading users');
                    return;
                }
                
                console.log(`‚úÖ Found ${users ? users.length : 0} users in ${municipalityAddress}`);
                console.log('üîç User details:', users);
                
                updateUserTable(users || [], null, municipalityAddress);
                
            } catch (error) {
                console.error('‚ùå Error in loadMunicipalityUsers:', error);
                updateUserTable([], 'Error loading users');
            }
        }
        
        // Pagination variables
        let currentUserPage = 1;
        let usersPerPage = 10;
        let allMunicipalityUsers = [];
        
        // Update User Management table with real data
        function updateUserTable(users, errorMessage, municipality) {
            const tableBody = document.getElementById('userManagementTable');
            const viewAllLink = document.getElementById('viewAllUsersLink');
            
            if (!tableBody) {
                console.warn('‚ö†Ô∏è User table element (userManagementTable) not found. Retrying in 1 second...');
                setTimeout(() => updateUserTable(users, errorMessage, municipality), 1000);
                return;
            }
            
            console.log('‚úÖ User table elements found, updating table...');
            
            // Store users for pagination
            allMunicipalityUsers = users;
            currentUserPage = 1;
            
            if (errorMessage) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${errorMessage}
                        </td>
                    </tr>
                `;
                return;
            }
            
            if (!users || users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-users me-2"></i>
                            No users found in ${municipality || 'this municipality'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            console.log(`üìä Displaying ${users.length} users from ${municipality}`);
            
            // Update view all link
            if (viewAllLink) {
                viewAllLink.textContent = `View all ${users.length} users >`;
            }
            
            // Display paginated users
            displayUsersPage(currentUserPage);
        }
        
        // Display users for current page
        function displayUsersPage(page) {
            const tableBody = document.getElementById('userManagementTable');
            const currentPageBtn = document.getElementById('currentPageBtn');
            
            if (!tableBody) {
                console.warn('‚ö†Ô∏è User table element not found in displayUsersPage');
                return;
            }
            
            console.log(`üìÑ Displaying page ${page} of users`);
            
            const startIndex = (page - 1) * usersPerPage;
            const endIndex = startIndex + usersPerPage;
            const pageUsers = allMunicipalityUsers.slice(startIndex, endIndex);
            
            if (pageUsers.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            No users on this page
                        </td>
                    </tr>
                `;
                return;
            }
            
            tableBody.innerHTML = pageUsers.map(user => `
                <tr>
                    <td>${user.full_name || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || 'N/A'}</td>
                </tr>
            `).join('');
            
            console.log(`‚úÖ Successfully displayed ${pageUsers.length} users on page ${page}`);
            
            // Update pagination
            if (currentPageBtn) {
                currentPageBtn.textContent = page;
            }
            
            console.log(`üìÑ Displaying page ${page}: ${pageUsers.length} users`);
        }
        
        // Pagination function
        function changePage(direction) {
            const totalPages = Math.ceil(allMunicipalityUsers.length / usersPerPage);
            const newPage = currentUserPage + direction;
            
            if (newPage >= 1 && newPage <= totalPages) {
                currentUserPage = newPage;
                displayUsersPage(currentUserPage);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>
