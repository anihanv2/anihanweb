<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Per Location - Anihan</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">               
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link href="sales_per_location.css" rel="stylesheet">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="navbar-nav">
                <div class="nav-item">
                    <div class="user-avatar" onclick="toggleProfileDropdown()">
                        <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                        <i id="userAvatarIcon" class="fas fa-user"></i>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="profileUserTitle">System Administrator</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link active d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="sales-card shadow-sm mt-4">
                    <div class="sales-card-header d-flex justify-content-between align-items-center">
                        <span>Sales Per Location</span>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="sales-table">
                            <thead>
                                <tr>
                                    <th>Store Location</th>
                                    <th>Product Name</th>
                                    <th>Quantity</th>
                                    <th>Total Sales</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Data rows will be populated here -->
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading sales data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="sales-card-footer">
                        <a href="#" style="color:#2563eb;font-size:0.95rem;">View all &gt;</a>
                        <div class="sales-pagination">
                            <button class="btn">&lt;</button>
                            <button class="btn active">1</button>
                            <button class="btn">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <!-- Add Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add Shared Profile System -->
    <script src="shared-profile.js"></script>
    <script>
        // Use Supabase client from shared-profile.js
        // Wait for shared-profile.js to initialize supabaseClient

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sales Per Location page loaded');
            // Small delay to ensure shared-profile.js has initialized supabaseClient
            setTimeout(() => {
                loadSalesPerLocationData();
            }, 200);
        });

        // Load sales per location data and populate table
        async function loadSalesPerLocationData() {
            try {
                console.log('ðŸ”„ Loading sales per location data...');
                
                // Use the global supabaseClient from shared-profile.js
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('âŒ Supabase client not available');
                    updateSalesTable([]);
                    return;
                }

                const client = window.supabaseClient || supabaseClient;

                // Get product sales data with store information using the same join approach as price monitoring
                const { data: salesData, error } = await client
                    .from('order_items')
                    .select(`
                        quantity,
                        orders!inner(
                            id,
                            total,
                            status
                        ),
                        my_products!inner(
                            id,
                            name,
                            category,
                            price,
                            user_id,
                            users!my_products_user_id_fkey (
                                id,
                                municipality,
                                store-owner!store-owner_user_id_fkey (
                                    store_name
                                )
                            )
                        )
                    `);

                console.log('ðŸ“ˆ Sales data query result:', { 
                    dataCount: salesData?.length || 0, 
                    error: error,
                    sampleData: salesData?.slice(0, 3) 
                });

                if (error) {
                    console.error('âŒ Error fetching sales data:', error);
                    updateSalesTable([]);
                    return;
                }

                if (!salesData || salesData.length === 0) {
                    console.warn('âš ï¸ No sales data found');
                    updateSalesTable([]);
                    return;
                }

                // Process and group the data by municipality (store location) and product (using same approach as price monitoring)
                const processedData = {};
                let processedCount = 0;











                    console.log('ï¿½ Attempting direct user lookup for municipalities...');
                    
                    // Get unique user IDs from sales data
                    const userIds = [...new Set(salesData.map(item => item.orders.user_id))];
                    console.log('ðŸ‘¥ Found unique user IDs in orders:', userIds);
                    
                    if (userIds.length > 0) {
                        const { data: users, error: usersError } = await client
                            .from('users')
                            .select('id, municipality, address, full_name')
                            .in('id', userIds);
                            
                        if (!usersError && users) {
                            users.forEach(user => {
                                const municipality = user.municipality || user.address || 'Unknown Location';
                                userMunicipalityMap[user.id] = municipality;
                                console.log(`ðŸ—ºï¸ Direct mapped User ${user.id} (${user.full_name}) to: ${municipality}`);
                            });
                        }
                    }

                
                salesData.forEach(item => {
                    // Get store information from the joined data (same approach as price monitoring)
                    const product = item.my_products;
                    const user = product?.users;
                    const storeOwner = user?.['store-owner']?.[0];
                    const storeName = storeOwner?.store_name || 'Unknown Store';
                    const municipality = user?.municipality || 'Unknown Location';
                    
                    console.log(`ðŸ“ Processing item - Product: ${product?.name}, Municipality: ${municipality}`);
                    
                    const productName = product?.name || 'Unknown Product';
                    const quantity = parseInt(item.quantity) || 0;
                    const productPrice = parseFloat(product?.price) || 0;
                    const itemTotal = quantity * productPrice;

                    const key = `${municipality}-${productName}`;
                    
                    if (processedData[key]) {
                        processedData[key].quantity += quantity;
                        processedData[key].totalSales += itemTotal;
                        processedData[key].orderCount += 1;
                    } else {
                        processedData[key] = {
                            municipality: municipality,
                            productName: productName,
                            category: product?.category || 'Unknown',
                            quantity: quantity,
                            totalSales: itemTotal,
                            orderCount: 1,
                            storeName: storeName
                        };
                    }
                    processedCount++;
                });

                console.log('ðŸ“Š Processing complete:', { 
                    processedItems: processedCount,
                    uniqueLocationProducts: Object.keys(processedData).length,
                    sampleProcessedData: Object.values(processedData).slice(0, 3)
                });

                // Convert to array and sort by total sales (descending)
                const salesArray = Object.values(processedData)
                    .sort((a, b) => b.totalSales - a.totalSales);

                console.log('âœ… Final sales array:', salesArray.length, 'records');
                console.log('ðŸ“‹ Sample records:', salesArray.slice(0, 5));
                
                updateSalesTable(salesArray);

            } catch (error) {
                console.error('ðŸ’¥ Error in loadSalesPerLocationData:', error);
                updateSalesTable([]);
            }
        }

        // Update the sales table with data
        function updateSalesTable(salesData) {
            const tableBody = document.getElementById('salesTableBody');
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }

            if (!salesData || salesData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            No sales data available
                        </td>
                    </tr>
                `;
                return;
            }

            // Generate table rows
            const tableRows = salesData.map(item => `
                <tr>
                    <td>
                        <div class="location-info">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            <span class="fw-semibold">${item.municipality}</span>
                        </div>
                    </td>
                    <td>
                        <div class="product-info">
                            <div class="product-name fw-semibold">${item.productName}</div>
                            <small class="text-muted">${item.category}</small>
                        </div>
                    </td>
                    <td>
                        <div class="quantity-info">
                            <span class="badge bg-success fs-6">${item.quantity}</span>
                            <small class="text-muted d-block">${item.orderCount} orders</small>
                        </div>
                    </td>
                    <td>
                        <div class="sales-amount">
                            <span class="fw-bold text-success">â‚±${item.totalSales.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                        </div>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = tableRows;
            console.log(`âœ… Updated table with ${salesData.length} records`);
        }

        // Search functionality
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableRows = document.querySelectorAll('.sales-table tbody tr');
                
                tableRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
</body>
</html>