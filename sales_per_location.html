<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Per Location - Anihan</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css?v=5.0" rel="stylesheet">               
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.0" rel="stylesheet">
    <link href="fixed-layout.css?v=5.0" rel="stylesheet">
    <link href="profile-dropdown.css?v=5.0" rel="stylesheet">
    <link href="sales_per_location.css?v=5.0" rel="stylesheet">
    <style>
        /* Remove conflicting layout styles - let fixed-layout.css handle it */

        /* Table styling improvements */
        .sales-table {
            border-collapse: collapse;
        }
        
        .sales-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        .sales-table tbody td {
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            vertical-align: middle;
            color: #495057;
        }

        .sales-table thead th {
            font-weight: 600;
            padding: 15px 20px;
            background-color: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
            color: #495057;
            border-top: none;
        }
        
        /* Ensure Bootstrap table classes don't override */
        .table thead th {
            background-color: #f8f9fa;
        }

        /* Card improvements */
        .sales-card {
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border: none;
            background: white;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .sales-card-header {
            background: #28a745;
            color: white;
            font-size: 1.5rem;
            font-weight: 600;
            padding: 20px 30px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="mobile-menu-toggle me-3 d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                    <span class="brand-text">Anihan</span>
                </a>
            </div>
            <div class="navbar-nav">
                <div class="nav-item">
                    <div class="user-avatar" onclick="toggleProfileDropdown()">
                        <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                        <i id="userAvatarIcon" class="fas fa-user"></i>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-shield-alt"></i>
                                    <span id="profileUserTitle">System Administrator</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link active d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="sales-card shadow-sm mt-4 mx-auto" style="max-width: 1200px;">
                    <div class="sales-card-header d-flex justify-content-between align-items-center">
                        <span>Sales Per Location</span>
                        <div class="search-container">
                            <div class="search-input-wrapper">
                                <i class="fas fa-search search-icon"></i>
                                <input type="text" class="form-control search-input" placeholder="Search">
                            </div>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table class="sales-table">
                            <thead>
                                <tr>
                                    <th>Store Location</th>
                                    <th>Product Name</th>
                                    <th>Quantity</th>
                                    <th>Total Sales</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Data rows will be populated here -->
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <p class="mt-2 text-muted">Loading sales data...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="sales-card-footer">
                        <div class="footer-left">
                            <span id="salesItemsCount" style="color:#495057;font-size:0.95rem;">0 to 0 items of 0</span>
                            <a href="#" style="color:#2563eb;font-size:0.95rem;margin-left:1rem;" onclick="event.preventDefault(); showAllSalesModal()">View all &gt;</a>
                        </div>
                        <div class="sales-pagination">
                            <button class="btn" onclick="changePage(-1)">&lt;</button>
                            <button class="btn active" id="currentPageBtn">1</button>
                            <button class="btn" onclick="changePage(1)">&gt;</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <!-- Add Supabase Client (required by shared-profile.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add Shared Profile System -->
    <script src="shared-profile.js"></script>
    <script>
        // Use Supabase client from shared-profile.js
        // Wait for shared-profile.js to initialize supabaseClient

        // Pagination variables
        let currentPage = 1;
        let totalSalesLocations = 0;
        const locationsPerPage = 10;
        let allGroupedSalesData = []; // Store all grouped data for pagination

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sales Per Location page loaded');
            // Small delay to ensure shared-profile.js has initialized supabaseClient
            setTimeout(() => {
                loadSalesPerLocationData();
            }, 200);
        });

        // Load sales per location data and populate table
        async function loadSalesPerLocationData() {
            try {
                console.log('üîÑ Loading sales per location data...');
                
                // Use the global supabaseClient from shared-profile.js
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('‚ùå Supabase client not available');
                    updateSalesTable([]);
                    return;
                }

                const client = window.supabaseClient || supabaseClient;

                // Get ALL product sales data (we'll handle pagination after grouping)
                const { data: salesData, error } = await client
                    .from('order_items')
                    .select(`
                        quantity,
                        orders!inner(
                            id,
                            total,
                            status
                        ),
                        my_products!inner(
                            id,
                            name,
                            category,
                            price,
                            user_id,
                            users!my_products_user_id_fkey (
                                id,
                                municipality,
                                store-owner!store-owner_user_id_fkey (
                                    store_name
                                )
                            )
                        )
                    `);

                console.log('üìà Sales data query result:', { 
                    dataCount: salesData?.length || 0, 
                    error: error,
                    sampleData: salesData?.slice(0, 3) 
                });

                if (error) {
                    console.error('‚ùå Error fetching sales data:', error);
                    updateSalesTable([]);
                    return;
                }

                if (!salesData || salesData.length === 0) {
                    console.warn('‚ö†Ô∏è No sales data found');
                    updateSalesTable([]);
                    return;
                }

                // Process and group the data by municipality (store location) and product (using same approach as price monitoring)
                const processedData = {};
                let processedCount = 0;











                    console.log('ÔøΩ Attempting direct user lookup for municipalities...');
                    
                    // Get unique user IDs from sales data
                    const userIds = [...new Set(salesData.map(item => item.orders.user_id))];
                    console.log('üë• Found unique user IDs in orders:', userIds);
                    
                    if (userIds.length > 0) {
                        const { data: users, error: usersError } = await client
                            .from('users')
                            .select('id, municipality, address, full_name')
                            .in('id', userIds);
                            
                        if (!usersError && users) {
                            users.forEach(user => {
                                const municipality = user.municipality || user.address || 'Unknown Location';
                                userMunicipalityMap[user.id] = municipality;
                                console.log(`üó∫Ô∏è Direct mapped User ${user.id} (${user.full_name}) to: ${municipality}`);
                            });
                        }
                    }

                
                salesData.forEach(item => {
                    // Get store information from the joined data (same approach as price monitoring)
                    const product = item.my_products;
                    const user = product?.users;
                    const storeOwner = user?.['store-owner']?.[0];
                    const storeName = storeOwner?.store_name || 'Unknown Store';
                    const municipality = user?.municipality || 'Unknown Location';
                    
                    console.log(`üìç Processing item - Product: ${product?.name}, Municipality: ${municipality}`);
                    
                    const productName = product?.name || 'Unknown Product';
                    const quantity = parseInt(item.quantity) || 0;
                    const productPrice = parseFloat(product?.price) || 0;
                    const itemTotal = quantity * productPrice;

                    const key = `${municipality}-${productName}`;
                    
                    if (processedData[key]) {
                        processedData[key].quantity += quantity;
                        processedData[key].totalSales += itemTotal;
                        processedData[key].orderCount += 1;
                    } else {
                        processedData[key] = {
                            municipality: municipality,
                            productName: productName,
                            category: product?.category || 'Unknown',
                            quantity: quantity,
                            totalSales: itemTotal,
                            orderCount: 1,
                            storeName: storeName
                        };
                    }
                    processedCount++;
                });

                console.log('üìä Processing complete:', { 
                    processedItems: processedCount,
                    uniqueLocationProducts: Object.keys(processedData).length,
                    sampleProcessedData: Object.values(processedData).slice(0, 3)
                });

                // Calculate total sales per municipality first
                const municipalityTotals = {};
                Object.values(processedData).forEach(item => {
                    if (!municipalityTotals[item.municipality]) {
                        municipalityTotals[item.municipality] = 0;
                    }
                    municipalityTotals[item.municipality] += item.totalSales;
                });

                // Convert to array and sort by municipality total sales (descending), then by product sales
                const salesArray = Object.values(processedData)
                    .sort((a, b) => {
                        // First sort by municipality total sales
                        const municATotalSales = municipalityTotals[a.municipality];
                        const municBTotalSales = municipalityTotals[b.municipality];
                        
                        if (municATotalSales !== municBTotalSales) {
                            return municBTotalSales - municATotalSales; // Higher total municipality sales first
                        }
                        
                        // If same municipality, sort by individual product sales
                        return b.totalSales - a.totalSales;
                    });

                console.log('‚úÖ Final sales array:', salesArray.length, 'records');
                console.log('üìã Sample records:', salesArray.slice(0, 5));
                console.log('üèÜ Municipality totals:', municipalityTotals);
                
                // Store all grouped data globally for pagination
                allGroupedSalesData = salesArray;
                totalSalesLocations = salesArray.length;
                
                // Display the current page
                displayCurrentPage();

            } catch (error) {
                console.error('üí• Error in loadSalesPerLocationData:', error);
                updateSalesTable([]);
            }
        }

        // Function to display the current page from the cached data
        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * locationsPerPage;
            const endIndex = startIndex + locationsPerPage;
            const paginatedData = allGroupedSalesData.slice(startIndex, endIndex);
            
            console.log(`üìÑ Showing page ${currentPage}: items ${startIndex + 1} to ${Math.min(endIndex, totalSalesLocations)} of ${totalSalesLocations}`);
            
            updateSalesTable(paginatedData);
        }

        // Update the sales table with data
        function updateSalesTable(salesData) {
            const tableBody = document.getElementById('salesTableBody');
            const itemsCount = document.getElementById('salesItemsCount');
            
            if (!tableBody) {
                console.error('Table body not found');
                return;
            }

            if (!salesData || salesData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-center text-muted py-4">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            No sales data available
                        </td>
                    </tr>
                `;
                if (itemsCount) itemsCount.textContent = '0 to 0 items of 0';
                return;
            }

            // Store all sales data globally for modal use
            window.allSalesData = salesData;

            // Generate table rows (pagination handled by query)
            const tableRows = salesData.map(item => `
                <tr>
                    <td>
                        <div class="location-info">
                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                            <span class="fw-semibold">${item.municipality}</span>
                        </div>
                    </td>
                    <td>
                        <div class="product-info">
                            <div class="product-name fw-semibold">${item.productName}</div>
                            <small class="text-muted">${item.category}</small>
                        </div>
                    </td>
                    <td>
                        <div class="quantity-info">
                            <span class="badge bg-success fs-6">${item.quantity}</span>
                            <small class="text-muted d-block">${item.orderCount} orders</small>
                        </div>
                    </td>
                    <td>
                        <div class="sales-amount">
                            <span class="fw-bold text-success">‚Ç±${item.totalSales.toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                        </div>
                    </td>
                </tr>
            `).join('');

            tableBody.innerHTML = tableRows;
            
            // Update items count with pagination info
            if (itemsCount) {
                const startItem = ((currentPage - 1) * locationsPerPage) + 1;
                const endItem = Math.min(currentPage * locationsPerPage, totalSalesLocations);
                itemsCount.textContent = `${startItem} to ${endItem} items of ${totalSalesLocations}`;
            }

            // Update current page button
            const currentPageBtn = document.getElementById('currentPageBtn');
            if (currentPageBtn) {
                currentPageBtn.textContent = currentPage;
            }
            
            console.log(`‚úÖ Updated table with ${salesData.length} of ${totalSalesLocations} records`);
        }

        // Function to change page
        // Function to change page
        function changePage(direction) {
            const totalPages = Math.ceil(totalSalesLocations / locationsPerPage);
            
            if (direction === 1 && currentPage < totalPages) {
                currentPage++;
                displayCurrentPage(); // Just update display, don't reload data
            } else if (direction === -1 && currentPage > 1) {
                currentPage--;
                displayCurrentPage(); // Just update display, don't reload data
            }
        }

        // Function to show all sales modal
        async function showAllSalesModal() {
            const modal = new bootstrap.Modal(document.getElementById('allSalesModal'));
            modal.show();
            
            // Fetch all sales data for the modal
            try {
                const client = window.supabaseClient || supabaseClient;
                const { data: allSalesData, error } = await client
                    .from('order_items')
                    .select(`
                        quantity,
                        orders!inner(
                            id,
                            total,
                            status
                        ),
                        my_products!inner(
                            id,
                            name,
                            category,
                            price,
                            user_id,
                            users!my_products_user_id_fkey (
                                id,
                                municipality,
                                store-owner!store-owner_user_id_fkey (
                                    store_name
                                )
                            )
                        )
                    `);
                
                if (error) {
                    console.error('Error fetching all sales:', error);
                    updateAllSalesTable([]);
                } else {
                    // Process data similar to main function - group by municipality AND product
                    const processedData = {};
                    allSalesData.forEach(item => {
                        const product = item.my_products;
                        const user = product?.users;
                        const storeOwner = user?.['store-owner']?.[0];
                        const storeName = storeOwner?.store_name || 'Unknown Store';
                        const municipality = user?.municipality || 'Unknown Location';
                        const productName = product?.name || 'Unknown Product';
                        const category = product?.category || 'Unknown';
                        const quantity = parseInt(item.quantity) || 0;
                        const price = parseFloat(product?.price) || 0;
                        const totalAmount = quantity * price;
                        
                        const key = `${municipality}-${productName}`;
                        
                        if (processedData[key]) {
                            processedData[key].quantity += quantity;
                            processedData[key].totalSales += totalAmount;
                            processedData[key].orderCount += 1;
                        } else {
                            processedData[key] = {
                                municipality: municipality,
                                productName: productName,
                                category: category,
                                quantity: quantity,
                                totalSales: totalAmount,
                                orderCount: 1,
                                storeName: storeName
                            };
                        }
                    });
                    
                    // Calculate total sales per municipality first
                    const municipalityTotals = {};
                    Object.values(processedData).forEach(item => {
                        if (!municipalityTotals[item.municipality]) {
                            municipalityTotals[item.municipality] = 0;
                        }
                        municipalityTotals[item.municipality] += item.totalSales;
                    });

                    // Sort by municipality total sales (descending), then by product sales
                    const salesData = Object.values(processedData)
                        .sort((a, b) => {
                            // First sort by municipality total sales
                            const municATotalSales = municipalityTotals[a.municipality];
                            const municBTotalSales = municipalityTotals[b.municipality];
                            
                            if (municATotalSales !== municBTotalSales) {
                                return municBTotalSales - municATotalSales; // Higher total municipality sales first
                            }
                            
                            // If same municipality, sort by individual product sales
                            return b.totalSales - a.totalSales;
                        });
                    
                    console.log('üèÜ Municipality totals (modal):', municipalityTotals);
                    updateAllSalesTable(salesData);
                }
            } catch (error) {
                console.error('Error in showAllSalesModal:', error);
                updateAllSalesTable([]);
            }
        }

        // Function to update the all sales modal table
        function updateAllSalesTable(salesData) {
            const tableBody = document.getElementById('allSalesTableBody');
            const countElement = document.getElementById('allSalesCount');
            
            if (!tableBody) {
                console.error('‚ùå All sales table body not found');
                return;
            }

            if (!salesData || salesData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-4">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            No sales records found
                        </td>
                    </tr>
                `;
                if (countElement) countElement.textContent = '0 sales records found';
                return;
            }

            // Generate all table rows
            tableBody.innerHTML = salesData.map((sale, index) => {
                return `
                    <tr>
                        <td>
                            <div class="location-info">
                                <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                <span class="fw-semibold">${escapeHtml(sale.municipality || 'Unknown Location')}</span>
                            </div>
                        </td>
                        <td>
                            <div class="product-name fw-semibold">${escapeHtml(sale.productName || 'Unknown Product')}</div>
                        </td>
                        <td>
                            <span class="badge bg-secondary">${escapeHtml(sale.category || 'Unknown')}</span>
                        </td>
                        <td>
                            <span class="badge bg-success fs-6">${escapeHtml(sale.quantity || '0')}</span>
                        </td>
                        <td>
                            <span class="fw-bold text-success">‚Ç±${(sale.totalSales || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                        </td>
                        <td>
                            <span class="text-muted">${escapeHtml(sale.orderCount || '0')} orders</span>
                        </td>
                    </tr>
                `;
            }).join('');

            // Update count
            if (countElement) {
                countElement.textContent = `${salesData.length} sales record${salesData.length !== 1 ? 's' : ''} found`;
            }

            // Add search functionality
            const searchInput = document.getElementById('salesSearchInput');
            if (searchInput) {
                searchInput.oninput = function() {
                    const searchTerm = this.value.toLowerCase();
                    const filteredData = salesData.filter(sale => 
                        (sale.municipality || '').toLowerCase().includes(searchTerm) ||
                        (sale.productName || '').toLowerCase().includes(searchTerm) ||
                        (sale.category || '').toLowerCase().includes(searchTerm)
                    );
                    
                    if (filteredData.length === 0) {
                        tableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted p-4">
                                    <i class="fas fa-search me-2"></i>
                                    No sales records found matching "${searchTerm}"
                                </td>
                            </tr>
                        `;
                    } else {
                        tableBody.innerHTML = filteredData.map((sale, index) => {
                            return `
                                <tr>
                                    <td>
                                        <div class="location-info">
                                            <i class="fas fa-map-marker-alt me-2 text-primary"></i>
                                            <span class="fw-semibold">${escapeHtml(sale.municipality || 'Unknown Location')}</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="product-name fw-semibold">${escapeHtml(sale.productName || 'Unknown Product')}</div>
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">${escapeHtml(sale.category || 'Unknown')}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-success fs-6">${escapeHtml(sale.quantity || '0')}</span>
                                    </td>
                                    <td>
                                        <span class="fw-bold text-success">‚Ç±${(sale.totalSales || 0).toLocaleString('en-PH', {minimumFractionDigits: 2})}</span>
                                    </td>
                                    <td>
                                        <span class="text-muted">${escapeHtml(sale.orderCount || '0')} orders</span>
                                    </td>
                                </tr>
                            `;
                        }).join('');
                    }
                    
                    if (countElement) {
                        countElement.textContent = `${filteredData.length} sales record${filteredData.length !== 1 ? 's' : ''} found`;
                    }
                };
            }
        }

        // Escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Search functionality
        const searchInput = document.querySelector('.search-input');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const tableRows = document.querySelectorAll('.sales-table tbody tr');
                
                tableRows.forEach(row => {
                    const text = row.textContent.toLowerCase();
                    if (text.includes(searchTerm)) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            });
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Mobile sidebar functions - CSS only, no duplicate positioning
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                // Add navigation content when opening
                if (!sidebar.classList.contains('mobile-open')) {
                    const mobileMenuContent = `
                        <div class="nav flex-column nav-pills">
                            <a class="nav-link" href="dashboard_super_admin.html">Dashboard</a>
                            <a class="nav-link" href="admin_accounts.html">Admin Accounts</a>
                            <a class="nav-link" href="for_approval.html">For Approval</a>
                            <a class="nav-link" href="approved_application.html">Approved Applications</a>
                            <a class="nav-link" href="add_voucher.html">Add Voucher</a>
                            <a class="nav-link" href="voucher_records.html">Voucher Records</a>
                            <a class="nav-link" href="inventory_records.html">Inventory Records</a>
                            <a class="nav-link" href="price_monitoring.html">Price Monitoring</a>
                            <a class="nav-link" href="in_demand_products.html">In Demand Products</a>
                            <a class="nav-link active" href="sales_per_location.html">Sales Per Location</a>
                            <a class="nav-link" href="violation.html">Violation</a>
                        </div>
                    `;
                    sidebar.innerHTML = mobileMenuContent;
                }
                
                // Just toggle the CSS class - let CSS handle all positioning
                sidebar.classList.toggle('mobile-open');
            }
            
            if (overlay) {
                overlay.classList.toggle('active');
            }
            
            document.body.style.overflow = sidebar && sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) sidebar.classList.remove('mobile-open');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>

    <!-- All Sales Modal -->
    <div class="modal fade" id="allSalesModal" tabindex="-1" aria-labelledby="allSalesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allSalesModalLabel">All Sales Per Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="salesSearchInput" placeholder="Search by location, product name, category...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Store Location</th>
                                    <th>Product Name</th>
                                    <th>Category</th>
                                    <th>Quantity</th>
                                    <th>Total Sales</th>
                                    <th>Orders Count</th>
                                </tr>
                            </thead>
                            <tbody id="allSalesTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading sales data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allSalesCount">0 sales records found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
