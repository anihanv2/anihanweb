<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Violation - Anihan</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=5.0" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.0">
    <link href="fixed-layout.css?v=5.1" rel="stylesheet">
    <link href="profile-dropdown.css?v=5.1" rel="stylesheet">
    <link rel="stylesheet" href="violation.css?v=5.1">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="mobile-menu-toggle me-3 d-md-none" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                    <span class="brand-text">Anihan</span>
                </a>
            </div>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-shield-alt"></i>
                            <span id="profileUserTitle">System Administrator</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                    <nav class="nav flex-column">
                        <a class="nav-link" href="dashboard_super_admin.html">
                            <i class="fas fa-tachometer-alt me-2"></i>
                            Dashboard
                        </a>
                        <a class="nav-link" href="admin_accounts.html">
                            <i class="fas fa-user-shield me-2"></i>
                            Admin Accounts
                        </a>
                        <a class="nav-link" href="for_approval.html">
                            <i class="fas fa-clock me-2"></i>
                            For Approval
                        </a>
                        <a class="nav-link" href="approved_application.html">
                            <i class="fas fa-check-circle me-2"></i>
                            Approved Application
                        </a>
                        <a class="nav-link" href="inventory_records.html">
                            <i class="fas fa-boxes me-2"></i>
                            Inventory Records
                        </a>
                        <a class="nav-link" href="price_monitoring.html">
                            <i class="fas fa-dollar-sign me-2"></i>
                            Price Monitoring
                        </a>
                        <a class="nav-link" href="in_demand_products.html">
                            <i class="fas fa-chart-line me-2"></i>
                            In Demand Products
                        </a>
                        <a class="nav-link" href="sales_per_location.html">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Sales Per Location
                        </a>
                        
                        <!-- Voucher Dropdown -->
                        <div class="nav-dropdown">
                            <a class="nav-link" href="#" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" aria-expanded="false">
                                <i class="fas fa-gift me-2"></i>
                                Voucher
                                <i class="fas fa-chevron-down dropdown-icon ms-auto"></i>
                            </a>
                            <div class="collapse submenu" id="voucherSubmenu">
                                <a class="nav-link submenu-link" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                        
                        <a class="nav-link active" href="violation.html">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Violation
                        </a>
                    </nav>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <div class="main-content">
                    <div class="card violation-card">
                        <div class="violation-card-header">
                            <h4 class="mb-0">Store Violations</h4>
                            <div class="search-container">
                                <div class="search-input-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                    <input type="text" class="form-control search-input" placeholder="Search violations...">
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table violation-table">
                                <thead>
                                    <tr>
                                        <th>Store Name</th>
                                        <th>Violation Type</th>
                                        <th>Date of Violation</th>
                                        <th>Status</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="violationsTableBody">
                                    <tr>
                                        <td colspan="5" class="text-center">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading violations data...
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="table-footer">
                            <div class="table-info-section">
                                <span class="table-info">Showing 5 of 25 violations</span>
                                <a href="#" class="view-all" onclick="showAllViolationsModal()">View all ></a>
                            </div>
                            <div class="pagination-controls">
                                <button class="btn btn-sm btn-outline-secondary">&lt;</button>
                                <button class="btn btn-sm btn-success">1</button>
                                <button class="btn btn-sm btn-outline-secondary">&gt;</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Add Supabase Client (required by shared-profile.js) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add Shared Profile System -->
    <script src="shared-profile.js"></script>
    <script>
        /*
        =================================================================
        DATABASE SCHEMA: store_reports table
        =================================================================
        - id: uuid (primary key)
        - store_id: uuid (foreign key to store-owner table)
        - store_name: text (store name)
        - report_description: text (violation description)
        - reported_at: timestamp (auto-generated)
        - status: text (pending/resolved/dismissed)
        - date: date (violation date)
        =================================================================
        */
        
        // Global variables to store violations data
        let allViolationsData = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Function to load violations data from store_reports database
        async function loadViolationsData() {
            console.log('Loading violations data from store_reports...');
            try {
                // Check if supabaseClient is available from shared-profile.js
                if (!window.supabaseClient && !supabaseClient) {
                    console.error('Supabase client not available');
                    showErrorMessage('Database connection not available');
                    return;
                }

                // Use the global supabaseClient
                const client = window.supabaseClient || supabaseClient;

                // Show loading state
                showLoadingState();

                // Fetch data from store_reports table
                const { data: reports, error } = await client
                    .from('store_reports')
                    .select('*')
                    .order('date', { ascending: false }); // Sort by date, newest first

                console.log('Store reports data:', { reports, error });

                if (error) {
                    console.error('Error fetching store reports:', error);
                    showErrorMessage(`Database error: ${error.message}`);
                    return;
                }

                if (!reports || reports.length === 0) {
                    console.log('No violation reports found');
                    showNoDataMessage();
                    return;
                }

                allViolationsData = reports;
                displayViolationsData(reports);
                updatePaginationInfo();

            } catch (error) {
                console.error('Error loading violations data:', error);
                showErrorMessage(`Failed to load violations: ${error.message}`);
            }
        }

        // Function to display violations data in the table
        function displayViolationsData(reports) {
            const tableBody = document.getElementById('violationsTableBody');
            
            if (!reports || reports.length === 0) {
                showNoDataMessage();
                return;
            }

            // Calculate pagination
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageReports = reports.slice(startIndex, endIndex);

            const tableRows = pageReports.map(report => {
                // Format the date
                const formattedDate = formatDate(report.date);
                
                // Determine status based on report data (you can customize this logic)
                const status = determineStatus(report);
                
                return `
                    <tr data-report-id="${report.id}">
                        <td>
                            <div class="store-name">${escapeHtml(report.store_name || 'Unknown Store')}</div>
                        </td>
                        <td>
                            <div class="violation-type">${escapeHtml(report.report_description || 'No description')}</div>
                        </td>
                        <td>
                            <div class="violation-date">${formattedDate}</div>
                        </td>
                        <td>
                            <span class="badge ${getStatusBadgeClass(status)}">${status}</span>
                        </td>
                        <td>
                            <button class="btn btn-success btn-sm me-1 resolve-btn" ${status === 'Resolved' || status === 'Dismissed' ? 'disabled' : ''} onclick="resolveViolation('${report.id}')">
                                <i class="fas fa-check"></i> Resolved
                            </button>
                            <button class="btn btn-danger btn-sm dismiss-btn" ${status === 'Dismissed' ? 'disabled' : ''} onclick="dismissViolation('${report.id}')">
                                <i class="fas fa-times"></i> Dismiss
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            tableBody.innerHTML = tableRows;
        }

        // Function to format date
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) return dateString; // Return original if invalid
                
                // Format as MM-DD-YY
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const year = String(date.getFullYear()).slice(-2);
                
                return `${month}-${day}-${year}`;
            } catch (error) {
                console.error('Error formatting date:', error);
                return dateString;
            }
        }

        // Function to determine status (customize based on your data structure)
        function determineStatus(report) {
            // Check if there's a status field in the report
            if (report.status) {
                return capitalizeFirst(report.status);
            }
            
            // Default logic - you can customize this based on your requirements
            if (report.resolved === true || report.is_resolved === true) {
                return 'Resolved';
            } else if (report.dismissed === true || report.is_dismissed === true) {
                return 'Dismissed';
            } else {
                return 'Pending';
            }
        }

        // Function to get status badge CSS class
        function getStatusBadgeClass(status) {
            switch (status.toLowerCase()) {
                case 'resolved':
                    return 'bg-success';
                case 'dismissed':
                    return 'bg-danger';
                case 'pending':
                default:
                    return 'bg-warning text-dark';
            }
        }

        // Helper function to capitalize first letter
        function capitalizeFirst(str) {
            if (!str) return '';
            return str.charAt(0).toUpperCase() + str.slice(1).toLowerCase();
        }

        // Function to show loading state
        function showLoadingState() {
            const tableBody = document.getElementById('violationsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                        Loading violations data...
                    </td>
                </tr>
            `;
        }

        // Function to show error message
        function showErrorMessage(message) {
            const tableBody = document.getElementById('violationsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${escapeHtml(message)}
                    </td>
                </tr>
            `;
        }

        // Function to show no data message
        function showNoDataMessage() {
            const tableBody = document.getElementById('violationsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center text-muted">
                        <i class="fas fa-clipboard-list me-2"></i>
                        No violation reports found
                    </td>
                </tr>
            `;
        }

        // Function to escape HTML to prevent XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.toString().replace(/[&<>"']/g, m => map[m]);
        }

        // Function to resolve violation
        async function resolveViolation(reportId) {
            try {
                console.log('Resolving violation:', reportId);
                
                const client = window.supabaseClient || supabaseClient;
                
                // Show loading state on the button
                const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
                const resolveBtn = row?.querySelector('.resolve-btn');
                if (resolveBtn) {
                    resolveBtn.disabled = true;
                    resolveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Resolving...';
                }
                
                // Update the report status to resolved in database
                const { data, error } = await client
                    .from('store_reports')
                    .update({ 
                        status: 'resolved'
                    })
                    .eq('id', reportId)
                    .select(); // Get the updated data back

                if (error) {
                    console.error('Error resolving violation:', error);
                    alert(`Failed to resolve violation: ${error.message}`);
                    
                    // Restore button state
                    if (resolveBtn) {
                        resolveBtn.disabled = false;
                        resolveBtn.innerHTML = '<i class="fas fa-check"></i> Resolved';
                    }
                    return;
                }

                console.log('Database update successful:', data);

                // Update local data array
                const reportIndex = allViolationsData.findIndex(r => r.id == reportId);
                if (reportIndex !== -1) {
                    allViolationsData[reportIndex] = { 
                        ...allViolationsData[reportIndex], 
                        status: 'resolved'
                    };
                }

                // Update the UI
                if (row) {
                    const statusBadge = row.querySelector('.badge');
                    statusBadge.className = 'badge bg-success';
                    statusBadge.textContent = 'Resolved';
                    
                    // Update button state
                    if (resolveBtn) {
                        resolveBtn.disabled = true;
                        resolveBtn.innerHTML = '<i class="fas fa-check"></i> Resolved';
                    }
                }

                console.log('Violation resolved successfully');
                
                // Show success message
                showSuccessMessage('Violation has been resolved successfully!');
                
            } catch (error) {
                console.error('Error resolving violation:', error);
                alert(`Failed to resolve violation: ${error.message}`);
                
                // Restore button state
                const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
                const resolveBtn = row?.querySelector('.resolve-btn');
                if (resolveBtn) {
                    resolveBtn.disabled = false;
                    resolveBtn.innerHTML = '<i class="fas fa-check"></i> Resolved';
                }
            }
        }

        // Function to dismiss violation
        async function dismissViolation(reportId) {
            if (!confirm('Are you sure you want to dismiss this violation? This action will mark the violation as dismissed.')) {
                return;
            }

            try {
                console.log('Dismissing violation:', reportId);
                
                const client = window.supabaseClient || supabaseClient;
                
                // Show loading state on the button
                const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
                const dismissBtn = row?.querySelector('.dismiss-btn');
                if (dismissBtn) {
                    dismissBtn.disabled = true;
                    dismissBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Dismissing...';
                }
                
                // Update the report status to dismissed in database
                const { data, error } = await client
                    .from('store_reports')
                    .update({ 
                        status: 'dismissed'
                    })
                    .eq('id', reportId)
                    .select(); // Get the updated data back

                if (error) {
                    console.error('Error dismissing violation:', error);
                    alert(`Failed to dismiss violation: ${error.message}`);
                    
                    // Restore button state
                    if (dismissBtn) {
                        dismissBtn.disabled = false;
                        dismissBtn.innerHTML = '<i class="fas fa-times"></i> Dismiss';
                    }
                    return;
                }

                console.log('Database update successful:', data);

                // Update local data array
                const reportIndex = allViolationsData.findIndex(r => r.id == reportId);
                if (reportIndex !== -1) {
                    allViolationsData[reportIndex] = { 
                        ...allViolationsData[reportIndex], 
                        status: 'dismissed'
                    };
                }

                // Update the UI
                if (row) {
                    const statusBadge = row.querySelector('.badge');
                    statusBadge.className = 'badge bg-danger';
                    statusBadge.textContent = 'Dismissed';
                    
                    const resolveBtn = row.querySelector('.resolve-btn');
                    const dismissBtn = row.querySelector('.dismiss-btn');
                    
                    // Disable dismiss button
                    if (dismissBtn) {
                        dismissBtn.disabled = true;
                        dismissBtn.innerHTML = '<i class="fas fa-times"></i> Dismiss';
                    }
                }

                console.log('Violation dismissed successfully');
                
                // Show success message
                showSuccessMessage('Violation has been dismissed successfully!');
                
            } catch (error) {
                console.error('Error dismissing violation:', error);
                alert(`Failed to dismiss violation: ${error.message}`);
                
                // Restore button state
                const row = document.querySelector(`tr[data-report-id="${reportId}"]`);
                const dismissBtn = row?.querySelector('.dismiss-btn');
                if (dismissBtn) {
                    dismissBtn.disabled = false;
                    dismissBtn.innerHTML = '<i class="fas fa-times"></i> Dismiss';
                }
            }
        }

        // Function to show success message
        function showSuccessMessage(message) {
            // Create success alert element
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${escapeHtml(message)}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            // Add to document
            document.body.appendChild(alertDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv && alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }

        // Function to update pagination info
        function updatePaginationInfo() {
            const totalReports = allViolationsData.length;
            const startItem = totalReports === 0 ? 0 : (currentPage - 1) * itemsPerPage + 1;
            const endItem = Math.min(currentPage * itemsPerPage, totalReports);
            
            const infoElement = document.querySelector('.table-info');
            if (infoElement) {
                infoElement.textContent = `Showing ${startItem} to ${endItem} of ${totalReports} violations`;
            }
        }

        // Search functionality
        function setupSearchFunctionality() {
            const searchInput = document.querySelector('.search-input');
            if (searchInput) {
                searchInput.addEventListener('input', function(e) {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    
                    if (searchTerm === '') {
                        displayViolationsData(allViolationsData);
                    } else {
                        const filteredReports = allViolationsData.filter(report => {
                            const storeName = (report.store_name || '').toLowerCase();
                            const violationType = (report.report_description || '').toLowerCase();
                            const date = formatDate(report.date).toLowerCase();
                            
                            return storeName.includes(searchTerm) || 
                                   violationType.includes(searchTerm) || 
                                   date.includes(searchTerm);
                        });
                        
                        displayViolationsData(filteredReports);
                    }
                });
            }
        }

        // Function to show all violations modal
        function showAllViolationsModal() {
            const modal = new bootstrap.Modal(document.getElementById('allViolationsModal'));
            modal.show();
            
            // Load all data into modal
            if (allViolationsData && allViolationsData.length > 0) {
                updateAllViolationsTable(allViolationsData);
            } else {
                updateAllViolationsTable([]);
            }
            
            // Setup search functionality
            setupViolationSearch();
        }

        // Function to update the all violations modal table
        function updateAllViolationsTable(violationsData) {
            const tableBody = document.getElementById('allViolationsTableBody');
            const countElement = document.getElementById('allViolationsCount');
            
            if (!tableBody) {
                console.error('❌ All violations table body not found');
                return;
            }

            if (!violationsData || violationsData.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center text-muted p-4">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            No violation records found
                        </td>
                    </tr>
                `;
                if (countElement) countElement.textContent = '0 violations found';
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            // Populate table with violation data
            violationsData.forEach(report => {
                const row = document.createElement('tr');
                
                // Determine status badge class
                let statusBadge = '';
                switch (report.status?.toLowerCase()) {
                    case 'resolved':
                        statusBadge = '<span class="badge bg-success">Resolved</span>';
                        break;
                    case 'dismissed':
                        statusBadge = '<span class="badge bg-secondary">Dismissed</span>';
                        break;
                    case 'pending':
                    default:
                        statusBadge = '<span class="badge bg-warning">Pending</span>';
                        break;
                }
                
                row.innerHTML = `
                    <td>${escapeHtml(report.id)}</td>
                    <td>${escapeHtml(report.store_name || 'N/A')}</td>
                    <td>${escapeHtml(report.report_description || 'N/A')}</td>
                    <td>${formatDate(report.date)}</td>
                    <td>${statusBadge}</td>
                    <td>
                        ${report.status?.toLowerCase() === 'pending' ? 
                            `<button class="btn btn-sm btn-success me-1" onclick="resolveViolation(${report.id})">
                                <i class="fas fa-check"></i> Resolve
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="dismissViolation(${report.id})">
                                <i class="fas fa-times"></i> Dismiss
                            </button>` : 
                            '<span class="text-muted">No actions available</span>'
                        }
                    </td>
                `;
                tableBody.appendChild(row);
            });

            // Update count
            if (countElement) {
                countElement.textContent = `${violationsData.length} violations found`;
            }

            console.log('✅ All violations modal table updated with', violationsData.length, 'violations');
        }

        // Setup violation search functionality in modal
        function setupViolationSearch() {
            const searchInput = document.getElementById('violationSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!allViolationsData) return;

                const filteredViolations = allViolationsData.filter(report => {
                    const storeName = (report.store_name || '').toLowerCase();
                    const violationType = (report.report_description || '').toLowerCase();
                    const status = (report.status || '').toLowerCase();
                    const date = formatDate(report.date).toLowerCase();
                    
                    return storeName.includes(searchTerm) || 
                           violationType.includes(searchTerm) || 
                           status.includes(searchTerm) ||
                           date.includes(searchTerm);
                });

                updateAllViolationsTable(filteredViolations);
            });
        }

        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Violations page loaded');
            
            // Wait for shared profile system to initialize
            const checkSharedProfile = () => {
                if (typeof supabaseClient !== 'undefined' || window.supabaseClient) {
                    console.log('Supabase client available, loading violations data...');
                    loadViolationsData();
                    setupSearchFunctionality();
                } else {
                    // Wait a bit more for shared-profile.js to load
                    setTimeout(checkSharedProfile, 100);
                }
            };
            
            checkSharedProfile();
        });

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });
    </script>
    <script>
        // Handle dropdown functionality
        document.addEventListener('DOMContentLoaded', function() {
            const dropdownToggle = document.querySelector('[data-bs-toggle="collapse"]');
            const dropdownIcon = dropdownToggle.querySelector('.dropdown-icon');
            const submenu = document.querySelector('#voucherSubmenu');
            
            if (submenu) {
                submenu.addEventListener('show.bs.collapse', function() {
                    dropdownIcon.style.transform = 'rotate(180deg)';
                });
                
                submenu.addEventListener('hide.bs.collapse', function() {
                    dropdownIcon.style.transform = 'rotate(0deg)';
                });
            }
        });

        // Mobile sidebar functions - CSS only, no duplicate positioning
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                // Add navigation content when opening
                if (!sidebar.classList.contains('mobile-open')) {
                    const mobileMenuContent = `
                        <div class="nav flex-column nav-pills">
                            <a class="nav-link" href="dashboard_super_admin.html">Dashboard</a>
                            <a class="nav-link" href="admin_accounts.html">Admin Accounts</a>
                            <a class="nav-link" href="for_approval.html">For Approval</a>
                            <a class="nav-link" href="approved_application.html">Approved Applications</a>
                            <a class="nav-link" href="add_voucher.html">Add Voucher</a>
                            <a class="nav-link" href="voucher_records.html">Voucher Records</a>
                            <a class="nav-link" href="inventory_records.html">Inventory Records</a>
                            <a class="nav-link" href="price_monitoring.html">Price Monitoring</a>
                            <a class="nav-link" href="in_demand_products.html">In Demand Products</a>
                            <a class="nav-link" href="sales_per_location.html">Sales Per Location</a>
                            <a class="nav-link active" href="violation.html">Violation</a>
                        </div>
                    `;
                    sidebar.innerHTML = mobileMenuContent;
                }
                
                // Just toggle the CSS class - let CSS handle all positioning
                sidebar.classList.toggle('mobile-open');
            }
            
            if (overlay) {
                overlay.classList.toggle('active');
            }
            
            document.body.style.overflow = sidebar && sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) sidebar.classList.remove('mobile-open');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }
    </script>

    <!-- All Violations Modal -->
    <div class="modal fade" id="allViolationsModal" tabindex="-1" aria-labelledby="allViolationsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allViolationsModalLabel">All Violations</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="violationSearchInput" placeholder="Search by store name, violation type, status...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Store Name</th>
                                    <th>Violation Type</th>
                                    <th>Date Reported</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="allViolationsTableBody">
                                <tr>
                                    <td colspan="6" class="text-center">Loading violations...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allViolationsCount">0 violations found</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
