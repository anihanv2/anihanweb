<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anihan Dashboard</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="fixed-layout.css" rel="stylesheet">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link href="dashboard_super_admin.css" rel="stylesheet">
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-shield-alt"></i>
                            <span id="profileUserTitle">System Administrator</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link active d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card stats-users">
                            <div class="stats-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="activeUsersCount">Loading...</div>
                                <div class="stats-label">Active Users</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card stats-products">
                            <div class="stats-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="availableProductsCount">Loading...</div>
                                <div class="stats-label">Available</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card stats-farmers">
                            <div class="stats-icon">
                                <i class="fas fa-tractor"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                <div class="stats-label">Active Farmers</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Cards Row 1 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Sales Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="salesChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Stocks Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 100px;">
                                        <option value="category">Category</option>
                                        <option value="status">Status</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="stocksChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Cards Row 2 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Soil Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                        <option value="type">Soil Type</option>
                                        <option value="region">Region</option>
                                        <option value="season">Season</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="soilChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Hectare Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 100px;">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <canvas id="hectareChart" width="400" height="200" style="display: block; max-width: 100%; height: 200px;"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Municipality Performance -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="analytics-card municipality-card">
                            <div class="card-header municipality-header d-flex justify-content-between align-items-center">
                                <h5>Top Performing Municipality in terms of Sales</h5>
                                <div class="chart-controls">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('municipality', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('municipality', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('municipality', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('municipality', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="municipality-chart">
                                    <div class="municipality-item">
                                        <span class="municipality-name">Tanauan</span>
                                        <div class="municipality-bar">
                                            <div class="municipality-progress" style="width: 90%"></div>
                                        </div>
                                    </div>
                                    <div class="municipality-item">
                                        <span class="municipality-name">Lipa</span>
                                        <div class="municipality-bar">
                                            <div class="municipality-progress" style="width: 75%"></div>
                                        </div>
                                    </div>
                                    <div class="municipality-item">
                                        <span class="municipality-name">Padre Garcia</span>
                                        <div class="municipality-bar">
                                            <div class="municipality-progress" style="width: 60%"></div>
                                        </div>
                                    </div>
                                    <div class="municipality-item">
                                        <span class="municipality-name">Talisay</span>
                                        <div class="municipality-bar">
                                            <div class="municipality-progress" style="width: 45%"></div>
                                        </div>
                                    </div>
                                    <div class="municipality-item">
                                        <span class="municipality-name">Nasugbu</span>
                                        <div class="municipality-bar">
                                            <div class="municipality-progress" style="width: 30%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="municipality-scale">
                                    <span>0</span>
                                    <span>5000</span>
                                    <span>10000</span>
                                    <span>15000</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="analytics-card users-card">
                            <div class="card-header users-header">
                                <h5>Users</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Contact Number</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Pluto D. Espijo</td>
                                                <td>Pluto@Gmail.com</td>
                                                <td>09455678945</td>
                                            </tr>
                                            <tr>
                                                <td>Pluto D. Espijo</td>
                                                <td>Pluto@Gmail.com</td>
                                                <td>09455678945</td>
                                            </tr>
                                            <tr>
                                                <td>Pluto D. Espijo</td>
                                                <td>Pluto@Gmail.com</td>
                                                <td>09455678945</td>
                                            </tr>
                                            <tr>
                                                <td>Pluto D. Espijo</td>
                                                <td>Pluto@Gmail.com</td>
                                                <td>09455678945</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="table-footer">
                                    <div class="table-info-section">
                                        <span class="table-info">1 to 4 items of 4</span>
                                        <a href="#" class="view-all">View all ></a>
                                    </div>
                                    <div class="pagination-controls">
                                        <button class="btn btn-sm btn-outline-secondary">&lt;</button>
                                        <button class="btn btn-sm btn-success">1</button>
                                        <button class="btn btn-sm btn-outline-secondary">&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add CryptoJS for MD5 hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ontuivohwjfkxjwrjnot.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9udHVpdm9od2pma3hqd3Jqbm90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2Njg3MTAsImV4cCI6MjA3MDI0NDcxMH0.jGQhshEtfnABK8xNF98WxB10c66vIkTzAoLrhxbeQwE'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Current user ID for tracking
        window.currentUserId = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded, initializing...');
            console.log('Supabase client available:', !!supabaseClient);
            console.log('Profile elements exist:', {
                profileUserName: !!document.getElementById('profileUserName'),
                profileUserEmail: !!document.getElementById('profileUserEmail'),
                profileUserRole: !!document.getElementById('profileUserRole'),
                userAvatarImage: !!document.getElementById('userAvatarImage'),
                userAvatarIcon: !!document.getElementById('userAvatarIcon')
            });
            
            // Small delay to ensure all elements are loaded
            setTimeout(() => {
                loadCurrentUserProfile();
                loadActiveUsersCount();
                loadActiveFarmersCount();
                loadAvailableProductsCount();
            }, 100);
        });

        // Profile loading functions
        async function loadCurrentUserProfile() {
            try {
                console.log('=== LOADING CURRENT USER PROFILE ===');
                
                // Get current user from session storage (set during login)
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('Session storage user:', currentUser);
                
                if (!currentUser.id || currentUser.id === 'fallback') {
                    console.log('No valid logged-in user found in session, checking database...');
                    // Check if there are any real users in the database
                    await loadFirstUserForTesting();
                    return;
                }
                
                console.log('Found logged-in user with ID:', currentUser.id);
                window.currentUserId = currentUser.id;
                
                // Fetch the actual user data from database using their ID
                try {
                    const { data: userData, error } = await supabaseClient
                        .from('admin_accounts')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error) {
                        console.error('Database error fetching user:', error);
                        // Try to load any available user from database
                        console.log('Trying to load any available user from database...');
                        await loadFirstUserForTesting();
                        return;
                    }
                    
                    if (userData) {
                        console.log('Logged-in user data from database:', userData);
                        
                        // Update session with fresh data
                        const userSession = {
                            id: userData.id,
                            name: userData.name,
                            email: userData.email,
                            userType: userData.user_type,
                            image_url: userData.image_url
                        };
                        sessionStorage.setItem('currentUser', JSON.stringify(userSession));
                        
                        // Update profile display with logged-in user's data
                        updateProfileDisplay({
                            name: userData.name,
                            email: userData.email,
                            user_type: userData.user_type,
                            image_url: userData.image_url
                        });
                    } else {
                        console.log('No user data found for ID:', currentUser.id);
                        updateProfileDisplay(currentUser);
                    }
                    
                } catch (dbError) {
                    console.error('Database connection error:', dbError);
                    console.log('Database connection failed, trying to load any available user...');
                    await loadFirstUserForTesting();
                }
                
            } catch (error) {
                console.error('Error in loadCurrentUserProfile:', error);
                await loadFirstUserForTesting();
            }
        }

        // Fallback function to load any user for testing
        async function loadFirstUserForTesting() {
            try {
                console.log('=== LOADING FIRST USER FOR TESTING ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available, using fallback data');
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                    return;
                }
                
                const { data: users, error } = await supabaseClient
                    .from('admin_accounts')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('Database error in loadFirstUserForTesting:', error);
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                    return;
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    console.log('Using first user from database:', user);
                    
                    // Store this user as fallback in session
                    const userSession = {
                        id: 'fallback',
                        name: user.name,
                        email: user.email,
                        userType: user.user_type,
                        image_url: user.image_url
                    };
                    sessionStorage.setItem('currentUser', JSON.stringify(userSession));
                    
                    updateProfileDisplay({
                        name: user.name,
                        email: user.email,
                        user_type: user.user_type,
                        image_url: user.image_url
                    });
                } else {
                    console.log('No users in database, using default');
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                }
                
            } catch (error) {
                console.error('Error in loadFirstUserForTesting:', error);
                updateProfileDisplay({
                    name: 'Administrator',
                    email: 'admin@anihan.gov.ph',
                    user_type: 'SUPER ADMIN',
                    image_url: null
                });
            }
        }

        function updateProfileDisplay(userData) {
            console.log('=== UPDATING PROFILE DISPLAY ===');
            console.log('Updating profile display with data:', userData);
            
            // Update profile name
            const profileName = document.getElementById('profileUserName');
            if (profileName) {
                const displayName = userData.name || 'Administrator';
                profileName.textContent = displayName;
                console.log('✅ Updated profile name to:', displayName);
            }
            
            // Update profile email
            const profileEmail = document.getElementById('profileUserEmail');
            if (profileEmail) {
                const displayEmail = userData.email || 'admin@anihan.gov.ph';
                profileEmail.textContent = displayEmail;
                console.log('✅ Updated profile email to:', displayEmail);
            }
            
            // Update profile role
            const profileRole = document.getElementById('profileUserRole');
            if (profileRole) {
                const displayRole = userData.user_type || userData.userType || 'ADMIN';
                profileRole.textContent = displayRole;
                console.log('✅ Updated profile role to:', displayRole);
            }
            
            // Update profile title based on role
            const profileTitle = document.getElementById('profileUserTitle');
            if (profileTitle) {
                const userRole = userData.user_type || userData.userType || 'ADMIN';
                if (userRole === 'SUPER ADMIN') {
                    profileTitle.textContent = 'System Administrator';
                } else if (userRole === 'SUB ADMIN') {
                    profileTitle.textContent = 'Municipal Administrator';
                } else {
                    profileTitle.textContent = 'Administrator';
                }
                console.log('Updated profile title for role:', userRole);
            }
            
            // Update profile images
            console.log('=== PROCESSING PROFILE IMAGE ===');
            console.log('Raw image URL from database:', userData.image_url);
            
            if (userData.image_url && userData.image_url.trim() !== '' && userData.image_url !== 'null') {
                console.log('✅ Profile image found - processing...');
                
                // Clean up the image URL
                let cleanImageUrl = userData.image_url.trim();
                if (cleanImageUrl.startsWith('"') && cleanImageUrl.endsWith('"')) {
                    cleanImageUrl = cleanImageUrl.slice(1, -1);
                }
                
                // Get image elements
                const userAvatarImage = document.getElementById('userAvatarImage');
                const userAvatarIcon = document.getElementById('userAvatarIcon');
                const profileAvatarImage = document.getElementById('profileAvatarImage');
                const profileAvatarIcon = document.getElementById('profileAvatarIcon');
                
                // Update main avatar (in navbar)
                if (userAvatarImage && userAvatarIcon) {
                    userAvatarImage.src = cleanImageUrl;
                    userAvatarImage.style.display = 'block';
                    userAvatarIcon.style.display = 'none';
                    
                    userAvatarImage.onerror = function() {
                        console.error('❌ Main avatar image failed to load');
                        this.style.display = 'none';
                        userAvatarIcon.style.display = 'block';
                    };
                    
                    userAvatarImage.onload = function() {
                        console.log('✅ Main avatar image loaded successfully');
                    };
                }
                
                // Update dropdown avatar
                if (profileAvatarImage && profileAvatarIcon) {
                    profileAvatarImage.src = cleanImageUrl;
                    profileAvatarImage.style.display = 'block';
                    profileAvatarIcon.style.display = 'none';
                    
                    profileAvatarImage.onerror = function() {
                        console.error('❌ Dropdown avatar image failed to load');
                        this.style.display = 'none';
                        profileAvatarIcon.style.display = 'block';
                    };
                    
                    profileAvatarImage.onload = function() {
                        console.log('✅ Dropdown avatar image loaded successfully');
                    };
                }
                
            } else {
                console.log('❌ No profile image found - showing default icons');
                
                // Get image elements
                const userAvatarImage = document.getElementById('userAvatarImage');
                const userAvatarIcon = document.getElementById('userAvatarIcon');
                const profileAvatarImage = document.getElementById('profileAvatarImage');
                const profileAvatarIcon = document.getElementById('profileAvatarIcon');
                
                // Show icons when no image
                if (userAvatarImage && userAvatarIcon) {
                    userAvatarImage.style.display = 'none';
                    userAvatarIcon.style.display = 'block';
                }
                if (profileAvatarImage && profileAvatarIcon) {
                    profileAvatarImage.style.display = 'none';
                    profileAvatarIcon.style.display = 'block';
                }
            }
            
            console.log('=== PROFILE DISPLAY UPDATE COMPLETE ===');
        }

        // Function to load active users count from database
        async function loadActiveUsersCount() {
            try {
                console.log('=== LOADING ACTIVE USERS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateActiveUsersDisplay(0);
                    return;
                }

                // Fetch count of users from the users table
                const { data, error, count } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching users count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('users')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateActiveUsersDisplay(0);
                    } else {
                        const userCount = fallbackData ? fallbackData.length : 0;
                        console.log('✅ Users count (fallback method):', userCount);
                        updateActiveUsersDisplay(userCount);
                    }
                    return;
                }

                const userCount = count || 0;
                console.log('✅ Users count from database:', userCount);
                updateActiveUsersDisplay(userCount);

            } catch (error) {
                console.error('Error in loadActiveUsersCount:', error);
                updateActiveUsersDisplay(0);
            }
        }

        // Function to update the active users display
        function updateActiveUsersDisplay(count) {
            const activeUsersElement = document.getElementById('activeUsersCount');
            if (activeUsersElement) {
                const displayText = count === 1 ? `${count} User` : `${count} Users`;
                activeUsersElement.textContent = displayText;
                console.log('✅ Updated active users display to:', displayText);
            } else {
                console.error('❌ Active users count element not found');
            }
        }

        // Function to load active farmers count from database
        async function loadActiveFarmersCount() {
            try {
                console.log('=== LOADING ACTIVE FARMERS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateActiveFarmersDisplay(0);
                    return;
                }

                // Fetch count of farmers from the store-owner table
                const { data, error, count } = await supabaseClient
                    .from('store-owner')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching farmers count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('store-owner')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateActiveFarmersDisplay(0);
                    } else {
                        const farmersCount = fallbackData ? fallbackData.length : 0;
                        console.log('✅ Farmers count (fallback method):', farmersCount);
                        updateActiveFarmersDisplay(farmersCount);
                    }
                    return;
                }

                const farmersCount = count || 0;
                console.log('✅ Farmers count from database:', farmersCount);
                updateActiveFarmersDisplay(farmersCount);

            } catch (error) {
                console.error('Error in loadActiveFarmersCount:', error);
                updateActiveFarmersDisplay(0);
            }
        }

        // Function to update the active farmers display
        function updateActiveFarmersDisplay(count) {
            const activeFarmersElement = document.getElementById('activeFarmersCount');
            if (activeFarmersElement) {
                const displayText = count === 1 ? `${count} Farmer` : `${count} Farmers`;
                activeFarmersElement.textContent = displayText;
                console.log('✅ Updated active farmers display to:', displayText);
            } else {
                console.error('❌ Active farmers count element not found');
            }
        }

        // Function to load available products count from database
        async function loadAvailableProductsCount() {
            try {
                console.log('=== LOADING AVAILABLE PRODUCTS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateAvailableProductsDisplay(0);
                    return;
                }

                // Count total products from the my_products table
                const { data, error, count } = await supabaseClient
                    .from('my_products')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching products count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('my_products')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateAvailableProductsDisplay(0);
                    } else {
                        const productsCount = fallbackData ? fallbackData.length : 0;
                        console.log('✅ Products count (fallback method):', productsCount);
                        updateAvailableProductsDisplay(productsCount);
                    }
                    return;
                }

                const productsCount = count || 0;
                console.log('✅ Products count from my_products table:', productsCount);
                updateAvailableProductsDisplay(productsCount);

            } catch (error) {
                console.error('Error in loadAvailableProductsCount:', error);
                updateAvailableProductsDisplay(0);
            }
        }

        // Function to update the available products display
        function updateAvailableProductsDisplay(count) {
            const availableProductsElement = document.getElementById('availableProductsCount');
            if (availableProductsElement) {
                const displayText = count === 1 ? `${count} Product` : `${count} Products`;
                availableProductsElement.textContent = displayText;
                console.log('✅ Updated available products display to:', displayText);
            } else {
                console.error('❌ Available products count element not found');
            }
        }

        // Test function to verify profile update works
        function testProfileUpdate() {
            console.log('Testing profile update with sample data...');
            updateProfileDisplay({
                name: 'Test User',
                email: 'test@anihan.gov.ph',
                user_type: 'SUPER ADMIN',
                image_url: null
            });
        }

        // Make test function available globally for console testing
        window.testProfileUpdate = testProfileUpdate;

        // Chart.js Analytics Implementation
        const allAnalytics = [
            {category: "Sales", metric: "Rice Sales", value: "₱950,000", location: "Quezon Province", period: "Monthly", growth: "+15.2%", status: "High"},
            {category: "Sales", metric: "Vegetable Sales", value: "₱750,000", location: "Bataan Province", period: "Monthly", growth: "+8.7%", status: "Good"},
            {category: "Stocks", metric: "Total Inventory", value: "15,750 tons", location: "All Warehouses", period: "Daily", growth: "+2.1%", status: "85% Capacity"},
            {category: "Stocks", metric: "Rice Stock", value: "8,200 tons", location: "Central Warehouse", period: "Daily", growth: "+5.3%", status: "Available"},
            {category: "Stocks", metric: "Vegetable Stock", value: "4,850 tons", location: "Regional Warehouses", period: "Daily", growth: "-1.5%", status: "Low Stock"},
            {category: "Soil", metric: "pH Level Optimal", value: "92%", location: "All Farmlands", period: "Weekly", growth: "+3.2%", status: "Excellent"},
            {category: "Soil", metric: "Nutrient Rich", value: "87%", location: "Organic Farms", period: "Weekly", growth: "+4.8%", status: "Good"},
            {category: "Soil", metric: "Moisture Content", value: "78%", location: "Irrigated Areas", period: "Weekly", growth: "-0.5%", status: "Adequate"},
            {category: "Hectare", metric: "Active Farmland", value: "8,450 ha", location: "All Regions", period: "Quarterly", growth: "+6.7%", status: "Expanding"},
            {category: "Hectare", metric: "Rice Production Area", value: "4,200 ha", location: "Quezon Province", period: "Quarterly", growth: "+8.9%", status: "High Yield"},
            {category: "Hectare", metric: "Vegetable Production Area", value: "2,150 ha", location: "Bataan Province", period: "Quarterly", growth: "+5.4%", status: "Productive"},
            {category: "Municipality", metric: "Top Sales Performance", value: "₱650,000", location: "Quezon", period: "Monthly", growth: "+15.2%", status: "#1 Rank"},
            {category: "Municipality", metric: "Second Best Performance", value: "₱540,000", location: "Bataan", period: "Monthly", growth: "+12.8%", status: "#2 Rank"},
            {category: "Municipality", metric: "Third Best Performance", value: "₱485,000", location: "Pampanga", period: "Monthly", growth: "+8.5%", status: "#3 Rank"}
        ];
        
        let filteredAnalytics = [...allAnalytics];

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Filter functions
        function applyFilters() {
            const categoryFilter = document.getElementById('categoryFilter').value;
            const periodFilter = document.getElementById('periodFilter').value;
            const searchTerm = document.getElementById('analyticsSearch').value.toLowerCase();
            
            filteredAnalytics = allAnalytics.filter(item => {
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                const matchesPeriod = !periodFilter || item.period === periodFilter;
                const matchesSearch = !searchTerm || 
                    item.category.toLowerCase().includes(searchTerm) ||
                    item.metric.toLowerCase().includes(searchTerm) ||
                    item.location.toLowerCase().includes(searchTerm) ||
                    item.value.toLowerCase().includes(searchTerm);
                    
                return matchesCategory && matchesPeriod && matchesSearch;
            });
            
            updateTable();
        }

        function resetFilters() {
            document.getElementById('categoryFilter').value = '';
            document.getElementById('periodFilter').value = '';
            document.getElementById('analyticsSearch').value = '';
            filteredAnalytics = [...allAnalytics];
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('analyticsTableBody');
            const tableInfo = document.getElementById('tableInfo');
            
            tbody.innerHTML = '';
            
            filteredAnalytics.forEach(item => {
                const statusClass = item.status.includes('Excellent') || item.status.includes('High') || item.status.includes('#1') ? 'bg-success' : 
                                   item.status.includes('Good') || item.status.includes('Available') || item.status.includes('#2') || item.status.includes('#3') ? 'bg-success' : 
                                   item.status.includes('Low') || item.status.includes('Adequate') ? 'bg-warning' : 'bg-info';
                
                const growthClass = item.growth.includes('+') ? 'text-success' : 
                                   item.growth.includes('-') ? 'text-danger' : 'text-warning';
                
                const row = `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.metric}</td>
                        <td>${item.value}</td>
                        <td>${item.location}</td>
                        <td>${item.period}</td>
                        <td><span class="${growthClass}">${item.growth}</span></td>
                        <td><span class="badge ${statusClass}">${item.status}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            tableInfo.textContent = `1 to ${filteredAnalytics.length} items of ${filteredAnalytics.length}`;
        }

        // Download functions
        function downloadData(format) {
            switch(format) {
                case 'csv':
                    downloadCSV();
                    break;
                case 'excel':
                    downloadExcel();
                    break;
                case 'pdf':
                    downloadPDF();
                    break;
                case 'word':
                    downloadWord();
                    break;
                case 'image':
                    downloadImage();
                    break;
            }
        }

        function downloadCSV() {
            const headers = ['Category', 'Metric', 'Value', 'Location/Product', 'Period', 'Growth Rate', 'Status'];
            const csvContent = [
                headers.join(','),
                ...filteredAnalytics.map(item => [
                    `"${item.category}"`,
                    `"${item.metric}"`,
                    `"${item.value}"`,
                    `"${item.location}"`,
                    `"${item.period}"`,
                    `"${item.growth}"`,
                    `"${item.status}"`
                ].join(','))
            ].join('\\n');
            
            downloadFile(csvContent, 'anihan-analytics-data.csv', 'text/csv');
        }

        function downloadExcel() {
            // Simple Excel-compatible format
            const headers = ['Category', 'Metric', 'Value', 'Location/Product', 'Period', 'Growth Rate', 'Status'];
            const csvContent = [
                headers.join('\\t'),
                ...filteredAnalytics.map(item => [
                    item.category,
                    item.metric,
                    item.value,
                    item.location,
                    item.period,
                    item.growth,
                    item.status
                ].join('\\t'))
            ].join('\\n');
            
            downloadFile(csvContent, 'anihan-analytics-data.xls', 'application/vnd.ms-excel');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Anihan Analytics Report', 20, 20);
            
            let y = 40;
            doc.setFontSize(10);
            doc.text('Category', 20, y);
            doc.text('Metric', 50, y);
            doc.text('Value', 90, y);
            doc.text('Location', 130, y);
            doc.text('Period', 160, y);
            doc.text('Growth', 180, y);
            doc.text('Status', 200, y);
            
            y += 10;
            filteredAnalytics.forEach(item => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(item.category, 20, y);
                doc.text(item.metric, 50, y);
                doc.text(item.value, 90, y);
                doc.text(item.location, 130, y);
                doc.text(item.period, 160, y);
                doc.text(item.growth, 180, y);
                doc.text(item.status, 200, y);
                y += 10;
            });
            
            doc.save('anihan-analytics-data.pdf');
        }

        function downloadWord() {
            let content = `
                <html>
                <head><title>Anihan Analytics Report</title></head>
                <body>
                    <h1>Anihan Analytics Report</h1>
                    <table border="1" cellpadding="5" cellspacing="0">
                        <tr>
                            <th>Category</th>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Location/Product</th>
                            <th>Period</th>
                            <th>Growth Rate</th>
                            <th>Status</th>
                        </tr>
            `;
            
            filteredAnalytics.forEach(item => {
                content += `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.metric}</td>
                        <td>${item.value}</td>
                        <td>${item.location}</td>
                        <td>${item.period}</td>
                        <td>${item.growth}</td>
                        <td>${item.status}</td>
                    </tr>
                `;
            });
            
            content += '</table></body></html>';
            
            downloadFile(content, 'anihan-analytics-data.doc', 'application/msword');
        }

        function downloadImage() {
            const table = document.getElementById('analyticsTable');
            html2canvas(table).then(canvas => {
                const link = document.createElement('a');
                link.download = 'anihan-analytics-table.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function previousPage() {
            // Pagination logic can be implemented here
            console.log('Previous page');
        }

        function nextPage() {
            // Pagination logic can be implemented here
            console.log('Next page');
        }

        // Event listeners
    const categoryFilterEl = document.getElementById('categoryFilter');
    if (categoryFilterEl) categoryFilterEl.addEventListener('change', applyFilters);
    const periodFilterEl = document.getElementById('periodFilter');
    if (periodFilterEl) periodFilterEl.addEventListener('change', applyFilters);
    const analyticsSearchEl = document.getElementById('analyticsSearch');
    if (analyticsSearchEl) analyticsSearchEl.addEventListener('input', applyFilters);

        // Initialize table
        updateTable();
    </script>
    <script>
        // Tabs for Account Approval
        document.getElementById('forApprovalTab').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'for_approval.html';
        });
        document.getElementById('approvedTab').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'approved_application.html';
        });
        document.getElementById('inventoryRecordsTab').addEventListener('click', function(e) {
            e.preventDefault();
            window.location.href = 'inventory_records.html';
        });

        // Sidebar navigation
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-link:not(.submenu-link):not(#inventoryRecordsTab)');
        const sidebarRoutes = [
            'dashboard_super_admin.html',
            'admin_accounts.html',
            '', // Account Approval handled by submenu
            'price_monitoring.html',
            'in_demand_products.html',
            'sales_per_location.html',
            'voucher.html',
            'violation.html'
        ];
        sidebarLinks.forEach((btn, idx) => {
            // Account Approval handled by submenu
            if (btn.closest('.nav-dropdown')) return;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (sidebarRoutes[idx]) {
                    window.location.href = sidebarRoutes[idx];
                }
            });
        });
    </script>
    
    <script>
        // Chart.js Analytics Implementation
        let salesChart, stocksChart, soilChart, hectareChart;

        // Chart Data
        const analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [15000, 18500, 22000, 19800, 25500, 28000, 32000, 29500, 31000, 35000, 38000, 42000]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [8500, 9200, 11000, 12500]
                },
                yearly: {
                    labels: ['2020', '2021', '2022', '2023', '2024'],
                    data: [180000, 220000, 285000, 340000, 420000]
                }
            },
            stocks: {
                category: {
                    labels: [],
                    data: [],
                    colors: ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#fd7e14', '#6610f2', '#6c757d']
                },
                status: {
                    labels: [],
                    data: [],
                    colors: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
                }
            },
            soil: {
                type: {
                    labels: [],
                    data: [],
                    colors: ['#8B4513', '#F4A460', '#DEB887', '#D2B48C', '#A0522D', '#198754', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [120, 135, 150, 168, 180, 195, 210, 225, 240, 255, 270, 285]
                }
            }
        };

        // Fetch product stock data from Supabase and update analyticsData.stocks.category
        async function updateStockAnalyticsFromDB() {
            // ...existing code...
    // ...existing code...

        // Move updateSoilAnalyticsFromDB to top-level scope so it is defined before use
        async function updateSoilAnalyticsFromDB() {
            try {
                const { data: stores, error } = await supabaseClient
                    .from('store-owner')
                    .select('soil_type');
                const soilErrorDiv = document.getElementById('soilAnalyticsError');
                const soilDebugDiv = document.getElementById('soilAnalyticsDebug');
                console.log('[SoilAnalytics] Raw fetch result:', stores, error);
                if (error) {
                    console.error('Error fetching stores for soil analytics:', error);
                    if (soilErrorDiv) soilErrorDiv.textContent = 'Error fetching soil analytics: ' + error.message;
                    if (soilDebugDiv) soilDebugDiv.textContent = '';
                    alert('Error fetching soil analytics: ' + error.message);
                    return;
                }
                if (!stores || stores.length === 0) {
                    if (soilErrorDiv) soilErrorDiv.textContent = 'No soil data found in the database.';
                    if (soilDebugDiv) soilDebugDiv.textContent = '[SoilAnalytics] No data returned from Supabase.';
                    alert('No soil data found in the database.');
                    // Clear chart if no data
                    if (typeof soilChart !== 'undefined' && soilChart) {
                        soilChart.data.labels = [];
                        soilChart.data.datasets[0].data = [];
                        soilChart.update();
                    }
                    return;
                } else {
                    if (soilErrorDiv) soilErrorDiv.textContent = '';
                    if (soilDebugDiv) soilDebugDiv.textContent = '[SoilAnalytics] Fetched soil_type data: ' + JSON.stringify(stores);
                }
                // Count occurrences of each soil_type
                const soilTypeMap = {};
                stores.forEach(store => {
                    const soil = store.soil_type && store.soil_type.trim() ? store.soil_type.trim() : 'Unknown';
                    if (!soilTypeMap[soil]) soilTypeMap[soil] = 0;
                    soilTypeMap[soil] += 1;
                });
                analyticsData.soil.type.labels = Object.keys(soilTypeMap);
                analyticsData.soil.type.data = Object.values(soilTypeMap);
                analyticsData.soil.type.counts = Object.values(soilTypeMap);
                // Optionally trim or repeat colors array to match soil types
                const baseColors = analyticsData.soil.type.colors;
                analyticsData.soil.type.colors = analyticsData.soil.type.labels.map((_, i) => baseColors[i % baseColors.length]);
                // Log chart data to debug div
                if (soilDebugDiv) {
                    soilDebugDiv.textContent += '\n[SoilAnalytics] Chart labels: ' + JSON.stringify(analyticsData.soil.type.labels) + '\nChart data: ' + JSON.stringify(analyticsData.soil.type.data);
                }
                // Refresh or initialize the chart
                if (typeof soilChart !== 'undefined' && soilChart) {
                    soilChart.data.labels = analyticsData.soil.type.labels;
                    soilChart.data.datasets[0].data = analyticsData.soil.type.data;
                    soilChart.data.datasets[0].backgroundColor = analyticsData.soil.type.colors;
                    soilChart.update();
                } else {
                    initSoilChart();
                }
                console.log('[SoilAnalytics] Chart updated:', analyticsData.soil.type);
            } catch (err) {
                console.error('Exception updating soil analytics:', err);
                const soilErrorDiv = document.getElementById('soilAnalyticsError');
                const soilDebugDiv = document.getElementById('soilAnalyticsDebug');
                if (soilErrorDiv) soilErrorDiv.textContent = 'Exception updating soil analytics: ' + err.message;
                if (soilDebugDiv) soilDebugDiv.textContent = '[SoilAnalytics] Exception: ' + err.message;
                alert('Exception updating soil analytics: ' + err.message);
            }
        }
        // Fetch soil analytics from store-owner table
        async function updateSoilAnalyticsFromDB() {
            try {
                const { data: stores, error } = await supabaseClient
                    .from('store-owner')
                    .select('soil_type');
                const soilErrorDiv = document.getElementById('soilAnalyticsError');
                const soilDebugDiv = document.getElementById('soilAnalyticsDebug');
                if (error) {
                    console.error('Error fetching stores for soil analytics:', error);
                    if (soilErrorDiv) soilErrorDiv.textContent = 'Error fetching soil analytics: ' + error.message;
                    if (soilDebugDiv) soilDebugDiv.textContent = '';
                    return;
                }
                if (!stores || stores.length === 0) {
                    if (soilErrorDiv) soilErrorDiv.textContent = 'No soil data found in the database.';
                    if (soilDebugDiv) soilDebugDiv.textContent = '';
                } else {
                    if (soilErrorDiv) soilErrorDiv.textContent = '';
                    if (soilDebugDiv) soilDebugDiv.textContent = 'Fetched soil_type data: ' + JSON.stringify(stores);
                }
                // Count occurrences of each soil_type
                const soilTypeMap = {};
                stores.forEach(store => {
                    const soil = store.soil_type ? store.soil_type.trim() : 'Unknown';
                    if (!soilTypeMap[soil]) soilTypeMap[soil] = 0;
                    soilTypeMap[soil] += 1;
                });
                analyticsData.soil.type.labels = Object.keys(soilTypeMap);
                analyticsData.soil.type.data = Object.values(soilTypeMap);
                analyticsData.soil.type.counts = Object.values(soilTypeMap);
                // Optionally trim or repeat colors array to match soil types
                const baseColors = analyticsData.soil.type.colors;
                analyticsData.soil.type.colors = analyticsData.soil.type.labels.map((_, i) => baseColors[i % baseColors.length]);
                // Refresh the chart if already initialized
                if (typeof soilChart !== 'undefined' && soilChart) {
                    soilChart.data.labels = analyticsData.soil.type.labels;
                    soilChart.data.datasets[0].data = analyticsData.soil.type.data;
                    soilChart.data.datasets[0].backgroundColor = analyticsData.soil.type.colors;
                    soilChart.update();
                }
                console.log('Soil analytics updated from DB:', analyticsData.soil.type);
            } catch (err) {
                console.error('Exception updating soil analytics:', err);
                const soilErrorDiv = document.getElementById('soilAnalyticsError');
                if (soilErrorDiv) soilErrorDiv.textContent = 'Exception updating soil analytics: ' + err.message;
            }
        }
        // Fetch soil analytics from store-owner table
        async function updateSoilAnalyticsFromDB() {
            try {
                const { data: stores, error } = await supabaseClient
                    .from('store-owner')
                    .select('soil_type');
                if (error) {
                    console.error('Error fetching stores for soil analytics:', error);
                    return;
                }
                // Count occurrences of each soil_type
                const soilTypeMap = {};
                stores.forEach(store => {
                    const soil = store.soil_type || 'Unknown';
                    if (!soilTypeMap[soil]) soilTypeMap[soil] = 0;
                    soilTypeMap[soil] += 1;
                });
                analyticsData.soil.type.labels = Object.keys(soilTypeMap);
                analyticsData.soil.type.data = Object.values(soilTypeMap);
                // Optionally trim or repeat colors array to match soil types
                const baseColors = analyticsData.soil.type.colors;
                analyticsData.soil.type.colors = analyticsData.soil.type.labels.map((_, i) => baseColors[i % baseColors.length]);
                // Refresh the chart if already initialized
                if (typeof soilChart !== 'undefined' && soilChart) {
                    soilChart.data.labels = analyticsData.soil.type.labels;
                    soilChart.data.datasets[0].data = analyticsData.soil.type.data;
                    soilChart.data.datasets[0].backgroundColor = analyticsData.soil.type.colors;
                    soilChart.update();
                }
                console.log('Soil analytics updated from DB:', analyticsData.soil.type);
            } catch (err) {
                console.error('Exception updating soil analytics:', err);
            }
        }
            try {
                const { data: products, error } = await supabaseClient
                    .from('my_products')
                    .select('category, quantity');
                // Store for export
                window.lastFetchedProductsForExport = products;
                if (error) {
                    console.error('Error fetching products for stock analytics:', error);
                    return;
                }
                // Group and sum quantities by category, and count products per category
                const categoryMap = {};
                const categoryCountMap = {};
                // Group by status (Available, Low Stock, Out of Stock)
                const statusMap = { 'Available': 0, 'Low Stock': 0, 'Out of Stock': 0 };
                products.forEach(product => {
                    const cat = product.category || 'Uncategorized';
                    const qty = parseInt(product.quantity, 10) || 0;
                    if (!categoryMap[cat]) categoryMap[cat] = 0;
                    if (!categoryCountMap[cat]) categoryCountMap[cat] = 0;
                    categoryMap[cat] += qty;
                    categoryCountMap[cat] += 1;
                    // Status logic like inventory_records.html
                    let status = 'Available';
                    if (qty === 0) status = 'Out of Stock';
                    else if (qty > 0 && qty <= 10) status = 'Low Stock';
                    statusMap[status] += 1;
                });
                // Update category analytics
                analyticsData.stocks.category.labels = Object.keys(categoryMap);
                analyticsData.stocks.category.data = Object.values(categoryMap);
                analyticsData.stocks.category.counts = Object.values(categoryCountMap);
                const baseColors = analyticsData.stocks.category.colors;
                analyticsData.stocks.category.colors = analyticsData.stocks.category.labels.map((_, i) => baseColors[i % baseColors.length]);
                // Update status analytics
                analyticsData.stocks.status.labels = Object.keys(statusMap);
                analyticsData.stocks.status.data = Object.values(statusMap);
                const statusColors = analyticsData.stocks.status.colors;
                analyticsData.stocks.status.colors = analyticsData.stocks.status.labels.map((_, i) => statusColors[i % statusColors.length]);
                // Refresh the chart if already initialized and status view is selected
                const stocksFilter = document.getElementById('stocksFilter');
                if (typeof stocksChart !== 'undefined' && stocksChart && stocksFilter) {
                    const view = stocksFilter.value;
                    if (view === 'category') {
                        stocksChart.data.labels = analyticsData.stocks.category.labels;
                        stocksChart.data.datasets[0].data = analyticsData.stocks.category.data;
                        stocksChart.data.datasets[0].backgroundColor = analyticsData.stocks.category.colors;
                    } else if (view === 'status') {
                        stocksChart.data.labels = analyticsData.stocks.status.labels;
                        stocksChart.data.datasets[0].data = analyticsData.stocks.status.data;
                        stocksChart.data.datasets[0].backgroundColor = analyticsData.stocks.status.colors;
                    }
                    stocksChart.update();
                }
                console.log('Stock analytics updated from DB:', analyticsData.stocks);
            } catch (err) {
                console.error('Exception updating stock analytics:', err);
            }
        }

        // Initialize Charts
        function initializeCharts() {
            initSalesChart();
            initStocksChart();
            initSoilChart();
            initHectareChart();
            updateStockAnalyticsFromDB();
            updateSoilAnalyticsFromDB();
        }

        // Sales Chart (Line Graph)
        function initSalesChart() {
            const canvas = document.getElementById('salesChart');
            if (!canvas) {
                console.error('Sales chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const currentData = analyticsData.sales.monthly;
            
            console.log('Initializing sales chart with data:', currentData);
            
            salesChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        label: 'Sales (PHP)',
                        data: currentData.data,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '₱' + value.toLocaleString();
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ₱' + context.parsed.y.toLocaleString();
                                }
                            }
                        }
                    }
                }
            });
        }

        // Stocks Chart (Pie Chart)
        function initStocksChart() {
            const canvas = document.getElementById('stocksChart');
            if (!canvas) {
                console.error('Stocks chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const currentData = analyticsData.stocks.category;
            
            console.log('Initializing stocks chart with data:', currentData);
            
            stocksChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Show count and stock for each category
                                    const label = context.label;
                                    const stock = context.parsed;
                                    const idx = context.dataIndex;
                                    const count = analyticsData.stocks.category.counts ? analyticsData.stocks.category.counts[idx] : undefined;
                                    if (typeof count !== 'undefined') {
                                        return `${label}: ${stock} (Products: ${count})`;
                                    } else {
                                        return `${label}: ${stock}`;
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        // Soil Chart (Donut Chart)
        function initSoilChart() {
            const canvas = document.getElementById('soilChart');
            if (!canvas) {
                console.error('Soil chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const currentData = analyticsData.soil.type;
            
            console.log('Initializing soil chart with data:', currentData);
            
            soilChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        data: currentData.data,
                        backgroundColor: currentData.colors,
                        borderWidth: 2,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: true,
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    // Show soil type and count for each type
                                    const label = context.label;
                                    const count = context.parsed;
                                    const idx = context.dataIndex;
                                    return `${label}: ${count} data`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // Hectare Chart (Histogram/Bar Chart)
        function initHectareChart() {
            const canvas = document.getElementById('hectareChart');
            if (!canvas) {
                console.error('Hectare chart canvas not found');
                return;
            }
            
            const ctx = canvas.getContext('2d');
            const currentData = analyticsData.hectare.monthly;
            
            console.log('Initializing hectare chart with data:', currentData);
            
            hectareChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: currentData.labels,
                    datasets: [{
                        label: 'Hectares Cultivated',
                        data: currentData.data,
                        backgroundColor: 'rgba(40, 167, 69, 0.8)',
                        borderColor: '#28a745',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' ha';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.y + ' hectares';
                                }
                            }
                        }
                    }
                }
            });
        }

        // Filter Functions
        function updateSalesChart(period) {
            const data = analyticsData.sales[period];
            salesChart.data.labels = data.labels;
            salesChart.data.datasets[0].data = data.data;
            salesChart.update();
        }

        function updateStocksChart(view) {
            const data = analyticsData.stocks[view];
            stocksChart.data.labels = data.labels;
            stocksChart.data.datasets[0].data = data.data;
            stocksChart.data.datasets[0].backgroundColor = data.colors;
            stocksChart.update();
        }

        // Event Listeners for Filters
        document.getElementById('salesFilter').addEventListener('change', function() {
            updateSalesChart(this.value);
        });

        document.getElementById('stocksFilter').addEventListener('change', function() {
            updateStocksChart(this.value);
        });

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                'sales': salesChart,
                'stocks': stocksChart,
                'soil': soilChart,
                'hectare': hectareChart,
                'municipality': null // Static chart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'png':
                case 'picture':
                    if (chart) {
                        const url = chart.toBase64Image();
                        const link = document.createElement('a');
                        link.download = filename + '.png';
                        link.href = url;
                        link.click();
                    }
                    break;
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = '';
            let data;
            
            switch(chartType) {
                case 'sales':
                    data = analyticsData.sales[document.getElementById('salesFilter').value];
                    csv = 'Period,Sales Amount (PHP)\n';
                    data.labels.forEach((label, index) => {
                        csv += label + ',' + data.data[index] + '\n';
                    });
                    break;
                case 'stocks':
                    // Always export as Category, Stock, Status for all products
                    csv = 'Category,Stock,Status\n';
                    // Fetch all products from analytics (or cache, or refetch if needed)
                    // We'll use the last fetched products from updateStockAnalyticsFromDB if available
                    if (window.lastFetchedProductsForExport && Array.isArray(window.lastFetchedProductsForExport)) {
                        window.lastFetchedProductsForExport.forEach(product => {
                            const cat = product.category || 'Uncategorized';
                            const qty = parseInt(product.quantity, 10) || 0;
                            let status = 'Available';
                            if (qty === 0) status = 'Out of Stock';
                            else if (qty > 0 && qty <= 10) status = 'Low Stock';
                            csv += `${cat},${qty},${status}\n`;
                        });
                    } else {
                        // fallback: use analyticsData.stocks.category/status (less detail)
                        data = analyticsData.stocks[document.getElementById('stocksFilter').value];
                        data.labels.forEach((label, index) => {
                            csv += label + ',' + data.data[index] + ',\n';
                        });
                    }
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    csv = 'Soil Type,Percentage\n';
                    data.labels.forEach((label, index) => {
                        csv += label + ',' + data.data[index] + '\n';
                    });
                    break;
                case 'hectare':
                    data = analyticsData.hectare.monthly;
                    csv = 'Period,Hectares\n';
                    data.labels.forEach((label, index) => {
                        csv += label + ',' + data.data[index] + '\n';
                    });
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF();
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            // Create a simple HTML document for Word export
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const html = `
                        <html>
                        <head><title>${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</title></head>
                        <body>
                            <h1>${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            <p>Generated on: ${new Date().toLocaleDateString()}</p>
                            <img src="${imgData}" style="max-width: 100%;" />
                        </body>
                        </html>
                    `;
                    const blob = new Blob([html], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        // Initialize all charts when the page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, Chart.js available:', typeof Chart !== 'undefined');
            if (typeof Chart !== 'undefined') {
                try {
                    initializeCharts();
                    console.log('Charts initialized successfully');
                } catch (error) {
                    console.error('Error initializing charts:', error);
                }
            } else {
                console.error('Chart.js not loaded');
            }
        });
    </script>
</body>
</html>