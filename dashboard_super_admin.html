<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anihan Dashboard</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="fixed-layout.css" rel="stylesheet">
    <link href="profile-dropdown.css" rel="stylesheet">
    <link href="dashboard_super_admin.css" rel="stylesheet">
    <style>
        /* All Users Modal Styles */
        #allUsersModal .modal-dialog {
            max-width: 95%;
        }
        
        #allUsersModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allUsersModal .table td {
            vertical-align: middle;
        }
        
        #userSearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #userSearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }
        
        .badge {
            font-size: 0.875rem;
        }
        
        .modal-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }
        
        .modal-footer {
            background-color: #f8f9fa;
            border-top: 1px solid #dee2e6;
        }
        
        /* Municipality Sales Modal Styles */
        #allMunicipalitySalesModal .modal-dialog {
            max-width: 95%;
        }
        
        #allMunicipalitySalesModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allMunicipalitySalesModal .table td {
            vertical-align: middle;
        }
        
        #municipalitySearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #municipalitySearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        /* Communities Modal Styles */
        #allCommunitiesModal .modal-dialog {
            max-width: 95%;
        }
        
        #allCommunitiesModal .table th {
            background-color: #f8f9fa;
            font-weight: 600;
            border-bottom: 2px solid #dee2e6;
        }
        
        #allCommunitiesModal .table td {
            vertical-align: middle;
        }
        
        #communitySearchInput {
            border-radius: 8px;
            border: 1px solid #ced4da;
            padding: 10px 15px;
        }
        
        #communitySearchInput:focus {
            border-color: #28a745;
            box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        }

        

        /* Users Table Styles */
        .users-table-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .users-table-header {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .users-table-header h5 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .users-table-body {
            padding: 0;
        }

        .users-table-body .table {
            margin: 0;
        }

        .users-table-body .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody td {
            padding: 12px 20px;
            border: none;
            color: #495057;
            font-size: 14px;
        }

        .users-table-body .table tbody tr {
            border-bottom: 1px solid #f1f3f4;
        }

        .users-table-body .table tbody tr:last-child {
            border-bottom: none;
        }

        .users-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        .table-info-section {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .table-info {
            color: #6c757d;
            font-size: 14px;
        }

        .view-all-link {
            color: #007bff;
            text-decoration: none;
            font-size: 14px;
            font-weight: 500;
        }

        .view-all-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }

        .pagination-controls {
            display: flex;
            gap: 5px;
        }

        .pagination-controls .btn {
            border-radius: 4px;
            font-size: 12px;
            padding: 5px 10px;
            border: 1px solid #28a745;
            color: #28a745;
            background-color: #ffffff;
            transition: all 0.2s ease;
        }

        .pagination-controls .btn:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        .pagination-controls .active-page {
            background: #28a745 !important;
            border-color: #28a745 !important;
            color: white !important;
        }

        .pagination-controls .btn-outline-secondary {
            border-color: #28a745;
            color: #28a745;
        }

        .pagination-controls .btn-outline-secondary:hover {
            background-color: #28a745;
            border-color: #28a745;
            color: white;
        }

        /* Community Table Styles */
        .community-table-card {
            background: #ffffff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .community-table-header {
            background: #28a745;
            color: white;
            padding: 15px 20px;
            font-weight: 600;
        }

        .community-table-header h5 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-weight: 600;
        }

        .community-table-body {
            padding: 0;
        }

        .community-table-body .table {
            margin: 0;
        }

        .community-table-body .table thead th {
            background: #f8f9fa;
            border: none;
            padding: 12px 20px;
            font-weight: 600;
            color: #495057;
            font-size: 14px;
        }

        .community-table-body .table tbody td {
            padding: 12px 20px;
            border: none;
            color: #495057;
            font-size: 14px;
        }

        .community-table-body .table tbody tr {
            border-bottom: 1px solid #f1f3f4;
        }

        .community-table-body .table tbody tr:last-child {
            border-bottom: none;
        }

        .community-table-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            background: #f8f9fa;
            border-top: 1px solid #e9ecef;
        }

        /* Chart Container Responsive Design */
        .chart-container {
            position: relative;
            width: 100%;
            min-height: 300px;
            height: 350px;
            overflow: hidden;
        }

        .chart-container canvas {
            width: 100% !important;
            max-width: 100% !important;
            height: 100% !important;
            min-height: 300px !important;
        }

        /* Analytics Card Styling */
        .analytics-card {
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            margin-bottom: 24px;
            min-height: 450px;
        }

        .analytics-card .card-header {
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            padding: 16px 20px;
        }

        .analytics-card .card-body {
            padding: 20px;
        }

        /* Total Sales Display */
        .total-sales-display {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
        }
    </style>
</head>
<body>
    <!-- Top Navigation -->
    <nav class="navbar navbar-light bg-white border-bottom">
        <div class="container-fluid">
            <div class="d-flex align-items-center">
                <button class="mobile-menu-toggle me-3" onclick="toggleMobileSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <a class="navbar-brand d-flex align-items-center" href="#">
                    <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                    <span class="brand-text">Anihan</span>
                </a>
            </div>
            <div class="user-avatar" onclick="toggleProfileDropdown()">
                <img id="userAvatarImage" src="" alt="User Avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover; display: none;">
                <i id="userAvatarIcon" class="fas fa-user"></i>
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="profile-dropdown-header">
                        <div class="profile-dropdown-avatar">
                            <img id="profileAvatarImage" src="" alt="Profile Avatar" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
                            <i id="profileAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <h6 class="profile-dropdown-name" id="profileUserName">Loading...</h6>
                    </div>
                    <div class="profile-dropdown-details">
                        <div class="profile-detail-item">
                            <i class="fas fa-envelope"></i>
                            <span id="profileUserEmail">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-user-tag"></i>
                            <span id="profileUserRole">Loading...</span>
                        </div>
                        <div class="profile-detail-item">
                            <i class="fas fa-shield-alt"></i>
                            <span id="profileUserTitle">System Administrator</span>
                        </div>
                    </div>
                    <div class="profile-dropdown-actions">
                        <button class="btn" onclick="signOut()">
                            <i class="fas fa-sign-out-alt"></i>
                            Sign out
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link active d-flex align-items-center text-start" href="dashboard_super_admin.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="admin_accounts.html">
                        <i class="fas fa-user-shield me-2"></i>
                        Admin Accounts
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="false" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="inventory_records.html">
                        <i class="fas fa-clipboard-list me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="in_demand_products.html">
                        <i class="fas fa-chart-bar me-2"></i>
                        In Demand Products
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sales_per_location.html">
                        <i class="fas fa-map-marker-alt me-2"></i>
                        Sales Per Location
                    </a>
                    
                    <!-- Voucher Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#voucherSubmenu" 
                                aria-expanded="false" aria-controls="voucherSubmenu">
                            <span>
                                <i class="fas fa-ticket-alt me-2"></i>
                                Voucher
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse" id="voucherSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="add_voucher.html">
                                    <i class="fas fa-plus me-2"></i>
                                    Add Voucher
                                </a>
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="voucher_records.html">
                                    <i class="fas fa-list me-2"></i>
                                    Voucher Records
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="violation.html">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Violation
                    </a>
                </div>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Stats Cards -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="stats-card stats-users">
                            <div class="stats-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="activeUsersCount">Loading...</div>
                                <div class="stats-label">Active Users</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card stats-products">
                            <div class="stats-icon">
                                <i class="fas fa-box"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="availableProductsCount">Loading...</div>
                                <div class="stats-label">Available</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stats-card stats-farmers">
                            <div class="stats-icon">
                                <i class="fas fa-tractor"></i>
                            </div>
                            <div class="stats-info">
                                <div class="stats-number" id="activeFarmersCount">Loading...</div>
                                <div class="stats-label">Active Farmers</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Cards Row 1 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Sales Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="salesFilter" style="width: 100px;">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('sales', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="salesChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Stocks Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="stocksFilter" style="width: 100px;">
                                        <option value="category">Category</option>
                                        <option value="status">Status</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('stocks', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="stocksChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Analytics Cards Row 2 -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Soil Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="soilFilter" style="width: 100px;">
                                        <option value="type">Soil Type</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('soil', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="soilChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="analytics-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5>Hectare Analytics</h5>
                                <div class="chart-controls">
                                    <select class="form-select form-select-sm me-2" id="hectareFilter" style="width: 120px;" onchange="updateHectareChart(this.value)">
                                        <option value="monthly">Monthly</option>
                                        <option value="weekly">Weekly</option>
                                        <option value="yearly">Yearly</option>
                                    </select>
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="dropdown">
                                            <i class="fas fa-bars"></i>
                                        </button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'csv')">
                                                <i class="fas fa-file-csv me-2"></i>Save as CSV
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'pdf')">
                                                <i class="fas fa-file-pdf me-2"></i>Save as PDF
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'word')">
                                                <i class="fas fa-file-word me-2"></i>Save as Word
                                            </a></li>
                                            <li><a class="dropdown-item" href="#" onclick="exportChart('hectare', 'picture')">
                                                <i class="fas fa-image me-2"></i>Save as Picture
                                            </a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="hectareChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Top Municipality in terms of Sales Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="municipality-sales-table-card">
                            <div class="municipality-sales-table-header">
                                <h5>Top Municipality in terms of Sales</h5>
                            </div>
                            <div class="municipality-sales-table-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead>
                                            <tr>
                                                <th>Municipality</th>
                                                <th>Total Sales</th>
                                                <th>Number of Orders</th>
                                            </tr>
                                        </thead>
                                        <tbody id="municipalitySalesTableBody">
                                            <!-- Municipality sales will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="municipality-sales-table-footer">
                                    <div class="table-info-section">
                                        <span class="table-info" id="municipalitySalesTableInfo">Loading municipality sales...</span>
                                        <a href="#" class="view-all-link" onclick="showAllMunicipalitySalesModal()">View all ></a>
                                    </div>
                                    <div class="pagination-controls">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changeMunicipalityPage(-1)">&lt;</button>
                                        <button class="btn btn-sm btn-success active-page" id="currentMunicipalityPageBtn">1</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changeMunicipalityPage(1)">&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Community Engagement Analytics Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="community-table-card">
                            <div class="community-table-header">
                                <h5>Community Engagement Analytics</h5>
                            </div>
                            <div class="community-table-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead>
                                            <tr>
                                                <th>Community Name</th>
                                                <th>Total Members</th>
                                                <th>Created Date</th>
                                            </tr>
                                        </thead>
                                        <tbody id="communityTableBody">
                                            <!-- Community data will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="community-table-footer">
                                    <div class="table-info-section">
                                        <span class="table-info" id="communityTableInfo">Loading community data...</span>
                                        <a href="#" class="view-all-link" onclick="showAllCommunitiesModal()">View all ></a>
                                    </div>
                                    <div class="pagination-controls">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changeCommunityPage(-1)">&lt;</button>
                                        <button class="btn btn-sm btn-success active-page" id="currentCommunityPageBtn">1</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changeCommunityPage(1)">&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Users Table -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="users-table-card">
                            <div class="users-table-header">
                                <h5>Users</h5>
                            </div>
                            <div class="users-table-body">
                                <div class="table-responsive">
                                    <table class="table table-borderless">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Email</th>
                                                <th>Contact Number</th>
                                            </tr>
                                        </thead>
                                        <tbody id="usersTableBody">
                                            <!-- Users will be loaded dynamically -->
                                        </tbody>
                                    </table>
                                </div>
                                <div class="users-table-footer">
                                    <div class="table-info-section">
                                        <span class="table-info" id="usersTableInfo">Loading users...</span>
                                        <a href="#" class="view-all-link" onclick="showAllUsersModal()">View all ></a>
                                    </div>
                                    <div class="pagination-controls">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changePage(-1)">&lt;</button>
                                        <button class="btn btn-sm btn-success active-page" id="currentPageBtn">1</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changePage(1)">&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All Users Modal -->
    <div class="modal fade" id="allUsersModal" tabindex="-1" aria-labelledby="allUsersModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allUsersModalLabel">All Users</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="userSearchInput" placeholder="Search users by name, email, or role...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-success">
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Contact Number</th>
                                </tr>
                            </thead>
                            <tbody id="allUsersTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allUsersCount">0 users found</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportAllUsers('csv')">
                                <i class="fas fa-file-csv me-1"></i>Export CSV
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="exportAllUsers('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>Export PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Municipality Sales Modal -->
    <div class="modal fade" id="allMunicipalitySalesModal" tabindex="-1" aria-labelledby="allMunicipalitySalesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allMunicipalitySalesModalLabel">All Municipality Sales</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="municipalitySearchInput" placeholder="Search municipalities by name...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-success">
                                <tr>
                                    <th>Municipality</th>
                                    <th>Total Sales</th>
                                    <th>Number of Orders</th>
                                </tr>
                            </thead>
                            <tbody id="allMunicipalitySalesTableBody">
                                <tr>
                                    <td colspan="3" class="text-center">Loading municipality sales...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allMunicipalitySalesCount">0 municipalities found</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportAllMunicipalitySales('csv')">
                                <i class="fas fa-file-csv me-1"></i>Export CSV
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="exportAllMunicipalitySales('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>Export PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- All Communities Modal -->
    <div class="modal fade" id="allCommunitiesModal" tabindex="-1" aria-labelledby="allCommunitiesModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="allCommunitiesModalLabel">All Communities</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <input type="text" class="form-control" id="communitySearchInput" placeholder="Search communities by name...">
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead class="table-primary">
                                <tr>
                                    <th>Community Name</th>
                                    <th>Total Members</th>
                                    <th>Created Date</th>
                                    <th>Created By</th>
                                </tr>
                            </thead>
                            <tbody id="allCommunitiesTableBody">
                                <tr>
                                    <td colspan="4" class="text-center">Loading communities...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div>
                            <span id="allCommunitiesCount">0 communities found</span>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="exportAllCommunities('csv')">
                                <i class="fas fa-file-csv me-1"></i>Export CSV
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="exportAllCommunities('pdf')">
                                <i class="fas fa-file-pdf me-1"></i>Export PDF
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Add Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Add CryptoJS for MD5 hashing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script>
        // Supabase configuration
        const SUPABASE_URL = 'https://ontuivohwjfkxjwrjnot.supabase.co'
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9udHVpdm9od2pma3hqd3Jqbm90Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ2Njg3MTAsImV4cCI6MjA3MDI0NDcxMH0.jGQhshEtfnABK8xNF98WxB10c66vIkTzAoLrhxbeQwE'
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY)

        // Current user ID for tracking
        window.currentUserId = null;

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Dashboard loaded, initializing...');
            console.log('Supabase client available:', !!supabaseClient);
            console.log('Profile elements exist:', {
                profileUserName: !!document.getElementById('profileUserName'),
                profileUserEmail: !!document.getElementById('profileUserEmail'),
                profileUserRole: !!document.getElementById('profileUserRole'),
                userAvatarImage: !!document.getElementById('userAvatarImage'),
                userAvatarIcon: !!document.getElementById('userAvatarIcon')
            });
            
            // Small delay to ensure all elements are loaded
            setTimeout(() => {
                loadCurrentUserProfile();
                loadActiveUsersCount();
                loadActiveFarmersCount();
                loadAvailableProductsCount();
                loadUsersData();
                loadMunicipalitySalesData();
                loadCommunityData();
                
                // Debug municipality sales
                setTimeout(() => {
                    if (window.debugMunicipalitySales) {
                        console.log('ðŸ§ª Running municipality sales debug...');
                        window.debugMunicipalitySales();
                    }
                }, 2000);
                
                // Initialize charts after supabaseClient is available
                if (typeof Chart !== 'undefined') {
                    initializeCharts();
                    console.log('Charts initialized successfully');
                }
                
                // Load sales chart data after chart initialization
                setTimeout(() => {
                    loadTotalSalesData();
                }, 500);
            }, 100);
        });

        // Profile loading functions
        async function loadCurrentUserProfile() {
            try {
                console.log('=== LOADING CURRENT USER PROFILE ===');
                
                // Get current user from session storage (set during login)
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                console.log('Session storage user:', currentUser);
                
                if (!currentUser.id || currentUser.id === 'fallback') {
                    console.log('No valid logged-in user found in session, checking database...');
                    // Check if there are any real users in the database
                    await loadFirstUserForTesting();
                    return;
                }
                
                console.log('Found logged-in user with ID:', currentUser.id);
                window.currentUserId = currentUser.id;
                
                // Fetch the actual user data from database using their ID
                try {
                    const { data: userData, error } = await supabaseClient
                        .from('admin_accounts')
                        .select('*')
                        .eq('id', currentUser.id)
                        .single();
                    
                    if (error) {
                        console.error('Database error fetching user:', error);
                        // Try to load any available user from database
                        console.log('Trying to load any available user from database...');
                        await loadFirstUserForTesting();
                        return;
                    }
                    
                    if (userData) {
                        console.log('Logged-in user data from database:', userData);
                        
                        // Update session with fresh data
                        const userSession = {
                            id: userData.id,
                            name: userData.name,
                            email: userData.email,
                            userType: userData.user_type,
                            image_url: userData.image_url
                        };
                        sessionStorage.setItem('currentUser', JSON.stringify(userSession));
                        
                        // Update profile display with logged-in user's data
                        updateProfileDisplay({
                            name: userData.name,
                            email: userData.email,
                            user_type: userData.user_type,
                            image_url: userData.image_url
                        });
                    } else {
                        console.log('No user data found for ID:', currentUser.id);
                        updateProfileDisplay(currentUser);
                    }
                    
                } catch (dbError) {
                    console.error('Database connection error:', dbError);
                    console.log('Database connection failed, trying to load any available user...');
                    await loadFirstUserForTesting();
                }
                
            } catch (error) {
                console.error('Error in loadCurrentUserProfile:', error);
                await loadFirstUserForTesting();
            }
        }

        // Fallback function to load any user for testing
        async function loadFirstUserForTesting() {
            try {
                console.log('=== LOADING FIRST USER FOR TESTING ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available, using fallback data');
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                    return;
                }
                
                const { data: users, error } = await supabaseClient
                    .from('admin_accounts')
                    .select('*')
                    .limit(1);
                
                if (error) {
                    console.error('Database error in loadFirstUserForTesting:', error);
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                    return;
                }
                
                if (users && users.length > 0) {
                    const user = users[0];
                    console.log('Using first user from database:', user);
                    
                    // Store this user as fallback in session
                    const userSession = {
                        id: 'fallback',
                        name: user.name,
                        email: user.email,
                        userType: user.user_type,
                        image_url: user.image_url
                    };
                    sessionStorage.setItem('currentUser', JSON.stringify(userSession));
                    
                    updateProfileDisplay({
                        name: user.name,
                        email: user.email,
                        user_type: user.user_type,
                        image_url: user.image_url
                    });
                } else {
                    console.log('No users in database, using default');
                    updateProfileDisplay({
                        name: 'Administrator',
                        email: 'admin@anihan.gov.ph',
                        user_type: 'SUPER ADMIN',
                        image_url: null
                    });
                }
                
            } catch (error) {
                console.error('Error in loadFirstUserForTesting:', error);
                updateProfileDisplay({
                    name: 'Administrator',
                    email: 'admin@anihan.gov.ph',
                    user_type: 'SUPER ADMIN',
                    image_url: null
                });
            }
        }

        function updateProfileDisplay(userData) {
            console.log('=== UPDATING PROFILE DISPLAY ===');
            console.log('Updating profile display with data:', userData);
            
            // Update profile name
            const profileName = document.getElementById('profileUserName');
            if (profileName) {
                const displayName = userData.name || 'Administrator';
                profileName.textContent = displayName;
                console.log('âœ… Updated profile name to:', displayName);
            }
            
            // Update profile email
            const profileEmail = document.getElementById('profileUserEmail');
            if (profileEmail) {
                const displayEmail = userData.email || 'admin@anihan.gov.ph';
                profileEmail.textContent = displayEmail;
                console.log('âœ… Updated profile email to:', displayEmail);
            }
            
            // Update profile role
            const profileRole = document.getElementById('profileUserRole');
            if (profileRole) {
                const displayRole = userData.user_type || userData.userType || 'ADMIN';
                profileRole.textContent = displayRole;
                console.log('âœ… Updated profile role to:', displayRole);
            }
            
            // Update profile title based on role
            const profileTitle = document.getElementById('profileUserTitle');
            if (profileTitle) {
                const userRole = userData.user_type || userData.userType || 'ADMIN';
                if (userRole === 'SUPER ADMIN') {
                    profileTitle.textContent = 'System Administrator';
                } else if (userRole === 'SUB ADMIN') {
                    profileTitle.textContent = 'Municipal Administrator';
                } else {
                    profileTitle.textContent = 'Administrator';
                }
                console.log('Updated profile title for role:', userRole);
            }
            
            // Update profile images
            console.log('=== PROCESSING PROFILE IMAGE ===');
            console.log('Raw image URL from database:', userData.image_url);
            
            if (userData.image_url && userData.image_url.trim() !== '' && userData.image_url !== 'null') {
                console.log('âœ… Profile image found - processing...');
                
                // Clean up the image URL
                let cleanImageUrl = userData.image_url.trim();
                if (cleanImageUrl.startsWith('"') && cleanImageUrl.endsWith('"')) {
                    cleanImageUrl = cleanImageUrl.slice(1, -1);
                }
                
                // Get image elements
                const userAvatarImage = document.getElementById('userAvatarImage');
                const userAvatarIcon = document.getElementById('userAvatarIcon');
                const profileAvatarImage = document.getElementById('profileAvatarImage');
                const profileAvatarIcon = document.getElementById('profileAvatarIcon');
                
                // Update main avatar (in navbar)
                if (userAvatarImage && userAvatarIcon) {
                    userAvatarImage.src = cleanImageUrl;
                    userAvatarImage.style.display = 'block';
                    userAvatarIcon.style.display = 'none';
                    
                    userAvatarImage.onerror = function() {
                        console.error('âŒ Main avatar image failed to load');
                        this.style.display = 'none';
                        userAvatarIcon.style.display = 'block';
                    };
                    
                    userAvatarImage.onload = function() {
                        console.log('âœ… Main avatar image loaded successfully');
                    };
                }
                
                // Update dropdown avatar
                if (profileAvatarImage && profileAvatarIcon) {
                    profileAvatarImage.src = cleanImageUrl;
                    profileAvatarImage.style.display = 'block';
                    profileAvatarIcon.style.display = 'none';
                    
                    profileAvatarImage.onerror = function() {
                        console.error('âŒ Dropdown avatar image failed to load');
                        this.style.display = 'none';
                        profileAvatarIcon.style.display = 'block';
                    };
                    
                    profileAvatarImage.onload = function() {
                        console.log('âœ… Dropdown avatar image loaded successfully');
                    };
                }
                
            } else {
                console.log('âŒ No profile image found - showing default icons');
                
                // Get image elements
                const userAvatarImage = document.getElementById('userAvatarImage');
                const userAvatarIcon = document.getElementById('userAvatarIcon');
                const profileAvatarImage = document.getElementById('profileAvatarImage');
                const profileAvatarIcon = document.getElementById('profileAvatarIcon');
                
                // Show icons when no image
                if (userAvatarImage && userAvatarIcon) {
                    userAvatarImage.style.display = 'none';
                    userAvatarIcon.style.display = 'block';
                }
                if (profileAvatarImage && profileAvatarIcon) {
                    profileAvatarImage.style.display = 'none';
                    profileAvatarIcon.style.display = 'block';
                }
            }
            
            console.log('=== PROFILE DISPLAY UPDATE COMPLETE ===');
        }

        // Function to load active users count from database
        async function loadActiveUsersCount() {
            try {
                console.log('=== LOADING ACTIVE USERS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateActiveUsersDisplay(0);
                    return;
                }

                // Fetch count of users from the users table
                const { data, error, count } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching users count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('users')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateActiveUsersDisplay(0);
                    } else {
                        const userCount = fallbackData ? fallbackData.length : 0;
                        console.log('âœ… Users count (fallback method):', userCount);
                        updateActiveUsersDisplay(userCount);
                    }
                    return;
                }

                const userCount = count || 0;
                console.log('âœ… Users count from database:', userCount);
                updateActiveUsersDisplay(userCount);

            } catch (error) {
                console.error('Error in loadActiveUsersCount:', error);
                updateActiveUsersDisplay(0);
            }
        }

        // Function to update the active users display
        function updateActiveUsersDisplay(count) {
            const activeUsersElement = document.getElementById('activeUsersCount');
            if (activeUsersElement) {
                const displayText = count === 1 ? `${count} User` : `${count} Users`;
                activeUsersElement.textContent = displayText;
                console.log('âœ… Updated active users display to:', displayText);
            } else {
                console.error('âŒ Active users count element not found');
            }
        }

        // Pagination variables
        let currentPage = 1;
        let totalUsers = 0;
        const usersPerPage = 4;

        // Sales chart data storage
        let currentSalesData = null;
        let currentSalesPeriod = 'monthly';

        // Function to load and display users data in the table
        async function loadUsersData() {
            try {
                console.log('=== LOADING USERS DATA ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateUsersTable([]);
                    return;
                }

                // First get total count
                const { count } = await supabaseClient
                    .from('users')
                    .select('*', { count: 'exact', head: true });

                totalUsers = count || 0;

                // Fetch users from the users table with pagination
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .range((currentPage - 1) * usersPerPage, currentPage * usersPerPage - 1);

                if (error) {
                    console.error('Database error fetching users:', error);
                    updateUsersTable([]);
                    return;
                }

                console.log('âœ… Users data fetched:', users);
                updateUsersTable(users || []);

            } catch (error) {
                console.error('Error in loadUsersData:', error);
                updateUsersTable([]);
            }
        }

        // Function to update the users table with real data
        function updateUsersTable(users) {
            const tableBody = document.getElementById('usersTableBody');
            const tableInfo = document.getElementById('usersTableInfo');
            
            if (!tableBody) {
                console.error('âŒ Users table body not found');
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No users found</td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }

            // Populate table with user data (simplified to match image)
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.full_name || user.name || user.email || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || user.phone || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update table info and pagination
            const startItem = ((currentPage - 1) * usersPerPage) + 1;
            const endItem = Math.min(currentPage * usersPerPage, totalUsers);
            
            if (tableInfo) {
                tableInfo.textContent = `${startItem} to ${endItem} items of ${totalUsers}`;
            }

            // Update current page button
            const currentPageBtn = document.getElementById('currentPageBtn');
            if (currentPageBtn) {
                currentPageBtn.textContent = currentPage;
            }

            console.log('âœ… Users table updated with', users.length, 'users');
        }

        // Function to change page
        function changePage(direction) {
            const totalPages = Math.ceil(totalUsers / usersPerPage);
            
            if (direction === 1 && currentPage < totalPages) {
                currentPage++;
                loadUsersData();
            } else if (direction === -1 && currentPage > 1) {
                currentPage--;
                loadUsersData();
            }
        }

        // Municipality Sales Variables
        let currentMunicipalityPage = 1;
        let totalMunicipalities = 0;
        const municipalitiesPerPage = 4;

        // Community pagination variables
        let currentCommunityPage = 1;
        let totalCommunities = 0;
        const communitiesPerPage = 4;

        // Function to load and display municipality sales data
        // Debug function for municipality sales
        window.debugMunicipalitySales = async function() {
            console.log('ðŸ§ª === DEBUGGING MUNICIPALITY SALES ===');
            
            if (!supabaseClient) {
                console.error('âŒ Supabase client not available');
                return;
            }

            try {
                // Test 1: Check store-owner table
                console.log('ðŸ§ª Test 1: Checking store-owner table...');
                const { data: sellers, error: sellersError } = await supabaseClient
                    .from('store-owner')
                    .select('user_id')
                    .limit(10);
                
                console.log('ðŸ§ª Sellers result:', { data: sellers, error: sellersError });

                if (sellers && sellers.length > 0) {
                    // Test 2: Check users table for these sellers
                    console.log('ðŸ§ª Test 2: Checking users table...');
                    const sellerIds = sellers.map(s => s.user_id);
                    const { data: users, error: usersError } = await supabaseClient
                        .from('users')
                        .select('id, full_name, municipality')
                        .in('id', sellerIds);
                    
                    console.log('ðŸ§ª Users result:', { data: users, error: usersError });
                    
                    if (users) {
                        const withMunicipality = users.filter(u => u.municipality);
                        console.log(`ðŸ§ª Users with municipality: ${withMunicipality.length} of ${users.length}`);
                        console.log('ðŸ§ª Sample:', withMunicipality.slice(0, 3));
                    }
                }

                // Test 3: Check completed orders
                console.log('ðŸ§ª Test 3: Checking completed orders...');
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id, total, status')
                    .limit(10);
                
                console.log('ðŸ§ª All orders result:', { data: orders, error: ordersError });
                
                if (orders && orders.length > 0) {
                    const statusCounts = {};
                    orders.forEach(order => {
                        statusCounts[order.status] = (statusCounts[order.status] || 0) + 1;
                    });
                    console.log('ðŸ§ª Order statuses found:', statusCounts);
                    
                    // Test completed orders specifically
                    const { data: completedOrders, error: completedError } = await supabaseClient
                        .from('orders')
                        .select('id, total, status')
                        .eq('status', 'completed')
                        .limit(5);
                    
                    console.log('ðŸ§ª Completed orders result:', { data: completedOrders, error: completedError });
                }

            } catch (error) {
                console.error('ðŸ§ª Debug error:', error);
            }
        };

        async function loadMunicipalitySalesData() {
            try {
                console.log('ðŸš€ === LOADING MUNICIPALITY SALES DATA ===');
                
                if (!supabaseClient) {
                    console.error('âŒ Supabase client not available');
                    updateMunicipalitySalesTable([]);
                    return;
                }

                // Step 1: Get all sellers from store-owner table
                console.log('ðŸ“¡ Step 1: Fetching all sellers from store-owner table...');
                const { data: sellers, error: sellersError } = await supabaseClient
                    .from('store-owner')
                    .select('user_id');
                
                if (sellersError) {
                    console.error('âŒ Error fetching sellers:', sellersError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ðŸ“Š Found ${sellers?.length || 0} sellers in store-owner table`);
                console.log('ðŸ“Š Sample sellers:', sellers?.slice(0, 3));
                
                if (!sellers || sellers.length === 0) {
                    console.warn('âš ï¸ No sellers found in store-owner table');
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                // Extract seller user IDs
                const sellerUserIds = sellers.map(seller => seller.user_id);
                console.log('ðŸ‘¥ Seller user IDs (first 5):', sellerUserIds.slice(0, 5));
                
                // Step 2: Get seller details with municipality from users table
                console.log('ðŸ“¡ Step 2: Fetching seller details from users table...');
                const { data: sellerUsers, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id, full_name, municipality')
                    .in('id', sellerUserIds);
                
                if (usersError) {
                    console.error('âŒ Error fetching seller users:', usersError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ï¿½ Found ${sellerUsers?.length || 0} seller users`);
                
                if (!sellerUsers || sellerUsers.length === 0) {
                    console.warn('âš ï¸ No seller users found');
                    updateMunicipalitySalesTable([]);
                    return;
                }

                // Step 3: Get products for these sellers
                const { data: sellerProducts, error: productsError } = await supabaseClient
                    .from('my_products')
                    .select('id, user_id, name')
                    .in('user_id', sellerUserIds);
                
                if (productsError) {
                    console.error('âŒ Error fetching seller products:', productsError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ðŸ›ï¸ Found ${sellerProducts?.length || 0} products from sellers`);
                
                if (!sellerProducts || sellerProducts.length === 0) {
                    console.warn('âš ï¸ No products found from sellers');
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                const productIds = sellerProducts.map(product => product.id);
                
                // Step 4: Get order items for these products
                const { data: orderItems, error: orderItemsError } = await supabaseClient
                    .from('order_items')
                    .select('id, order_id, product_id, quantity, price')
                    .in('product_id', productIds);
                
                if (orderItemsError) {
                    console.error('âŒ Error fetching order items:', orderItemsError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ï¿½ Found ${orderItems?.length || 0} order items for seller products`);
                
                if (!orderItems || orderItems.length === 0) {
                    console.warn('âš ï¸ No order items found for seller products');
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                const orderIds = [...new Set(orderItems.map(item => item.order_id))];
                
                // Step 5: Get the full orders for these order IDs
                console.log('ðŸ“¡ Step 5: Fetching orders (all statuses)...');
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id, user_id, total, created_at, status')
                    .in('id', orderIds);
                
                if (ordersError) {
                    console.error('âŒ Error fetching orders:', ordersError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ðŸ“¦ Found ${orders?.length || 0} orders (all statuses)`);
                console.log('ðŸ“¦ Sample orders:', orders?.slice(0, 3));
                
                // Check order statuses
                if (orders && orders.length > 0) {
                    const statusCounts = {};
                    orders.forEach(order => {
                        statusCounts[order.status] = (statusCounts[order.status] || 0) + 1;
                    });
                    console.log('ðŸ“Š Order status breakdown:', statusCounts);
                }
                
                if (ordersError) {
                    console.error('âŒ Error fetching orders:', ordersError);
                    updateMunicipalitySalesTable([]);
                    return;
                }
                
                console.log(`ï¿½ Found ${orders?.length || 0} completed orders`);
                
                // Step 6: Calculate sales by municipality
                const salesByMunicipality = {};
                
                if (orders && orders.length > 0) {
                    // For each order, calculate how much was spent on seller products by municipality
                    for (const order of orders) {
                        const orderItemsForThisOrder = orderItems.filter(item => item.order_id === order.id);
                        
                        // Group by seller municipality for this order
                        const orderSalesByMunicipality = {};
                        
                        for (const item of orderItemsForThisOrder) {
                            const product = sellerProducts.find(p => p.id === item.product_id);
                            if (product) {
                                const seller = sellerUsers.find(u => u.id === product.user_id);
                                if (seller && seller.municipality) {
                                    const municipality = seller.municipality;
                                    const itemTotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0);
                                    
                                    if (!orderSalesByMunicipality[municipality]) {
                                        orderSalesByMunicipality[municipality] = 0;
                                    }
                                    orderSalesByMunicipality[municipality] += itemTotal;
                                }
                            }
                        }
                        
                        // Add to overall totals
                        for (const [municipality, sales] of Object.entries(orderSalesByMunicipality)) {
                            if (!salesByMunicipality[municipality]) {
                                salesByMunicipality[municipality] = {
                                    municipality: municipality,
                                    totalSales: 0,
                                    orderCount: 0
                                };
                            }
                            salesByMunicipality[municipality].totalSales += sales;
                            salesByMunicipality[municipality].orderCount += 1;
                        }
                    }
                }

                console.log('ðŸ“Š Sales by municipality (seller attribution):', salesByMunicipality);

                // Convert to array and sort by total sales
                const aggregatedData = Object.values(salesByMunicipality)
                    .sort((a, b) => b.totalSales - a.totalSales);

                totalMunicipalities = aggregatedData.length;

                // Get paginated data
                const startIndex = (currentMunicipalityPage - 1) * municipalitiesPerPage;
                const endIndex = startIndex + municipalitiesPerPage;
                const paginatedData = aggregatedData.slice(startIndex, endIndex);

                console.log(`âœ… Final result: ${aggregatedData.length} municipalities found`);
                console.log('ðŸ† Top municipalities by seller sales:', paginatedData);

                updateMunicipalitySalesTable(paginatedData);

            } catch (error) {
                console.error('âŒ Error in loadMunicipalitySalesData:', error);
                updateMunicipalitySalesTable([]);
            }
        }

        // Function to update the municipality sales table
        function updateMunicipalitySalesTable(municipalityData) {
            console.log('ðŸ”„ Updating municipality sales table with data:', municipalityData);
            
            const tableBody = document.getElementById('municipalitySalesTableBody');
            const tableInfo = document.getElementById('municipalitySalesTableInfo');
            
            if (!tableBody) {
                console.error('âŒ Municipality sales table body not found');
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (municipalityData.length === 0) {
                console.log('âš ï¸ No municipality data to display');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            No sales data found. Check browser console for debugging info.
                        </td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }

            console.log(`ðŸ“Š Displaying ${municipalityData.length} municipalities`);

            // Populate table with municipality sales data
            municipalityData.forEach(data => {
                const row = document.createElement('tr');
                
                const formattedSales = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP',
                    minimumFractionDigits: 2
                }).format(data.totalSales);
                
                row.innerHTML = `
                    <td>${data.municipality}</td>
                    <td>${formattedSales}</td>
                    <td>${data.orderCount}</td>
                `;
                tableBody.appendChild(row);
                
                console.log(`ðŸ“ Added row: ${data.municipality} - ${formattedSales} (${data.orderCount} orders)`);
            });

            // Update table info and pagination
            const startItem = ((currentMunicipalityPage - 1) * municipalitiesPerPage) + 1;
            const endItem = Math.min(currentMunicipalityPage * municipalitiesPerPage, totalMunicipalities);
            
            if (tableInfo) {
                tableInfo.textContent = `${startItem} to ${endItem} items of ${totalMunicipalities}`;
            }

            // Update current page button
            const currentMunicipalityPageBtn = document.getElementById('currentMunicipalityPageBtn');
            if (currentMunicipalityPageBtn) {
                currentMunicipalityPageBtn.textContent = currentMunicipalityPage;
            }

            console.log('âœ… Municipality sales table updated successfully');
        }

        // Debug function to manually check municipality data
        async function debugMunicipalityData() {
            console.log('ðŸ” === MANUAL DEBUG: MUNICIPALITY DATA ===');
            
            if (!supabaseClient) {
                console.error('âŒ Supabase client not available');
                alert('Supabase client not available - check connection');
                return;
            }

            try {
                // Check if orders table exists and has data
                console.log('ðŸ“¦ Checking orders table...');
                const { data: ordersCheck, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id, total, status, user_id')
                    .limit(5);
                
                console.log('Orders table check:', { ordersCheck, ordersError });
                
                if (ordersError) {
                    console.error('âŒ Orders table error:', ordersError);
                    alert(`Orders table error: ${ordersError.message}`);
                    return;
                }
                
                if (!ordersCheck || ordersCheck.length === 0) {
                    console.log('âš ï¸ No orders found in database');
                    alert('No orders found in the database. You need to add some orders first.');
                    return;
                }
                
                console.log('âœ… Orders table accessible, sample data:', ordersCheck);
                
                // Check users table
                console.log('ðŸ‘¥ Checking users table...');
                const { data: usersCheck, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id, full_name, municipality')
                    .limit(5);
                
                console.log('Users table check:', { usersCheck, usersError });
                
                if (usersError) {
                    console.error('âŒ Users table error:', usersError);
                    alert(`Users table error: ${usersError.message}`);
                    return;
                }
                
                // Check JOIN query
                console.log('ðŸ”— Testing JOIN query...');
                const { data: joinTest, error: joinError } = await supabaseClient
                    .from('orders')
                    .select(`
                        id,
                        total,
                        status,
                        users!orders_user_id_fkey(
                            id,
                            full_name,
                            municipality
                        )
                    `)
                    .limit(5);
                
                console.log('JOIN test:', { joinTest, joinError });
                
                if (joinError) {
                    console.error('âŒ JOIN query error:', joinError);
                    alert(`JOIN query error: ${joinError.message}`);
                    return;
                }
                
                // Check what statuses are available
                const { data: allOrders, error: allOrdersError } = await supabaseClient
                    .from('orders')
                    .select('id, status, total, users!orders_user_id_fkey(municipality)');
                
                if (allOrdersError) {
                    console.error('âŒ Error fetching all orders:', allOrdersError);
                    return;
                }
                
                const statuses = [...new Set(allOrders.map(o => o.status))];
                console.log('ðŸ“Š Available order statuses:', statuses);
                console.log('ðŸ“Š Orders by status:', 
                    statuses.map(status => ({
                        status,
                        count: allOrders.filter(o => o.status === status).length
                    }))
                );
                
                // Show municipalities
                const municipalities = [...new Set(allOrders.map(o => o.users?.municipality).filter(Boolean))];
                console.log('ï¿½ï¸ Municipalities found in users:', municipalities);
                
                // Now try to load the municipality data
                console.log('ðŸ”„ Triggering loadMunicipalitySalesData...');
                await loadMunicipalitySalesData();
                
            } catch (error) {
                console.error('âŒ Debug error:', error);
                alert(`Debug error: ${error.message}`);
            }
        }

        // Simple test function for municipality data
        async function testMunicipalityData() {
            console.log('ðŸ” === SIMPLE MUNICIPALITY TEST ===');
            
            if (!supabaseClient) {
                alert('Supabase client not available');
                return;
            }

            try {
                // Test the exact query we use for municipality sales
                console.log('ðŸ” Testing municipality sales query...');
                const { data: ordersData, error } = await supabaseClient
                    .from('orders')
                    .select(`
                        total,
                        users!orders_user_id_fkey(municipality)
                    `)
                    .limit(10);
                
                console.log('Municipality sales query result:', { ordersData, error });
                
                if (error) {
                    alert(`Query error: ${error.message}`);
                    return;
                }

                if (!ordersData || ordersData.length === 0) {
                    alert('No orders found in database');
                    return;
                }

                // Analyze the data
                let validSales = 0;
                let totalSales = 0;
                const municipalities = new Set();

                ordersData.forEach(order => {
                    const municipality = order.users?.municipality;
                    const total = parseFloat(order.total || 0);
                    
                    if (municipality && total > 0) {
                        validSales++;
                        totalSales += total;
                        municipalities.add(municipality);
                    }
                });

                const result = `Municipality Sales Test Results:
â€¢ Total orders: ${ordersData.length}
â€¢ Orders with valid sales: ${validSales}
â€¢ Total sales amount: â‚±${totalSales.toFixed(2)}
â€¢ Unique municipalities: ${municipalities.size}
â€¢ Municipalities found: ${Array.from(municipalities).join(', ')}

${validSales > 0 ? 'âœ… Data looks good!' : 'âŒ No valid sales data found'}`;

                console.log(result);
                alert(result);

                // Try to load the actual data if valid
                if (validSales > 0) {
                    console.log('ðŸ”„ Triggering loadMunicipalitySalesData...');
                    await loadMunicipalitySalesData();
                }

            } catch (error) {
                console.error('Test error:', error);
                alert(`Test error: ${error.message}`);
            }
        }

        // Function to change municipality page
        function changeMunicipalityPage(direction) {
            const totalPages = Math.ceil(totalMunicipalities / municipalitiesPerPage);
            
            if (direction === 1 && currentMunicipalityPage < totalPages) {
                currentMunicipalityPage++;
                loadMunicipalitySalesData();
            } else if (direction === -1 && currentMunicipalityPage > 1) {
                currentMunicipalityPage--;
                loadMunicipalitySalesData();
            }
        }

        // Function to show all municipality sales modal
        function showAllMunicipalitySalesModal() {
            const modal = new bootstrap.Modal(document.getElementById('allMunicipalitySalesModal'));
            modal.show();
            loadAllMunicipalitySalesData();
        }

        // Community Analytics Functions
        async function loadCommunityData() {
            try {
                console.log('ðŸš€ === LOADING COMMUNITY DATA ===');
                
                if (!supabaseClient) {
                    console.error('âŒ Supabase client not available');
                    updateCommunityTable([]);
                    return;
                }

                // Step 1: Get all communities first
                console.log('ðŸ“¡ Fetching communities...');
                const { data: communities, error: communitiesError } = await supabaseClient
                    .from('communities')
                    .select(`
                        id,
                        name,
                        created_at,
                        created_by
                    `);
                
                if (communitiesError) {
                    console.error('âŒ Error fetching communities:', communitiesError);
                    updateCommunityTable([]);
                    return;
                }
                
                console.log(`ðŸ“Š Found ${communities?.length || 0} communities`);
                
                if (!communities || communities.length === 0) {
                    console.warn('âš ï¸ No communities found');
                    updateCommunityTable([]);
                    return;
                }

                // Step 2: Get member counts for each community
                console.log('ðŸ“¡ Fetching member counts...');
                const communityData = [];
                for (const community of communities) {
                    const { count, error: countError } = await supabaseClient
                        .from('community_members')
                        .select('*', { count: 'exact', head: true })
                        .eq('community_id', community.id);

                    if (countError) {
                        console.warn(`âš ï¸ Error getting count for community ${community.name}:`, countError);
                    }

                    communityData.push({
                        id: community.id,
                        name: community.name,
                        memberCount: count || 0,
                        createdAt: community.created_at,
                        createdBy: community.created_by
                    });
                }

                // Sort by member count (descending)
                communityData.sort((a, b) => b.memberCount - a.memberCount);

                totalCommunities = communityData.length;

                // Get paginated data
                const startIndex = (currentCommunityPage - 1) * communitiesPerPage;
                const endIndex = startIndex + communitiesPerPage;
                const paginatedData = communityData.slice(startIndex, endIndex);

                console.log(`âœ… Final result: ${communityData.length} communities found`);
                console.log('ðŸ† Top communities:', paginatedData);

                updateCommunityTable(paginatedData);

            } catch (error) {
                console.error('âŒ Error in loadCommunityData:', error);
                updateCommunityTable([]);
            }
        }

        // Function to update the community table
        function updateCommunityTable(communityData) {
            console.log('ðŸ”„ Updating community table with data:', communityData);
            
            const tableBody = document.getElementById('communityTableBody');
            const tableInfo = document.getElementById('communityTableInfo');
            
            if (!tableBody) {
                console.error('âŒ Community table body not found');
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (communityData.length === 0) {
                console.log('âš ï¸ No community data to display');
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center text-muted">
                            <i class="fas fa-info-circle me-2"></i>
                            No communities found.
                        </td>
                    </tr>
                `;
                if (tableInfo) {
                    tableInfo.textContent = '0 items of 0';
                }
                return;
            }

            console.log(`ðŸ“Š Displaying ${communityData.length} communities`);

            // Populate table with community data
            communityData.forEach(data => {
                const row = document.createElement('tr');
                
                const createdDate = new Date(data.createdAt).toLocaleDateString();
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users me-2 text-primary"></i>
                            <strong>${data.name}</strong>
                        </div>
                    </td>
                    <td>
                        <span class="text-success fw-bold">${data.memberCount} members</span>
                    </td>
                    <td>${createdDate}</td>
                `;
                tableBody.appendChild(row);
                
                console.log(`ðŸ˜ï¸ Added row: ${data.name} - ${data.memberCount} members`);
            });

            // Update table info and pagination
            const startItem = ((currentCommunityPage - 1) * communitiesPerPage) + 1;
            const endItem = Math.min(currentCommunityPage * communitiesPerPage, totalCommunities);
            
            if (tableInfo) {
                tableInfo.textContent = `${startItem} to ${endItem} items of ${totalCommunities}`;
            }

            // Update current page button
            const currentCommunityPageBtn = document.getElementById('currentCommunityPageBtn');
            if (currentCommunityPageBtn) {
                currentCommunityPageBtn.textContent = currentCommunityPage;
            }

            console.log('âœ… Community table updated successfully');
        }

        // Function to change community page
        function changeCommunityPage(direction) {
            const totalPages = Math.ceil(totalCommunities / communitiesPerPage);
            
            if (direction === 1 && currentCommunityPage < totalPages) {
                currentCommunityPage++;
                loadCommunityData();
            } else if (direction === -1 && currentCommunityPage > 1) {
                currentCommunityPage--;
                loadCommunityData();
            }
        }

        // Function to show all communities modal
        function showAllCommunitiesModal() {
            const modal = new bootstrap.Modal(document.getElementById('allCommunitiesModal'));
            modal.show();
            loadAllCommunities();
        }

        // Function to load all communities for modal
        async function loadAllCommunities() {
            try {
                const tableBody = document.getElementById('allCommunitiesTableBody');
                const countSpan = document.getElementById('allCommunitiesCount');
                
                if (!tableBody) {
                    console.error('âŒ Communities table body not found');
                    return;
                }

                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Loading communities...</td></tr>';

                if (!supabaseClient) {
                    console.error('âŒ Supabase client not available');
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Database connection not available</td></tr>';
                    return;
                }

                console.log('ðŸ”„ Loading all communities for modal...');

                // Step 1: Get all communities first
                const { data: communities, error: communitiesError } = await supabaseClient
                    .from('communities')
                    .select(`
                        id,
                        name,
                        created_at,
                        created_by
                    `);

                if (communitiesError) {
                    console.error('âŒ Error loading communities:', communitiesError);
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading communities</td></tr>';
                    return;
                }

                console.log(`ðŸ“Š Found ${communities?.length || 0} communities`);

                if (!communities || communities.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No communities found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 communities found';
                    return;
                }

                // Step 2: Get member counts for each community
                const communitiesWithCounts = [];
                for (const community of communities) {
                    const { count, error: countError } = await supabaseClient
                        .from('community_members')
                        .select('*', { count: 'exact', head: true })
                        .eq('community_id', community.id);

                    if (countError) {
                        console.warn(`âš ï¸ Error getting count for community ${community.name}:`, countError);
                    }

                    communitiesWithCounts.push({
                        ...community,
                        memberCount: count || 0
                    });
                }

                console.log('ðŸ“Š Communities with member counts:', communitiesWithCounts);

                // Sort by member count (descending)
                communitiesWithCounts.sort((a, b) => b.memberCount - a.memberCount);

                // Clear table and populate with data
                tableBody.innerHTML = '';
                
                communitiesWithCounts.forEach(community => {
                    const row = document.createElement('tr');
                    const createdDate = new Date(community.created_at).toLocaleDateString();
                    const creatorName = 'Admin'; // Simplified - can be enhanced later
                    
                    row.innerHTML = `
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-users me-2 text-primary"></i>
                                <strong>${community.name}</strong>
                            </div>
                        </td>
                        <td>
                            <span class="text-success fw-bold">${community.memberCount} members</span>
                        </td>
                        <td>${createdDate}</td>
                        <td>${creatorName}</td>
                    `;
                    tableBody.appendChild(row);
                    
                    console.log(`ðŸ˜ï¸ Added community: ${community.name} - ${community.memberCount} members`);
                });

                if (countSpan) {
                    countSpan.textContent = `${communitiesWithCounts.length} communities found`;
                }

                // Store data for search functionality
                window.allCommunityData = communitiesWithCounts;
                
                // Setup search functionality
                setupCommunitySearch();

                console.log(`âœ… All communities modal loaded with ${communitiesWithCounts.length} communities`);

            } catch (error) {
                console.error('âŒ Error in loadAllCommunities:', error);
                const tableBody = document.getElementById('allCommunitiesTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading data</td></tr>';
                }
            }
        }

        // Export functions for communities
        function exportAllCommunities(format) {
            console.log(`Exporting all communities as ${format}`);
            // Implementation for CSV/PDF export would go here
            alert(`Community export in ${format.toUpperCase()} format - Feature coming soon!`);
        }

        // Search functionality for municipality modal
        function setupMunicipalitySearch() {
            const searchInput = document.getElementById('municipalitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filterMunicipalityData(searchTerm);
                });
            }
        }

        function filterMunicipalityData(searchTerm) {
            if (!window.allMunicipalityData) return;
            
            const filteredData = window.allMunicipalityData.filter(data => 
                data.municipality.toLowerCase().includes(searchTerm)
            );
            
            updateMunicipalityModalTable(filteredData);
        }

        function updateMunicipalityModalTable(data) {
            const tableBody = document.getElementById('allMunicipalitySalesTableBody');
            const countSpan = document.getElementById('allMunicipalitySalesCount');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No municipalities found</td></tr>';
                if (countSpan) countSpan.textContent = '0 municipalities found';
                return;
            }
            
            data.forEach(municipality => {
                const row = document.createElement('tr');
                
                const formattedSales = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP',
                    minimumFractionDigits: 2
                }).format(municipality.totalSales);
                
                row.innerHTML = `
                    <td><strong>${municipality.municipality}</strong></td>
                    <td>${formattedSales}</td>
                    <td>${municipality.orderCount}</td>
                `;
                tableBody.appendChild(row);
            });
            
            if (countSpan) {
                countSpan.textContent = `${data.length} municipalities found`;
            }
        }

        // Search functionality for community modal
        function setupCommunitySearch() {
            const searchInput = document.getElementById('communitySearchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    filterCommunityData(searchTerm);
                });
            }
        }

        function filterCommunityData(searchTerm) {
            if (!window.allCommunityData) return;
            
            const filteredData = window.allCommunityData.filter(data => 
                data.name.toLowerCase().includes(searchTerm) ||
                (data.users?.full_name || '').toLowerCase().includes(searchTerm)
            );
            
            updateCommunityModalTable(filteredData);
        }

        function updateCommunityModalTable(data) {
            const tableBody = document.getElementById('allCommunitiesTableBody');
            const countSpan = document.getElementById('allCommunitiesCount');
            
            if (!tableBody) return;
            
            tableBody.innerHTML = '';
            
            if (data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No communities found</td></tr>';
                if (countSpan) countSpan.textContent = '0 communities found';
                return;
            }
            
            data.forEach(community => {
                const row = document.createElement('tr');
                const memberCount = community.community_members?.[0]?.count || 0;
                const createdDate = new Date(community.created_at).toLocaleDateString();
                const creatorName = community.users?.full_name || 'Unknown';
                
                row.innerHTML = `
                    <td>
                        <div class="d-flex align-items-center">
                            <i class="fas fa-users me-2 text-primary"></i>
                            <strong>${community.name}</strong>
                        </div>
                    </td>
                    <td>
                        <span class="text-success fw-bold">${memberCount} members</span>
                    </td>
                    <td>${createdDate}</td>
                    <td>${creatorName}</td>
                `;
                tableBody.appendChild(row);
            });
            
            if (countSpan) {
                countSpan.textContent = `${data.length} communities found`;
            }
        }

        // Function to load all municipality sales data for modal
        async function loadAllMunicipalitySalesData() {
            try {
                const tableBody = document.getElementById('allMunicipalitySalesTableBody');
                const countSpan = document.getElementById('allMunicipalitySalesCount');
                
                if (!tableBody) return;

                tableBody.innerHTML = '<tr><td colspan="3" class="text-center">Loading municipality sales...</td></tr>';

                if (!supabaseClient) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Database connection not available</td></tr>';
                    return;
                }

                console.log('ðŸ”„ Loading all municipality sales for modal...');

                // Use the same logic as the main function - seller attribution
                // Step 1: Get all sellers
                const { data: sellers, error: sellersError } = await supabaseClient
                    .from('store-owner')
                    .select('user_id');
                
                if (sellersError || !sellers || sellers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No sellers found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Step 2: Get seller details with municipality
                const sellerUserIds = sellers.map(seller => seller.user_id);
                const { data: sellerUsers, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id, full_name, municipality')
                    .in('id', sellerUserIds);
                
                if (usersError || !sellerUsers || sellerUsers.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No seller users found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Step 3: Get products for these sellers
                const { data: sellerProducts, error: productsError } = await supabaseClient
                    .from('my_products')
                    .select('id, user_id, name')
                    .in('user_id', sellerUserIds);
                
                if (productsError || !sellerProducts || sellerProducts.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No products found from sellers</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Step 4: Get order items for these products
                const productIds = sellerProducts.map(product => product.id);
                const { data: orderItems, error: orderItemsError } = await supabaseClient
                    .from('order_items')
                    .select('id, order_id, product_id, quantity, price')
                    .in('product_id', productIds);
                
                if (orderItemsError || !orderItems || orderItems.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No order items found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Step 5: Get orders (all statuses)
                const orderIds = [...new Set(orderItems.map(item => item.order_id))];
                const { data: orders, error: ordersError } = await supabaseClient
                    .from('orders')
                    .select('id, user_id, total, created_at, status')
                    .in('id', orderIds);
                
                if (ordersError || !orders || orders.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No orders found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Step 6: Calculate sales by municipality (seller attribution)
                const salesByMunicipality = {};
                
                for (const order of orders) {
                    const orderItemsForThisOrder = orderItems.filter(item => item.order_id === order.id);
                    
                    for (const item of orderItemsForThisOrder) {
                        const product = sellerProducts.find(p => p.id === item.product_id);
                        if (product) {
                            const seller = sellerUsers.find(u => u.id === product.user_id);
                            if (seller && seller.municipality) {
                                const municipality = seller.municipality;
                                const itemTotal = (parseFloat(item.price) || 0) * (parseInt(item.quantity) || 0);
                                
                                if (!salesByMunicipality[municipality]) {
                                    salesByMunicipality[municipality] = {
                                        municipality: municipality,
                                        totalSales: 0,
                                        orderCount: 0
                                    };
                                }
                                salesByMunicipality[municipality].totalSales += itemTotal;
                                salesByMunicipality[municipality].orderCount += 1;
                            }
                        }
                    }
                }

                console.log('ðŸ“Š All municipality sales calculated:', salesByMunicipality);

                // Convert to array and sort by total sales
                const aggregatedData = Object.values(salesByMunicipality)
                    .sort((a, b) => b.totalSales - a.totalSales);

                if (aggregatedData.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">No sales data found</td></tr>';
                    if (countSpan) countSpan.textContent = '0 municipalities found';
                    return;
                }

                // Clear table and populate with all data
                tableBody.innerHTML = '';
                
                aggregatedData.forEach(data => {
                    const row = document.createElement('tr');
                    
                    const formattedSales = new Intl.NumberFormat('en-PH', {
                        style: 'currency',
                        currency: 'PHP',
                        minimumFractionDigits: 2
                    }).format(data.totalSales);
                    
                    row.innerHTML = `
                        <td><strong>${data.municipality}</strong></td>
                        <td>${formattedSales}</td>
                        <td>${data.orderCount}</td>
                    `;
                    tableBody.appendChild(row);
                });

                if (countSpan) {
                    countSpan.textContent = `${aggregatedData.length} municipalities found`;
                }

                console.log(`âœ… All municipality sales modal loaded with ${aggregatedData.length} municipalities`);

                // Store data for search functionality
                window.allMunicipalityData = aggregatedData;
                
                // Setup search functionality
                setupMunicipalitySearch();

            } catch (error) {
                console.error('Error in loadAllMunicipalitySalesData:', error);
                const tableBody = document.getElementById('allMunicipalitySalesTableBody');
                if (tableBody) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">Error loading data</td></tr>';
                }
            }
        }

        // Function to export municipality sales data
        function exportAllMunicipalitySales(format) {
            if (!window.allMunicipalityData || window.allMunicipalityData.length === 0) {
                alert('No data to export');
                return;
            }

            if (format === 'csv') {
                exportMunicipalitySalesCSV();
            } else if (format === 'pdf') {
                exportMunicipalitySalesPDF();
            }
        }

        function exportMunicipalitySalesCSV() {
            const csvContent = [
                ['Municipality', 'Total Sales', 'Number of Orders'],
                ...window.allMunicipalityData.map(data => [
                    data.municipality,
                    data.totalSales.toFixed(2),
                    data.orderCount
                ])
            ].map(row => row.join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'municipality_sales.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        function exportMunicipalitySalesPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            doc.setFontSize(16);
            doc.text('Top Municipality Sales Report', 20, 20);

            let yPosition = 40;
            doc.setFontSize(12);
            doc.text('Municipality', 20, yPosition);
            doc.text('Total Sales', 80, yPosition);
            doc.text('Orders', 140, yPosition);

            yPosition += 10;
            window.allMunicipalityData.forEach(data => {
                if (yPosition > 270) {
                    doc.addPage();
                    yPosition = 20;
                }
                
                const formattedSales = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP',
                    minimumFractionDigits: 2
                }).format(data.totalSales);
                
                doc.text(data.municipality, 20, yPosition);
                doc.text(formattedSales, 80, yPosition);
                doc.text(data.orderCount.toString(), 140, yPosition);
                yPosition += 10;
            });

            doc.save('municipality_sales.pdf');
        }

        // Function to load and populate sales chart with real data
        async function loadTotalSalesData() {
            try {
                console.log('=== LOADING SALES CHART DATA ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateSalesChartWithFallback();
                    return;
                }

                // First, let's test if we can access the orders table
                const { data: ordersTest, error: testError } = await supabaseClient
                    .from('orders')
                    .select('*')
                    .limit(5);

                console.log('Orders table test:', { data: ordersTest, error: testError });

                if (testError) {
                    console.error('Cannot access orders table:', testError);
                    updateSalesChartWithFallback();
                    return;
                }

                // Fetch all orders for chart data
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('total, created_at, status');

                if (error) {
                    console.error('Database error fetching orders:', error);
                    updateSalesChartWithFallback();
                    return;
                }

                console.log('Orders fetched for chart:', { 
                    count: orders?.length || 0, 
                    sampleData: orders?.slice(0, 3) 
                });

                if (!orders || orders.length === 0) {
                    console.log('No orders found, using sample data for chart');
                    updateSalesChartWithSampleData();
                    return;
                }

                // Process data for chart (group by month)
                const chartData = processOrdersForChart(orders);
                
                console.log('Chart data processed:', chartData);
                updateSalesChartWithData(chartData);

            } catch (error) {
                console.error('Error in loadTotalSalesData:', error);
                updateSalesChartWithFallback();
            }
        }

        // Function to process orders data for chart display
        function processOrdersForChart(orders) {
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            const currentYear = new Date().getFullYear();
            
            // Initialize monthly data
            const monthlyData = {};
            monthNames.forEach(month => {
                monthlyData[month] = 0;
            });

            // Group orders by month
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    const monthName = monthNames[orderDate.getMonth()];
                    const orderTotal = parseFloat(order.total) || 0;
                    monthlyData[monthName] += orderTotal;
                }
            });

            console.log('Monthly sales data:', monthlyData);

            return {
                labels: monthNames,
                data: monthNames.map(month => monthlyData[month])
            };
        }

        // Function to update sales chart with real data
        function updateSalesChartWithData(chartData) {
            if (!salesChart) {
                console.error('Sales chart not initialized');
                return;
            }

            if (!chartData || !chartData.labels || !chartData.data) {
                console.error('Invalid chart data provided');
                return;
            }

            // Store data globally for export functions
            currentSalesData = {
                labels: [...chartData.labels],
                data: [...chartData.data]
            };
            currentSalesPeriod = document.getElementById('salesFilter')?.value || 'monthly';

            // Update chart data
            salesChart.data.labels = chartData.labels;
            salesChart.data.datasets[0].data = chartData.data;
            
            // Update chart label based on data type
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let datasetLabel = 'Sales (PHP)';
            
            switch (period) {
                case 'weekly':
                    datasetLabel = 'Weekly Sales';
                    break;
                case 'yearly':
                    datasetLabel = 'Annual Sales';
                    break;
                case 'monthly':
                default:
                    datasetLabel = 'Monthly Sales';
                    break;
            }
            
            salesChart.data.datasets[0].label = datasetLabel;
            salesChart.update('active');
            console.log(`âœ… Sales chart updated with real ${period} data`);
        }

        // Function to show sample data when no real data is available
        function updateSalesChartWithSampleData() {
            if (!salesChart) return;
            
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let sampleData;
            
            switch (period) {
                case 'weekly':
                    sampleData = {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        data: [0, 0, 0, 0] // Total: 14220
                    };
                    break;
                case 'yearly':
                    sampleData = {
                        labels: ['2021', '2022', '2023', '2024', '2025'],
                        data: [0, 0, 0, 0, 0]
                    };
                    break;
                case 'monthly':
                default:
                    sampleData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        data: [0, 0, 0, 0, 0, 0, 0, 14220, 0, 0, 0, 0] // Show data for August (current month)
                    };
                    break;
            }
            
            // Store sample data globally for export
            currentSalesData = {
                labels: [...sampleData.labels],
                data: [...sampleData.data]
            };
            currentSalesPeriod = period;
            
            salesChart.data.labels = sampleData.labels;
            salesChart.data.datasets[0].data = sampleData.data;
            salesChart.data.datasets[0].label = period === 'weekly' ? 'Weekly Sales' : 
                                               period === 'yearly' ? 'Annual Sales' : 'Monthly Sales';
            salesChart.update();
            console.log(`âœ… Sales chart updated with sample ${period} data (no real orders found)`);
        }

        // Function to show fallback chart when there are errors
        function updateSalesChartWithFallback() {
            if (!salesChart) return;
            
            const period = document.getElementById('salesFilter')?.value || 'monthly';
            let fallbackData;
            
            switch (period) {
                case 'weekly':
                    fallbackData = {
                        labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                        data: [0, 0, 0, 0]
                    };
                    break;
                case 'yearly':
                    fallbackData = {
                        labels: ['2021', '2022', '2023', '2024', '2025'],
                        data: [0, 0, 0, 0, 0]
                    };
                    break;
                case 'monthly':
                default:
                    fallbackData = {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        data: [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
                    };
                    break;
            }
            
            // Store fallback data globally for export
            currentSalesData = {
                labels: [...fallbackData.labels],
                data: [...fallbackData.data]
            };
            currentSalesPeriod = period;
            
            salesChart.data.labels = fallbackData.labels;
            salesChart.data.datasets[0].data = fallbackData.data;
            salesChart.data.datasets[0].label = period === 'weekly' ? 'Weekly Sales' : 
                                               period === 'yearly' ? 'Annual Sales' : 'Monthly Sales';
            salesChart.update();
            console.log(`âœ… Sales chart updated with fallback ${period} demo data`);
        }

        // Function to show all users modal
        function showAllUsersModal() {
            const modal = new bootstrap.Modal(document.getElementById('allUsersModal'));
            modal.show();
            // Handle async loadAllUsers call with proper error handling
            loadAllUsers().catch(error => {
                console.error('Error loading all users:', error);
            });
        }

        // Function to load all users for the modal
        async function loadAllUsers() {
            try {
                console.log('=== LOADING ALL USERS ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateAllUsersTable([]);
                    return;
                }

                // Fetch all users from the users table
                const { data: users, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('Database error fetching all users:', error);
                    updateAllUsersTable([]);
                    return;
                }

                console.log('âœ… All users data fetched:', users);
                updateAllUsersTable(users || []);
                
                // Store data globally for search functionality
                window.allUsersData = users || [];
                
                // Setup search functionality
                setupUserSearch();

            } catch (error) {
                console.error('Error in loadAllUsers:', error);
                updateAllUsersTable([]);
            }
        }

        // Function to update the all users modal table
        function updateAllUsersTable(users) {
            const tableBody = document.getElementById('allUsersTableBody');
            const usersCount = document.getElementById('allUsersCount');
            
            if (!tableBody) {
                console.error('âŒ All users table body not found');
                return;
            }

            // Clear existing content
            tableBody.innerHTML = '';

            if (users.length === 0) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="3" class="text-center">No users found</td>
                    </tr>
                `;
                if (usersCount) {
                    usersCount.textContent = '0 users found';
                }
                return;
            }

            // Populate table with user data (simplified to match main table)
            users.forEach(user => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${user.full_name || user.name || user.email || 'N/A'}</td>
                    <td>${user.email || 'N/A'}</td>
                    <td>${user.phone_number || user.phone || 'N/A'}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update count
            if (usersCount) {
                usersCount.textContent = `${users.length} users found`;
            }

            console.log('âœ… All users modal table updated with', users.length, 'users');
        }

        // Function to setup user search functionality
        function setupUserSearch() {
            const searchInput = document.getElementById('userSearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!window.allUsersData) return;

                const filteredUsers = window.allUsersData.filter(user => {
                    const name = (user.full_name || user.name || '').toLowerCase();
                    const email = (user.email || '').toLowerCase();
                    const role = (user.user_type || user.role || 'user').toLowerCase();
                    const phone = (user.phone_number || user.phone || '').toLowerCase();
                    
                    return name.includes(searchTerm) || 
                           email.includes(searchTerm) || 
                           role.includes(searchTerm) ||
                           phone.includes(searchTerm);
                });

                updateAllUsersTable(filteredUsers);
            });
        }

        // Setup municipality search functionality
        function setupMunicipalitySearch() {
            const searchInput = document.getElementById('municipalitySearchInput');
            if (!searchInput) return;

            searchInput.addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                
                if (!window.allMunicipalityData) return;

                const filteredMunicipalities = window.allMunicipalityData.filter(data => {
                    const municipality = (data.municipality || '').toLowerCase();
                    
                    return municipality.includes(searchTerm);
                });

                updateAllMunicipalitySalesTable(filteredMunicipalities);
            });
        }

        // Function to update all municipality sales table in modal
        function updateAllMunicipalitySalesTable(municipalityData) {
            const tableBody = document.getElementById('allMunicipalitySalesTableBody');
            const countSpan = document.getElementById('allMunicipalitySalesCount');
            
            if (!tableBody) return;

            tableBody.innerHTML = '';

            if (municipalityData.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="3" class="text-center">No municipalities found</td></tr>';
                if (countSpan) countSpan.textContent = '0 municipalities found';
                return;
            }

            municipalityData.forEach(data => {
                const row = document.createElement('tr');
                
                const formattedSales = new Intl.NumberFormat('en-PH', {
                    style: 'currency',
                    currency: 'PHP',
                    minimumFractionDigits: 2
                }).format(data.totalSales);
                
                row.innerHTML = `
                    <td>${data.municipality}</td>
                    <td>${formattedSales}</td>
                    <td>${data.orderCount}</td>
                `;
                tableBody.appendChild(row);
            });

            if (countSpan) {
                countSpan.textContent = `${municipalityData.length} municipalities found`;
            }
        }

        // Function to export all users data
        function exportAllUsers(format) {
            if (!window.allUsersData || window.allUsersData.length === 0) {
                alert('No users data to export');
                return;
            }

            if (format === 'csv') {
                exportUsersToCSV();
            } else if (format === 'pdf') {
                exportUsersToPDF();
            }
        }

        // Function to export users to CSV
        function exportUsersToCSV() {
            const headers = ['Name', 'Email', 'Contact Number', 'Role', 'Date Joined', 'Status'];
            let csvContent = headers.join(',') + '\n';

            window.allUsersData.forEach(user => {
                const dateJoined = user.created_at ? 
                    new Date(user.created_at).toLocaleDateString('en-US') : 'N/A';
                
                let role = 'User';
                if (user.user_type) {
                    role = user.user_type;
                } else if (user.role) {
                    role = user.role;
                } else if (user.is_admin) {
                    role = 'Admin';
                }

                let status = 'Active';
                if (user.is_active === false) {
                    status = 'Inactive';
                } else if (user.email_verified === false) {
                    status = 'Unverified';
                }

                const row = [
                    user.full_name || user.name || user.email || 'N/A',
                    user.email || 'N/A',
                    user.phone_number || user.phone || 'N/A',
                    role,
                    dateJoined,
                    status
                ].map(field => `"${field}"`).join(',');
                
                csvContent += row + '\n';
            });

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `all_users_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Function to export users to PDF
        function exportUsersToPDF() {
            // Create a temporary table for PDF export
            const tempTable = document.createElement('table');
            tempTable.style.width = '100%';
            tempTable.style.borderCollapse = 'collapse';
            
            const headers = ['Name', 'Email', 'Contact', 'Role', 'Date Joined', 'Status'];
            const thead = tempTable.createTHead();
            const headerRow = thead.insertRow();
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.style.border = '1px solid #ddd';
                th.style.padding = '8px';
                th.style.backgroundColor = '#f5f5f5';
                headerRow.appendChild(th);
            });

            const tbody = tempTable.createTBody();
            window.allUsersData.forEach(user => {
                const row = tbody.insertRow();
                
                const dateJoined = user.created_at ? 
                    new Date(user.created_at).toLocaleDateString('en-US') : 'N/A';
                
                let role = 'User';
                if (user.user_type) {
                    role = user.user_type;
                } else if (user.role) {
                    role = user.role;
                } else if (user.is_admin) {
                    role = 'Admin';
                }

                let status = 'Active';
                if (user.is_active === false) {
                    status = 'Inactive';
                } else if (user.email_verified === false) {
                    status = 'Unverified';
                }

                const data = [
                    user.full_name || user.name || user.email || 'N/A',
                    user.email || 'N/A',
                    user.phone_number || user.phone || 'N/A',
                    role,
                    dateJoined,
                    status
                ];

                data.forEach(cellData => {
                    const td = row.insertCell();
                    td.textContent = cellData;
                    td.style.border = '1px solid #ddd';
                    td.style.padding = '8px';
                });
            });

            // Use html2canvas and jsPDF to create PDF
            html2canvas(tempTable).then(canvas => {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF();
                
                const imgData = canvas.toDataURL('image/png');
                const imgWidth = 210;
                const pageHeight = 295;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;
                let heightLeft = imgHeight;
                
                let position = 0;
                
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
                
                while (heightLeft >= 0) {
                    position = heightLeft - imgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                }
                
                pdf.save(`all_users_${new Date().toISOString().split('T')[0]}.pdf`);
            });
        }

        // Function to load active farmers count from database
        async function loadActiveFarmersCount() {
            try {
                console.log('=== LOADING ACTIVE FARMERS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateActiveFarmersDisplay(0);
                    return;
                }

                // Fetch count of farmers from the store-owner table
                const { data, error, count } = await supabaseClient
                    .from('store-owner')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching farmers count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('store-owner')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateActiveFarmersDisplay(0);
                    } else {
                        const farmersCount = fallbackData ? fallbackData.length : 0;
                        console.log('âœ… Farmers count (fallback method):', farmersCount);
                        updateActiveFarmersDisplay(farmersCount);
                    }
                    return;
                }

                const farmersCount = count || 0;
                console.log('âœ… Farmers count from database:', farmersCount);
                updateActiveFarmersDisplay(farmersCount);

            } catch (error) {
                console.error('Error in loadActiveFarmersCount:', error);
                updateActiveFarmersDisplay(0);
            }
        }

        // Function to update the active farmers display
        function updateActiveFarmersDisplay(count) {
            const activeFarmersElement = document.getElementById('activeFarmersCount');
            if (activeFarmersElement) {
                const displayText = count === 1 ? `${count} Farmer` : `${count} Farmers`;
                activeFarmersElement.textContent = displayText;
                console.log('âœ… Updated active farmers display to:', displayText);
            } else {
                console.error('âŒ Active farmers count element not found');
            }
        }

        // Function to load available products count from database
        async function loadAvailableProductsCount() {
            try {
                console.log('=== LOADING AVAILABLE PRODUCTS COUNT ===');
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    updateAvailableProductsDisplay(0);
                    return;
                }

                // Count total products from the my_products table
                const { data, error, count } = await supabaseClient
                    .from('my_products')
                    .select('*', { count: 'exact', head: true });

                if (error) {
                    console.error('Database error fetching products count:', error);
                    // Fallback: try to get actual data and count it
                    const { data: fallbackData, error: fallbackError } = await supabaseClient
                        .from('my_products')
                        .select('id');
                    
                    if (fallbackError) {
                        console.error('Fallback query also failed:', fallbackError);
                        updateAvailableProductsDisplay(0);
                    } else {
                        const productsCount = fallbackData ? fallbackData.length : 0;
                        console.log('âœ… Products count (fallback method):', productsCount);
                        updateAvailableProductsDisplay(productsCount);
                    }
                    return;
                }

                const productsCount = count || 0;
                console.log('âœ… Products count from my_products table:', productsCount);
                updateAvailableProductsDisplay(productsCount);

            } catch (error) {
                console.error('Error in loadAvailableProductsCount:', error);
                updateAvailableProductsDisplay(0);
            }
        }

        // Function to update the available products display
        function updateAvailableProductsDisplay(count) {
            const availableProductsElement = document.getElementById('availableProductsCount');
            if (availableProductsElement) {
                const displayText = count === 1 ? `${count} Product` : `${count} Products`;
                availableProductsElement.textContent = displayText;
                console.log('âœ… Updated available products display to:', displayText);
            } else {
                console.error('âŒ Available products count element not found');
            }
        }

        // Test function to verify profile update works
        function testProfileUpdate() {
            console.log('Testing profile update with sample data...');
            updateProfileDisplay({
                name: 'Test User',
                email: 'test@anihan.gov.ph',
                user_type: 'SUPER ADMIN',
                image_url: null
            });
        }

        // Make test function available globally for console testing
        window.testProfileUpdate = testProfileUpdate;

        // Chart.js Analytics Implementation
        const allAnalytics = [
            {category: "Sales", metric: "Rice Sales", value: "â‚±950,000", location: "Quezon Province", period: "Monthly", growth: "+15.2%", status: "High"},
            {category: "Sales", metric: "Vegetable Sales", value: "â‚±750,000", location: "Bataan Province", period: "Monthly", growth: "+8.7%", status: "Good"},
            {category: "Stocks", metric: "Total Inventory", value: "15,750 tons", location: "All Warehouses", period: "Daily", growth: "+2.1%", status: "85% Capacity"},
            {category: "Stocks", metric: "Rice Stock", value: "8,200 tons", location: "Central Warehouse", period: "Daily", growth: "+5.3%", status: "Available"},
            {category: "Stocks", metric: "Vegetable Stock", value: "4,850 tons", location: "Regional Warehouses", period: "Daily", growth: "-1.5%", status: "Low Stock"},
            {category: "Soil", metric: "pH Level Optimal", value: "92%", location: "All Farmlands", period: "Weekly", growth: "+3.2%", status: "Excellent"},
            {category: "Soil", metric: "Nutrient Rich", value: "87%", location: "Organic Farms", period: "Weekly", growth: "+4.8%", status: "Good"},
            {category: "Soil", metric: "Moisture Content", value: "78%", location: "Irrigated Areas", period: "Weekly", growth: "-0.5%", status: "Adequate"},
            {category: "Hectare", metric: "Active Farmland", value: "8,450 ha", location: "All Regions", period: "Quarterly", growth: "+6.7%", status: "Expanding"},
            {category: "Hectare", metric: "Rice Production Area", value: "4,200 ha", location: "Quezon Province", period: "Quarterly", growth: "+8.9%", status: "High Yield"},
            {category: "Hectare", metric: "Vegetable Production Area", value: "2,150 ha", location: "Bataan Province", period: "Quarterly", growth: "+5.4%", status: "Productive"}
        ];
        
        let filteredAnalytics = [...allAnalytics];

        // Export Functions (Dashboard Style)
        function exportChart(chartType, format) {
            const chartMap = {
                sales: salesChart,
                stocks: stocksChart,
                soil: soilChart,
                hectare: hectareChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_super_admin_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
                case 'picture':
                    exportToPicture(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = '';
            let headers = '';
            let dataRows = '';
            
            if (chartType === 'sales' && currentSalesData) {
                // Use real sales data
                headers = 'Period,Sales Amount (PHP)\n';
                currentSalesData.labels.forEach((label, index) => {
                    const value = currentSalesData.data[index] || 0;
                    dataRows += `${label},${value.toFixed(2)}\n`;
                });
                csv = headers + dataRows;
            } else {
                // Fallback to chart data for other chart types
                csv = 'Label,Value\n';
                
                const chartMap = {
                    sales: salesChart,
                    stocks: stocksChart,
                    soil: soilChart,
                    hectare: hectareChart
                };
                    
                const chart = chartMap[chartType];
                if (chart && chart.data) {
                    chart.data.labels.forEach((label, index) => {
                        const value = chart.data.datasets[0].data[index];
                        csv += `${label},${value}\n`;
                    });
                }
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const targetElement = document.querySelector('#' + chartType + 'Chart');
            
            if (targetElement) {
                html2canvas(targetElement).then(canvas => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF();
                    const imgData = canvas.toDataURL('image/png');
                    doc.addImage(imgData, 'PNG', 10, 10, 190, 100);
                    doc.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            console.log('ðŸ“ Exporting to Word:', chartType);
            const targetElement = document.querySelector('#' + chartType + 'Chart');
            
            if (targetElement) {
                html2canvas(targetElement).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Prepare data table HTML based on chart type
                    let dataTableHTML = '';
                    
                    if (chartType === 'sales' && currentSalesData) {
                        console.log('ðŸ“Š Processing sales data...');
                        dataTableHTML = `
                            <h2>Sales Data Table</h2>
                            <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left;">Period</th>
                                        <th style="padding: 10px; text-align: right;">Sales Amount (PHP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        currentSalesData.labels.forEach((label, index) => {
                            const value = currentSalesData.data[index] || 0;
                            const formattedValue = new Intl.NumberFormat('en-PH', {
                                style: 'currency',
                                currency: 'PHP',
                                minimumFractionDigits: 2
                            }).format(value);
                            
                            dataTableHTML += `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedValue}</td>
                                </tr>
                            `;
                        });
                        
                        // Calculate total
                        const total = currentSalesData.data.reduce((sum, value) => sum + (value || 0), 0);
                        const formattedTotal = new Intl.NumberFormat('en-PH', {
                            style: 'currency',
                            currency: 'PHP',
                            minimumFractionDigits: 2
                        }).format(total);
                        
                        dataTableHTML += `
                                    <tr style="background-color: #e9ecef; font-weight: bold;">
                                        <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedTotal}</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    } else if (chartType === 'soil' && typeof soilChart !== 'undefined' && soilChart) {
                        console.log('ðŸŒ± Processing soil data...');
                        const soilData = soilChart.data;
                        console.log('Soil chart data:', soilData);
                        
                        if (soilData && soilData.labels && soilData.datasets && soilData.datasets[0]) {
                            dataTableHTML = `
                                <h2>Soil Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Soil Type</th>
                                            <th style="padding: 10px; text-align: right;">Percentage (%)</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            const labels = soilData.labels;
                            const data = soilData.datasets[0].data;
                            let total = 0;
                            
                            labels.forEach((label, index) => {
                                const value = data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}%</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}%</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('âš ï¸ Soil chart data not available');
                            dataTableHTML = `<p><em>No soil data available for export.</em></p>`;
                        }
                    } else if (chartType === 'hectare' && typeof hectareChart !== 'undefined' && hectareChart) {
                        console.log('ðŸ“Š Processing hectare data...');
                        const hectareData = hectareChart.data;
                        console.log('Hectare chart data:', hectareData);
                        
                        if (hectareData && hectareData.labels && hectareData.datasets && hectareData.datasets[0]) {
                            dataTableHTML = `
                                <h2>Hectare Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Hectares</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            const labels = hectareData.labels;
                            const data = hectareData.datasets[0].data;
                            let total = 0;
                            
                            labels.forEach((label, index) => {
                                const value = data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value} ha</td>
                                    </tr>
                                `;
                            });
                            
                            // Calculate average
                            const average = (total / labels.length).toFixed(1);
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total} ha</td>
                                        </tr>
                                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Average</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${average} ha</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('âš ï¸ Hectare chart data not available');
                            dataTableHTML = `<p><em>No hectare data available for export.</em></p>`;
                        }
                    } else {
                        console.warn('âš ï¸ Chart data not available for:', chartType);
                        dataTableHTML = `<p><em>No data available for ${chartType} chart.</em></p>`;
                    }
                    
                    const content = `
                        <html>
                        <head>
                            <title>Super Admin ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
                                h2 { color: #495057; margin-top: 30px; }
                                .report-info { background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; }
                                .chart-container { text-align: center; margin: 30px 0; }
                                table { font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <h1>Super Admin ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            
                            <div class="report-info">
                                <strong>Report Generated:</strong> ${new Date().toLocaleDateString('en-PH', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}<br>
                                <strong>Period:</strong> ${currentSalesPeriod || 'Monthly'}<br>
                                <strong>Chart Type:</strong> ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}
                            </div>
                            
                            <div class="chart-container">
                                <h2>Chart Visualization</h2>
                                <img src="${imgData}" style="max-width: 100%; height: auto; border: 1px solid #ddd; padding: 10px;">
                            </div>
                            
                            ${dataTableHTML}
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #6c757d;">
                                <p>This report was automatically generated by the Anihan Super Admin Dashboard.</p>
                            </div>
                        </body>
                        </html>
                    `;
                    const blob = new Blob([content], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

        function exportToPicture(chartType, filename) {
            const targetElement = document.querySelector('#' + chartType + 'Chart');
            
            if (targetElement) {
                html2canvas(targetElement).then(canvas => {
                    const link = document.createElement('a');
                    link.download = filename + '.png';
                    link.href = canvas.toDataURL();
                    link.click();
                });
            }
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('show');
        }

        // Mobile sidebar functions - CSS only, no duplicate positioning
        function toggleMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) {
                // Add navigation content when opening
                if (!sidebar.classList.contains('mobile-open')) {
                    const mobileMenuContent = `
                        <div class="nav flex-column nav-pills">
                            <a class="nav-link active" href="dashboard_super_admin.html">Dashboard</a>
                            <a class="nav-link" href="admin_accounts.html">Admin Accounts</a>
                            <a class="nav-link" href="for_approval.html">For Approval</a>
                            <a class="nav-link" href="approved_application.html">Approved Applications</a>
                            <a class="nav-link" href="add_voucher.html">Add Voucher</a>
                            <a class="nav-link" href="voucher_records.html">Voucher Records</a>
                            <a class="nav-link" href="inventory_records.html">Inventory Records</a>
                            <a class="nav-link" href="price_monitoring.html">Price Monitoring</a>
                            <a class="nav-link" href="in_demand_products.html">In Demand Products</a>
                            <a class="nav-link" href="sales_per_location.html">Sales Per Location</a>
                            <a class="nav-link" href="violation.html">Violation</a>
                        </div>
                    `;
                    sidebar.innerHTML = mobileMenuContent;
                }
                
                // Just toggle the CSS class - let CSS handle all positioning
                sidebar.classList.toggle('mobile-open');
            }
            
            if (overlay) {
                overlay.classList.toggle('active');
            }
            
            document.body.style.overflow = sidebar && sidebar.classList.contains('mobile-open') ? 'hidden' : '';
        }

        function closeMobileSidebar() {
            const sidebar = document.querySelector('.col-md-3.sidebar') || document.querySelector('.sidebar');
            const overlay = document.querySelector('.sidebar-overlay');
            
            if (sidebar) sidebar.classList.remove('mobile-open');
            if (overlay) overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                window.location.href = 'sign_in_form.html';
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('profileDropdown');
            const userAvatar = document.querySelector('.user-avatar');
            
            if (!userAvatar.contains(event.target)) {
                dropdown.classList.remove('show');
            }
        });

        // Filter functions
        function applyFilters() {
            const categoryFilterEl = document.getElementById('categoryFilter');
            const periodFilterEl = document.getElementById('periodFilter');
            const searchEl = document.getElementById('analyticsSearch');
            
            const categoryFilter = categoryFilterEl ? categoryFilterEl.value : '';
            const periodFilter = periodFilterEl ? periodFilterEl.value : '';
            const searchTerm = searchEl ? searchEl.value.toLowerCase() : '';
            
            filteredAnalytics = allAnalytics.filter(item => {
                const matchesCategory = !categoryFilter || item.category === categoryFilter;
                const matchesPeriod = !periodFilter || item.period === periodFilter;
                const matchesSearch = !searchTerm || 
                    item.category.toLowerCase().includes(searchTerm) ||
                    item.metric.toLowerCase().includes(searchTerm) ||
                    item.location.toLowerCase().includes(searchTerm) ||
                    item.value.toLowerCase().includes(searchTerm);
                    
                return matchesCategory && matchesPeriod && matchesSearch;
            });
            
            updateTable();
        }

        function resetFilters() {
            const categoryFilterEl = document.getElementById('categoryFilter');
            const periodFilterEl = document.getElementById('periodFilter');
            const searchEl = document.getElementById('analyticsSearch');
            
            if (categoryFilterEl) categoryFilterEl.value = '';
            if (periodFilterEl) periodFilterEl.value = '';
            if (searchEl) searchEl.value = '';
            
            filteredAnalytics = [...allAnalytics];
            updateTable();
        }

        function updateTable() {
            const tbody = document.getElementById('analyticsTableBody');
            const tableInfo = document.getElementById('tableInfo');
            
            // Check if elements exist before trying to use them
            if (!tbody) {
                console.warn('Analytics table body element (analyticsTableBody) not found in DOM');
                return;
            }
            
            if (!tableInfo) {
                console.warn('Table info element (tableInfo) not found in DOM');
                // Continue without table info if it doesn't exist
            }
            
            tbody.innerHTML = '';
            
            filteredAnalytics.forEach(item => {
                const statusClass = item.status.includes('Excellent') || item.status.includes('High') || item.status.includes('#1') ? 'bg-success' : 
                                   item.status.includes('Good') || item.status.includes('Available') || item.status.includes('#2') || item.status.includes('#3') ? 'bg-success' : 
                                   item.status.includes('Low') || item.status.includes('Adequate') ? 'bg-warning' : 'bg-info';
                
                const growthClass = item.growth.includes('+') ? 'text-success' : 
                                   item.growth.includes('-') ? 'text-danger' : 'text-warning';
                
                const row = `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.metric}</td>
                        <td>${item.value}</td>
                        <td>${item.location}</td>
                        <td>${item.period}</td>
                        <td><span class="${growthClass}">${item.growth}</span></td>
                        <td><span class="badge ${statusClass}">${item.status}</span></td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
            
            // Update table info if element exists
            if (tableInfo) {
                tableInfo.textContent = `1 to ${filteredAnalytics.length} items of ${filteredAnalytics.length}`;
            }
        }

        // Download functions
        function downloadData(format) {
            switch(format) {
                case 'csv':
                    downloadCSV();
                    break;
                case 'excel':
                    downloadExcel();
                    break;
                case 'pdf':
                    downloadPDF();
                    break;
                case 'word':
                    downloadWord();
                    break;
                case 'image':
                    downloadImage();
                    break;
            }
        }

        function downloadCSV() {
            const headers = ['Category', 'Metric', 'Value', 'Location/Product', 'Period', 'Growth Rate', 'Status'];
            const csvContent = [
                headers.join(','),
                ...filteredAnalytics.map(item => [
                    `"${item.category}"`,
                    `"${item.metric}"`,
                    `"${item.value}"`,
                    `"${item.location}"`,
                    `"${item.period}"`,
                    `"${item.growth}"`,
                    `"${item.status}"`
                ].join(','))
            ].join('\\n');
            
            downloadFile(csvContent, 'anihan-analytics-data.csv', 'text/csv');
        }

        function downloadExcel() {
            // Simple Excel-compatible format
            const headers = ['Category', 'Metric', 'Value', 'Location/Product', 'Period', 'Growth Rate', 'Status'];
            const csvContent = [
                headers.join('\\t'),
                ...filteredAnalytics.map(item => [
                    item.category,
                    item.metric,
                    item.value,
                    item.location,
                    item.period,
                    item.growth,
                    item.status
                ].join('\\t'))
            ].join('\\n');
            
            downloadFile(csvContent, 'anihan-analytics-data.xls', 'application/vnd.ms-excel');
        }

        function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(16);
            doc.text('Anihan Analytics Report', 20, 20);
            
            let y = 40;
            doc.setFontSize(10);
            doc.text('Category', 20, y);
            doc.text('Metric', 50, y);
            doc.text('Value', 90, y);
            doc.text('Location', 130, y);
            doc.text('Period', 160, y);
            doc.text('Growth', 180, y);
            doc.text('Status', 200, y);
            
            y += 10;
            filteredAnalytics.forEach(item => {
                if (y > 280) {
                    doc.addPage();
                    y = 20;
                }
                doc.text(item.category, 20, y);
                doc.text(item.metric, 50, y);
                doc.text(item.value, 90, y);
                doc.text(item.location, 130, y);
                doc.text(item.period, 160, y);
                doc.text(item.growth, 180, y);
                doc.text(item.status, 200, y);
                y += 10;
            });
            
            doc.save('anihan-analytics-data.pdf');
        }

        function downloadWord() {
            let content = `
                <html>
                <head><title>Anihan Analytics Report</title></head>
                <body>
                    <h1>Anihan Analytics Report</h1>
                    <table border="1" cellpadding="5" cellspacing="0">
                        <tr>
                            <th>Category</th>
                            <th>Metric</th>
                            <th>Value</th>
                            <th>Location/Product</th>
                            <th>Period</th>
                            <th>Growth Rate</th>
                            <th>Status</th>
                        </tr>
            `;
            
            filteredAnalytics.forEach(item => {
                content += `
                    <tr>
                        <td>${item.category}</td>
                        <td>${item.metric}</td>
                        <td>${item.value}</td>
                        <td>${item.location}</td>
                        <td>${item.period}</td>
                        <td>${item.growth}</td>
                        <td>${item.status}</td>
                    </tr>
                `;
            });
            
            content += '</table></body></html>';
            
            downloadFile(content, 'anihan-analytics-data.doc', 'application/msword');
        }

        function downloadImage() {
            const table = document.getElementById('analyticsTable');
            html2canvas(table).then(canvas => {
                const link = document.createElement('a');
                link.download = 'anihan-analytics-table.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function previousPage() {
            // Pagination logic can be implemented here
            console.log('Previous page');
        }

        function nextPage() {
            // Pagination logic can be implemented here
            console.log('Next page');
        }

        // Event listeners
    // Initialize analytics table only if the required elements exist
    const analyticsTableBody = document.getElementById('analyticsTableBody');
    const categoryFilterEl = document.getElementById('categoryFilter');
    const periodFilterEl = document.getElementById('periodFilter');
    const analyticsSearchEl = document.getElementById('analyticsSearch');
    
    if (analyticsTableBody) {
        // Add event listeners only if elements exist
        if (categoryFilterEl) categoryFilterEl.addEventListener('change', applyFilters);
        if (periodFilterEl) periodFilterEl.addEventListener('change', applyFilters);
        if (analyticsSearchEl) analyticsSearchEl.addEventListener('input', applyFilters);

        // Initialize table
        updateTable();
    } else {
        console.log('Analytics table functionality disabled - required HTML elements not found');
        console.log('Missing elements: analyticsTableBody, categoryFilter, periodFilter, analyticsSearch');
    }
    </script>
    <script>
        // Tabs for Account Approval - with error handling
        const forApprovalTab = document.getElementById('forApprovalTab');
        if (forApprovalTab) {
            forApprovalTab.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'for_approval.html';
            });
        }
        
        const approvedTab = document.getElementById('approvedTab');
        if (approvedTab) {
            approvedTab.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'approved_application.html';
            });
        }
        
        const inventoryRecordsTab = document.getElementById('inventoryRecordsTab');
        if (inventoryRecordsTab) {
            inventoryRecordsTab.addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'inventory_records.html';
            });
        }

        // Sidebar navigation
        const sidebarLinks = document.querySelectorAll('.sidebar .nav-link:not(.submenu-link):not(#inventoryRecordsTab)');
        const sidebarRoutes = [
            'dashboard_super_admin.html',
            'admin_accounts.html',
            '', // Account Approval handled by submenu
            'inventory_records.html',
            'price_monitoring.html',
            'in_demand_products.html',
            'sales_per_location.html',
            '', // Voucher handled by submenu
            'violation.html'
        ];
        sidebarLinks.forEach((btn, idx) => {
            // Account Approval handled by submenu
            if (btn.closest('.nav-dropdown')) return;
            btn.addEventListener('click', function(e) {
                e.preventDefault();
                if (sidebarRoutes[idx]) {
                    window.location.href = sidebarRoutes[idx];
                }
            });
        });
    </script>
    
    <script>
        // Chart.js Analytics Implementation
        let salesChart, stocksChart, soilChart, hectareChart;

        // Chart Data
        const analyticsData = {
            sales: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [15000, 18500, 22000, 19800, 25500, 28000, 32000, 29500, 31000, 35000, 38000, 42000]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [8500, 9200, 11000, 12500]
                },
                yearly: {
                    labels: ['2020', '2021', '2022', '2023', '2024'],
                    data: [180000, 220000, 285000, 340000, 420000]
                }
            },
            stocks: {
                category: {
                    labels: [],
                    data: [],
                    colors: ['#28a745', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14', '#20c997', '#e83e8c', '#fd7e14', '#6610f2', '#6c757d']
                },
                status: {
                    labels: [],
                    data: [],
                    colors: ['#28a745', '#ffc107', '#dc3545', '#6c757d']
                }
            },
            soil: {
                type: {
                    labels: ['Clay Soil', 'Sandy Soil', 'Loam Soil', 'Silt Soil', 'Peat Soil', 'Chalk Soil'],
                    data: [25, 20, 30, 15, 8, 2],
                    colors: ['#8B4513', '#F4A460', '#DEB887', '#D2B48C', '#A0522D', '#198754']
                }
            },
            hectare: {
                monthly: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [120, 135, 150, 168, 180, 195, 210, 225, 240, 255, 270, 285]
                },
                weekly: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    data: [65, 72, 68, 80]
                },
                yearly: {
                    labels: ['2020', '2021', '2022', '2023', '2024'],
                    data: [1200, 1350, 1800, 2100, 2400]
                }
            }
        };

        // Fetch soil analytics from store-owner table
        async function updateSoilAnalyticsFromDB() {
            try {
                if (!supabaseClient) {
                    console.error('Supabase client not available for soil analytics');
                    return;
                }
                
                const { data: stores, error } = await supabaseClient
                    .from('store-owner')
                    .select('soil_type');
                
                if (error) {
                    console.error('âŒ Error fetching stores for soil analytics:', error);
                    console.log('Using default soil data instead');
                    return;
                }
                
                console.log(`ðŸŒ± Soil Analytics: Found ${stores?.length || 0} store owners in database`);
                
                if (!stores || stores.length === 0) {
                    console.log('âš ï¸ No soil data found in database, charts will show default data');
                    return;
                }
                
                // Count occurrences of each soil_type
                const soilTypeMap = {};
                
                stores.forEach(store => {
                    const soil = store.soil_type && store.soil_type.trim() ? store.soil_type.trim() : 'Unknown';
                    
                    // Group by soil type
                    if (!soilTypeMap[soil]) soilTypeMap[soil] = 0;
                    soilTypeMap[soil] += 1;
                });
                
                if (Object.keys(soilTypeMap).length > 0) {
                    analyticsData.soil.type.labels = Object.keys(soilTypeMap);
                    analyticsData.soil.type.data = Object.values(soilTypeMap);
                    
                    // Assign colors
                    const baseColors = ['#8B4513', '#F4A460', '#DEB887', '#D2B48C', '#A0522D', '#198754', '#ffc107', '#17a2b8', '#6f42c1', '#fd7e14'];
                    analyticsData.soil.type.colors = analyticsData.soil.type.labels.map((_, i) => baseColors[i % baseColors.length]);
                    
                    // Update chart if it exists
                    if (typeof soilChart !== 'undefined' && soilChart) {
                        soilChart.data.labels = analyticsData.soil.type.labels;
                        soilChart.data.datasets[0].data = analyticsData.soil.type.data;
                        soilChart.data.datasets[0].backgroundColor = analyticsData.soil.type.colors;
                        soilChart.update();
                    }
                }
                
                console.log('ðŸŒ± Soil analytics updated from database:', Object.keys(soilTypeMap));
            } catch (err) {
                console.error('Exception updating soil analytics:', err);
                console.log('Using default soil data instead');
            }
        }

        // Fetch hectare analytics from store-owner table
        async function updateHectareAnalyticsFromDB() {
            try {
                if (!supabaseClient) {
                    console.error('Supabase client not available for hectare analytics');
                    return;
                }
                
                const { data: stores, error } = await supabaseClient
                    .from('store-owner')
                    .select('land_size, created_at');
                
                if (error) {
                    console.error('Error fetching stores for hectare analytics:', error);
                    console.log('Using default hectare data instead');
                    return;
                }
                
                if (!stores || stores.length === 0) {
                    console.log('No hectare data found in database, using default data');
                    return;
                }
                
                // Process data for different views
                updateHectareTimeline(stores);
                
                // Update chart if it exists
                if (typeof hectareChart !== 'undefined' && hectareChart) {
                    const hectareFilter = document.getElementById('hectareFilter');
                    const currentView = hectareFilter ? hectareFilter.value : 'monthly';
                    updateHectareChart(currentView);
                }
                
                console.log('Hectare analytics updated from DB');
            } catch (err) {
                console.error('Exception updating hectare analytics:', err);
                console.log('Using default hectare data instead');
            }
        }

        // Update hectare timeline data based on actual database records
        function updateHectareTimeline(stores) {
            const currentYear = new Date().getFullYear();
            const currentDate = new Date();
            
            // Initialize data structures
            const monthlyTotals = {};
            const weeklyTotals = {};
            const yearlyTotals = {};
            
            // Initialize months for current year
            for (let i = 0; i < 12; i++) {
                const monthName = new Date(currentYear, i).toLocaleDateString('en', {month: 'short'});
                monthlyTotals[monthName] = 0;
            }
            
            // Initialize weeks for current month (last 4 weeks)
            for (let i = 1; i <= 4; i++) {
                weeklyTotals[`Week ${i}`] = 0;
            }
            
            // Initialize years (last 5 years)
            for (let i = 4; i >= 0; i--) {
                const year = currentYear - i;
                yearlyTotals[year.toString()] = 0;
            }
            
            // Process each store record
            stores.forEach(store => {
                if (store.created_at && store.land_size) {
                    const date = new Date(store.created_at);
                    const landSize = parseFloat(store.land_size) || 0;
                    const year = date.getFullYear();
                    
                    // Monthly data (current year only)
                    if (year === currentYear) {
                        const monthName = date.toLocaleDateString('en', {month: 'short'});
                        if (monthlyTotals.hasOwnProperty(monthName)) {
                            monthlyTotals[monthName] += landSize;
                        }
                    }
                    
                    // Weekly data (current month only, distributed across weeks)
                    if (year === currentYear && date.getMonth() === currentDate.getMonth()) {
                        const weekOfMonth = Math.ceil(date.getDate() / 7);
                        const weekKey = `Week ${Math.min(weekOfMonth, 4)}`;
                        if (weeklyTotals.hasOwnProperty(weekKey)) {
                            weeklyTotals[weekKey] += landSize;
                        }
                    }
                    
                    // Yearly data (last 5 years)
                    if (yearlyTotals.hasOwnProperty(year.toString())) {
                        yearlyTotals[year.toString()] += landSize;
                    }
                }
            });
            
            // Update analytics data
            analyticsData.hectare.monthly.labels = Object.keys(monthlyTotals);
            analyticsData.hectare.monthly.data = Object.values(monthlyTotals);
            
            analyticsData.hectare.weekly.labels = Object.keys(weeklyTotals);
            analyticsData.hectare.weekly.data = Object.values(weeklyTotals);
            
            analyticsData.hectare.yearly.labels = Object.keys(yearlyTotals);
            analyticsData.hectare.yearly.data = Object.values(yearlyTotals);
            
            console.log('Hectare timeline data updated:', {
                monthly: analyticsData.hectare.monthly,
                weekly: analyticsData.hectare.weekly,
                yearly: analyticsData.hectare.yearly
            });
        }

        // Update hectare chart based on selected filter
        function updateHectareChart(filterValue) {
            if (typeof hectareChart === 'undefined' || !hectareChart) return;
            
            let currentData;
            let chartLabel = 'Hectares Cultivated';
            
            switch(filterValue) {
                case 'weekly':
                    currentData = analyticsData.hectare.weekly;
                    chartLabel = 'Weekly Hectares';
                    break;
                case 'yearly':
                    currentData = analyticsData.hectare.yearly;
                    chartLabel = 'Yearly Hectares';
                    break;
                default:
                    currentData = analyticsData.hectare.monthly;
                    chartLabel = 'Monthly Hectares';
            }
            
            // Update chart data (all are bar charts now)
            hectareChart.data.labels = currentData.labels;
            hectareChart.data.datasets[0].data = currentData.data;
            hectareChart.data.datasets[0].label = chartLabel;
            hectareChart.data.datasets[0].backgroundColor = 'rgba(40, 167, 69, 0.8)';
            hectareChart.data.datasets[0].borderColor = '#28a745';
            hectareChart.update();
            
            console.log(`Hectare chart updated to ${filterValue} view:`, currentData);
        }

        // Fetch stock analytics from products table
        async function updateStockAnalyticsFromDB() {
            try {
                if (!supabaseClient) {
                    console.error('Supabase client not available for stock analytics');
                    return;
                }
                
                const { data: products, error } = await supabaseClient
                    .from('my_products')
                    .select('category, quantity');
                    
                // Store for export
                window.lastFetchedProductsForExport = products;
                if (error) {
                    console.error('âŒ Error fetching products for stock analytics:', error);
                    return;
                }
                
                console.log(`ðŸ“¦ Stock Analytics: Found ${products?.length || 0} products in database`);
                
                if (!products || products.length === 0) {
                    console.log('âš ï¸ No products found in database, charts will show default data');
                    return;
                }
                
                // Group and sum quantities by category, and count products per category
                const categoryMap = {};
                const categoryCountMap = {};
                // Group by status (Available, Low Stock, Out of Stock)
                const statusMap = { 'Available': 0, 'Low Stock': 0, 'Out of Stock': 0 };
                
                products.forEach(product => {
                    const cat = product.category || 'Uncategorized';
                    const qty = parseInt(product.quantity, 10) || 0;
                    
                    // Category grouping
                    if (!categoryMap[cat]) categoryMap[cat] = 0;
                    if (!categoryCountMap[cat]) categoryCountMap[cat] = 0;
                    categoryMap[cat] += qty;
                    categoryCountMap[cat] += 1;
                    
                    // Status logic like inventory_records.html
                    let status = 'Available';
                    if (qty === 0) status = 'Out of Stock';
                    else if (qty > 0 && qty <= 10) status = 'Low Stock';
                    statusMap[status] += 1;
                });
                // Update category analytics
                analyticsData.stocks.category.labels = Object.keys(categoryMap);
                analyticsData.stocks.category.data = Object.values(categoryMap);
                analyticsData.stocks.category.counts = Object.values(categoryCountMap);
                const baseColors = analyticsData.stocks.category.colors;
                analyticsData.stocks.category.colors = analyticsData.stocks.category.labels.map((_, i) => baseColors[i % baseColors.length]);
                
                // Update status analytics
                analyticsData.stocks.status.labels = Object.keys(statusMap);
                analyticsData.stocks.status.data = Object.values(statusMap);
                const statusColors = analyticsData.stocks.status.colors;
                analyticsData.stocks.status.colors = analyticsData.stocks.status.labels.map((_, i) => statusColors[i % statusColors.length]);
                
                console.log('ðŸ“Š Stock analytics updated from database:', {
                    categories: Object.keys(categoryMap),
                    status: Object.keys(statusMap)
                });
                
                // Update the chart with new data
                if (typeof stocksChart !== 'undefined' && stocksChart) {
                    const stocksFilter = document.getElementById('stocksFilter');
                    const view = stocksFilter ? stocksFilter.value : 'category';
                    
                    if (view === 'category') {
                        stocksChart.data.labels = analyticsData.stocks.category.labels;
                        stocksChart.data.datasets[0].data = analyticsData.stocks.category.data;
                        stocksChart.data.datasets[0].backgroundColor = analyticsData.stocks.category.colors;
                    } else if (view === 'status') {
                        stocksChart.data.labels = analyticsData.stocks.status.labels;
                        stocksChart.data.datasets[0].data = analyticsData.stocks.status.data;
                        stocksChart.data.datasets[0].backgroundColor = analyticsData.stocks.status.colors;
                    }
                    stocksChart.update();
                }
                
            } catch (err) {
                console.error('Exception updating stock analytics:', err);
            }
        }

        // Initialize Charts
        async function initializeCharts() {
            initSalesChart();
            initStocksChart();
            initSoilChart();
            initHectareChart();
            try {
                await updateStockAnalyticsFromDB();
            } catch (error) {
                console.error('Exception updating stock analytics:', error);
            }
            try {
                await updateSoilAnalyticsFromDB();
            } catch (error) {
                console.error('Exception updating soil analytics:', error);
            }
            try {
                await updateHectareAnalyticsFromDB();
            } catch (error) {
                console.error('Exception updating hectare analytics:', error);
            }
        }

        // Sales Chart (Dashboard Style)
        function initSalesChart() {
            try {
                // Destroy existing chart if it exists
                if (salesChart && typeof salesChart.destroy === 'function') {
                    salesChart.destroy();
                    salesChart = null;
                }
                
                const canvas = document.getElementById('salesChart');
                if (!canvas) {
                    console.warn('âš ï¸ Sales chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                
                salesChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                        datasets: [{
                            label: 'Sales (â‚±)',
                            data: [0, 0, 0, 0, 0, 0, 0, 14220, 0, 0, 0, 0],
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'â‚±' + value.toLocaleString();
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ Error initializing sales chart:', error);
            }
        }

        // Stocks Chart (Dashboard Style - Pie Chart)
        function initStocksChart() {
            try {
                // Destroy existing chart if it exists
                if (stocksChart && typeof stocksChart.destroy === 'function') {
                    stocksChart.destroy();
                    stocksChart = null;
                }
                
                const canvas = document.getElementById('stocksChart');
                if (!canvas) {
                    console.warn('âš ï¸ Stocks chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = {
                    labels: ['Vegetables', 'Fruits', 'Grains', 'Herbs'],
                    data: [45, 30, 15, 10],
                    colors: ['#e74c3c', '#3498db', '#2ecc71', '#f39c12']
                };
                
                stocksChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ Error initializing stocks chart:', error);
            }
        }

        // Soil Chart (Dashboard Style - Doughnut Chart)
        function initSoilChart() {
            try {
                // Destroy existing chart if it exists
                if (soilChart && typeof soilChart.destroy === 'function') {
                    soilChart.destroy();
                    soilChart = null;
                }
                
                const canvas = document.getElementById('soilChart');
                if (!canvas) {
                    console.warn('âš ï¸ Soil chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = {
                    labels: ['Clay Soil', 'Sandy Soil', 'Loam Soil', 'Silt Soil'],
                    data: [30, 25, 25, 20],
                    colors: ['#8b4513', '#f4a460', '#deb887', '#d2b48c']
                };
                
                soilChart = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            data: currentData.data,
                            backgroundColor: currentData.colors,
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ Error initializing soil chart:', error);
            }
        }

        // Hectare Chart (Dashboard Style - Bar Chart)
        function initHectareChart() {
            try {
                // Destroy existing chart if it exists
                if (hectareChart && typeof hectareChart.destroy === 'function') {
                    hectareChart.destroy();
                    hectareChart = null;
                }
                
                const canvas = document.getElementById('hectareChart');
                if (!canvas) {
                    console.warn('âš ï¸ Hectare chart canvas not found');
                    return;
                }
                
                const ctx = canvas.getContext('2d');
                const currentData = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    data: [180, 185, 190, 195, 200, 210, 220, 225, 215, 205, 190, 180]
                };
                
                hectareChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: currentData.labels,
                        datasets: [{
                            label: 'Hectares',
                            data: currentData.data,
                            backgroundColor: 'rgba(40, 167, 69, 0.8)',
                            borderColor: '#28a745',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                                labels: {
                                    boxWidth: 40,
                                    usePointStyle: false
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' ha';
                                    }
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('âŒ Error initializing hectare chart:', error);
            }
        }

        // Filter Functions
        function updateSalesChart(period) {
            if (!salesChart) {
                console.error('Sales chart not initialized');
                return;
            }
            
            console.log('Sales chart filter changed to:', period);
            
            // Load data for the selected period
            loadSalesDataForPeriod(period);
        }

        // Function to load sales data for specific time period
        async function loadSalesDataForPeriod(period) {
            try {
                console.log(`Loading sales data for period: ${period}`);
                
                if (!supabaseClient) {
                    console.error('Supabase client not available');
                    return;
                }

                // Fetch orders data
                const { data: orders, error } = await supabaseClient
                    .from('orders')
                    .select('total, created_at, status');

                if (error) {
                    console.error('Database error fetching orders:', error);
                    return;
                }

                if (!orders || orders.length === 0) {
                    console.log('No orders found');
                    return;
                }

                // Process data based on selected period
                let chartData;
                switch (period) {
                    case 'weekly':
                        chartData = processOrdersForWeekly(orders);
                        break;
                    case 'yearly':
                        chartData = processOrdersForYearly(orders);
                        break;
                    case 'monthly':
                    default:
                        chartData = processOrdersForChart(orders);
                        break;
                }

                console.log(`Chart data for ${period}:`, chartData);
                updateSalesChartWithData(chartData);
                
                // Calculate and display total sales
                updateTotalSalesDisplay(orders);

            } catch (error) {
                console.error(`Error loading ${period} sales data:`, error);
            }
        }
        
        // Function to update total sales display
        function updateTotalSalesDisplay(orders) {
            try {
                let totalSales = 0;
                let totalOrders = 0;
                
                if (orders && orders.length > 0) {
                    orders.forEach(order => {
                        if (order.total && (order.status === 'completed' || order.status === 'delivered')) {
                            totalSales += parseFloat(order.total) || 0;
                            totalOrders++;
                        }
                    });
                }
                
                // Update the display elements
                const totalSalesElement = document.getElementById('totalSalesDisplay');
                const totalSalesCountElement = document.getElementById('totalSalesCount');
                
                if (totalSalesElement) {
                    totalSalesElement.textContent = `â‚±${totalSales.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                }
                
                if (totalSalesCountElement) {
                    totalSalesCountElement.textContent = `${totalOrders.toLocaleString()} orders`;
                }
                
                console.log(`Total Sales Updated: â‚±${totalSales.toFixed(2)} from ${totalOrders} completed orders`);
                
            } catch (error) {
                console.error('Error updating total sales display:', error);
            }
        }

        // Function to process orders for weekly view (last 4 weeks)
        function processOrdersForWeekly(orders) {
            const weekLabels = ['Week 1', 'Week 2', 'Week 3', 'Week 4'];
            const weeklyData = [0, 0, 0, 0];
            
            const currentDate = new Date();
            const currentMonth = currentDate.getMonth();
            const currentYear = currentDate.getFullYear();
            
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    
                    // Only process orders from current month
                    if (orderDate.getMonth() === currentMonth && orderDate.getFullYear() === currentYear) {
                        const dayOfMonth = orderDate.getDate();
                        const weekIndex = Math.floor((dayOfMonth - 1) / 7);
                        
                        if (weekIndex >= 0 && weekIndex < 4) {
                            weeklyData[weekIndex] += parseFloat(order.total) || 0;
                        }
                    }
                }
            });

            return {
                labels: weekLabels,
                data: weeklyData
            };
        }

        // Function to process orders for yearly view (last 5 years)
        function processOrdersForYearly(orders) {
            const currentYear = new Date().getFullYear();
            const yearLabels = [];
            const yearlyData = {};
            
            // Generate last 5 years
            for (let i = 4; i >= 0; i--) {
                const year = currentYear - i;
                yearLabels.push(year.toString());
                yearlyData[year] = 0;
            }
            
            orders.forEach(order => {
                if (order.created_at && order.total) {
                    const orderDate = new Date(order.created_at);
                    const orderYear = orderDate.getFullYear();
                    
                    if (yearlyData.hasOwnProperty(orderYear)) {
                        yearlyData[orderYear] += parseFloat(order.total) || 0;
                    }
                }
            });

            return {
                labels: yearLabels,
                data: yearLabels.map(year => yearlyData[parseInt(year)])
            };
        }

        function updateStocksChart(view) {
            const data = analyticsData.stocks[view];
            stocksChart.data.labels = data.labels;
            stocksChart.data.datasets[0].data = data.data;
            stocksChart.data.datasets[0].backgroundColor = data.colors;
            stocksChart.update();
        }

        // Event Listeners for Filters - with error handling
        const salesFilterEl = document.getElementById('salesFilter');
        if (salesFilterEl) {
            salesFilterEl.addEventListener('change', function() {
                updateSalesChart(this.value);
            });
        }

        const stocksFilterEl = document.getElementById('stocksFilter');
        if (stocksFilterEl) {
            stocksFilterEl.addEventListener('change', function() {
                updateStocksChart(this.value);
            });
        }

        // Export Functions
        function exportChart(chartType, format) {
            const chartMap = {
                'sales': salesChart,
                'stocks': stocksChart,
                'soil': soilChart,
                'hectare': hectareChart
            };
            
            const chart = chartMap[chartType];
            const filename = chartType + '_analytics_' + new Date().toISOString().split('T')[0];
            
            switch(format) {
                case 'png':
                case 'picture':
                    if (chart) {
                        const url = chart.toBase64Image();
                        const link = document.createElement('a');
                        link.download = filename + '.png';
                        link.href = url;
                        link.click();
                    }
                    break;
                case 'csv':
                    exportToCSV(chartType, filename);
                    break;
                case 'pdf':
                    exportToPDF(chartType, filename);
                    break;
                case 'word':
                    exportToWord(chartType, filename);
                    break;
            }
        }

        function exportToCSV(chartType, filename) {
            let csv = '';
            let data;
            
            switch(chartType) {
                case 'sales':
                    // Use real sales data instead of dummy analyticsData
                    if (currentSalesData) {
                        csv = 'Period,Sales Amount (PHP)\n';
                        currentSalesData.labels.forEach((label, index) => {
                            const value = currentSalesData.data[index] || 0;
                            csv += `${label},${value.toFixed(2)}\n`;
                        });
                    } else {
                        // Fallback if no data available
                        csv = 'Period,Sales Amount (PHP)\nNo data available,0.00\n';
                    }
                    break;
                case 'stocks':
                    // Always export as Category, Stock, Status for all products
                    csv = 'Category,Stock,Status\n';
                    // Fetch all products from analytics (or cache, or refetch if needed)
                    // We'll use the last fetched products from updateStockAnalyticsFromDB if available
                    if (window.lastFetchedProductsForExport && Array.isArray(window.lastFetchedProductsForExport)) {
                        window.lastFetchedProductsForExport.forEach(product => {
                            const cat = product.category || 'Uncategorized';
                            const qty = parseInt(product.quantity, 10) || 0;
                            let status = 'Available';
                            if (qty === 0) status = 'Out of Stock';
                            else if (qty > 0 && qty <= 10) status = 'Low Stock';
                            csv += `${cat},${qty},${status}\n`;
                        });
                    } else {
                        // fallback: use analyticsData.stocks.category/status (less detail)
                        data = analyticsData.stocks[document.getElementById('stocksFilter').value];
                        data.labels.forEach((label, index) => {
                            csv += label + ',' + data.data[index] + ',\n';
                        });
                    }
                    break;
                case 'soil':
                    data = analyticsData.soil.type;
                    csv = 'Soil Type,Percentage\n';
                    data.labels.forEach((label, index) => {
                        csv += label + ',' + data.data[index] + '\n';
                    });
                    break;
                case 'hectare':
                    data = analyticsData.hectare.monthly;
                    csv = 'Period,Hectares\n';
                    data.labels.forEach((label, index) => {
                        csv += label + ',' + data.data[index] + '\n';
                    });
                    break;
            }
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = filename + '.csv';
            link.click();
            window.URL.revokeObjectURL(url);
        }

        function exportToPDF(chartType, filename) {
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF();
                    const imgWidth = 210;
                    const pageHeight = 295;
                    const imgHeight = (canvas.height * imgWidth) / canvas.width;
                    let heightLeft = imgHeight;
                    let position = 0;
                    
                    pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                    heightLeft -= pageHeight;
                    
                    while (heightLeft >= 0) {
                        position = heightLeft - imgHeight;
                        pdf.addPage();
                        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                        heightLeft -= pageHeight;
                    }
                    
                    pdf.save(filename + '.pdf');
                });
            }
        }

        function exportToWord(chartType, filename) {
            console.log('ðŸ“ Exporting to Word:', chartType);
            const canvas = document.querySelector('#' + chartType + 'Chart');
            if (canvas) {
                html2canvas(canvas).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    
                    // Prepare data table HTML based on chart type
                    let dataTableHTML = '';
                    
                    if (chartType === 'sales' && currentSalesData) {
                        console.log('ðŸ“Š Processing sales data for Word export...');
                        dataTableHTML = `
                            <h2>Sales Data Table</h2>
                            <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                <thead>
                                    <tr style="background-color: #f8f9fa;">
                                        <th style="padding: 10px; text-align: left;">Period</th>
                                        <th style="padding: 10px; text-align: right;">Sales Amount (PHP)</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        currentSalesData.labels.forEach((label, index) => {
                            const value = currentSalesData.data[index] || 0;
                            const formattedValue = new Intl.NumberFormat('en-PH', {
                                style: 'currency',
                                currency: 'PHP',
                                minimumFractionDigits: 2
                            }).format(value);
                            
                            dataTableHTML += `
                                <tr>
                                    <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                    <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedValue}</td>
                                </tr>
                            `;
                        });
                        
                        // Calculate total
                        const total = currentSalesData.data.reduce((sum, value) => sum + (value || 0), 0);
                        const formattedTotal = new Intl.NumberFormat('en-PH', {
                            style: 'currency',
                            currency: 'PHP',
                            minimumFractionDigits: 2
                        }).format(total);
                        
                        dataTableHTML += `
                                    <tr style="background-color: #e9ecef; font-weight: bold;">
                                        <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${formattedTotal}</td>
                                    </tr>
                                </tbody>
                            </table>
                        `;
                    } else if (chartType === 'soil') {
                        console.log('ðŸŒ± Processing soil data for Word export...');
                        // Use analyticsData.soil.type which gets updated from database
                        const soilData = analyticsData.soil.type;
                        console.log('Soil data for export:', soilData);
                        
                        if (soilData && soilData.labels && soilData.data) {
                            dataTableHTML = `
                                <h2>Soil Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Soil Type</th>
                                            <th style="padding: 10px; text-align: right;">Count</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            soilData.labels.forEach((label, index) => {
                                const value = soilData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('âš ï¸ Soil data not available for Word export');
                            dataTableHTML = `<p><em>No soil data available for export.</em></p>`;
                        }
                    } else if (chartType === 'hectare') {
                        console.log('ðŸ“Š Processing hectare data for Word export...');
                        // Use analyticsData.hectare.monthly which gets updated from database
                        const hectareData = analyticsData.hectare.monthly;
                        console.log('Hectare data for export:', hectareData);
                        
                        if (hectareData && hectareData.labels && hectareData.data) {
                            dataTableHTML = `
                                <h2>Hectare Analytics Data Table</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">Period</th>
                                            <th style="padding: 10px; text-align: right;">Hectares</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            hectareData.labels.forEach((label, index) => {
                                const value = hectareData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value.toFixed(1)} ha</td>
                                    </tr>
                                `;
                            });
                            
                            // Calculate average
                            const average = hectareData.labels.length > 0 ? (total / hectareData.labels.length).toFixed(1) : 0;
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total.toFixed(1)} ha</td>
                                        </tr>
                                        <tr style="background-color: #f8f9fa; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Average</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${average} ha</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('âš ï¸ Hectare data not available for Word export');
                            dataTableHTML = `<p><em>No hectare data available for export.</em></p>`;
                        }
                    } else if (chartType === 'stocks') {
                        console.log('ðŸ“¦ Processing stocks data for Word export...');
                        // Use the current stocks filter to determine which data to show
                        const stocksFilter = document.getElementById('stocksFilter');
                        const currentView = stocksFilter ? stocksFilter.value : 'category';
                        const stocksData = analyticsData.stocks[currentView];
                        
                        if (stocksData && stocksData.labels && stocksData.data) {
                            const headerLabel = currentView === 'category' ? 'Category' : 'Status';
                            const valueLabel = currentView === 'category' ? 'Quantity' : 'Count';
                            
                            dataTableHTML = `
                                <h2>Stocks Analytics Data Table (${currentView.charAt(0).toUpperCase() + currentView.slice(1)})</h2>
                                <table border="1" style="border-collapse: collapse; width: 100%; margin: 20px 0;">
                                    <thead>
                                        <tr style="background-color: #f8f9fa;">
                                            <th style="padding: 10px; text-align: left;">${headerLabel}</th>
                                            <th style="padding: 10px; text-align: right;">${valueLabel}</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                            `;
                            
                            let total = 0;
                            stocksData.labels.forEach((label, index) => {
                                const value = stocksData.data[index] || 0;
                                total += value;
                                
                                dataTableHTML += `
                                    <tr>
                                        <td style="padding: 10px; border: 1px solid #ddd;">${label}</td>
                                        <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${value}</td>
                                    </tr>
                                `;
                            });
                            
                            dataTableHTML += `
                                        <tr style="background-color: #e9ecef; font-weight: bold;">
                                            <td style="padding: 10px; border: 1px solid #ddd;">Total</td>
                                            <td style="padding: 10px; border: 1px solid #ddd; text-align: right;">${total}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            `;
                        } else {
                            console.warn('âš ï¸ Stocks data not available for Word export');
                            dataTableHTML = `<p><em>No stocks data available for export.</em></p>`;
                        }
                    } else {
                        console.warn('âš ï¸ Chart data not available for:', chartType);
                        dataTableHTML = `<p><em>No data available for ${chartType} chart.</em></p>`;
                    }
                    
                    const html = `
                        <html>
                        <head>
                            <title>Super Admin ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</title>
                            <style>
                                body { font-family: Arial, sans-serif; margin: 40px; }
                                h1 { color: #333; border-bottom: 2px solid #28a745; padding-bottom: 10px; }
                                h2 { color: #495057; margin-top: 30px; }
                                .report-info { background-color: #f8f9fa; padding: 15px; margin: 20px 0; border-left: 4px solid #28a745; }
                                .chart-container { text-align: center; margin: 30px 0; }
                                table { font-size: 14px; }
                            </style>
                        </head>
                        <body>
                            <h1>Super Admin ${chartType.charAt(0).toUpperCase() + chartType.slice(1)} Analytics Report</h1>
                            
                            <div class="report-info">
                                <strong>Report Generated:</strong> ${new Date().toLocaleDateString('en-PH', { 
                                    year: 'numeric', 
                                    month: 'long', 
                                    day: 'numeric',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}<br>
                                <strong>Period:</strong> ${currentSalesPeriod || 'Monthly'}<br>
                                <strong>Chart Type:</strong> ${chartType.charAt(0).toUpperCase() + chartType.slice(1)}
                            </div>
                            
                            <div class="chart-container">
                                <h2>Chart Visualization</h2>
                                <img src="${imgData}" style="max-width: 100%; border: 1px solid #ddd; padding: 10px;" />
                            </div>
                            
                            ${dataTableHTML}
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #6c757d;">
                                <p>This report was automatically generated by the Anihan Super Admin Dashboard.</p>
                            </div>
                        </body>
                        </html>
                    `;
                    const blob = new Blob([html], { type: 'application/msword' });
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = filename + '.doc';
                    link.click();
                    window.URL.revokeObjectURL(url);
                });
            }
        }

    </script>
</body>
</html>

