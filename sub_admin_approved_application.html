<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Approved Accounts - Sub Admin</title>
    <link rel="icon" type="image/png" href="images/pic4.png">
    <link rel="shortcut icon" type="image/png" href="images/pic4.png">
    <link rel="apple-touch-icon" href="images/pic4.png">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css?v=5.5" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css?v=5.5">
    <link rel="stylesheet" href="fixed-layout.css?v=5.5">
    <link rel="stylesheet" href="profile-dropdown.css?v=5.5">
    <link rel="stylesheet" href="approved_application.css?v=5.5">
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm">
        <div class="container-fluid">
            <button class="mobile-menu-toggle me-3 d-md-none" onclick="toggleMobileSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a class="navbar-brand d-flex align-items-center" href="#">
                <img src="images/pic4.png" alt="Anihan Logo" class="logo-image me-2">
                <span class="brand-text">Anihan</span>
            </a>
            <div class="collapse navbar-collapse">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item dropdown">
                        <div class="user-avatar" onclick="toggleProfileDropdown()">
                            <img id="userAvatarImage" class="avatar-img" style="display: none;" alt="Profile">
                            <i id="userAvatarIcon" class="fas fa-user"></i>
                        </div>
                        <!-- Profile Dropdown -->
                        <div class="profile-dropdown" id="profileDropdown">
                            <div class="profile-dropdown-header">
                                <div class="profile-dropdown-avatar">
                                    <img id="profileAvatarImage" class="profile-avatar-img" style="display: none;" alt="Profile">
                                    <i id="profileAvatarIcon" class="fas fa-user"></i>
                                </div>
                                <h6 id="profileUserName" class="profile-dropdown-name">Loading...</h6>
                            </div>
                            <div class="profile-dropdown-details">
                                <div class="profile-detail-item">
                                    <i class="fas fa-envelope"></i>
                                    <span id="profileUserEmail">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-user-tag"></i>
                                    <span id="profileUserRole">Loading...</span>
                                </div>
                                <div class="profile-detail-item">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span id="profileUserAccess">Loading...</span>
                                </div>
                            </div>
                            <div class="profile-dropdown-actions">
                                <button class="btn" onclick="signOut()">
                                    <i class="fas fa-sign-out-alt"></i>
                                    Sign out
                                </button>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-md-3 col-lg-2 sidebar bg-white border-end">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <a class="nav-link d-flex align-items-center text-start" href="municipality_dashboard.html">
                        <i class="fas fa-tachometer-alt me-2"></i>
                        Dashboard
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_inventory.html">
                        <i class="fas fa-boxes me-2"></i>
                        Inventory Records
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_price_monitoring.html">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Price Monitoring
                    </a>
                    
                    <a class="nav-link d-flex align-items-center text-start" href="sub_admin_in_demand_products.html">
                        <i class="fas fa-chart-line me-2"></i>
                        In Demand Products
                    </a>
                    
                    <!-- Account Approval Dropdown -->
                    <div class="nav-dropdown">
                        <button class="nav-link d-flex align-items-center justify-content-between text-start w-100" 
                                type="button" data-bs-toggle="collapse" data-bs-target="#accountApprovalSubmenu" 
                                aria-expanded="true" aria-controls="accountApprovalSubmenu">
                            <span>
                                <i class="fas fa-clipboard-check me-2"></i>
                                Account Approval
                            </span>
                            <i class="fas fa-chevron-down dropdown-icon"></i>
                        </button>
                        <div class="collapse show" id="accountApprovalSubmenu">
                            <div class="submenu">
                                <a class="nav-link submenu-link d-flex align-items-center text-start" href="sub_admin_for_approval.html">
                                    <i class="fas fa-user-clock me-2"></i>
                                    For Approval
                                </a>
                                <a class="nav-link submenu-link active d-flex align-items-center text-start" href="sub_admin_approved_application.html">
                                    <i class="fas fa-user-check me-2"></i>
                                    Approved Applications
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Sidebar Overlay -->
            <div class="sidebar-overlay" onclick="closeMobileSidebar()"></div>

            <!-- Main Content -->
            <div class="col-md-9 col-lg-10 main-content">
                <!-- Approved Applications Table -->
                <div class="row">
                    <div class="col-12">
                        <div class="approval-card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h5 class="mb-0"><b>Approved Applications</b></h5>
                                <!-- Search Bar -->
                                <div class="d-flex gap-2">
                                    <div class="search-container">
                                        <i class="fas fa-search search-icon"></i>
                                        <input type="text" class="form-control search-input" placeholder="Search..." onkeyup="searchAccounts(this.value)">
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Store Name</th>
                                                <th>Municipality</th>
                                                <th>Status</th>
                                                <th>Date Processed</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="accountsTableBody">
                                            <tr>
                                                <td colspan="5" class="text-center">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                                    Loading approved accounts...
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                                <div class="table-footer">
                                    <div class="table-info-section">
                                        <span id="accountsCount">0 accounts</span>
                                    </div>
                                    <div class="pagination-controls">
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changePage(-1)">&lt;</button>
                                        <button class="btn btn-sm btn-success" id="currentPageBtn">1</button>
                                        <button class="btn btn-sm btn-outline-secondary" onclick="changePage(1)">&gt;</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Application Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">Account Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsModalBody">
                    <!-- Account details will be loaded here -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Modal -->
    <div class="modal fade" id="mapModal" tabindex="-1" aria-labelledby="mapModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="mapModalLabel">Store Location</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="mapContainer" style="width: 100%; height: 400px; border-radius: 8px;">
                        <iframe id="mapIframe" width="100%" height="100%" frameborder="0" style="border:0; border-radius: 8px;" allowfullscreen></iframe>
                    </div>
                    <div class="mt-3">
                        <p class="mb-1"><strong>Coordinates:</strong></p>
                        <p class="text-muted" id="mapCoordinates">-</p>
                        <a id="openInGoogleMaps" href="#" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Open in Google Maps
                        </a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Certificate Image Modal -->
    <div class="modal fade" id="certificateModal" tabindex="-1" aria-labelledby="certificateModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="certificateModalLabel">Barangay Certificate</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body text-center">
                    <img id="certificateImage" src="" alt="Barangay Certificate" style="max-width: 100%; height: auto; border-radius: 8px;">
                </div>
                <div class="modal-footer">
                    <a id="downloadCertificate" href="#" download class="btn btn-primary">
                        <i class="fas fa-download me-1"></i>Download
                    </a>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="shared-profile.js?v=5.5"></script>
    <script>
        // supabaseClient is already initialized in shared-profile.js
        // Just ensure it's available
        let allAccounts = [];
        let currentPage = 1;
        const itemsPerPage = 5;

        // Load approved accounts on page load
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Approved Accounts page loaded');
            await loadApprovedAccounts();
        });

        async function loadApprovedAccounts() {
            try {
                console.log('üì° Loading approved accounts...');
                
                // Get current admin's municipality from sessionStorage
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser') || '{}');
                const municipalityAddress = currentUser.address;

                console.log('üîç Current User:', currentUser);
                console.log('üèõÔ∏è Municipality Address:', municipalityAddress);

                if (!municipalityAddress) {
                    console.warn('‚ö†Ô∏è No municipality found for admin');
                    document.getElementById('accountsTableBody').innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted">No municipality assigned to your account</td></tr>
                    `;
                    return;
                }

                // Step 1: Get all users from this municipality
                const { data: municipalityUsers, error: usersError } = await supabaseClient
                    .from('users')
                    .select('id')
                    .eq('municipality', municipalityAddress);

                if (usersError) {
                    console.error('‚ùå Error fetching users:', usersError);
                    document.getElementById('accountsTableBody').innerHTML = `
                        <tr><td colspan="5" class="text-center text-danger">Error: ${usersError.message}</td></tr>
                    `;
                    return;
                }

                console.log('üë• Municipality Users:', municipalityUsers);

                if (!municipalityUsers || municipalityUsers.length === 0) {
                    document.getElementById('accountsTableBody').innerHTML = `
                        <tr><td colspan="5" class="text-center text-muted">No users found in ${municipalityAddress}</td></tr>
                    `;
                    return;
                }

                const userIds = municipalityUsers.map(u => u.id);
                console.log('üÜî User IDs to query:', userIds);

                // Step 2: Get approved store-owner accounts for these users
                const { data: accounts, error: accountsError } = await supabaseClient
                    .from('store-owner')
                    .select('*, users!inner(id, full_name, municipality, phone_number, email)')
                    .in('user_id', userIds)
                    .eq('status', 'approved')
                    .order('created_at', { ascending: false });

                if (accountsError) {
                    console.error('‚ùå Error fetching accounts:', accountsError);
                    document.getElementById('accountsTableBody').innerHTML = `
                        <tr><td colspan="5" class="text-center text-danger">Error: ${accountsError.message}</td></tr>
                    `;
                    return;
                }

                console.log(`‚úÖ Found ${accounts?.length || 0} approved accounts`);
                console.log('Accounts data:', accounts);

                allAccounts = accounts || [];
                displayAccounts(allAccounts);

            } catch (error) {
                console.error('‚ùå Error loading approved accounts:', error);
                document.getElementById('accountsTableBody').innerHTML = `
                    <tr><td colspan="5" class="text-center text-danger">Error loading accounts: ${error.message}</td></tr>
                `;
            }
        }

        function displayAccounts(accounts) {
            const tbody = document.getElementById('accountsTableBody');
            
            if (!accounts || accounts.length === 0) {
                tbody.innerHTML = `
                    <tr><td colspan="5" class="text-center text-muted">No approved accounts found</td></tr>
                `;
                document.getElementById('accountsCount').textContent = '0 accounts';
                return;
            }

            // Display paginated results
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedAccounts = accounts.slice(startIndex, endIndex);

            tbody.innerHTML = paginatedAccounts.map(acc => `
                <tr>
                    <td><strong>${acc.store_name}</strong></td>
                    <td>${acc.users.municipality}</td>
                    <td><span class="badge bg-success">Approved</span></td>
                    <td>${new Date(acc.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-info" onclick="viewDetails('${acc.id}')">
                            <i class="fas fa-eye me-1"></i>View
                        </button>
                    </td>
                </tr>
            `).join('');
            
            document.getElementById('accountsCount').textContent = `${accounts.length} account${accounts.length !== 1 ? 's' : ''}`;
            document.getElementById('currentPageBtn').textContent = currentPage;
        }

        function changePage(direction) {
            const totalPages = Math.ceil(allAccounts.length / itemsPerPage);
            currentPage += direction;
            
            if (currentPage < 1) currentPage = 1;
            if (currentPage > totalPages) currentPage = totalPages;
            
            displayAccounts(allAccounts);
        }

        async function viewDetails(accountId) {
            try {
                const { data: acc, error } = await supabaseClient
                    .from('store-owner')
                    .select('*, users!inner(id, full_name, municipality, phone_number, email)')
                    .eq('id', accountId)
                    .single();

                if (error) throw error;

                // Store coordinates globally for map function
                window.currentLatitude = acc.latitude;
                window.currentLongitude = acc.longitude;

                const certUrl = acc.barangay_certificate_url;
                const certificateType = acc.certificate_type || 'Barangay Certificate';
                const certificateSection = certUrl ? `
                    <div class="mt-3">
                        <h6>${certificateType}</h6>
                        <div class="d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-primary" onclick="viewCertificate('${certUrl.replace(/'/g, "\\'")}', '${certificateType.replace(/'/g, "\\'")}')">
                                <i class="fas fa-image me-1"></i>View Certificate
                            </button>
                        </div>
                    </div>
                ` : '';

                document.getElementById('detailsModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Store Information</h6>
                            <p><strong>Store Name:</strong> ${acc.store_name}</p>
                            <p><strong>Operation Time:</strong> ${acc.operation_time}</p>
                            <p><strong>Crops Type:</strong> ${acc.crops_type}</p>
                            <p><strong>Land Size:</strong> ${acc.land_size || 'N/A'} ${acc.land_size_unit || ''}</p>
                            <p><strong>Soil Type:</strong> ${acc.soil_type || 'N/A'}</p>
                            ${acc.recommendation ? `<p><strong>Recommendation:</strong> ${acc.recommendation}</p>` : ''}
                        </div>
                        <div class="col-md-6">
                            <h6>Owner Information</h6>
                            <p><strong>Name:</strong> ${acc.users.full_name}</p>
                            <p><strong>Email:</strong> ${acc.users.email || 'N/A'}</p>
                            <p><strong>Phone:</strong> ${acc.users.phone_number}</p>
                            <p><strong>Municipality:</strong> ${acc.users.municipality}</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <h6>Location & Status</h6>
                            <p><strong>Coordinates:</strong> ${acc.latitude}, ${acc.longitude}</p>
                            <button type="button" class="btn btn-primary btn-sm mb-2" onclick="viewOnMap()">
                                <i class="fas fa-map-marker-alt me-1"></i>View Location on Map
                            </button>
                            <p><strong>Status:</strong> <span class="badge bg-success">${acc.status}</span></p>
                            <p><strong>Approved Date:</strong> ${new Date(acc.created_at).toLocaleString()}</p>
                            ${certificateSection}
                        </div>
                    </div>
                `;

                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();

            } catch (error) {
                console.error('‚ùå Error loading account details:', error);
                alert('Error loading account details');
            }
        }

        function viewOnMap() {
            const lat = window.currentLatitude;
            const lon = window.currentLongitude;
            
            if (!lat || !lon) {
                alert('Location coordinates not available');
                return;
            }

            // Set map iframe source to Google Maps embed
            const mapIframe = document.getElementById('mapIframe');
            mapIframe.src = `https://maps.google.com/maps?q=${lat},${lon}&hl=es;z=14&output=embed`;
            
            // Set coordinates text
            document.getElementById('mapCoordinates').textContent = `Latitude: ${lat}, Longitude: ${lon}`;
            
            // Set Google Maps link
            document.getElementById('openInGoogleMaps').href = `https://www.google.com/maps?q=${lat},${lon}`;
            
            // Show the map modal
            const mapModal = new bootstrap.Modal(document.getElementById('mapModal'));
            mapModal.show();
        }

        function viewCertificate(imageUrl, certificateType = 'Barangay Certificate') {
            document.getElementById('certificateImage').src = imageUrl;
            document.getElementById('downloadCertificate').href = imageUrl;
            document.getElementById('certificateModalLabel').textContent = certificateType;
            
            const certModal = new bootstrap.Modal(document.getElementById('certificateModal'));
            certModal.show();
        }

        function refreshAccounts() {
            loadApprovedAccounts();
        }

        function exportData() {
            if (!allAccounts || allAccounts.length === 0) {
                alert('No data to export');
                return;
            }

            let csv = 'Store Name,Owner,Municipality,Crops Type,Land Size,Soil Type,Operation Time,Approved Date,Email,Phone\n';
            
            allAccounts.forEach(acc => {
                csv += `"${acc.store_name}","${acc.users.full_name}","${acc.users.municipality}","${acc.crops_type}","${acc.land_size || 'N/A'} ${acc.land_size_unit || ''}","${acc.soil_type || 'N/A'}","${acc.operation_time}","${new Date(acc.created_at).toLocaleDateString()}","${acc.users.email || 'N/A'}","${acc.users.phone_number}"\n`;
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `approved_accounts_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            window.URL.revokeObjectURL(url);
        }

        // Search functionality
        function searchAccounts(searchTerm) {
            const term = searchTerm.toLowerCase();
            const rows = document.querySelectorAll('#accountsTableBody tr');
            
            rows.forEach(row => {
                if (row.cells.length === 1) return; // Skip loading/empty rows
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        }

        // Mobile sidebar toggle
        function toggleMobileSidebar() {
            document.querySelector('.sidebar').classList.toggle('active');
            document.querySelector('.sidebar-overlay')?.classList.toggle('active');
        }

        function closeMobileSidebar() {
            document.querySelector('.sidebar').classList.remove('active');
            document.querySelector('.sidebar-overlay')?.classList.remove('active');
        }
    </script>
</body>
</html>
